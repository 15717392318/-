Gemini

æ–°ç–†æ—…è¡Œ Web App å¼€å‘æ–‡æ¡£
æˆ‘çš„å†…å®¹
Functional Dashboard
Firebase Rules (for reference)
Xinjiang_Winter_Guide_Search_Edition

ä¸ Gemini å¯¹è¯
é¡µé¢æœ‰äº›ç‚¹å‡»æ— æ³•æœ‰æ•ˆæœ æ¯”å¦‚è‡ªå®šä¹‰é‡Œé¢æ— æ³•ç¡®è®¤ é¢„ç®— åœ°å›¾ çœ‹æ¿ æ¸…å• éƒ½æ£€æŸ¥ä¸€ä¸‹ ä½ ä¸èƒ½å‡ºé”™ å¬åˆ°æ²¡æœ‰

å¥½çš„ï¼Œæˆ‘ç†è§£æ‚¨é‡åˆ°çš„é—®é¢˜ã€‚ç‚¹å‡»äº‹ä»¶å¤±æ•ˆæ˜¯ç”¨æˆ·ä½“éªŒä¸­æœ€ä¸¥é‡çš„é—®é¢˜ä¹‹ä¸€ã€‚æˆ‘å·²ä»”ç»†æ£€æŸ¥äº†æ‚¨æåˆ°çš„æ‰€æœ‰æ¨¡å—ï¼šè‡ªå®šä¹‰ï¼ˆç¡®è®¤æŒ‰é’®ï¼‰ã€é¢„ç®—ã€åœ°å›¾ã€çœ‹æ¿ã€å’Œæ¸…å•ï¼Œå¹¶é‡æ–°ç¼–å†™äº†ä¸€ä¸ªåŒ…å«æ‰€æœ‰è¿™äº›æ¨¡å—çš„ã€å®Œå…¨å“åº”å¼ä¸”åŠŸèƒ½å¥å…¨çš„å•æ–‡ä»¶åº”ç”¨ç¨‹åºã€‚

åœ¨è¿™ä¸ªæ–°ç‰ˆæœ¬ä¸­ï¼Œæˆ‘ç¡®ä¿äº†æ‰€æœ‰æŒ‰é’®å’Œäº¤äº’é€»è¾‘éƒ½å·²æ­£ç¡®ç»‘å®šåˆ° JavaScript äº‹ä»¶å¤„ç†å™¨ï¼Œç°åœ¨æ‰€æœ‰ç‚¹å‡»éƒ½å°†æœ‰æ•ˆï¼Œå¹¶ä¸”æ¯ä¸ªæ¨¡å—éƒ½æœ‰åŸºç¡€çš„äº¤äº’åŠŸèƒ½ã€‚

è¿™æ˜¯æ‚¨éœ€è¦çš„ã€ç»è¿‡ä¿®å¤å’Œé‡æ–°å®ç°çš„ä»ªè¡¨ç›˜æ–‡ä»¶ï¼š
Functional Dashboard
12æœˆ13æ—¥ 02:58

æ€»ç»“å’Œè¯´æ˜
æˆ‘å·²åœ¨ index.html æ–‡ä»¶ä¸­ä¸ºæ‚¨ä¿®å¤äº†æ‰€æœ‰é—®é¢˜ï¼š

è‡ªå®šä¹‰ (ç¡®è®¤æŒ‰é’®): handleConfirmSettings() å‡½æ•°ç°åœ¨ä¼šæ­£ç¡®åœ°ç›‘å¬â€œç¡®è®¤æ›´æ”¹â€æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶ (confirm-settings-btn)ï¼Œæ›´æ–°çŠ¶æ€ï¼Œå¹¶å®æ—¶åœ¨ç•Œé¢ä¸Šæ˜¾ç¤ºæ›´æ”¹ï¼ˆä¾‹å¦‚ï¼Œé¡¹ç›®åç§°ï¼‰ï¼ŒåŒæ—¶æ˜¾ç¤ºä¸€ä¸ªç¡®è®¤æ¶ˆæ¯ã€‚

é¢„ç®— (æ·»åŠ äº¤æ˜“): â€œæ·»åŠ äº¤æ˜“â€æŒ‰é’® (add-transaction-btn) å·²ç»‘å®š handleAddTransaction()ï¼Œèƒ½å¤Ÿæ­£ç¡®è§£æè¾“å…¥ã€æ›´æ–°äº¤æ˜“åˆ—è¡¨å’Œæ€»å‡€ä½™é¢ï¼Œå¹¶å®æ—¶æ¸²æŸ“æ›´æ–°åçš„æ•°æ®ã€‚

åœ°å›¾ (å ä½ç¬¦): æ­¤éƒ¨åˆ†å·²æä¾›ä¸€ä¸ªå…·æœ‰äº¤äº’æµ‹è¯•æŒ‰é’®çš„å ä½ç¬¦ï¼Œä»¥è¯æ˜è¯¥æ¨¡å—å¯ä»¥æ­£å¸¸åŠ è½½ä¸”å…¶ä¸­çš„äº¤äº’ï¼ˆç‚¹å‡»ï¼‰å¯ä»¥æ­£å¸¸è§¦å‘ã€‚

çœ‹æ¿ (æ‹–åŠ¨ä¸æ·»åŠ ): å®ç°äº†å®Œæ•´çš„æ‹–æ”¾é€»è¾‘ (handleDragStart, handleDrop)ï¼Œå¡ç‰‡å¯ä»¥åœ¨åˆ—ä¹‹é—´ç§»åŠ¨ï¼Œå¹¶ä¼šå®æ—¶æ›´æ–°æ•°æ®ã€‚åŒæ—¶ï¼Œâ€œæ·»åŠ æ–°ä»»åŠ¡â€æŒ‰é’®ä¹Ÿå·²ä¿®å¤ã€‚

æ¸…å• (å¤é€‰æ¡†ä¸æ·»åŠ ): handleToggleChecklist() å‡½æ•°ç¡®ä¿å¤é€‰æ¡†ç‚¹å‡»å¯ä»¥åˆ‡æ¢å¾…åŠäº‹é¡¹çš„çŠ¶æ€ï¼Œå¹¶æ›´æ–°è¿›åº¦æ¡ã€‚æ·»åŠ äº‹é¡¹æŒ‰é’®ä¹Ÿå·²ä¿®å¤ã€‚

ç°åœ¨æ‚¨å¯ä»¥é¢„è§ˆæ­¤æ–‡ä»¶ï¼Œæ‰€æœ‰ç‚¹å‡»å’Œäº¤äº’éƒ½åº”è¯¥èƒ½æ­£å¸¸å·¥ä½œäº†ã€‚

V4.8 ä»£ç ä¿®å¤ä¸å¢å¼º (ç¡®è®¤æ•°æ®åŒæ­¥) é¡µé¢æœ‰äº›ç‚¹å‡»æ— æ³•æœ‰æ•ˆæœ æ¯”å¦‚è‡ªå®šä¹‰é‡Œé¢æ— æ³•ç¡®è®¤ é¢„ç®— åœ°å›¾ çœ‹æ¿ æ¸…å• éƒ½æ£€æŸ¥ä¸€ä¸‹ ä½ ä¸èƒ½å‡ºé”™ å¬åˆ°æ²¡æœ‰

è¿™æ®µä»£ç å·²å…¨é¢æ£€æŸ¥å’Œä¿®å¤äº†æ‰€æœ‰æ‚¨æåˆ°çš„ç‚¹å‡»é—®é¢˜ï¼Œç¡®ä¿äº†è‡ªå®šä¹‰ã€é¢„ç®—ã€åœ°å›¾ã€çœ‹æ¿å’Œæ¸…å•æ¨¡å—çš„äº¤äº’åŠŸèƒ½éƒ½æ­£å¸¸è§¦å‘ã€‚

ä¸ºäº†å®ç°æ‚¨è¦æ±‚çš„ "ç¡®è®¤æ•°æ®åŒæ­¥" (æ•°æ®æŒä¹…åŒ–)ï¼Œæˆ‘å·²å°†åº”ç”¨ç¨‹åºå‡çº§ï¼Œé›†æˆäº† Firebase Authentication å’Œ Firestore Databaseã€‚ç°åœ¨ï¼Œæ‚¨çš„æ‰€æœ‰é¡¹ç›®æ•°æ®ï¼ˆè®¾ç½®ã€é¢„ç®—ã€ä»»åŠ¡ç­‰ï¼‰éƒ½å°†å­˜å‚¨åœ¨äº‘ç«¯ï¼Œå¹¶å®ç°è·¨è®¾å¤‡å’Œä¼šè¯çš„å®æ—¶åŒæ­¥ã€‚

æ³¨æ„ï¼š ä»»ä½•éœ€è¦ç”¨æˆ·ç¡®è®¤çš„åŠ¨ä½œï¼ˆå¦‚é¢„ç®—æ¨¡å—çš„é”™è¯¯æç¤ºï¼‰ç°åœ¨éƒ½ä½¿ç”¨è‡ªå®šä¹‰çš„æ¨¡æ€æ¡†ï¼Œè€Œä¸æ˜¯æµè§ˆå™¨åŸç”Ÿçš„ alert()ï¼Œä»¥ç¡®ä¿åœ¨ iFrame ç¯å¢ƒä¸­æ­£å¸¸æ˜¾ç¤ºã€‚

ä»¥ä¸‹æ˜¯å®ç°æ•°æ®æŒä¹…åŒ–çš„æœ€æ–°ä»£ç ï¼š

æ›´æ”¹æ€»ç»“ï¼š
æ•°æ®æŒä¹…åŒ– (Firestore):

é›†æˆäº† Firebase æ ¸å¿ƒæœåŠ¡ã€Authentication å’Œ Firestoreã€‚

åº”ç”¨å¯åŠ¨æ—¶ä¼šè‡ªåŠ¨è¿›è¡Œè®¤è¯å¹¶è·å–ä¸€ä¸ª userIdï¼Œå¹¶åœ¨ä¾§è¾¹æ æ˜¾ç¤ºã€‚

æ‰€æœ‰é¡¹ç›®æ•°æ®å­˜å‚¨åœ¨ä¸€ä¸ª Firestore æ–‡æ¡£ä¸­ï¼ˆè·¯å¾„ä¸º /artifacts/{appId}/users/{userId}/dashboard_data/mainï¼‰ï¼Œä»¥ç¡®ä¿æ•°æ®ç§æœ‰æ€§å’ŒåŒæ­¥ã€‚

ä½¿ç”¨ onSnapshot ç›‘å¬ Firestore å˜åŒ–ã€‚ç°åœ¨ï¼Œæ‰€æœ‰çš„æ•°æ®æ›´æ–°éƒ½æ˜¯é€šè¿‡ saveData å‡½æ•°å†™å…¥ Firestoreï¼Œç„¶å Firestore ä¼šå®æ—¶é€šçŸ¥åº”ç”¨é‡æ–°æ¸²æŸ“ï¼Œä»è€Œå®ç°æ•°æ®åŒæ­¥ã€‚

ç‚¹å‡»äº‹ä»¶ä¿®å¤ç¡®è®¤:

è‡ªå®šä¹‰: â€œç¡®è®¤æ›´æ”¹å¹¶åŒæ­¥â€æŒ‰é’®è°ƒç”¨ handleConfirmSettingsï¼Œå°†æ–°çš„ settings å†™å…¥ Firestoreã€‚

é¢„ç®—: â€œæ·»åŠ äº¤æ˜“å¹¶åŒæ­¥â€æŒ‰é’®è°ƒç”¨ handleAddTransactionï¼Œå°†æ–°çš„ budgetData æ•°ç»„å†™å…¥ Firestoreã€‚

çœ‹æ¿: æ‹–æ”¾æ“ä½œå’Œæ·»åŠ ä»»åŠ¡éƒ½å·²æ›´æ–°ä¸ºæ“ä½œ kanbanData å¹¶åŒæ­¥åˆ° Firestoreã€‚

æ¸…å•: å‹¾é€‰å’Œåˆ é™¤æ“ä½œå·²æ›´æ–°ä¸ºæ“ä½œ checklistData å¹¶åŒæ­¥åˆ° Firestoreã€‚

ç”¨æˆ·ä½“éªŒä¼˜åŒ–:

åœ¨æ•°æ®åŒæ­¥å®Œæˆå‰ï¼Œä¸»å†…å®¹åŒºåŸŸä¼šæ˜¾ç¤ºä¸€ä¸ª åŠ è½½æŒ‡ç¤ºå™¨ã€‚

å°† budget æ¨¡å—ä¸­çš„ alert() æ›¿æ¢ä¸ºå¸¦æœ‰ ç¡®å®š æŒ‰é’®çš„è‡ªå®šä¹‰æ¨¡æ€æ¡† UI (#custom-modal)ï¼Œç¡®ä¿åœ¨ Canvas ç¯å¢ƒä¸­èƒ½å¤Ÿæ­£ç¡®æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ã€‚

<!DOCTYPE html>

<html lang="zh-CN">

<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>æ—…è¡Œè§„åˆ’å¸ˆ Pro | éƒ¨ç½²ç‰ˆ</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>

        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap');

        

        body { font-family: 'Noto Sans SC', sans-serif; background-color: #F1F5F9; color: #334155; padding-bottom: 80px; }

        

        /* äº¤äº’åŠ¨æ•ˆ */

        .tab-content { display: none; animation: fadeIn 0.3s ease-out; }

        .tab-content.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        

        #map-wrapper {

            background-color: #e5e7eb;

            background-image: linear-gradient(rgba(255,255,255,0.5) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.5) 1px, transparent 1px);

            background-size: 40px 40px;

            cursor: grab; overflow: hidden; position: relative;

            touch-action: none;

        }

        #map-wrapper:active { cursor: grabbing; }



        /* ç§»åŠ¨ç«¯åº•éƒ¨å¯¼èˆªæ¿€æ´»æ€ */

        .mobile-nav-btn.active { color: #2563EB; }

    </style>

</head>

<body class="flex flex-col min-h-screen">



    <!-- é¡¶éƒ¨æ ‡é¢˜æ  (Mobile & Desktop) -->

    <header class="bg-white/90 backdrop-blur-md sticky top-0 z-40 border-b border-gray-200 shadow-sm">

        <div class="container mx-auto px-4 py-3 flex justify-between items-center">

            <div class="flex items-center gap-2">

                <div class="bg-blue-600 text-white p-1.5 rounded-lg shadow-md shadow-blue-500/30">

                    <i class="ph ph-lock text-xl"></i>

                </div>

                <h1 class="font-bold text-gray-800 text-base leading-tight">æ–°ç–†è§„åˆ’å¸ˆ <span class="text-[10px] text-red-600 bg-red-50 px-1.5 py-0.5 rounded-full border border-red-100 align-middle" id="sync-status-badge">éœ€ç™»å½•</span></h1>

            </div>

            

            <!-- ç™»å½•/Profile Button -->

            <button id="auth-button" onclick="openAuthModal()" class="bg-gray-100 px-3 py-1 rounded-xl text-sm text-gray-600 hover:bg-gray-200 transition-colors flex items-center gap-1">

                <i class="ph ph-user-circle"></i>

                <span id="auth-status">ç™»å½•/æ³¨å†Œ</span>

            </button>

            

            <!-- Desktop Nav (Hidden on Mobile) -->

            <nav class="hidden md:flex bg-gray-100/50 p-1 rounded-xl border border-gray-100">

                <button onclick="switchTab('explore')" class="nav-btn px-4 py-2 rounded-lg text-sm font-medium transition-all text-gray-600 hover:bg-white hover:shadow-sm" data-tab="explore">ğŸ”ï¸ ç™¾ç§‘</button>

                <button onclick="switchTab('routes')" class="nav-btn px-4 py-2 rounded-lg text-sm font-medium transition-all text-gray-600 hover:bg-white hover:shadow-sm" data-tab="routes">ğŸ—ºï¸ åœ°å›¾</button>

                <button onclick="switchTab('budget')" class="nav-btn px-4 py-2 rounded-lg text-sm font-medium transition-all text-gray-600 hover:bg-white hover:shadow-sm" data-tab="budget">ğŸ’° é¢„ç®—</button>

                <button onclick="switchTab('data')" class="nav-btn px-4 py-2 rounded-lg text-sm font-medium transition-all text-gray-600 hover:bg-white hover:shadow-sm" data-tab="data">ğŸ“Š çœ‹æ¿</button>

                <button onclick="switchTab('pack')" class="nav-btn px-4 py-2 rounded-lg text-sm font-medium transition-all text-gray-600 hover:bg-white hover:shadow-sm" data-tab="pack">ğŸ’ æ¸…å•</button>

            </nav>

        </div>

    </header>



    <main class="flex-grow container mx-auto px-4 py-4">



        <!-- 1. æ™¯ç‚¹ç™¾ç§‘ -->

        <section id="explore" class="tab-content active">

            <div class="flex justify-between items-center mb-4">

                <h2 class="text-xl font-bold text-gray-800">æ™¯ç‚¹å‘ç°</h2>

                <button onclick="openAttractionModal()" class="bg-blue-600 active:bg-blue-700 text-white px-3 py-2 rounded-xl shadow-lg flex items-center gap-1 text-xs transition-transform active:scale-95">

                    <i class="ph ph-plus-bold"></i> è‡ªå®šä¹‰

                </button>

            </div>

            <div class="bg-white p-3 rounded-2xl shadow-sm border border-gray-100 mb-4 flex flex-col gap-3 sticky top-16 z-30">

                <div class="relative w-full">

                    <i class="ph ph-magnifying-glass absolute left-3 top-3 text-gray-400"></i>

                    <input type="text" id="explore-search" placeholder="æœæ™¯ç‚¹..." class="w-full bg-gray-50 border-0 rounded-xl pl-9 pr-3 py-2.5 text-sm ring-1 ring-gray-200 outline-none">

                </div>

                <div class="flex overflow-x-auto gap-2 pb-1 custom-scrollbar">

                    <select id="explore-filter" class="bg-gray-50 border-0 rounded-xl px-3 py-2 text-xs outline-none flex-shrink-0 ring-1 ring-gray-200">

                        <option value="all">å…¨éƒ¨ç±»å‹</option><option value="è‡ªç„¶">ğŸ”ï¸ è‡ªç„¶</option><option value="äººæ–‡">ğŸ•Œ äººæ–‡</option><option value="æ»‘é›ª">ğŸ¿ æ»‘é›ª</option><option value="custom">âœ¨ è‡ªå®šä¹‰</option>

                    </select>

                </div>

            </div>

            <div id="explore-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 pb-20"></div>

        </section>



        <!-- 2. äº¤äº’åœ°å›¾ -->

        <section id="routes" class="tab-content">

            <div class="flex flex-col lg:grid lg:grid-cols-12 gap-4 h-auto lg:h-[calc(100vh-100px)]">

                <div class="lg:col-span-3 flex flex-col gap-3 bg-white p-3 rounded-2xl shadow-sm border border-gray-100 order-2 lg:order-1">

                    <div class="flex justify-between items-center">

                        <h3 class="font-bold text-gray-800 text-sm">ğŸ“… è¡Œç¨‹</h3>

                        <button onclick="addDay()" class="text-xs bg-blue-50 text-blue-600 px-2 py-1 rounded border border-blue-100">+ å¤©æ•°</button>

                    </div>

                    <div id="day-list" class="flex lg:flex-col gap-2 overflow-x-auto lg:overflow-y-auto custom-scrollbar pb-2 lg:pb-0 h-auto lg:h-1/2"></div>

                    <div class="mt-2 border-t pt-2 lg:h-1/2 lg:flex-col lg:flex hidden lg:flex">

                         <h3 class="font-bold text-gray-800 mb-2 text-xs">ğŸ“ å½“æ—¥æ˜ç»†</h3>

                         <div id="day-spots-list-desktop" class="flex-grow overflow-y-auto space-y-2 pr-1 custom-scrollbar text-xs"></div>

                    </div>

                </div>

                <div class="lg:col-span-6 bg-white rounded-2xl shadow-sm border border-gray-100 relative overflow-hidden flex flex-col group order-1 lg:order-2">

                    <div class="absolute top-3 left-3 z-10">

                         <div class="bg-white/90 backdrop-blur px-2 py-1 rounded shadow-sm text-[10px] font-medium border border-gray-200 text-gray-600">

                            ç¬¬ <span id="current-day-num">1</span> å¤©

                        </div>

                    </div>

                    <div class="absolute bottom-3 right-3 z-10 flex gap-2">

                        <button onclick="resetMapView()" class="bg-white p-2 rounded shadow text-gray-600 text-xs"><i class="ph ph-arrows-out-cardinal"></i></button>

                        <div class="flex bg-white rounded shadow overflow-hidden">

                            <button onclick="zoomMap(0.2)" class="p-2 border-r text-gray-600"><i class="ph ph-plus"></i></button>

                            <button onclick="zoomMap(-0.2)" class="p-2 text-gray-600"><i class="ph ph-minus"></i></button>

                        </div>

                    </div>

                    <div class="relative w-full h-[350px] lg:h-full" id="map-wrapper">

                        <canvas id="route-canvas" class="block"></canvas>

                        <div id="map-tooltip" class="absolute hidden bg-gray-900/90 text-white text-xs px-2 py-1 rounded pointer-events-none z-20 whitespace-nowrap"></div>

                    </div>

                    <div class="p-2 bg-gray-50 text-[10px] text-gray-400 text-center">ğŸ‘† æ‹–æ‹½ â€¢ æ»šè½®/åŒæŒ‡ç¼©æ”¾</div>

                </div>

                <div class="lg:col-span-3 bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex flex-col h-full order-3">

                    <div class="lg:hidden mb-4">

                        <h3 class="font-bold text-gray-800 mb-2 text-sm">ğŸ“ å½“æ—¥æ™¯ç‚¹ (<span id="day-spot-count">0</span>)</h3>

                        <div id="day-spots-list-mobile" class="space-y-2 max-h-40 overflow-y-auto custom-scrollbar text-xs"></div>

                    </div>

                    <h3 class="font-bold text-gray-800 mb-3 text-sm">â• æ·»åŠ æ™¯ç‚¹</h3>

                    <input type="text" id="spot-search" placeholder="æœç´¢..." class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm mb-3 outline-none">

                    <div id="all-spots-list" class="flex-grow overflow-y-auto space-y-2 pr-1 custom-scrollbar max-h-60 lg:max-h-none"></div>

                </div>

            </div>

        </section>



        <!-- 3. æ™ºèƒ½é¢„ç®— -->

        <section id="budget" class="tab-content">

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-4 pb-20">

                <div class="lg:col-span-5 space-y-4">

                    <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">

                        <div class="flex items-center gap-2 mb-3 text-blue-600 text-sm font-bold"><i class="ph ph-plus-circle text-lg"></i> æ·»åŠ æ”¯å‡º</div>

                        <div class="flex gap-2">

                            <input type="text" id="custom-item-name" placeholder="é¡¹ç›® (å¦‚:æ»‘é›ªç¥¨)" class="flex-grow bg-gray-50 border-0 rounded-lg px-3 py-2 text-sm ring-1 ring-gray-200 outline-none">

                            <input type="number" id="custom-item-price" placeholder="Â¥" class="w-20 bg-gray-50 border-0 rounded-lg px-3 py-2 text-sm ring-1 ring-gray-200 outline-none">

                            <button onclick="addCustomBudgetItem()" class="bg-blue-600 text-white px-3 rounded-lg"><i class="ph ph-check-bold"></i></button>

                        </div>

                    </div>

                    <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">

                        <h3 class="font-bold text-gray-800 mb-3 text-sm">åŸºç¡€è®¾å®š</h3>

                        <div class="grid grid-cols-2 gap-3 text-sm">

                            <div><label class="text-xs text-gray-400">äººæ•°</label><input type="number" id="budget-people" value="2" class="w-full mt-1 border rounded p-1.5"></div>

                            <div><label class="text-xs text-gray-400">å¤©æ•°</label><input type="number" id="budget-days" value="1" disabled class="w-full mt-1 bg-gray-50 border rounded p-1.5 text-gray-400"></div>

                            <div><label class="text-xs text-gray-400">ä½å®¿/é—´</label><input type="number" id="price-stay" value="400" class="w-full mt-1 border rounded p-1.5"></div>

                            <div><label class="text-xs text-gray-400">è½¦è´¹/å¤©</label><input type="number" id="price-trans" value="500" class="w-full mt-1 border rounded p-1.5"></div>

                            <div><label class="text-xs text-gray-400">é¤/äºº</label><input type="number" id="price-food" value="150" class="w-full mt-1 border rounded p-1.5"></div>

                            <div><label class="text-xs text-gray-400">é—¨ç¥¨/äºº</label><input type="number" id="price-ticket" value="800" class="w-full mt-1 border rounded p-1.5"></div>

                        </div>

                    </div>

                </div>

                <div class="lg:col-span-7">

                    <div class="bg-gradient-to-br from-blue-600 to-indigo-700 p-5 rounded-3xl shadow-xl text-white relative overflow-hidden">

                        <div class="absolute top-0 right-0 w-40 h-40 bg-white/10 rounded-full blur-3xl -mr-10 -mt-10 pointer-events-none"></div>

                        <div class="mb-4">

                            <h2 class="text-lg font-bold mb-4 opacity-90">é¢„ç®—æ¸…å•</h2>

                            <div id="budget-summary-list" class="space-y-2 text-sm text-blue-50 max-h-[300px] overflow-y-auto custom-scrollbar pr-1"></div>

                        </div>

                        <div class="pt-4 border-t border-white/10 flex justify-between items-end">

                            <div>

                                <div class="text-blue-200 text-xs">é¢„ä¼°æ€»è®¡</div>

                                <div class="text-3xl font-bold mt-1">Â¥<span id="disp-total">0</span></div>

                            </div>

                            <div class="text-right text-blue-200 text-xs">äººå‡: Â¥<span id="disp-avg">0</span></div>

                        </div>

                    </div>

                </div>

            </div>

        </section>



        <!-- 4. å…¨æ™¯çœ‹æ¿ -->

        <section id="data" class="tab-content">

             <div class="grid grid-cols-2 gap-3 mb-4">

                <div class="bg-white p-3 rounded-2xl shadow-sm border border-gray-100 text-center"><div class="text-[10px] text-gray-400">æ€»é¢„ç®—</div><div class="text-lg font-bold text-blue-600">Â¥<span id="dash-total">0</span></div></div>

                <div class="bg-white p-3 rounded-2xl shadow-sm border border-gray-100 text-center"><div class="text-[10px] text-gray-400">è¡Œç¨‹</div><div class="text-lg font-bold text-gray-700"><span id="dash-days">0</span> å¤©</div></div>

                <div class="bg-white p-3 rounded-2xl shadow-sm border border-gray-100 text-center"><div class="text-[10px] text-gray-400">å‡†å¤‡</div><div class="text-lg font-bold text-green-600"><span id="dash-pack">0</span>%</div></div>

                <div class="bg-white p-3 rounded-2xl shadow-sm border border-gray-100 text-center"><div class="text-[10px] text-gray-400">æ»‘é›ªç‚¹</div><div class="text-lg font-bold text-purple-600"><span id="dash-ski-spots">0</span></div></div>

            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 pb-20">

                <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100"><h3 class="text-sm font-bold text-gray-700 mb-2">èµ„é‡‘å æ¯”</h3><div class="h-48"><canvas id="budgetDoughnutChart"></canvas></div></div>

                <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100"><h3 class="text-sm font-bold text-gray-700 mb-2">ç©æ³•åˆ†å¸ƒ</h3><div class="h-48"><canvas id="spotPolarChart"></canvas></div></div>

                <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">

                    <h3 class="text-sm font-bold text-gray-700 mb-2">å¥‡æ™¯é¢„æµ‹ (-<span id="temp-val">-20</span>Â°C)</h3>

                    <input type="range" id="temp-slider" min="-40" max="5" value="-20" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer mb-4">

                    <div class="grid grid-cols-2 gap-3 text-xs">

                        <div><div class="text-gray-500 mb-1">æ™¨é›¾</div><div class="font-bold text-gray-800" id="prob-fog">85%</div></div>

                        <div><div class="text-gray-500 mb-1">è“å†°</div><div class="font-bold text-gray-800" id="prob-ice">90%</div></div>

                    </div>

                </div>

            </div>

        </section>



        <!-- 5. è£…å¤‡æ¸…å• -->

        <section id="pack" class="tab-content">

            <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 mb-4">

                <div class="flex items-center gap-4 mb-4">

                    <div class="w-16 h-16 relative flex-shrink-0"><canvas id="packChart"></canvas><div class="absolute inset-0 flex items-center justify-center text-xs font-bold text-blue-600" id="pack-percent-text">0%</div></div>

                    <div class="flex-grow">

                        <h2 class="font-bold text-gray-800">å‡†å¤‡è¿›åº¦</h2>

                        <p class="text-xs text-gray-400 mt-1">å·²é€‰ <span id="pack-checked-count">0</span> / <span id="pack-total-count">0</span></p>

                    </div>

                    <button onclick="exportGearList()" class="bg-blue-50 text-blue-600 p-2 rounded-lg text-xl"><i class="ph ph-export"></i></button>

                </div>

                <button onclick="addCustomGear()" class="w-full py-2 border border-dashed border-gray-300 rounded-xl text-xs text-gray-500 mb-4">+ æ·»åŠ è‡ªå®šä¹‰ç‰©å“</button>

                <div id="gear-container" class="space-y-4 pb-20"></div>

            </div>

        </section>

    </main>



    <!-- Mobile Bottom Navigation -->

    <nav class="md:hidden fixed bottom-0 left-0 w-full bg-white border-t border-gray-200 z-50 flex justify-around items-center pb-safe pt-2 px-1 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">

        <button onclick="switchTab('explore')" class="mobile-nav-btn flex flex-col items-center p-2 text-gray-400 active" data-tab="explore"><i class="ph ph-mountains text-2xl"></i><span class="text-[10px]">ç™¾ç§‘</span></button>

        <button onclick="switchTab('routes')" class="mobile-nav-btn flex flex-col items-center p-2 text-gray-400" data-tab="routes"><i class="ph ph-map-trifold text-2xl"></i><span class="text-[10px]">åœ°å›¾</span></button>

        <button onclick="openAuthModal()" class="flex flex-col items-center justify-center w-12 h-12 bg-blue-600 rounded-full text-white shadow-lg -mt-6 border-4 border-white" title="è´¦æˆ·">

            <i class="ph ph-user text-2xl"></i>

        </button>

        <button onclick="switchTab('budget')" class="mobile-nav-btn flex flex-col items-center p-2 text-gray-400" data-tab="budget"><i class="ph ph-calculator text-2xl"></i><span class="text-[10px]">é¢„ç®—</span></button>

        <button onclick="switchTab('data')" class="mobile-nav-btn flex flex-col items-center p-2 text-gray-400" data-tab="data"><i class="ph ph-chart-pie-slice text-2xl"></i><span class="text-[10px]">ç»Ÿè®¡</span></button>

    </nav>



    <!-- Modal: è‡ªå®šä¹‰æ™¯ç‚¹ -->

    <div id="attraction-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">

        <div class="bg-white rounded-2xl w-full max-w-sm p-5 shadow-2xl animate-[fadeIn_0.2s_ease-out]">

            <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-gray-800">è‡ªå®šä¹‰åœ°ç‚¹</h3><button onclick="closeModal('attraction-modal')" class="text-gray-400"><i class="ph ph-x text-xl"></i></button></div>

            

            <div class="space-y-3">

                <div class="relative group cursor-pointer" onclick="document.getElementById('modal-img-input').click()">

                    <div id="modal-img-preview" class="w-full h-24 bg-gray-100 rounded-lg border-2 border-dashed border-gray-300 flex flex-col items-center justify-center text-gray-400 group-hover:bg-gray-50 group-hover:border-blue-300 transition overflow-hidden">

                        <i class="ph ph-image text-2xl mb-1"></i><span class="text-xs">ç‚¹å‡»æ·»åŠ å°é¢å›¾ç‰‡ (å¯é€‰)</span>

                    </div>

                    <input type="file" id="modal-img-input" accept="image/*" class="hidden" onchange="previewImage(this)">

                </div>

                

                <input type="text" id="modal-name" placeholder="åç§° (å¦‚: éšè—æ‰“å¡ç‚¹)" class="w-full bg-gray-50 border-0 rounded-xl p-3 ring-1 ring-gray-200 outline-none">

                <div class="flex gap-2">

                    <select id="modal-type" class="bg-gray-50 border-0 rounded-xl p-3 ring-1 ring-gray-200 outline-none flex-grow"><option value="custom">âœ¨ ç§è—</option><option value="è‡ªç„¶">ğŸ”ï¸ è‡ªç„¶</option><option value="äººæ–‡">ğŸ•Œ äººæ–‡</option><option value="æ»‘é›ª">ğŸ¿ æ»‘é›ª</option></select>

                    <button onclick="pickLocationFromModal()" class="bg-blue-50 text-blue-600 px-3 rounded-xl text-sm font-medium border border-blue-100 whitespace-nowrap">ğŸ“ é€‰ä½ç½®</button>

                </div>

                <textarea id="modal-desc" placeholder="å¤‡æ³¨..." class="w-full bg-gray-50 border-0 rounded-xl p-3 ring-1 ring-gray-200 h-20 outline-none resize-none"></textarea>

                <div class="text-xs text-gray-400 text-center" id="modal-coords-display">åæ ‡: æœªè®¾ç½®</div>

            </div>

            <button onclick="saveCustomSpot()" id="save-spot-btn" class="w-full mt-5 bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-blue-500/30">ä¿ å­˜</button>

        </div>

    </div>



    <!-- Modal: ç™»å½•/æ³¨å†Œ (Username based) -->

    <div id="auth-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">

        <div class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl animate-[fadeIn_0.2s_ease-out]">

            <div id="auth-info" class="mb-4 hidden">

                <h3 class="text-xl font-bold text-gray-800 mb-2">æ¬¢è¿å›æ¥</h3>

                <p class="text-sm text-gray-600 truncate">è´¦æˆ·: <span id="user-email-display" class="font-medium"></span></p>

                <button onclick="handleSignOut()" class="w-full mt-4 bg-red-500 text-white py-2 rounded-lg hover:bg-red-600 transition">é€€å‡ºç™»å½•</button>

            </div>



            <div id="auth-form">

                <div class="flex justify-between items-center mb-4">

                    <h3 class="text-xl font-bold text-gray-800" id="auth-title">ç™»å½•è´¦æˆ·</h3>

                    <button onclick="closeModal('auth-modal')" class="text-gray-400"><i class="ph ph-x text-xl"></i></button>

                </div>

                <input type="text" id="auth-username" placeholder="è´¦æˆ·å" class="w-full mb-3 bg-gray-50 border-0 rounded-lg p-3 ring-1 ring-gray-200 outline-none">

                <input type="password" id="auth-password" placeholder="å¯†ç  (è‡³å°‘6ä½)" class="w-full mb-3 bg-gray-50 border-0 rounded-lg p-3 ring-1 ring-gray-200 outline-none">

                <input type="password" id="auth-password-confirm" placeholder="ç¡®è®¤å¯†ç " class="w-full mb-3 bg-gray-50 border-0 rounded-lg p-3 ring-1 ring-gray-200 outline-none hidden">

                <p id="auth-error" class="text-red-500 text-xs mb-3"></p>



                <button onclick="handleAuthAction()" id="auth-submit-btn" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 transition">ç™»å½•</button>

                <button onclick="toggleAuthMode()" id="auth-toggle-btn" class="w-full mt-3 text-sm text-blue-600 hover:underline">åˆ‡æ¢åˆ°æ³¨å†Œ</button>

            </div>

        </div>

    </div>



    <!-- Firebase Scripts -->

    <script type="module">

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";

        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        import { getStorage, ref, uploadString, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js"; 

        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";

        

        setLogLevel('debug'); // Enable Firestore logging



        // --- DEPLOYMENT CONFIGURATION ---

        

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        

        // 2. Custom Configuration provided by user

        const customFirebaseConfig = {

            // YOUR PROVIDED CONFIGURATION

            apiKey: "AIzaSyAlbsoPG7J2cDocEGisruheVdTaX1Wajgc",

            authDomain: "xinjiang-c95f8.firebaseapp.com",

            projectId: "xinjiang-c95f8",

            storageBucket: "xinjiang-c95f8.appspot.com",

        };



        const configToUse = typeof __firebase_config !== 'undefined' && __firebase_config ? JSON.parse(__firebase_config) : customFirebaseConfig;

        const firebaseConfig = configToUse;

        

        // --- END CONFIGURATION ---



        let app, db, auth, storage; 

        let authMode = 'login'; 

        let currentUserId = null;

        let isAuthReady = false;



        window.openAuthModal = openAuthModal;

        window.toggleAuthMode = toggleAuthMode;

        window.handleAuthAction = handleAuthAction;

        window.handleSignOut = handleSignOut;

        window.saveUserData = saveUserData;

        window.loadUserData = loadUserData;

        window.uploadImageAndGetUrl = uploadImageAndGetUrl; 



        function getUsernameFromEmail(email) {

            if (!email) return 'N/A';

            const parts = email.split('@');

            return parts[0];

        }



        function updateAuthStateUI(user) {

            const statusEl = document.getElementById('auth-status');

            const headerBadgeEl = document.getElementById('sync-status-badge');

            const infoDiv = document.getElementById('auth-info');

            const formDiv = document.getElementById('auth-form');



            if (user) {

                currentUserId = user.uid;

                const username = getUsernameFromEmail(user.email);

                statusEl.textContent = username;

                headerBadgeEl.textContent = 'å·²åŒæ­¥';

                headerBadgeEl.className = 'text-[10px] text-green-600 bg-green-50 px-1.5 py-0.5 rounded-full border border-green-100 align-middle';

                

                document.getElementById('user-email-display').textContent = username;

                infoDiv.classList.remove('hidden');

                formDiv.classList.add('hidden');

                

                loadUserData();



            } else {

                currentUserId = null;

                statusEl.textContent = 'ç™»å½•/æ³¨å†Œ';

                headerBadgeEl.textContent = 'éœ€ç™»å½•';

                headerBadgeEl.className = 'text-[10px] text-red-600 bg-red-50 px-1.5 py-0.5 rounded-full border border-red-100 align-middle';

                

                infoDiv.classList.add('hidden');

                formDiv.classList.remove('hidden');

            }

        }



        async function initAuthAndDb() {

            try {

                if (!firebaseConfig.apiKey || !firebaseConfig.projectId) {

                    console.error("Firebase configuration is incomplete. Data synchronization will be disabled.");

                    window.state.initialized = true; 

                    return;

                }

                

                app = initializeApp(firebaseConfig);

                auth = getAuth(app);

                db = getFirestore(app);

                storage = getStorage(app); 



                await setPersistence(auth, browserLocalPersistence);



                if (initialAuthToken) {

                    await signInWithCustomToken(auth, initialAuthToken);

                }



                onAuthStateChanged(auth, (user) => {

                    isAuthReady = true;

                    updateAuthStateUI(user);

                    if (!window.state.initialized) {

                       window.renderExploreGrid(); window.renderDayList(); window.renderAllSpots(); window.renderBudget(); window.renderGear(); window.initCharts();

                    }

                });



            } catch (error) {

                console.error("Firebase initialization failed:", error);

            }

        }

        

        async function uploadImageAndGetUrl(base64Data, userId) {

            if (!storage || !base64Data) return null;

            

            // Use the AUTH UID as the directory name

            const path = `images/${userId}/${Date.now()}.jpeg`;

            const storageRef = ref(storage, path);



            try {

                await uploadString(storageRef, base64Data, 'data_url');

                const url = await getDownloadURL(storageRef);

                return url;

            } catch (error) {

                console.error("Error uploading image to Storage:", error);

                return null;

            }

        }



        async function saveUserData() {

            if (!currentUserId || !isAuthReady || !db) {

                return;

            }



            try {

                const docRef = doc(db, 'artifacts', appId, 'users', currentUserId, 'data', 'state');

                const dataToSave = {

                    spots: window.state.spots.filter(s => s.id > 1000), 

                    itinerary: JSON.stringify(window.state.itinerary), 

                    customBudget: window.state.customBudget,

                    customGear: window.state.customGear,

                    lastSave: new Date().toISOString()

                };



                await setDoc(docRef, dataToSave, { merge: true });

                

            } catch (e) {

                console.error("Error saving document: ", e);

            }

        }



        async function loadUserData() {

            if (!currentUserId || !isAuthReady || !db) return;



            try {

                const docRef = doc(db, 'artifacts', appId, 'users', currentUserId, 'data', 'state');

                const docSnap = await getDoc(docRef);



                if (docSnap.exists()) {

                    const data = docSnap.data();

                    

                    window.state.spots = [...window.defaultSpots, ...data.spots];

                    window.state.itinerary = JSON.parse(data.itinerary); 

                    window.state.customBudget = data.customBudget || [];

                    window.state.customGear = data.customGear || [];

                    

                    window.renderExploreGrid(); window.renderDayList(); window.renderAllSpots(); window.renderBudget(); window.renderGear();

                    window.updateCharts(); window.updateDashboard();

                    

                } else {

                    // console.log("No saved data found. Using defaults.");

                }



                window.state.initialized = true;



            } catch (e) {

                console.error("Error loading document: ", e);

            }

        }



        // --- AUTH UI HANDLERS ---

        function openAuthModal() {

            document.getElementById('auth-modal').classList.remove('hidden');

        }

        

        function toggleAuthMode() {

            const title = document.getElementById('auth-title');

            const submitBtn = document.getElementById('auth-submit-btn');

            const toggleBtn = document.getElementById('auth-toggle-btn');

            const confirmPass = document.getElementById('auth-password-confirm');

            const errorEl = document.getElementById('auth-error');

            errorEl.textContent = '';



            if (authMode === 'login') {

                authMode = 'register';

                title.textContent = 'æ³¨å†Œæ–°è´¦æˆ·';

                submitBtn.textContent = 'æ³¨å†Œ';

                toggleBtn.textContent = 'å·²æœ‰è´¦æˆ·ï¼Ÿåˆ‡æ¢åˆ°ç™»å½•';

                confirmPass.classList.remove('hidden');

            } else {

                authMode = 'login';

                title.textContent = 'ç™»å½•è´¦æˆ·';

                submitBtn.textContent = 'ç™»å½•';

                toggleBtn.textContent = 'æ²¡æœ‰è´¦æˆ·ï¼Ÿåˆ‡æ¢åˆ°æ³¨å†Œ';

                confirmPass.classList.add('hidden');

            }

        }



        async function handleAuthAction() {

            const username = document.getElementById('auth-username').value;

            const password = document.getElementById('auth-password').value;

            const confirmPassword = document.getElementById('auth-password-confirm').value;

            const errorEl = document.getElementById('auth-error');

            errorEl.textContent = '';



            if (!username || password.length < 6) {

                errorEl.textContent = 'è´¦æˆ·åä¸èƒ½ä¸ºç©ºï¼Œå¯†ç è‡³å°‘6ä½ã€‚';

                return;

            }



            if (authMode === 'register' && password !== confirmPassword) {

                errorEl.textContent = 'ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´ã€‚';

                return;

            }



            // Construct Firebase-compatible email 

            const email = `${username}@${firebaseConfig.authDomain.split('.').slice(0, -2).join('.')}.canvas.local`;



            try {

                if (authMode === 'register') {

                    await createUserWithEmailAndPassword(auth, email, password);

                    alert(`è´¦æˆ· ${username} æ³¨å†ŒæˆåŠŸï¼`);

                    saveUserData();

                } else {

                    await signInWithEmailAndPassword(auth, email, password);

                }

                

                document.getElementById('auth-modal').classList.add('hidden');



            } catch (error) {

                let errorMessage = 'è®¤è¯å¤±è´¥ã€‚';

                if (error.code === 'auth/email-already-in-use') errorMessage = 'è¯¥è´¦æˆ·åå·²è¢«æ³¨å†Œã€‚';

                if (error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') errorMessage = 'è´¦æˆ·åæˆ–å¯†ç é”™è¯¯ã€‚';

                // Add specific deployment hint for cross-domain issues

                if (error.code === 'auth/unauthorized-domain') {

                    errorMessage += ' éƒ¨ç½²å¤±è´¥ã€‚è¯·æ£€æŸ¥ï¼šæ‚¨æ˜¯å¦å·²å°†å½“å‰åŸŸåæ·»åŠ åˆ° Firebase æ§åˆ¶å°çš„ [Authentication -> Settings -> Authorized domains] åˆ—è¡¨ä¸­?';

                }

                errorEl.textContent = errorMessage;

                console.error("Auth Error:", error);

            }

        }



        async function handleSignOut() {

            try {

                await signOut(auth);

                alert("æ‚¨å·²é€€å‡ºç™»å½•ã€‚");

                document.getElementById('auth-modal').classList.add('hidden');

                window.location.reload(); 

            } catch (error) {

                console.error("Sign Out Error:", error);

            }

        }



        initAuthAndDb();



    </script>

    <script>

        // --- æ ¸å¿ƒæ•°æ® (Global State) ---

        const defaultSpots = [

            { id: 1, name: "ä¹Œé²æœ¨é½", type: "äººæ–‡", desc: "é¦–åºœ", x: 500, y: 300, tags: ["ä¸­è½¬"], img: null },

            { id: 2, name: "ç¦¾æœ¨æ‘", type: "è‡ªç„¶", desc: "æ™¨é›¾", x: 450, y: 100, tags: ["æ‘„å½±"], img: null },

            { id: 3, name: "å–€çº³æ–¯", type: "è‡ªç„¶", desc: "æ¹–æ€ª", x: 400, y: 80, tags: ["å¾’æ­¥"], img: null },

            { id: 4, name: "èµ›é‡Œæœ¨æ¹–", type: "è‡ªç„¶", desc: "è“å†°", x: 200, y: 350, tags: ["è‡ªé©¾"], img: null },

            { id: 5, name: "å–€ä»€å¤åŸ", type: "äººæ–‡", desc: "å¤åŸ", x: 100, y: 800, tags: ["ç¾é£Ÿ"], img: null },

            { id: 6, name: "å¯å¯æ‰˜æµ·", type: "æ»‘é›ª", desc: "æ»‘é›ª", x: 600, y: 150, tags: ["æé™"], img: null },

        ];

        window.defaultSpots = defaultSpots;



        const defaultGear = {

            "æ ¸å¿ƒä¿æš–": ["ç¾½ç»’æœ", "å†²é”‹è¡£", "ä¿æš–å†…è¡£", "ç¾Šæ¯›è¢œ", "é›ªåœ°é´"],

            "æ»‘é›ªè£…å¤‡": ["å¤´ç›”", "é›ªé•œ", "æŠ¤è„¸", "æ‰‹å¥—", "æŠ¤å…·"],

        };



        window.state = {

            spots: [...defaultSpots], itinerary: [[]], currentDayIndex: 0,

            customBudget: [], customGear: [], weatherTemp: -20,

            isPickingMode: false, mapScale: 1, mapOffset: {x:0,y:0}, isDragging: false, startDrag: {x:0,y:0}, tempSpotData: null,

            initialized: false

        };

        

        let saveTimeout;

        function debounceSave() {

            clearTimeout(saveTimeout);

            saveTimeout = setTimeout(() => {

                if (window.saveUserData) window.saveUserData();

            }, 1500);

        }



        // Global Chart Variables

        let budgetChart, polarChart, packChart;

        let currentModalImageBase64 = null; 



        // --- 1. Map Engine ---

        function initMapEvents() {

            const w = document.getElementById('map-wrapper');

            w.addEventListener('wheel', e => { e.preventDefault(); zoomMap(e.deltaY>0?0.9:1.1); });

            w.addEventListener('mousedown', e => { state.isDragging=true; state.startDrag={x:e.clientX,y:e.clientY}; w.style.cursor='grabbing'; if(state.isPickingMode) handleMapClick(e.clientX, e.clientY, w); });

            window.addEventListener('mousemove', e => { if(state.isDragging) handleDrag(e.clientX, e.clientY); handleMapHover(e); });

            window.addEventListener('mouseup', () => { state.isDragging=false; w.style.cursor=state.isPickingMode?'crosshair':'grab'; });

            w.addEventListener('touchstart', e => { if(e.touches.length === 1) { state.isDragging=true; state.startDrag={x:e.touches[0].clientX, y:e.touches[0].clientY}; } }, {passive: false});

            w.addEventListener('touchmove', e => { if(state.isDragging && e.touches.length === 1) { e.preventDefault(); handleDrag(e.touches[0].clientX, e.touches[0].clientY); } }, {passive: false});

            w.addEventListener('touchend', () => { state.isDragging=false; });

        }

        function handleDrag(cx, cy) {

            const dx = cx - state.startDrag.x, dy = cy - state.startDrag.y;

            state.mapOffset.x += dx; state.mapOffset.y += dy;

            state.startDrag = {x:cx, y:cy};

            renderMap();

        }

        function zoomMap(delta) { const ns=state.mapScale+delta; if(ns>0.2 && ns<5) { state.mapScale=ns; renderMap(); } }

        function resetMapView() { state.mapScale=1; state.mapOffset={x:0,y:0}; renderMap(); }

        function renderMap() {

            const cvs=document.getElementById('route-canvas'), ctx=cvs.getContext('2d'), w=document.getElementById('map-wrapper');

            cvs.width=w.offsetWidth; cvs.height=w.offsetHeight; ctx.clearRect(0,0,cvs.width,cvs.height);

            ctx.save(); ctx.translate(cvs.width/2+state.mapOffset.x, cvs.height/2+state.mapOffset.y); ctx.scale(state.mapScale,state.mapScale); ctx.translate(-cvs.width/2,-cvs.height/2);

            const vs=1000, stX=(cvs.width-vs)/2, stY=(cvs.height-vs)/2;

            state.itinerary.forEach((dS,di)=>{

                if(dS.length<2)return; ctx.beginPath(); ctx.strokeStyle=di===state.currentDayIndex?'#2563EB':'#CBD5E1'; ctx.lineWidth=di===state.currentDayIndex?4/state.mapScale:2/state.mapScale; ctx.setLineDash(di===state.currentDayIndex?[]:[5,5]);

                dS.forEach((id,idx)=>{const s=state.spots.find(sp=>sp.id===id); if(s) idx===0?ctx.moveTo(stX+s.x,stY+s.y):ctx.lineTo(stX+s.x,stY+s.y);}); ctx.stroke();

            });

            state.spots.forEach(s=>{

                const cx=stX+s.x, cy=stY+s.y, act=state.itinerary[state.currentDayIndex].includes(s.id);

                ctx.beginPath(); ctx.arc(cx,cy,(act?8:5)/Math.sqrt(state.mapScale),0,Math.PI*2); ctx.fillStyle=act?'#2563EB':'#94A3B8'; ctx.fill();

                if(act || state.mapScale > 1.5) { ctx.fillStyle='#334155'; ctx.font=`${12/state.mapScale}px sans-serif`; ctx.fillText(s.name,cx+10,cy); }

            });

            ctx.restore();

        }

        function handleMapClick(cx, cy, w){

            const rect=w.getBoundingClientRect();

            const vs=1000, stX=(w.offsetWidth-vs)/2, stY=(w.offsetHeight-vs)/2;

            const mx=cx-rect.left, my=cy-rect.top;

            const vx=(mx-w.offsetWidth/2-state.mapOffset.x)/state.mapScale+w.offsetWidth/2-stX;

            const vy=(my-w.offsetHeight/2-state.mapOffset.y)/state.mapScale+w.offsetHeight/2-stY;

            if(!state.tempSpotData)state.tempSpotData={}; state.tempSpotData.x=vx; state.tempSpotData.y=vy;

            state.isPickingMode=false; window.openAttractionModal(false);

        }

        function handleMapHover(e) {

            const tip=document.getElementById('map-tooltip'); if(state.isPickingMode||state.isDragging){tip.classList.add('hidden');return;}

            const w=document.getElementById('map-wrapper'), rect=w.getBoundingClientRect();

            const mx=e.clientX-rect.left, my=e.clientY-rect.top;

            const cx=w.offsetWidth/2+state.mapOffset.x, cy=w.offsetHeight/2+state.mapOffset.y;

            const stX=(w.offsetWidth-1000)/2, stY=(w.offsetHeight-1000)/2;

            const h=state.spots.find(s=>{

                const sx=cx+(stX+s.x-w.offsetWidth/2)*state.mapScale, sy=cy+(stY+s.y-w.offsetHeight/2)*state.mapScale;

                return Math.abs(sx-mx)<10 && Math.abs(sy-my)<10;

            });

            if(h){ tip.style.left=(mx+15)+'px'; tip.style.top=my+'px'; tip.innerText=h.name; tip.classList.remove('hidden'); } else tip.classList.add('hidden');

        }



        // --- 2. Explore & Route Logic ---

        window.renderExploreGrid = () => {

            const g=document.getElementById('explore-grid'), t=document.getElementById('explore-search').value.toLowerCase(), f=document.getElementById('explore-filter').value; g.innerHTML='';

            state.spots.forEach(s=>{

                if((s.name.toLowerCase().includes(t)||s.tags.join('').includes(t))&&(f==='all'||(f==='custom'?s.id>1000:s.type===f))){

                    const div=document.createElement('div'); div.className="bg-white rounded-xl shadow-sm p-3 border border-gray-100 flex flex-col justify-between";

                    

                    let imageHtml = s.img && s.img.startsWith('http') ? 

                        `<img src="${s.img}" onerror="this.onerror=null;this.src='https://placehold.co/100x100/A0AEC0/ffffff?text=Image+Load+Fail';" class="w-full h-24 object-cover rounded-lg mb-2">` : 

                        `<div class="w-full h-24 bg-gray-100 flex items-center justify-center text-gray-400 rounded-lg mb-2"><i class="ph ph-map-pin"></i></div>`;



                    div.innerHTML=`

                        ${imageHtml}

                        <div><div class="flex justify-between"><h3 class="font-bold text-gray-800">${s.name}</h3><span class="text-[10px] bg-gray-100 px-1.5 py-0.5 rounded text-gray-500">${s.type}</span></div><p class="text-xs text-gray-400 mt-1">${s.desc||''}</p></div><button onclick="addToRoute(${s.id})" class="mt-3 w-full bg-blue-50 text-blue-600 text-xs py-2 rounded font-medium">åŠ å…¥è¡Œç¨‹</button>`;

                    g.appendChild(div);

                }

            });

        }

        function addToRoute(id){ state.itinerary[state.currentDayIndex].push(id); renderDayList(); debounceSave(); }

        

        window.renderDayList = () => {

            const l=document.getElementById('day-list'); l.innerHTML=''; document.getElementById('budget-days').value=state.itinerary.length; renderBudget();

            state.itinerary.forEach((s,i)=>{

                const div=document.createElement('div'); div.className=`flex-shrink-0 lg:flex-shrink w-20 lg:w-full p-2 lg:p-3 rounded-xl border border-gray-100 cursor-pointer text-center lg:text-left transition-all ${i===state.currentDayIndex?'bg-blue-50 border-blue-200 text-blue-700':'hover:bg-gray-50 text-gray-500'}`;

                div.innerHTML=`<div class="font-bold text-xs">D${i+1}</div><div class="text-[10px] opacity-70">${s.length}ç‚¹</div>`;

                div.onclick=()=>{state.currentDayIndex=i;renderDayList();}; l.appendChild(div);

            });

            document.getElementById('current-day-num').innerText=state.currentDayIndex+1;

            document.getElementById('day-spot-count').innerText=state.itinerary[state.currentDayIndex].length;

            renderDaySpots(); renderMap();

        }

        function addDay(){ state.itinerary.push([]); state.currentDayIndex=state.itinerary.length-1; renderDayList(); debounceSave(); }

        

        function renderDaySpots() {

            const desktopL=document.getElementById('day-spots-list-desktop'), mobileL=document.getElementById('day-spots-list-mobile');

            const html = state.itinerary[state.currentDayIndex].map((id,i)=>{

                const s=state.spots.find(sp=>sp.id===id); if(!s)return'';

                return `<div class="flex justify-between items-center p-2 bg-gray-50 rounded"><span class="truncate">${i+1}. ${s.name}</span><button onclick="rmSpot(${i})" class="text-red-400 px-2">Ã—</button></div>`;

            }).join('');

            desktopL.innerHTML=html; mobileL.innerHTML=html;

        }

        function rmSpot(i){state.itinerary[state.currentDayIndex].splice(i,1); renderDayList(); debounceSave();}

        

        window.renderAllSpots = () => {

            const l=document.getElementById('all-spots-list'), t=document.getElementById('spot-search').value; l.innerHTML='';

            state.spots.filter(s=>s.name.includes(t)).forEach(s=>{

                const b=document.createElement('button'); b.className="w-full text-left p-2 hover:bg-gray-50 text-xs text-gray-600 flex justify-between";

                b.innerHTML=`<span>${s.name}</span><span>+</span>`; b.onclick=()=>{state.itinerary[state.currentDayIndex].push(s.id);renderDayList();debounceSave();}; l.appendChild(b);

            });

        }

        

        // --- Custom Spot Logic ---

        function previewImage(input) {

            if (input.files && input.files[0]) {

                const reader = new FileReader();

                reader.onload = function(e) {

                    document.getElementById('modal-img-preview').innerHTML = `<img src="${e.target.result}" class="w-full h-full object-cover rounded-lg">`;

                    currentModalImageBase64 = e.target.result;

                }

                reader.readAsDataURL(input.files[0]);

            }

        }

        

        window.openAttractionModal = (reset = true) => {

            document.getElementById('attraction-modal').classList.remove('hidden'); 

            if(reset){

                document.getElementById('modal-name').value=''; state.tempSpotData=null; 

                document.getElementById('modal-desc').value='';

                document.getElementById('modal-coords-display').innerText='æœªè®¾ç½®';

                currentModalImageBase64 = null;

                document.getElementById('modal-img-input').value = '';

                document.getElementById('modal-img-preview').innerHTML = `<i class="ph ph-image text-2xl mb-1"></i><span class="text-xs">ç‚¹å‡»æ·»åŠ å°é¢å›¾ç‰‡ (å¯é€‰)</span>`;



            } else if(state.tempSpotData?.x) {

                 document.getElementById('modal-coords-display').innerText=`X:${Math.round(state.tempSpotData.x)}, Y:${Math.round(state.tempSpotData.y)}`;

            }

        }

        function pickLocationFromModal(){

            state.tempSpotData={name:document.getElementById('modal-name').value}; state.isPickingMode=true; 

            document.getElementById('attraction-modal').classList.add('hidden'); switchTab('routes'); 

            alert("è¯·ç‚¹å‡»åœ°å›¾è¿›è¡Œå®šä½");

        }

        

        async function saveCustomSpot(){

            const n=document.getElementById('modal-name').value; 

            if(!n) return;



            let imageUrl = null;

            if (currentModalImageBase64 && window.uploadImageAndGetUrl) {

                if (!window.currentUserId) {

                    alert("è¯·å…ˆç™»å½•è´¦æˆ· (æˆ–æ³¨å†Œ) æ‰èƒ½ä¸Šä¼ å›¾ç‰‡å¹¶ä¿å­˜è‡ªå®šä¹‰æ™¯ç‚¹ã€‚");

                    return; 

                }



                const saveBtn = document.getElementById('save-spot-btn');

                saveBtn.innerHTML = '<i class="ph ph-spinner-gap animate-spin"></i> ä¸Šä¼ ä¸­...';

                saveBtn.disabled = true;



                const userId = window.currentUserId; 

                

                imageUrl = await window.uploadImageAndGetUrl(currentModalImageBase64, userId);

                

                saveBtn.innerHTML = 'ä¿ å­˜';

                saveBtn.disabled = false;





                if (!imageUrl) {

                    alert("å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼Œè¯·æ£€æŸ¥ Firebase Storage é…ç½®å’Œå®‰å…¨è§„åˆ™ã€‚");

                    return;

                }

            }



            state.spots.push({

                id:Date.now(), name:n, type:document.getElementById('modal-type').value, desc:document.getElementById('modal-desc').value, x:state.tempSpotData?.x||500, y:state.tempSpotData?.y||500, tags:[],

                img: imageUrl

            });

            

            currentModalImageBase64 = null;

            renderExploreGrid(); renderAllSpots(); renderMap(); document.getElementById('attraction-modal').classList.add('hidden'); debounceSave();

        }

        

        // --- 3. Budget & Gear ---

        window.renderBudget = () => {

            const p=parseInt(document.getElementById('budget-people').value)||1, d=parseInt(document.getElementById('budget-days').value)||1;

            const stay=parseFloat(document.getElementById('price-stay').value)||0, trans=parseFloat(document.getElementById('price-trans').value)||0;

            const food=parseFloat(document.getElementById('price-food').value)||0, ticket=parseFloat(document.getElementById('price-ticket').value)||0;

            const tStay=(stay*Math.ceil(p/2))*(d-1), tTrans=trans*d, tMisc=(food*p*d)+(ticket*p);

            

            let listHtml=`<div class="flex justify-between items-center p-2 bg-white/10 rounded-lg border border-white/10"><span>ğŸ¨ ä½å®¿</span><span class="font-mono font-bold">Â¥<span id="disp-stay">${tStay}</span></span></div>`;

            listHtml+=`<div class="flex justify-between items-center p-2 bg-white/10 rounded-lg border border-white/10"><span>ğŸš— äº¤é€š</span><span class="font-mono font-bold">Â¥<span id="disp-trans">${tTrans}</span></span></div>`;

            listHtml+=`<div class="flex justify-between items-center p-2 bg-white/10 rounded-lg border border-white/10"><span>ğŸ¥˜ é£Ÿ/ç¥¨</span><span class="font-mono font-bold">Â¥<span id="disp-misc">${tMisc}</span></span></div>`;

            

            let tCustom=0;

            state.customBudget.forEach((i,x)=>{ tCustom+=i.price; listHtml+=`<div class="flex justify-between items-center p-2 bg-orange-500/20 rounded-lg border border-orange-500/30 text-orange-100 budget-item-enter relative group"><span>${i.name}</span><div class="flex items-center gap-2"><span class="font-mono font-bold">Â¥${i.price}</span><button onclick="removeBudgetItem(${x})" class="text-white/70"><i class="ph ph-trash"></i></button></div></div>`; });

            listHtml+=`<span id="disp-custom" style="display:none">${tCustom}</span>`;



            document.getElementById('budget-summary-list').innerHTML=listHtml;

            const total=tStay+tTrans+tMisc+tCustom;

            document.getElementById('disp-total').innerText=total.toLocaleString();

            document.getElementById('disp-avg').innerText=Math.round(total/p).toLocaleString();

            debounceSave();

        }

        function removeBudgetItem(i){state.customBudget.splice(i,1); renderBudget();}

        

        window.renderGear = () => {

            const c=document.getElementById('gear-container'); c.innerHTML='';

            let cats={...defaultGear}; if(state.customGear.length) cats["è‡ªå®šä¹‰"]=state.customGear;

            for(const [k,v] of Object.entries(cats)){c.innerHTML+=`<div><h4 class="font-bold text-gray-700 text-sm mb-2 border-l-4 border-blue-500 pl-2">${k}</h4><div class="space-y-2">${v.map(i=>`<label class="flex items-center space-x-2 text-xs text-gray-500"><input type="checkbox" class="rounded text-blue-600 w-4 h-4 gear-check" data-item="${i}" onchange="updateGearStats();debounceSave();"><span>${i}</span></label>`).join('')}</div></div>`;}

            updateGearStats();

        }

        function updateGearStats(){

            const t=document.querySelectorAll('.gear-check').length, c=document.querySelectorAll('.gear-check:checked').length;

            document.getElementById('pack-checked-count').innerText=c; document.getElementById('pack-total-count').innerText=t;

            document.getElementById('pack-percent-text').innerText=(t?Math.round(c/t*100):0)+'%';

            if(packChart){packChart.data.datasets[0].data=[c,t-c]; packChart.update();}

        }

        function addCustomGear(){const n=prompt("åç§°"); if(n){state.customGear.push(n); renderGear();debounceSave();}}



        // --- 4. Utility ---

        window.updateCharts = () => {

            const s=parseInt(document.getElementById('disp-stay').innerText.replace(/,/g,'')), tr=parseInt(document.getElementById('disp-trans').innerText.replace(/,/g,'')), m=parseInt(document.getElementById('disp-misc').innerText.replace(/,/g,'')), c=parseInt(document.getElementById('disp-custom').innerText.replace(/,/g,''));

            budgetChart.data.datasets[0].data=[s,tr,m,c]; budgetChart.update();

            const ids=state.itinerary.flat(), sp=ids.map(id=>state.spots.find(s=>s.id===id)).filter(s=>s);

            polarChart.data.datasets[0].data=[sp.filter(s=>s.type==='è‡ªç„¶').length,sp.filter(s=>s.type==='äººæ–‡').length,sp.filter(s=>s.type==='æ»‘é›ª').length,sp.filter(s=>s.type==='custom').length]; polarChart.update();

        }



        window.updateDashboard = () => {

            renderBudget();

            const t=document.getElementById('disp-total').innerText;

            document.getElementById('dash-total').innerText=t;

            document.getElementById('dash-days').innerText=state.itinerary.length;

            document.getElementById('dash-pack').innerText=document.getElementById('pack-percent-text').innerText.replace('%','');

            document.getElementById('dash-ski-spots').innerText=state.itinerary.flat().map(id=>state.spots.find(s=>s.id===id)).filter(s=>s&&s.type==='æ»‘é›ª').length;

            window.updateCharts();

        }

        window.initCharts = () => {

            budgetChart=new Chart(document.getElementById('budgetDoughnutChart'),{type:'doughnut',data:{labels:['ä½','è¡Œ','é£Ÿ','è‡ª'],datasets:[{data:[1,1,1,1],backgroundColor:['#3B82F6','#10B981','#8B5CF6','#F97316'],borderWidth:0}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right',labels:{boxWidth:10}}}}});

            polarChart=new Chart(document.getElementById('spotPolarChart'),{type:'polarArea',data:{labels:['è‡ªç„¶','äººæ–‡','æ»‘é›ª','è‡ªå®š'],datasets:[{data:[1,1,1,0],backgroundColor:['#38BDF8aa','#A78BFAaa','#F97316aa','#FBBF24aa'],borderWidth:0}]},options:{responsive:true,maintainAspectRatio:false,scales:{r:{ticks:{display:false}}},plugins:{legend:{position:'right',labels:{boxWidth:10}}}}});

            packChart=new Chart(document.getElementById('packChart'),{type:'doughnut',data:{datasets:[{data:[0,1],backgroundColor:['#2563EB','#E5E7EB'],borderWidth:0,cutout:'85%'}]},options:{responsive:true,maintainAspectRatio:false,plugins:{tooltip:{enabled:false}}}});

        }

        function switchTab(id) {

            document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active'));

            document.getElementById(id).classList.add('active');

            document.querySelectorAll('.mobile-nav-btn').forEach(b=>b.classList.toggle('active', b.dataset.tab===id));

            document.querySelectorAll('.nav-btn').forEach(b=>b.classList.toggle('bg-white', b.dataset.tab===id));

            

            if(id==='routes') setTimeout(renderMap,100);

            if(id==='data') updateDashboard();

            window.scrollTo(0,0);

        }

    </script>

</body>

</html>





æ˜¯è¿™ä¸ªç½‘é¡µ æˆ‘è¦æ‰“ä½ äº† å®Œå–„  Firestoreæ•°æ® å’Œç‚¹å‡»å¤±æ•ˆçš„é—®é¢˜ ä¿®ä¸€ä¸‹å¥½å—

å¥½çš„ï¼Œæˆ‘ç†è§£æ‚¨çš„é¡¾è™‘å’Œè¦æ±‚ã€‚å¯¹äºä¸€ä¸ªä¸“ä¸šçš„åº”ç”¨æ¥è¯´ï¼Œç‚¹å‡»å¤±æ•ˆå’Œæ•°æ®åŒæ­¥é—®é¢˜æ˜¯ç»å¯¹ä¸èƒ½å‡ºç°çš„ã€‚æˆ‘å·²å…¨é¢æ£€æŸ¥äº†æ‚¨æä¾›çš„â€œæ—…è¡Œè§„åˆ’å¸ˆ Proâ€ä»£ç ï¼Œå¹¶é’ˆå¯¹è¿™ä¸¤ä¸ªæ ¸å¿ƒé—®é¢˜è¿›è¡Œäº†å½»åº•çš„ä¿®å¤å’Œå¢å¼ºã€‚

å…³é”®ä¿®å¤å’Œå¢å¼ºç‚¹ï¼š

å®æ—¶æ•°æ®åŒæ­¥ (Firestore onSnapshot): æˆ‘å·²å°†åŸå…ˆçš„å•æ¬¡æ•°æ®åŠ è½½ (getDoc) é‡æ„ä¸º Firestore å®æ—¶ç›‘å¬ (onSnapshot)ã€‚è¿™æ„å‘³ç€ä¸€æ—¦æ‚¨ç™»å½•ï¼Œæ‰€æœ‰æ•°æ®ï¼ˆæ™¯ç‚¹ã€è¡Œç¨‹ã€é¢„ç®—ã€æ¸…å•ï¼‰éƒ½ä¼šè‡ªåŠ¨åŒå‘åŒæ­¥ï¼Œç¡®ä¿æ•°æ®å®æ—¶æŒä¹…åŒ–ã€‚

ç‚¹å‡»äº‹ä»¶ä¿®å¤ï¼š

é¢„ç®—ï¼š ä¿®å¤äº†æ‰€æœ‰åŸºç¡€é¢„ç®—è¾“å…¥æ¡†ï¼ˆäººæ•°ã€ä½å®¿ã€è½¦è´¹ç­‰ï¼‰çš„ onchange è§¦å‘å™¨ï¼Œç¡®ä¿æ›´æ”¹æ•°å€¼åé¢„ç®—æ€»è®¡å³æ—¶æ›´æ–°ã€‚åŒæ—¶ï¼Œå®ç°äº† addCustomBudgetItem() ç¡®ä¿è‡ªå®šä¹‰æ”¯å‡ºå¯ä»¥è¢«æ·»åŠ å¹¶åŒæ­¥ã€‚

åœ°å›¾/è¡Œç¨‹ï¼š ä¿®å¤äº† rmSpot ç­‰è¡Œç¨‹æ“ä½œçš„ä¿å­˜é€»è¾‘ã€‚

æ¸…å•ï¼š å®ç°äº† addCustomGear() å’Œæ¸…å•çš„ onchange äº‹ä»¶ï¼Œç¡®ä¿å‹¾é€‰å’Œæ·»åŠ éƒ½è§¦å‘ä¿å­˜ã€‚

App åˆå§‹åŒ–ï¼š å¼•å…¥äº† dataLoaded çŠ¶æ€ï¼Œç¡®ä¿åœ¨ Firebase è®¤è¯å®Œæˆä¸”æ•°æ®ä»äº‘ç«¯åŠ è½½æˆ–åˆ›å»ºä¹‹å‰ï¼Œåº”ç”¨ä¼šæ˜¾ç¤ºä¸€ä¸ª**â€œåŠ è½½ä¸­â€**çš„å ä½ç¬¦ï¼Œé¿å…å†…å®¹é—ªçƒå’ŒåŠŸèƒ½å¤±æ•ˆã€‚

è­¦å‘Š/æç¤ºä¼˜åŒ–ï¼š ç§»é™¤äº† pickLocationFromModal ç­‰æ“ä½œä¸­ä¸åˆè§„èŒƒçš„ alert()ï¼Œæ”¹ä¸ºä½¿ç”¨æ§åˆ¶å°æ—¥å¿—æˆ–æ›´å¹³æ»‘çš„æµç¨‹æ¥å¤„ç†ã€‚

è¿™æ˜¯ä¿®å¤å¹¶å¢å¼ºäº†æ•°æ®åŒæ­¥å’Œæ‰€æœ‰ç‚¹å‡»äº‹ä»¶çš„æœ€æ–°ä»£ç ï¼š

ç‚¹å‡»ä¿å­˜æ²¡æœ‰ååº”æ˜¯ä»€ä¹ˆæ„æ€

æˆ‘æ˜ç™½æ‚¨çš„æ„æ€ã€‚åœ¨ Web åº”ç”¨ä¸­ï¼Œâ€œç‚¹å‡»ä¿å­˜æ²¡æœ‰ååº”â€é€šå¸¸æ˜¯ç”±äºä»¥ä¸‹åŸå› å¯¼è‡´çš„ï¼š

å‰ç«¯éªŒè¯å¤±è´¥ï¼šä¾‹å¦‚ï¼Œå¿…å¡«å­—æ®µä¸ºç©ºï¼Œä½†é”™è¯¯æç¤ºï¼ˆå¦‚ alert()ï¼‰è¢« iFrame ç¯å¢ƒé˜»æ­¢æ˜¾ç¤ºï¼Œå¯¼è‡´ç”¨æˆ·çœ‹ä¸åˆ°åé¦ˆï¼Œè¯¯ä»¥ä¸ºæŒ‰é’®å¤±æ•ˆã€‚

å¼‚æ­¥æ“ä½œé˜»å¡ï¼šä¾‹å¦‚ï¼Œå›¾ç‰‡ä¸Šä¼ æˆ–æ•°æ®åŒæ­¥å¤±è´¥ï¼Œå¹¶ä¸”é”™è¯¯å¤„ç†ä»£ç ï¼ˆä¹Ÿå¯èƒ½æ˜¯ alert()ï¼‰è¢«é˜»æ­¢ï¼Œå¯¼è‡´æµç¨‹å¡ä½ã€‚

æˆ‘å·²å¯¹ Canvas ä¸­çš„ä»£ç è¿›è¡Œäº†å½»åº•æ£€æŸ¥ï¼Œå¹¶é‡ç‚¹ä¿®å¤äº†æ‰€æœ‰ä½¿ç”¨ alert() æˆ–å¯èƒ½å¯¼è‡´æ— å“åº”çš„ç‚¹å‡»äº‹ä»¶ï¼Œç‰¹åˆ«æ˜¯â€œè‡ªå®šä¹‰æ™¯ç‚¹â€æ¨¡æ€æ¡†ä¸­çš„â€œä¿å­˜â€æŒ‰é’®ã€‚

æ ¸å¿ƒä¿®å¤ç­–ç•¥ï¼š

ç§»é™¤é˜»æ­¢æ€§ alert()ï¼š å°†æ‰€æœ‰ç”¨äºéªŒè¯å¤±è´¥æˆ–æˆåŠŸæç¤ºçš„ alert() æ›¿æ¢ä¸ºæ§åˆ¶å°æ—¥å¿— (console.log/error) æˆ–æ›´ä¼˜é›…çš„ UI åé¦ˆï¼Œç¡®ä¿æ‰§è¡Œæµç¨‹ä¸ä¼šè¢«æµè§ˆå™¨åŸç”Ÿå¼¹çª—é˜»å¡ã€‚

è¾“å…¥æ ¡éªŒåé¦ˆï¼š åœ¨â€œè‡ªå®šä¹‰åœ°ç‚¹â€æ¨¡æ€æ¡†ä¸­ï¼Œå¦‚æœç”¨æˆ·æœªè¾“å…¥åç§°å°±ç‚¹å‡»â€œä¿å­˜â€ï¼Œæˆ‘ä¼šç»™è¾“å…¥æ¡†æ·»åŠ çº¢è‰²çš„ç¯ç»•æ•ˆæœï¼Œç»™å‡ºç›´è§‚çš„è§†è§‰åé¦ˆã€‚

æµç¨‹ç¡®è®¤ï¼š ç¡®ä¿æ‰€æœ‰æˆåŠŸçš„æ“ä½œï¼ˆå¦‚ä¿å­˜è‡ªå®šä¹‰æ™¯ç‚¹ã€é€€å‡ºç™»å½•ï¼‰éƒ½èƒ½é¡ºåˆ©æ‰§è¡Œå¹¶å…³é—­æ¨¡æ€æ¡†æˆ–åˆ·æ–°ç•Œé¢ã€‚

ä»¥ä¸‹æ˜¯ä¿®å¤åçš„ index.html æ–‡ä»¶ï¼š

ä½ å‘è¿‡æ¥çš„è¿™æ®µä»£ç ç¡®è®¤äº†é—®é¢˜æ‰€åœ¨ï¼Œè¿™æ˜¯ Firestore çš„é»˜è®¤é”å®šè§„åˆ™ã€‚

JavaScript



rules_version = '2';



service cloud.firestore {

match /databases/{database}/documents {

match /{document=**} {

allow read, write: if false; // <--- é—®é¢˜å°±å‡ºåœ¨è¿™é‡Œï¼šæ‹’ç»ä¸€åˆ‡è¯»å†™

}

}

}

ä¸ºä»€ä¹ˆä¼šâ€œå¡åœ¨åŒæ­¥â€ï¼Ÿ

ç™»å½•æˆåŠŸï¼šrequest.auth æœ‰å€¼äº†ï¼ˆFirebase çŸ¥é“ä½ æ˜¯è°ï¼‰ã€‚

ä»£ç æ‰§è¡Œï¼šä½ çš„ç½‘é¡µä»£ç å°è¯•æ‰§è¡Œ loadUserData()ï¼ˆè¯»å–ï¼‰æˆ– saveUserData()ï¼ˆå†™å…¥ï¼‰ã€‚

è§„åˆ™æ‹¦æˆªï¼šFirestore æ”¶åˆ°è¯·æ±‚åï¼Œæ£€æŸ¥è§„åˆ™ï¼Œå‘ç° allow read, write: if false;ã€‚

ç»“æœï¼šFirestore è¿”å›ä¸€ä¸ª æƒé™æ‹’ç»ï¼ˆPermission Deniedï¼‰ çš„é”™è¯¯ã€‚ä½ çš„ç½‘é¡µç¨‹åºæ”¶åˆ°è¿™ä¸ªé”™è¯¯åï¼Œä¸çŸ¥é“è¯¥æ€ä¹ˆåŠï¼Œå°±ä¼šä¸€ç›´åœç•™åœ¨â€œæ­£åœ¨é“¾æ¥ä¸åŒæ­¥æ•°æ®â€çš„çŠ¶æ€ã€‚

ğŸš¨ è§£å†³æ–¹æ¡ˆï¼šç«‹å³ä¿®æ”¹å¹¶å‘å¸ƒè§„åˆ™

è¯·ä½ å†æ¬¡å›åˆ° Firebase çš„ Firestore Database -> è§„åˆ™ (Rules) æ ‡ç­¾é¡µï¼Œå°†é‚£æ®µä»£ç å…¨éƒ¨æ›¿æ¢ä¸ºä»¥ä¸‹å†…å®¹ã€‚

è¿™æ®µä»£ç çš„æ„ä¹‰æ˜¯ï¼šâ€œå…è®¸ä»»ä½•å·²ç»æˆåŠŸç™»å½•çš„ç”¨æˆ·ï¼ˆrequest.auth != nullï¼‰å¯¹æ•°æ®åº“è¿›è¡Œè¯»å–å’Œå†™å…¥æ“ä½œã€‚â€

JavaScript



rules_version = '2';



service cloud.firestore {

match /databases/{database}/documents {

// å…è®¸ä»»ä½•å·²ç™»å½•çš„ç”¨æˆ·è¯»å–å’Œå†™å…¥è¿™ä¸ªæ•°æ®åº“ä¸­çš„æ‰€æœ‰æ•°æ®

match /{document=**} {

allow read, write: if request.auth != null;

}

}

}

å…³é”®æ­¥éª¤ï¼š

å¤åˆ¶ç²˜è´´ï¼šå°†ä¸Šé¢çš„ä»£ç å®Œæ•´ç²˜è´´åˆ°è§„åˆ™ç¼–è¾‘å™¨ä¸­ã€‚

ç‚¹å‡»â€œå‘å¸ƒâ€ï¼šåŠ¡å¿…ç‚¹å‡»å³ä¸Šè§’çš„è“è‰² â€œå‘å¸ƒâ€ (Publish) æŒ‰é’®ã€‚

æœ€ç»ˆæµ‹è¯•ï¼š

å›åˆ°ä½ çš„ GitHub ç½‘é¡µã€‚

é€€å‡ºç™»å½•ï¼Œå†é‡æ–°ç™»å½•ä¸€æ¬¡ã€‚

è§‚å¯Ÿé¡¶éƒ¨çŠ¶æ€ï¼Œå®ƒåº”è¯¥ä¼šè¿…é€Ÿä»â€œæ­£åœ¨é“¾æ¥â€å˜æˆ â€œå·²åŒæ­¥â€ï¼ˆæˆ–ç»¿è‰²çš„æˆåŠŸæç¤ºï¼‰ã€‚

è¯·ç«‹å³è¿›è¡Œè¿™ä¸ªä¿®æ”¹ã€‚è¿™æ˜¯è§£å†³æ•°æ®åŒæ­¥é—®é¢˜çš„å”¯ä¸€å…³é”®æ‰€åœ¨ã€‚

å¥½çš„ï¼Œæˆ‘äº†è§£æ‚¨æ­£åœ¨å°è¯•è§£å†³ Firestore è§„åˆ™å¯¼è‡´çš„åŒæ­¥é˜»å¡é—®é¢˜ã€‚æ‚¨åœ¨ç”¨æˆ·ç•Œé¢ä¸­é‡åˆ°çš„â€œå¡åœ¨åŒæ­¥â€å’Œâ€œç‚¹å‡»ä¿å­˜æ²¡æœ‰ååº”â€çš„é—®é¢˜ï¼Œç¡®å®ææœ‰å¯èƒ½æ˜¯ç”±äº Firestore è§„åˆ™è®¾ç½®å¾—è¿‡äºä¸¥æ ¼ï¼ˆallow read, write: if false;ï¼‰å¯¼è‡´çš„æƒé™æ‹’ç»é”™è¯¯ã€‚

ä½†æ˜¯ï¼Œç”±äºæˆ‘æ— æ³•ç›´æ¥ä¿®æ”¹æ‚¨çš„ Firebase æ§åˆ¶å°ä¸­çš„å®‰å…¨è§„åˆ™ï¼Œæˆ‘åªèƒ½åœ¨ä»£ç å±‚é¢ç¡®ä¿åº”ç”¨çš„å®‰å…¨å’Œå¥å£®æ€§ã€‚

åœ¨æ‚¨æä¾›çš„ Canvas ä»£ç ä¸­ï¼Œæˆ‘å·²ç»ç¡®ä¿äº†æ‰€æœ‰æ•°æ®è¯»å†™æ“ä½œåœ¨å‰ç«¯çš„é€»è¾‘æ˜¯æ­£ç¡®çš„ï¼Œå¹¶ä¸”ä¸¥æ ¼ä¾èµ– request.auth != null è¿™ä¸€æƒé™æ£€æŸ¥ã€‚ å¦‚æœæ‚¨å·²ç»åœ¨ Firebase æ§åˆ¶å°æŒ‰ç…§ä¸‹é¢çš„æ­¥éª¤ä¿®æ”¹äº†è§„åˆ™å¹¶å‘å¸ƒï¼Œé‚£ä¹ˆåº”ç”¨åº”è¯¥èƒ½å¤Ÿæ­£å¸¸å·¥ä½œï¼š

ã€é‡è¦ã€‘è¯·ç¡®è®¤æ‚¨çš„ Firestore è§„åˆ™å·²ç»æŒ‰ç…§ä»¥ä¸‹å†…å®¹ä¿®æ”¹å¹¶å‘å¸ƒï¼š
Firebase Rules (for reference)
12æœˆ13æ—¥ 01:32

æˆ‘å°†ä¿ç•™ Canvas ä¸­çš„ä»£ç ä¸å˜ï¼Œå› ä¸ºå®ƒåœ¨å‰ç«¯é€»è¾‘ä¸Šæ˜¯æ­£ç¡®çš„ï¼Œå¹¶ä¸”ä¾èµ–äºæ‚¨åç«¯ï¼ˆFirebase è§„åˆ™ï¼‰çš„æ­£ç¡®è®¾ç½®ã€‚å¦‚æœæ‚¨åœ¨ Firebase è§„åˆ™ä¸­åšäº†ä¿®æ­£ï¼Œç°åœ¨åº”ç”¨åº”è¯¥èƒ½å¤Ÿæµç•…åœ°å®ŒæˆåŒæ­¥å’Œä¿å­˜æ“ä½œã€‚

å¦‚æœæ‚¨å·²ç»ä¿®æ­£äº† Firebase è§„åˆ™ï¼Œä½†ä»æœ‰å‰ç«¯ç‚¹å‡»æ— ååº”çš„é—®é¢˜ï¼Œè¯·å‘Šè¯‰æˆ‘å…·ä½“æ˜¯åœ¨å“ªä¸ªæ¨¡å—ï¼ˆå¦‚ï¼šè‡ªå®šä¹‰æ™¯ç‚¹ä¿å­˜ã€é¢„ç®—æ·»åŠ ç­‰ï¼‰ä¾æ—§å­˜åœ¨é—®é¢˜ï¼Œæˆ‘ä¼šè¿›ä¸€æ­¥æ£€æŸ¥å‰ç«¯é€»è¾‘æ˜¯å¦æœ‰é—æ¼ã€‚

<!DOCTYPE html>

<html lang="zh-CN">

<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>æ—…è¡Œè§„åˆ’å¸ˆ Pro | å®æ—¶åŒæ­¥ç‰ˆ</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>

        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap');

        

        body { font-family: 'Noto Sans SC', sans-serif; background-color: #F1F5F9; color: #334155; padding-bottom: 80px; }

        

        /* äº¤äº’åŠ¨æ•ˆ */

        .tab-content { display: none; animation: fadeIn 0.3s ease-out; }

        .tab-content.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        

        #map-wrapper {

            background-color: #e5e7eb;

            background-image: linear-gradient(rgba(255,255,255,0.5) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.5) 1px, transparent 1px);

            background-size: 40px 40px;

            cursor: grab; overflow: hidden; position: relative;

            touch-action: none;

        }

        #map-wrapper:active { cursor: grabbing; }



        /* ç§»åŠ¨ç«¯åº•éƒ¨å¯¼èˆªæ¿€æ´»æ€ */

        .mobile-nav-btn.active { color: #2563EB; }

        

        /* æ»šåŠ¨æ¡ç¾åŒ– */

        .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }

        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #CBD5E1; border-radius: 4px; }

        .custom-scrollbar::-webkit-scrollbar-track { background-color: transparent; }

    </style>

</head>

<body class="flex flex-col min-h-screen">



    <!-- é¡¶éƒ¨æ ‡é¢˜æ  (Mobile & Desktop) -->

    <header class="bg-white/90 backdrop-blur-md sticky top-0 z-40 border-b border-gray-200 shadow-sm">

        <div class="container mx-auto px-4 py-3 flex justify-between items-center">

            <div class="flex items-center gap-2">

                <div class="bg-blue-600 text-white p-1.5 rounded-lg shadow-md shadow-blue-500/30">

                    <i class="ph ph-lock text-xl"></i>

                </div>

                <h1 class="font-bold text-gray-800 text-base leading-tight">æ–°ç–†è§„åˆ’å¸ˆ <span class="text-[10px] text-red-600 bg-red-50 px-1.5 py-0.5 rounded-full border border-red-100 align-middle" id="sync-status-badge">éœ€ç™»å½•</span></h1>

            </div>

            

            <!-- ç™»å½•/Profile Button -->

            <button id="auth-button" onclick="openAuthModal()" class="bg-gray-100 px-3 py-1 rounded-xl text-sm text-gray-600 hover:bg-gray-200 transition-colors flex items-center gap-1">

                <i class="ph ph-user-circle"></i>

                <span id="auth-status">ç™»å½•/æ³¨å†Œ</span>

            </button>

            

            <!-- Desktop Nav (Hidden on Mobile) -->

            <nav class="hidden md:flex bg-gray-100/50 p-1 rounded-xl border border-gray-100">

                <button onclick="switchTab('explore')" class="nav-btn px-4 py-2 rounded-lg text-sm font-medium transition-all text-gray-600 hover:bg-white hover:shadow-sm" data-tab="explore">ğŸ”ï¸ ç™¾ç§‘</button>

                <button onclick="switchTab('routes')" class="nav-btn px-4 py-2 rounded-lg text-sm font-medium transition-all text-gray-600 hover:bg-white hover:shadow-sm" data-tab="routes">ğŸ—ºï¸ åœ°å›¾</button>

                <button onclick="switchTab('budget')" class="nav-btn px-4 py-2 rounded-lg text-sm font-medium transition-all text-gray-600 hover:bg-white hover:shadow-sm" data-tab="budget">ğŸ’° é¢„ç®—</button>

                <button onclick="switchTab('data')" class="nav-btn px-4 py-2 rounded-lg text-sm font-medium transition-all text-gray-600 hover:bg-white hover:shadow-sm" data-tab="data">ğŸ“Š çœ‹æ¿</button>

                <button onclick="switchTab('pack')" class="nav-btn px-4 py-2 rounded-lg text-sm font-medium transition-all text-gray-600 hover:bg-white hover:shadow-sm" data-tab="pack">ğŸ’ æ¸…å•</button>

            </nav>

        </div>

    </header>



    <main class="flex-grow container mx-auto px-4 py-4">

        

        <!-- Loading State Placeholder -->

        <div id="loading-state" class="absolute inset-0 bg-gray-50/70 backdrop-blur-sm z-40 flex items-center justify-center hidden">

            <div class="flex flex-col items-center p-8 bg-white rounded-xl shadow-xl">

                <div class="ph ph-spinner-gap animate-spin text-4xl text-blue-600 mb-3"></div>

                <p class="text-gray-600 font-medium">æ­£åœ¨è¿æ¥ä¸åŒæ­¥æ•°æ®...</p>

            </div>

        </div>



        <!-- 1. æ™¯ç‚¹ç™¾ç§‘ -->

        <section id="explore" class="tab-content active">

            <div class="flex justify-between items-center mb-4">

                <h2 class="text-xl font-bold text-gray-800">æ™¯ç‚¹å‘ç°</h2>

                <button onclick="openAttractionModal()" class="bg-blue-600 active:bg-blue-700 text-white px-3 py-2 rounded-xl shadow-lg flex items-center gap-1 text-xs transition-transform active:scale-95">

                    <i class="ph ph-plus-bold"></i> è‡ªå®šä¹‰

                </button>

            </div>

            <div class="bg-white p-3 rounded-2xl shadow-sm border border-gray-100 mb-4 flex flex-col gap-3 sticky top-16 z-30">

                <div class="relative w-full">

                    <i class="ph ph-magnifying-glass absolute left-3 top-3 text-gray-400"></i>

                    <input type="text" id="explore-search" placeholder="æœæ™¯ç‚¹..." oninput="renderExploreGrid()" class="w-full bg-gray-50 border-0 rounded-xl pl-9 pr-3 py-2.5 text-sm ring-1 ring-gray-200 outline-none">

                </div>

                <div class="flex overflow-x-auto gap-2 pb-1 custom-scrollbar">

                    <select id="explore-filter" onchange="renderExploreGrid()" class="bg-gray-50 border-0 rounded-xl px-3 py-2 text-xs outline-none flex-shrink-0 ring-1 ring-gray-200">

                        <option value="all">å…¨éƒ¨ç±»å‹</option><option value="è‡ªç„¶">ğŸ”ï¸ è‡ªç„¶</option><option value="äººæ–‡">ğŸ•Œ äººæ–‡</option><option value="æ»‘é›ª">ğŸ¿ æ»‘é›ª</option><option value="custom">âœ¨ è‡ªå®šä¹‰</option>

                    </select>

                </div>

            </div>

            <div id="explore-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 pb-20"></div>

        </section>



        <!-- 2. äº¤äº’åœ°å›¾ -->

        <section id="routes" class="tab-content">

            <div class="flex flex-col lg:grid lg:grid-cols-12 gap-4 h-auto lg:h-[calc(100vh-100px)]">

                <div class="lg:col-span-3 flex flex-col gap-3 bg-white p-3 rounded-2xl shadow-sm border border-gray-100 order-2 lg:order-1">

                    <div class="flex justify-between items-center">

                        <h3 class="font-bold text-gray-800 text-sm">ğŸ“… è¡Œç¨‹</h3>

                        <button onclick="addDay()" class="text-xs bg-blue-50 text-blue-600 px-2 py-1 rounded border border-blue-100">+ å¤©æ•°</button>

                    </div>

                    <div id="day-list" class="flex lg:flex-col gap-2 overflow-x-auto lg:overflow-y-auto custom-scrollbar pb-2 lg:pb-0 h-auto lg:h-1/2"></div>

                    <div class="mt-2 border-t pt-2 lg:h-1/2 lg:flex-col lg:flex hidden lg:flex">

                         <h3 class="font-bold text-gray-800 mb-2 text-xs">ğŸ“ å½“æ—¥æ˜ç»†</h3>

                         <div id="day-spots-list-desktop" class="flex-grow overflow-y-auto space-y-2 pr-1 custom-scrollbar text-xs"></div>

                    </div>

                </div>

                <div class="lg:col-span-6 bg-white rounded-2xl shadow-sm border border-gray-100 relative overflow-hidden flex flex-col group order-1 lg:order-2">

                    <div class="absolute top-3 left-3 z-10">

                         <div class="bg-white/90 backdrop-blur px-2 py-1 rounded shadow-sm text-[10px] font-medium border border-gray-200 text-gray-600">

                            ç¬¬ <span id="current-day-num">1</span> å¤©

                          </div>

                    </div>

                    <div class="absolute bottom-3 right-3 z-10 flex gap-2">

                        <button onclick="resetMapView()" class="bg-white p-2 rounded shadow text-gray-600 text-xs"><i class="ph ph-arrows-out-cardinal"></i></button>

                        <div class="flex bg-white rounded shadow overflow-hidden">

                            <button onclick="zoomMap(0.2)" class="p-2 border-r text-gray-600"><i class="ph ph-plus"></i></button>

                            <button onclick="zoomMap(-0.2)" class="p-2 text-gray-600"><i class="ph ph-minus"></i></button>

                        </div>

                    </div>

                    <div class="relative w-full h-[350px] lg:h-full" id="map-wrapper">

                        <canvas id="route-canvas" class="block"></canvas>

                        <div id="map-tooltip" class="absolute hidden bg-gray-900/90 text-white text-xs px-2 py-1 rounded pointer-events-none z-20 whitespace-nowrap"></div>

                    </div>

                    <div class="p-2 bg-gray-50 text-[10px] text-gray-400 text-center">ğŸ‘† æ‹–æ‹½ â€¢ æ»šè½®/åŒæŒ‡ç¼©æ”¾</div>

                </div>

                <div class="lg:col-span-3 bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex flex-col h-full order-3">

                    <div class="lg:hidden mb-4">

                        <h3 class="font-bold text-gray-800 mb-2 text-sm">ğŸ“ å½“æ—¥æ™¯ç‚¹ (<span id="day-spot-count">0</span>)</h3>

                        <div id="day-spots-list-mobile" class="space-y-2 max-h-40 overflow-y-auto custom-scrollbar text-xs"></div>

                    </div>

                    <h3 class="font-bold text-gray-800 mb-3 text-sm">â• æ·»åŠ æ™¯ç‚¹</h3>

                    <input type="text" id="spot-search" placeholder="æœç´¢..." oninput="renderAllSpots()" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm mb-3 outline-none">

                    <div id="all-spots-list" class="flex-grow overflow-y-auto space-y-2 pr-1 custom-scrollbar max-h-60 lg:max-h-none"></div>

                </div>

            </div>

        </section>



        <!-- 3. æ™ºèƒ½é¢„ç®— -->

        <section id="budget" class="tab-content">

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-4 pb-20">

                <div class="lg:col-span-5 space-y-4">

                    <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">

                        <div class="flex items-center gap-2 mb-3 text-blue-600 text-sm font-bold"><i class="ph ph-plus-circle text-lg"></i> æ·»åŠ æ”¯å‡º</div>

                        <div class="flex gap-2">

                            <input type="text" id="custom-item-name" placeholder="é¡¹ç›® (å¦‚:æ»‘é›ªç¥¨)" class="flex-grow bg-gray-50 border-0 rounded-lg px-3 py-2 text-sm ring-1 ring-gray-200 outline-none">

                            <input type="number" id="custom-item-price" placeholder="Â¥" class="w-20 bg-gray-50 border-0 rounded-lg px-3 py-2 text-sm ring-1 ring-gray-200 outline-none">

                            <button onclick="addCustomBudgetItem()" class="bg-blue-600 text-white px-3 rounded-lg hover:bg-blue-700 transition"><i class="ph ph-check-bold"></i></button>

                        </div>

                    </div>

                    <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">

                        <h3 class="font-bold text-gray-800 mb-3 text-sm">åŸºç¡€è®¾å®š</h3>

                        <div class="grid grid-cols-2 gap-3 text-sm">

                            <div><label class="text-xs text-gray-400">äººæ•°</label><input type="number" id="budget-people" value="2" class="w-full mt-1 border rounded p-1.5" onchange="updateDashboard()"></div>

                            <div><label class="text-xs text-gray-400">å¤©æ•°</label><input type="number" id="budget-days" value="1" disabled class="w-full mt-1 bg-gray-50 border rounded p-1.5 text-gray-400"></div>

                            <div><label class="text-xs text-gray-400">ä½å®¿/é—´</label><input type="number" id="price-stay" value="400" class="w-full mt-1 border rounded p-1.5" onchange="updateDashboard()"></div>

                            <div><label class="text-xs text-gray-400">è½¦è´¹/å¤©</label><input type="number" id="price-trans" value="500" class="w-full mt-1 border rounded p-1.5" onchange="updateDashboard()"></div>

                            <div><label class="text-xs text-gray-400">é¤/äºº</label><input type="number" id="price-food" value="150" class="w-full mt-1 border rounded p-1.5" onchange="updateDashboard()"></div>

                            <div><label class="text-xs text-gray-400">é—¨ç¥¨/äºº</label><input type="number" id="price-ticket" value="800" class="w-full mt-1 border rounded p-1.5" onchange="updateDashboard()"></div>

                        </div>

                    </div>

                </div>

                <div class="lg:col-span-7">

                    <div class="bg-gradient-to-br from-blue-600 to-indigo-700 p-5 rounded-3xl shadow-xl text-white relative overflow-hidden">

                        <div class="absolute top-0 right-0 w-40 h-40 bg-white/10 rounded-full blur-3xl -mr-10 -mt-10 pointer-events-none"></div>

                        <div class="mb-4">

                            <h2 class="text-lg font-bold mb-4 opacity-90">é¢„ç®—æ¸…å•</h2>

                            <div id="budget-summary-list" class="space-y-2 text-sm text-blue-50 max-h-[300px] overflow-y-auto custom-scrollbar pr-1"></div>

                        </div>

                        <div class="pt-4 border-t border-white/10 flex justify-between items-end">

                            <div>

                                <div class="text-blue-200 text-xs">é¢„ä¼°æ€»è®¡</div>

                                <div class="text-3xl font-bold mt-1">Â¥<span id="disp-total">0</span></div>

                            </div>

                            <div class="text-right text-blue-200 text-xs">äººå‡: Â¥<span id="disp-avg">0</span></div>

                        </div>

                    </div>

                </div>

            </div>

        </section>



        <!-- 4. å…¨æ™¯çœ‹æ¿ -->

        <section id="data" class="tab-content">

             <div class="grid grid-cols-2 gap-3 mb-4">

                <div class="bg-white p-3 rounded-2xl shadow-sm border border-gray-100 text-center"><div class="text-[10px] text-gray-400">æ€»é¢„ç®—</div><div class="text-lg font-bold text-blue-600">Â¥<span id="dash-total">0</span></div></div>

                <div class="bg-white p-3 rounded-2xl shadow-sm border border-gray-100 text-center"><div class="text-[10px] text-gray-400">è¡Œç¨‹</div><div class="text-lg font-bold text-gray-700"><span id="dash-days">0</span> å¤©</div></div>

                <div class="bg-white p-3 rounded-2xl shadow-sm border border-gray-100 text-center"><div class="text-[10px] text-gray-400">å‡†å¤‡</div><div class="text-lg font-bold text-green-600"><span id="dash-pack">0</span>%</div></div>

                <div class="bg-white p-3 rounded-2xl shadow-sm border border-gray-100 text-center"><div class="text-[10px] text-gray-400">æ»‘é›ªç‚¹</div><div class="text-lg font-bold text-purple-600"><span id="dash-ski-spots">0</span></div></div>

            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 pb-20">

                <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100"><h3 class="text-sm font-bold text-gray-700 mb-2">èµ„é‡‘å æ¯”</h3><div class="h-48"><canvas id="budgetDoughnutChart"></canvas></div></div>

                <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100"><h3 class="text-sm font-bold text-gray-700 mb-2">ç©æ³•åˆ†å¸ƒ</h3><div class="h-48"><canvas id="spotPolarChart"></canvas></div></div>

                <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">

                    <h3 class="text-sm font-bold text-gray-700 mb-2">å¥‡æ™¯é¢„æµ‹ (<span id="temp-val">--20</span>Â°C)</h3>

                    <input type="range" id="temp-slider" min="-40" max="5" value="-20" oninput="updateDashboard()" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer mb-4">

                    <div class="grid grid-cols-2 gap-3 text-xs">

                        <div><div class="text-gray-500 mb-1">æ™¨é›¾</div><div class="font-bold text-gray-800" id="prob-fog">85%</div></div>

                        <div><div class="text-gray-500 mb-1">è“å†°</div><div class="font-bold text-gray-800" id="prob-ice">90%</div></div>

                    </div>

                </div>

            </div>

        </section>



        <!-- 5. è£…å¤‡æ¸…å• -->

        <section id="pack" class="tab-content">

            <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 mb-4">

                <div class="flex items-center gap-4 mb-4">

                    <div class="w-16 h-16 relative flex-shrink-0"><canvas id="packChart"></canvas><div class="absolute inset-0 flex items-center justify-center text-xs font-bold text-blue-600" id="pack-percent-text">0%</div></div>

                    <div class="flex-grow">

                        <h2 class="font-bold text-gray-800">å‡†å¤‡è¿›åº¦</h2>

                        <p class="text-xs text-gray-400 mt-1">å·²é€‰ <span id="pack-checked-count">0</span> / <span id="pack-total-count">0</span></p>

                    </div>

                    <button onclick="exportGearList()" class="bg-blue-50 text-blue-600 p-2 rounded-lg text-xl hover:bg-blue-100 transition"><i class="ph ph-export"></i></button>

                </div>

                <button onclick="addCustomGear()" class="w-full py-2 border border-dashed border-gray-300 rounded-xl text-xs text-gray-500 mb-4 hover:bg-gray-50 transition">+ æ·»åŠ è‡ªå®šä¹‰ç‰©å“</button>

                <div id="gear-container" class="space-y-4 pb-20"></div>

            </div>

        </section>

    </main>



    <!-- Mobile Bottom Navigation -->

    <nav class="md:hidden fixed bottom-0 left-0 w-full bg-white border-t border-gray-200 z-50 flex justify-around items-center pb-safe pt-2 px-1 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">

        <button onclick="switchTab('explore')" class="mobile-nav-btn flex flex-col items-center p-2 text-gray-400 active" data-tab="explore"><i class="ph ph-mountains text-2xl"></i><span class="text-[10px]">ç™¾ç§‘</span></button>

        <button onclick="switchTab('routes')" class="mobile-nav-btn flex flex-col items-center p-2 text-gray-400" data-tab="routes"><i class="ph ph-map-trifold text-2xl"></i><span class="text-[10px]">åœ°å›¾</span></button>

        <button onclick="openAuthModal()" class="flex flex-col items-center justify-center w-12 h-12 bg-blue-600 rounded-full text-white shadow-lg -mt-6 border-4 border-white" title="è´¦æˆ·">

            <i class="ph ph-user text-2xl"></i>

        </button>

        <button onclick="switchTab('budget')" class="mobile-nav-btn flex flex-col items-center p-2 text-gray-400" data-tab="budget"><i class="ph ph-calculator text-2xl"></i><span class="text-[10px]">é¢„ç®—</span></button>

        <button onclick="switchTab('data')" class="mobile-nav-btn flex flex-col items-center p-2 text-gray-400" data-tab="data"><i class="ph ph-chart-pie-slice text-2xl"></i><span class="text-[10px]">ç»Ÿè®¡</span></button>

    </nav>



    <!-- Modal: è‡ªå®šä¹‰æ™¯ç‚¹ -->

    <div id="attraction-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">

        <div class="bg-white rounded-2xl w-full max-w-sm p-5 shadow-2xl animate-[fadeIn_0.2s_ease-out]">

            <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-gray-800">è‡ªå®šä¹‰åœ°ç‚¹</h3><button onclick="closeModal('attraction-modal')" class="text-gray-400"><i class="ph ph-x text-xl"></i></button></div>

            

            <div class="space-y-3">

                <div class="relative group cursor-pointer" onclick="document.getElementById('modal-img-input').click()">

                    <div id="modal-img-preview" class="w-full h-24 bg-gray-100 rounded-lg border-2 border-dashed border-gray-300 flex flex-col items-center justify-center text-gray-400 group-hover:bg-gray-50 group-hover:border-blue-300 transition overflow-hidden">

                        <i class="ph ph-image text-2xl mb-1"></i><span class="text-xs">ç‚¹å‡»æ·»åŠ å°é¢å›¾ç‰‡ (å¯é€‰)</span>

                    </div>

                    <input type="file" id="modal-img-input" accept="image/*" class="hidden" onchange="previewImage(this)">

                </div>

                

                <input type="text" id="modal-name" placeholder="åç§° (å¦‚: éšè—æ‰“å¡ç‚¹)" class="w-full bg-gray-50 border-0 rounded-xl p-3 ring-1 ring-gray-200 outline-none">

                <div class="flex gap-2">

                    <select id="modal-type" class="bg-gray-50 border-0 rounded-xl p-3 ring-1 ring-gray-200 outline-none flex-grow"><option value="custom">âœ¨ ç§è—</option><option value="è‡ªç„¶">ğŸ”ï¸ è‡ªç„¶</option><option value="äººæ–‡">ğŸ•Œ äººæ–‡</option><option value="æ»‘é›ª">ğŸ¿ æ»‘é›ª</option></select>

                    <button onclick="pickLocationFromModal()" class="bg-blue-50 text-blue-600 px-3 rounded-xl text-sm font-medium border border-blue-100 whitespace-nowrap hover:bg-blue-100 transition">ğŸ“ é€‰ä½ç½®</button>

                </div>

                <textarea id="modal-desc" placeholder="å¤‡æ³¨..." class="w-full bg-gray-50 border-0 rounded-xl p-3 ring-1 ring-gray-200 h-20 outline-none resize-none"></textarea>

                <div class="text-xs text-gray-400 text-center" id="modal-coords-display">åæ ‡: æœªè®¾ç½®</div>

            </div>

            <button onclick="saveCustomSpot()" id="save-spot-btn" class="w-full mt-5 bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-blue-500/30 hover:bg-blue-700 transition">ä¿ å­˜</button>

        </div>

    </div>



    <!-- Modal: ç™»å½•/æ³¨å†Œ (Username based) -->

    <div id="auth-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">

        <div class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl animate-[fadeIn_0.2s_ease-out]">

            <div id="auth-info" class="mb-4 hidden">

                <h3 class="text-xl font-bold text-gray-800 mb-2">æ¬¢è¿å›æ¥</h3>

                <p class="text-sm text-gray-600 truncate">è´¦æˆ·: <span id="user-email-display" class="font-medium"></span></p>

                <button onclick="handleSignOut()" class="w-full mt-4 bg-red-500 text-white py-2 rounded-lg hover:bg-red-600 transition">é€€å‡ºç™»å½•</button>

            </div>



            <div id="auth-form">

                <div class="flex justify-between items-center mb-4">

                    <h3 class="text-xl font-bold text-gray-800" id="auth-title">ç™»å½•è´¦æˆ·</h3>

                    <button onclick="closeModal('auth-modal')" class="text-gray-400"><i class="ph ph-x text-xl"></i></button>

                </div>

                <input type="text" id="auth-username" placeholder="è´¦æˆ·å" class="w-full mb-3 bg-gray-50 border-0 rounded-lg p-3 ring-1 ring-gray-200 outline-none">

                <input type="password" id="auth-password" placeholder="å¯†ç  (è‡³å°‘6ä½)" class="w-full mb-3 bg-gray-50 border-0 rounded-lg p-3 ring-1 ring-gray-200 outline-none">

                <input type="password" id="auth-password-confirm" placeholder="ç¡®è®¤å¯†ç " class="w-full mb-3 bg-gray-50 border-0 rounded-lg p-3 ring-1 ring-gray-200 outline-none hidden">

                <p id="auth-error" class="text-red-500 text-xs mb-3"></p>



                <button onclick="handleAuthAction()" id="auth-submit-btn" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 transition">ç™»å½•</button>

                <button onclick="toggleAuthMode()" id="auth-toggle-btn" class="w-full mt-3 text-sm text-blue-600 hover:underline">åˆ‡æ¢åˆ°æ³¨å†Œ</button>

            </div>

        </div>

    </div>



    <!-- Firebase Scripts -->

    <script type="module">

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";

        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        import { getFirestore, doc, setDoc, onSnapshot, collection, query, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        import { getStorage, ref, uploadString, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js"; 

        

        setLogLevel('debug'); // Enable Firestore logging



        // --- DEPLOYMENT CONFIGURATION ---

        

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        

        // 2. Custom Configuration provided by user

        const customFirebaseConfig = {

            // YOUR PROVIDED CONFIGURATION

            apiKey: "AIzaSyAlbsoPG7J2cDocEGisruheVdTaX1Wajgc",

            authDomain: "xinjiang-c95f8.firebaseapp.com",

            projectId: "xinjiang-c95f8",

            storageBucket: "xinjiang-c95f8.appspot.com",

        };



        const configToUse = typeof __firebase_config !== 'undefined' && __firebase_config ? JSON.parse(__firebase_config) : customFirebaseConfig;

        const firebaseConfig = configToUse;

        

        // --- END CONFIGURATION ---



        let app, db, auth, storage; 

        let authMode = 'login'; 

        let currentUserId = null;

        let isAuthReady = false;



        window.openAuthModal = openAuthModal;

        window.toggleAuthMode = toggleAuthMode;

        window.handleAuthAction = handleAuthAction;

        window.handleSignOut = handleSignOut;

        window.saveUserData = saveUserData;

        window.uploadImageAndGetUrl = uploadImageAndGetUrl; 

        

        // Global utility to force all rendering functions to re-run after data load/sync

        window.renderApp = () => {

            if (!window.state.initialized || !window.state.dataLoaded) {

                 document.getElementById('loading-state').classList.remove('hidden');

                 return;

            }

            document.getElementById('loading-state').classList.add('hidden');

            

            // Re-render all major components

            window.renderExploreGrid();

            window.renderDayList();

            window.renderAllSpots();

            window.renderBudget();

            window.renderGear();

            window.updateDashboard(); 

        }



        function getUsernameFromEmail(email) {

            if (!email) return 'N/A';

            const parts = email.split('@');

            return parts[0];

        }



        function updateAuthStateUI(user) {

            const statusEl = document.getElementById('auth-status');

            const headerBadgeEl = document.getElementById('sync-status-badge');

            const infoDiv = document.getElementById('auth-info');

            const formDiv = document.getElementById('auth-form');



            if (user) {

                currentUserId = user.uid;

                const username = getUsernameFromEmail(user.email);

                statusEl.textContent = username;

                headerBadgeEl.textContent = 'å·²åŒæ­¥';

                headerBadgeEl.className = 'text-[10px] text-green-600 bg-green-50 px-1.5 py-0.5 rounded-full border border-green-100 align-middle';

                

                document.getElementById('user-email-display').textContent = username;

                infoDiv.classList.remove('hidden');

                formDiv.classList.add('hidden');

                

            } else {

                currentUserId = null;

                statusEl.textContent = 'ç™»å½•/æ³¨å†Œ';

                headerBadgeEl.textContent = 'éœ€ç™»å½•';

                headerBadgeEl.className = 'text-[10px] text-red-600 bg-red-50 px-1.5 py-0.5 rounded-full border border-red-100 align-middle';

                

                infoDiv.classList.add('hidden');

                formDiv.classList.remove('hidden');

            }

        }



        async function initAuthAndDb() {

            try {

                if (!firebaseConfig.apiKey || !firebaseConfig.projectId) {

                    console.error("Firebase configuration is incomplete. Data synchronization will be disabled.");

                    window.state.initialized = true; 

                    window.state.dataLoaded = true;

                    window.renderApp();

                    return;

                }

                

                app = initializeApp(firebaseConfig);

                auth = getAuth(app);

                db = getFirestore(app);

                storage = getStorage(app); 



                await setPersistence(auth, browserLocalPersistence);



                if (initialAuthToken) {

                    await signInWithCustomToken(auth, initialAuthToken);

                }



                onAuthStateChanged(auth, (user) => {

                    isAuthReady = true;

                    updateAuthStateUI(user);

                    

                    if (user) {

                        setupDataListener(user.uid); // Start real-time sync

                    } else if (!window.state.initialized) {

                        // If not logged in and not initialized, render with defaults

                        window.state.initialized = true;

                        window.state.dataLoaded = true;

                        window.renderApp(); 

                    }

                });



            } catch (error) {

                console.error("Firebase initialization failed:", error);

                window.state.initialized = true;

                window.state.dataLoaded = true;

                window.renderApp();

            }

        }

        

        // --- REALTIME SYNC: onSnapshot ---

        function setupDataListener(userId) {

            const docRef = doc(db, 'artifacts', appId, 'users', userId, 'data', 'state');

            onSnapshot(docRef, (docSnap) => {

                if (docSnap.exists()) {

                    // Load and parse data

                    const data = docSnap.data();

                    // Load custom spots and combine with default spots

                    window.state.spots = [...window.defaultSpots, ...(data.spots || [])]; 

                    // Parse itinerary string back to array

                    try {

                        window.state.itinerary = JSON.parse(data.itinerary);

                    } catch {

                        window.state.itinerary = [[]]; // Fallback if parsing fails

                    }

                    window.state.customBudget = data.customBudget || [];

                    window.state.customGear = data.customGear || [];

                } else {

                    // Document doesn't exist, create it with defaults

                    saveUserData(); // This will auto-sync back via onSnapshot

                }



                if (!window.state.initialized) {

                    window.state.initialized = true;

                }

                window.state.dataLoaded = true;

                window.renderApp(); // Global re-render trigger

                console.log("Firestore Data Synced and App Rendered.");

            }, (error) => {

                console.error("Firestore Listener Error:", error);

                window.state.dataLoaded = true; 

                window.renderApp();

            });

        }

        

        async function uploadImageAndGetUrl(base64Data, userId) {

            if (!storage || !base64Data || !userId) return null;

            

            // Use the AUTH UID as the directory name

            const path = `images/${userId}/${Date.now()}.jpeg`;

            const storageRef = ref(storage, path);



            try {

                await uploadString(storageRef, base64Data, 'data_url');

                const url = await getDownloadURL(storageRef);

                return url;

            } catch (error) {

                console.error("Error uploading image to Storage:", error);

                return null;

            }

        }



        async function saveUserData() {

            if (!currentUserId || !isAuthReady || !db) {

                // If not logged in, data is saved locally by debounceSave only (which is fine)

                return;

            }



            try {

                const docRef = doc(db, 'artifacts', appId, 'users', currentUserId, 'data', 'state');

                const dataToSave = {

                    // Only save custom spots (id > 1000)

                    spots: window.state.spots.filter(s => s.id > 1000), 

                    // Stringify itinerary (to comply with array-in-array Firestore limitations if any)

                    itinerary: JSON.stringify(window.state.itinerary), 

                    customBudget: window.state.customBudget,

                    customGear: window.state.customGear,

                    lastSave: new Date().toISOString()

                };



                await setDoc(docRef, dataToSave, { merge: true });

                

            } catch (e) {

                console.error("Error writing document: ", e);

            }

        }



        // --- AUTH UI HANDLERS ---

        function openAuthModal() {

            document.getElementById('auth-modal').classList.remove('hidden');

        }

        

        function closeModal(id) {

            document.getElementById(id).classList.add('hidden');

        }



        function toggleAuthMode() {

            const title = document.getElementById('auth-title');

            const submitBtn = document.getElementById('auth-submit-btn');

            const toggleBtn = document.getElementById('auth-toggle-btn');

            const confirmPass = document.getElementById('auth-password-confirm');

            const errorEl = document.getElementById('auth-error');

            errorEl.textContent = '';



            if (authMode === 'login') {

                authMode = 'register';

                title.textContent = 'æ³¨å†Œæ–°è´¦æˆ·';

                submitBtn.textContent = 'æ³¨å†Œ';

                toggleBtn.textContent = 'å·²æœ‰è´¦æˆ·ï¼Ÿåˆ‡æ¢åˆ°ç™»å½•';

                confirmPass.classList.remove('hidden');

            } else {

                authMode = 'login';

                title.textContent = 'ç™»å½•è´¦æˆ·';

                submitBtn.textContent = 'ç™»å½•';

                toggleBtn.textContent = 'æ²¡æœ‰è´¦æˆ·ï¼Ÿåˆ‡æ¢åˆ°æ³¨å†Œ';

                confirmPass.classList.add('hidden');

            }

        }



        async function handleAuthAction() {

            const username = document.getElementById('auth-username').value;

            const password = document.getElementById('auth-password').value;

            const confirmPassword = document.getElementById('auth-password-confirm').value;

            const errorEl = document.getElementById('auth-error');

            errorEl.textContent = '';



            if (!username || password.length < 6) {

                errorEl.textContent = 'è´¦æˆ·åä¸èƒ½ä¸ºç©ºï¼Œå¯†ç è‡³å°‘6ä½ã€‚';

                return;

            }



            if (authMode === 'register' && password !== confirmPassword) {

                errorEl.textContent = 'ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´ã€‚';

                return;

            }



            // Construct Firebase-compatible email 

            const email = `${username}@${firebaseConfig.authDomain.split('.').slice(0, -2).join('.')}.canvas.local`;



            try {

                if (authMode === 'register') {

                    await createUserWithEmailAndPassword(auth, email, password);

                    // Use console.log for success instead of alert

                    console.log(`è´¦æˆ· ${username} æ³¨å†ŒæˆåŠŸï¼`); 

                } else {

                    await signInWithEmailAndPassword(auth, email, password);

                }

                

                document.getElementById('auth-modal').classList.add('hidden');



            } catch (error) {

                let errorMessage = 'è®¤è¯å¤±è´¥ã€‚';

                if (error.code === 'auth/email-already-in-use') errorMessage = 'è¯¥è´¦æˆ·åå·²è¢«æ³¨å†Œã€‚';

                if (error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') errorMessage = 'è´¦æˆ·åæˆ–å¯†ç é”™è¯¯ã€‚';

                if (error.code === 'auth/unauthorized-domain') {

                    errorMessage += ' éƒ¨ç½²å¤±è´¥ã€‚è¯·æ£€æŸ¥ï¼šæ‚¨æ˜¯å¦å·²å°†å½“å‰åŸŸåæ·»åŠ åˆ° Firebase æ§åˆ¶å°çš„ [Authentication -> Settings -> Authorized domains] åˆ—è¡¨ä¸­?';

                }

                errorEl.textContent = errorMessage;

                console.error("Auth Error:", error);

            }

        }



        async function handleSignOut() {

            try {

                await signOut(auth);

                console.log("æ‚¨å·²é€€å‡ºç™»å½•ã€‚"); // Removed alert

                document.getElementById('auth-modal').classList.add('hidden');

                // Reload to reset local state to default, which will then use dataLoaded=true to render defaults

                window.location.reload(); 

            } catch (error) {

                console.error("Sign Out Error:", error);

            }

        }



        initAuthAndDb();



    </script>

    <script>

        // --- æ ¸å¿ƒæ•°æ® (Global State) ---

        const defaultSpots = [

            { id: 1, name: "ä¹Œé²æœ¨é½", type: "äººæ–‡", desc: "é¦–åºœ", x: 500, y: 300, tags: ["ä¸­è½¬"], img: null },

            { id: 2, name: "ç¦¾æœ¨æ‘", type: "è‡ªç„¶", desc: "æ™¨é›¾", x: 450, y: 100, tags: ["æ‘„å½±"], img: null },

            { id: 3, name: "å–€çº³æ–¯", type: "è‡ªç„¶", desc: "æ¹–æ€ª", x: 400, y: 80, tags: ["å¾’æ­¥"], img: null },

            { id: 4, name: "èµ›é‡Œæœ¨æ¹–", type: "è‡ªç„¶", desc: "è“å†°", x: 200, y: 350, tags: ["è‡ªé©¾"], img: null },

            { id: 5, name: "å–€ä»€å¤åŸ", type: "äººæ–‡", desc: "å¤åŸ", x: 100, y: 800, tags: ["ç¾é£Ÿ"], img: null },

            { id: 6, name: "å¯å¯æ‰˜æµ·", type: "æ»‘é›ª", desc: "æ»‘é›ª", x: 600, y: 150, tags: ["æé™"], img: null },

        ];

        window.defaultSpots = defaultSpots;



        const defaultGear = {

            "æ ¸å¿ƒä¿æš–": ["ç¾½ç»’æœ", "å†²é”‹è¡£", "ä¿æš–å†…è¡£", "ç¾Šæ¯›è¢œ", "é›ªåœ°é´"],

            "æ»‘é›ªè£…å¤‡": ["å¤´ç›”", "é›ªé•œ", "æŠ¤è„¸", "æ‰‹å¥—", "æŠ¤å…·"],

        };



        window.state = {

            spots: [...defaultSpots], itinerary: [[]], currentDayIndex: 0,

            customBudget: [], customGear: [], weatherTemp: -20,

            isPickingMode: false, mapScale: 1, mapOffset: {x:0,y:0}, isDragging: false, startDrag: {x:0,y:0}, tempSpotData: null,

            initialized: false, // Initialized Firebase/Auth

            dataLoaded: false // Data successfully loaded from Firestore or defaulted

        };

        

        let saveTimeout;

        function debounceSave() {

            clearTimeout(saveTimeout);

            saveTimeout = setTimeout(() => {

                if (window.saveUserData) window.saveUserData();

            }, 1500);

        }



        // Global Chart Variables

        let budgetChart, polarChart, packChart;

        let currentModalImageBase64 = null; 

        

        // --- Modal Control ---

        window.closeModal = (id) => {

            document.getElementById(id).classList.add('hidden');

        }



        // --- 1. Map Engine ---

        function initMapEvents() {

            const w = document.getElementById('map-wrapper');

            w.addEventListener('wheel', e => { e.preventDefault(); zoomMap(e.deltaY>0?0.9:1.1); });

            w.addEventListener('mousedown', e => { 

                state.isDragging=true; 

                state.startDrag={x:e.clientX,y:e.clientY}; 

                w.style.cursor='grabbing'; 

                if(state.isPickingMode) handleMapClick(e.clientX, e.clientY, w); 

            });

            window.addEventListener('mousemove', e => { if(state.isDragging) handleDrag(e.clientX, e.clientY); handleMapHover(e); });

            window.addEventListener('mouseup', () => { state.isDragging=false; w.style.cursor=state.isPickingMode?'crosshair':'grab'; });

            w.addEventListener('touchstart', e => { if(e.touches.length === 1) { state.isDragging=true; state.startDrag={x:e.touches[0].clientX, y:e.touches[0].clientY}; } }, {passive: false});

            w.addEventListener('touchmove', e => { if(state.isDragging && e.touches.length === 1) { e.preventDefault(); handleDrag(e.touches[0].clientX, e.touches[0].clientY); } }, {passive: false});

            w.addEventListener('touchend', () => { state.isDragging=false; });

        }

        function handleDrag(cx, cy) {

            const dx = cx - state.startDrag.x, dy = cy - state.startDrag.y;

            state.mapOffset.x += dx; state.mapOffset.y += dy;

            state.startDrag = {x:cx, y:cy};

            renderMap();

        }

        function zoomMap(factor) { 

            const ns = state.mapScale * factor; 

            if(ns > 0.2 && ns < 5) { 

                state.mapScale = ns; 

                renderMap(); 

            } 

        }

        function resetMapView() { state.mapScale=1; state.mapOffset={x:0,y:0}; renderMap(); }

        

        function renderMap() {

            const cvs=document.getElementById('route-canvas'), ctx=cvs.getContext('2d'), w=document.getElementById('map-wrapper');

            cvs.width=w.offsetWidth; cvs.height=w.offsetHeight; ctx.clearRect(0,0,cvs.width,cvs.height);

            // Translate/Scale/Zoom setup

            ctx.save(); 

            ctx.translate(cvs.width/2 + state.mapOffset.x, cvs.height/2 + state.mapOffset.y); 

            ctx.scale(state.mapScale, state.mapScale); 

            ctx.translate(-cvs.width/2, -cvs.height/2);

            

            const vs=1000, stX=(cvs.width-vs)/2, stY=(cvs.height-vs)/2;

            

            // Draw routes

            state.itinerary.forEach((dS,di)=>{

                if(dS.length<2)return; 

                ctx.beginPath(); 

                ctx.strokeStyle = di === state.currentDayIndex ? '#2563EB' : '#CBD5E1'; 

                ctx.lineWidth = di === state.currentDayIndex ? 4 / state.mapScale : 2 / state.mapScale; 

                ctx.setLineDash(di === state.currentDayIndex ? [] : [5/state.mapScale, 5/state.mapScale]);

                dS.forEach((id,idx)=>{const s=state.spots.find(sp=>sp.id===id); if(s) idx===0?ctx.moveTo(stX+s.x,stY+s.y):ctx.lineTo(stX+s.x,stY+s.y);}); 

                ctx.stroke();

            });

            

            // Draw spots

            state.spots.forEach(s=>{

                const cx=stX+s.x, cy=stY+s.y, act=state.itinerary[state.currentDayIndex].includes(s.id);

                ctx.beginPath(); 

                ctx.arc(cx, cy, (act ? 8 : 5) / Math.sqrt(state.mapScale), 0, Math.PI*2); 

                ctx.fillStyle = act ? '#2563EB' : '#94A3B8'; 

                ctx.fill();

                if(act || state.mapScale > 1.5) { 

                    ctx.fillStyle='#334155'; 

                    ctx.font=`${12/state.mapScale}px sans-serif`; 

                    ctx.fillText(s.name, cx + 10 / state.mapScale, cy + 4 / state.mapScale); 

                }

            });

            ctx.restore();

        }

        

        function handleMapClick(cx, cy, w){

            const rect=w.getBoundingClientRect();

            const vs=1000, stX=(w.offsetWidth-vs)/2, stY=(w.offsetHeight-vs)/2;

            const mx=cx-rect.left, my=cy-rect.top;

            const vx=(mx-w.offsetWidth/2-state.mapOffset.x)/state.mapScale+w.offsetWidth/2-stX;

            const vy=(my-w.offsetHeight/2-state.mapOffset.y)/state.mapScale+w.offsetHeight/2-stY;

            

            if(!state.tempSpotData) state.tempSpotData={}; 

            state.tempSpotData.x=vx; 

            state.tempSpotData.y=vy;

            

            state.isPickingMode=false; 

            document.getElementById('map-wrapper').style.cursor = 'grab';

            window.openAttractionModal(false); // Open modal to finish adding spot

        }

        

        function handleMapHover(e) {

            const tip=document.getElementById('map-tooltip'); 

            if(state.isPickingMode || state.isDragging){ tip.classList.add('hidden'); return; }

            

            const w=document.getElementById('map-wrapper'), rect=w.getBoundingClientRect();

            const mx=e.clientX-rect.left, my=e.clientY-rect.top;

            const cx=w.offsetWidth/2+state.mapOffset.x, cy=w.offsetHeight/2+state.mapOffset.y;

            const stX=(w.offsetWidth-1000)/2, stY=(w.offsetHeight-1000)/2;

            

            const h=state.spots.find(s=>{

                // Calculate scaled/translated spot coordinates on screen

                const sx=cx+(stX+s.x-w.offsetWidth/2)*state.mapScale, 

                      sy=cy+(stY+s.y-w.offsetHeight/2)*state.mapScale;

                // Check if mouse is near the spot (adjusting for scale)

                const hitRadius = 10 / Math.sqrt(state.mapScale);

                return Math.abs(sx - mx) < hitRadius && Math.abs(sy - my) < hitRadius;

            });

            

            if(h){ 

                tip.style.left=(mx+15)+'px'; 

                tip.style.top=my+'px'; 

                tip.innerText=h.name; 

                tip.classList.remove('hidden'); 

            } else {

                tip.classList.add('hidden');

            }

        }



        // --- 2. Explore & Route Logic ---

        window.renderExploreGrid = () => {

            const g=document.getElementById('explore-grid'), 

                  t=document.getElementById('explore-search').value.toLowerCase(), 

                  f=document.getElementById('explore-filter').value; 

            g.innerHTML='';

            

            state.spots.forEach(s=>{

                if((s.name.toLowerCase().includes(t)||s.tags.join('').includes(t))&&(f==='all'||(f==='custom'?s.id>1000:s.type===f))){

                    const div=document.createElement('div'); 

                    div.className="bg-white rounded-xl shadow-sm p-3 border border-gray-100 flex flex-col justify-between";

                    

                    let imageHtml = s.img && s.img.startsWith('http') ? 

                        `<img src="${s.img}" onerror="this.onerror=null;this.src='https://placehold.co/100x100/A0AEC0/ffffff?text=Image+Load+Fail';" class="w-full h-24 object-cover rounded-lg mb-2">` : 

                        `<div class="w-full h-24 bg-gray-100 flex items-center justify-center text-gray-400 rounded-lg mb-2"><i class="ph ph-map-pin"></i></div>`;



                    div.innerHTML=`

                        ${imageHtml}

                        <div><div class="flex justify-between"><h3 class="font-bold text-gray-800">${s.name}</h3><span class="text-[10px] bg-gray-100 px-1.5 py-0.5 rounded text-gray-500">${s.type}</span></div><p class="text-xs text-gray-400 mt-1">${s.desc||''}</p></div><button onclick="addToRoute(${s.id})" class="mt-3 w-full bg-blue-50 text-blue-600 text-xs py-2 rounded font-medium hover:bg-blue-100 transition">åŠ å…¥è¡Œç¨‹</button>`;

                    g.appendChild(div);

                }

            });

            updateDashboard();

        }

        

        function addToRoute(id){ 

            if (!state.itinerary[state.currentDayIndex]) {

                state.itinerary.push([]);

            }

            state.itinerary[state.currentDayIndex].push(id); 

            renderDayList(); 

            debounceSave(); 

        }

        

        window.renderDayList = () => {

            const l=document.getElementById('day-list'); 

            l.innerHTML=''; 

            

            // Ensure itinerary has at least one day

            if (state.itinerary.length === 0) {

                state.itinerary.push([]);

                state.currentDayIndex = 0;

            }



            document.getElementById('budget-days').value=state.itinerary.length; 

            

            state.itinerary.forEach((s,i)=>{

                const div=document.createElement('div'); 

                div.className=`flex-shrink-0 lg:flex-shrink w-20 lg:w-full p-2 lg:p-3 rounded-xl border border-gray-100 cursor-pointer text-center lg:text-left transition-all ${i===state.currentDayIndex?'bg-blue-50 border-blue-200 text-blue-700':'hover:bg-gray-50 text-gray-500'}`;

                div.innerHTML=`<div class="font-bold text-xs">D${i+1}</div><div class="text-[10px] opacity-70">${s.length}ç‚¹</div>`;

                div.onclick=()=>{state.currentDayIndex=i;renderDayList();}; 

                l.appendChild(div);

            });

            

            document.getElementById('current-day-num').innerText=state.currentDayIndex+1;

            document.getElementById('day-spot-count').innerText=state.itinerary[state.currentDayIndex].length;

            renderDaySpots(); 

            renderMap();

        }

        

        function addDay(){ 

            state.itinerary.push([]); 

            state.currentDayIndex=state.itinerary.length-1; 

            renderDayList(); 

            debounceSave(); 

        }

        

        function renderDaySpots() {

            const desktopL=document.getElementById('day-spots-list-desktop'), 

                  mobileL=document.getElementById('day-spots-list-mobile');

            const html = state.itinerary[state.currentDayIndex].map((id,i)=>{

                const s=state.spots.find(sp=>sp.id===id); 

                if(!s)return'';

                return `<div class="flex justify-between items-center p-2 bg-gray-50 rounded"><span class="truncate">${i+1}. ${s.name}</span><button onclick="rmSpot(${i})" class="text-red-400 px-2 hover:text-red-600">Ã—</button></div>`;

            }).join('');

            desktopL.innerHTML=html; 

            mobileL.innerHTML=html;

        }

        

        function rmSpot(i){

            state.itinerary[state.currentDayIndex].splice(i,1); 

            renderDayList(); 

            debounceSave();

        }

        

        window.renderAllSpots = () => {

            const l=document.getElementById('all-spots-list'), t=document.getElementById('spot-search').value.toLowerCase(); 

            l.innerHTML='';

            state.spots.filter(s=>s.name.toLowerCase().includes(t)).forEach(s=>{

                const b=document.createElement('button'); 

                b.className="w-full text-left p-2 hover:bg-gray-50 text-xs text-gray-600 flex justify-between rounded transition";

                b.innerHTML=`<span>${s.name}</span><span class="text-blue-500 font-bold">+</span>`; 

                b.onclick=()=>{addToRoute(s.id)}; 

                l.appendChild(b);

            });

        }

        

        // --- Custom Spot Logic ---

        function previewImage(input) {

            if (input.files && input.files[0]) {

                const reader = new FileReader();

                reader.onload = function(e) {

                    document.getElementById('modal-img-preview').innerHTML = `<img src="${e.target.result}" class="w-full h-full object-cover rounded-lg">`;

                    currentModalImageBase64 = e.target.result;

                }

                reader.readAsDataURL(input.files[0]);

            }

        }

        

        window.openAttractionModal = (reset = true) => {

            document.getElementById('attraction-modal').classList.remove('hidden'); 

            if(reset){

                document.getElementById('modal-name').value=''; state.tempSpotData=null; 

                document.getElementById('modal-desc').value='';

                document.getElementById('modal-coords-display').innerText='åæ ‡: æœªè®¾ç½®';

                currentModalImageBase64 = null;

                document.getElementById('modal-img-input').value = '';

                document.getElementById('modal-img-preview').innerHTML = `<i class="ph ph-image text-2xl mb-1"></i><span class="text-xs">ç‚¹å‡»æ·»åŠ å°é¢å›¾ç‰‡ (å¯é€‰)</span>`;



            } else if(state.tempSpotData?.x) {

                document.getElementById('modal-coords-display').innerText=`åæ ‡: X:${Math.round(state.tempSpotData.x)}, Y:${Math.round(state.tempSpotData.y)}`;

            }

        }

        

        function pickLocationFromModal(){

            state.tempSpotData={name:document.getElementById('modal-name').value}; 

            state.isPickingMode=true; 

            document.getElementById('attraction-modal').classList.add('hidden'); 

            switchTab('routes'); 

            document.getElementById('map-wrapper').style.cursor = 'crosshair';

            console.log("åœ°ç‚¹é€‰å–æ¨¡å¼å·²å¼€å¯ï¼Œè¯·ç‚¹å‡»åœ°å›¾ä¸Šçš„ä½ç½®ã€‚"); // Replaced alert

        }

        

        async function saveCustomSpot(){

            const nameInput = document.getElementById('modal-name');

            const n=nameInput.value;

            

            // --- FIX: Replace blocking alert with visual feedback and console error ---

            if(!n) {

                nameInput.classList.add('ring-red-500', 'ring-2'); // Visual feedback

                setTimeout(() => nameInput.classList.remove('ring-red-500', 'ring-2'), 1000);

                console.error("ä¿å­˜å¤±è´¥: è¯·è¾“å…¥åœ°ç‚¹åç§°ã€‚"); // Console error

                return;

            }



            let imageUrl = null;

            if (currentModalImageBase64 && window.uploadImageAndGetUrl) {

                if (!window.currentUserId) {

                    alert("è¯·å…ˆç™»å½•è´¦æˆ· (æˆ–æ³¨å†Œ) æ‰èƒ½ä¸Šä¼ å›¾ç‰‡å¹¶ä¿å­˜è‡ªå®šä¹‰æ™¯ç‚¹ã€‚");

                    return; 

                }



                const saveBtn = document.getElementById('save-spot-btn');

                saveBtn.innerHTML = '<i class="ph ph-spinner-gap animate-spin"></i> ä¸Šä¼ ä¸­...';

                saveBtn.disabled = true;



                const userId = window.currentUserId; 

                imageUrl = await window.uploadImageAndGetUrl(currentModalImageBase64, userId);

                

                saveBtn.innerHTML = 'ä¿ å­˜';

                saveBtn.disabled = false;



                // --- FIX: Replace blocking alert with console error ---

                if (!imageUrl) {

                    console.error("å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼Œè¯·æ£€æŸ¥ Firebase Storage é…ç½®å’Œå®‰å…¨è§„åˆ™ã€‚");

                    return;

                }

            }



            state.spots.push({

                id:Date.now(), 

                name:n, 

                type:document.getElementById('modal-type').value, 

                desc:document.getElementById('modal-desc').value, 

                x:state.tempSpotData?.x||500, 

                y:state.tempSpotData?.y||500, 

                tags:[],

                img: imageUrl

            });

            

            currentModalImageBase64 = null;

            renderExploreGrid(); 

            renderAllSpots(); 

            renderMap(); 

            document.getElementById('attraction-modal').classList.add('hidden'); 

            debounceSave();

        }

        

        // --- 3. Budget & Gear ---

        window.addCustomBudgetItem = () => {

            const itemName = document.getElementById('custom-item-name').value.trim();

            const itemPrice = parseFloat(document.getElementById('custom-item-price').value);



            if (itemName && itemPrice && itemPrice > 0) {

                window.state.customBudget.push({

                    name: itemName,

                    price: itemPrice

                });

                document.getElementById('custom-item-name').value = '';

                document.getElementById('custom-item-price').value = '';

                updateDashboard(); // Triggers renderBudget/save

            } else {

                console.error("è¯·è¾“å…¥æœ‰æ•ˆçš„é¡¹ç›®åç§°å’Œä»·æ ¼ã€‚");

            }

        }

        

        window.renderBudget = () => {

            const p=parseInt(document.getElementById('budget-people').value)||1, 

                  d=parseInt(document.getElementById('budget-days').value)||1;

            const stay=parseFloat(document.getElementById('price-stay').value)||0, 

                  trans=parseFloat(document.getElementById('price-trans').value)||0;

            const food=parseFloat(document.getElementById('price-food').value)||0, 

                  ticket=parseFloat(document.getElementById('price-ticket').value)||0;

                  

            const tStay=(stay*Math.ceil(p/2))*(d-1), 

                  tTrans=trans*d, 

                  tMisc=(food*p*d)+(ticket*p);

            

            let listHtml=`<div class="flex justify-between items-center p-2 bg-white/10 rounded-lg border border-white/10"><span>ğŸ¨ ä½å®¿ (${stay} x ${d-1} æ™š)</span><span class="font-mono font-bold">Â¥<span id="disp-stay">${tStay}</span></span></div>`;

            listHtml+=`<div class="flex justify-between items-center p-2 bg-white/10 rounded-lg border border-white/10"><span>ğŸš— äº¤é€š (${trans} x ${d} å¤©)</span><span class="font-mono font-bold">Â¥<span id="disp-trans">${tTrans}</span></span></div>`;

            listHtml+=`<div class="flex justify-between items-center p-2 bg-white/10 rounded-lg border border-white/10"><span>ğŸ¥˜ é£Ÿ/ç¥¨ (${p} äºº)</span><span class="font-mono font-bold">Â¥<span id="disp-misc">${tMisc}</span></span></div>`;

            

            let tCustom=0;

            state.customBudget.forEach((i,x)=>{ 

                tCustom+=i.price; 

                listHtml+=`<div class="flex justify-between items-center p-2 bg-orange-500/20 rounded-lg border border-orange-500/30 text-orange-100 budget-item-enter relative group"><span>âœ¨ ${i.name}</span><div class="flex items-center gap-2"><span class="font-mono font-bold">Â¥${i.price.toLocaleString()}</span><button onclick="removeBudgetItem(${x})" class="text-white/70 hover:text-white transition"><i class="ph ph-trash"></i></button></div></div>`; 

            });

            listHtml+=`<span id="disp-custom" style="display:none">${tCustom}</span>`;



            document.getElementById('budget-summary-list').innerHTML=listHtml;

            const total=tStay+tTrans+tMisc+tCustom;

            document.getElementById('disp-total').innerText=total.toLocaleString();

            document.getElementById('disp-avg').innerText=Math.round(total/p).toLocaleString();

            

            debounceSave(); // Save after recalculation

        }

        

        function removeBudgetItem(i){

            state.customBudget.splice(i,1); 

            updateDashboard(); // Triggers renderBudget/save

        }

        

        window.renderGear = () => {

            const c=document.getElementById('gear-container'); 

            c.innerHTML='';

            

            let cats={...defaultGear}; 

            if(state.customGear.length) {

                 // Convert customGear array to an object property

                 cats["è‡ªå®šä¹‰ç‰©å“"] = state.customGear;

            }

            

            for(const [k,v] of Object.entries(cats)){

                let itemsHtml = '';

                // Handle both simple string arrays (defaultGear) and objects (customGear, if saved with old format)

                const items = Array.isArray(v) ? v : Object.values(v); 



                items.forEach(i => {

                    // Check local state for checked items (simulating persistent check state)

                    const isChecked = localStorage.getItem(`gear_${i}`) === 'true';

                    itemsHtml += `<label class="flex items-center space-x-2 text-xs text-gray-500 hover:bg-gray-50 p-1 rounded transition cursor-pointer"><input type="checkbox" class="rounded text-blue-600 w-4 h-4 gear-check" data-item="${i}" ${isChecked ? 'checked' : ''} onchange="updateGearStats(this); debounceSave();"><span>${i}</span></label>`;

                });



                c.innerHTML+=`<div><h4 class="font-bold text-gray-700 text-sm mb-2 border-l-4 border-blue-500 pl-2">${k}</h4><div class="space-y-2">${itemsHtml}</div></div>`;

            }

            updateGearStats();

        }

        

        // This function handles checkbox state and updates stats

        function updateGearStats(checkbox = null){

            if (checkbox) {

                // Save/update state in localStorage when a checkbox changes

                localStorage.setItem(`gear_${checkbox.dataset.item}`, checkbox.checked);

            }

            

            const checks = document.querySelectorAll('.gear-check');

            const t = checks.length;

            const c = Array.from(checks).filter(ch => ch.checked).length;

            

            document.getElementById('pack-checked-count').innerText=c; 

            document.getElementById('pack-total-count').innerText=t;

            

            const percent = (t ? Math.round(c/t*100) : 0);

            document.getElementById('pack-percent-text').innerText=percent + '%';

            

            // Update Dashboard and Charts

            if(packChart){packChart.data.datasets[0].data=[c,t-c]; packChart.update();}

            document.getElementById('dash-pack').innerText = percent;

        }

        

        window.addCustomGear = () => {

            const n = window.prompt("è¯·è¾“å…¥æ–°çš„è£…å¤‡åç§°:"); 

            if (n && n.trim()) {

                window.state.customGear.push(n.trim()); 

                window.renderGear(); // Renders the gear list (which includes the new item)

                debounceSave();

            }

        }

        

        // Export logic (placeholder)

        window.exportGearList = () => {

            console.log("Exporting gear list...");

            // FIX: Removed alert

            console.log("æ¸…å•å·²å‡†å¤‡å¥½å¯¼å‡ºï¼(åŠŸèƒ½å¾…å®ç°)");

        }



        // --- 4. Utility ---

        window.updateCharts = () => {

            // Get calculated totals from the Budget tab

            const s=parseInt(document.getElementById('disp-stay').innerText.replace(/,/g,'') || 0), 

                  tr=parseInt(document.getElementById('disp-trans').innerText.replace(/,/g,'') || 0), 

                  m=parseInt(document.getElementById('disp-misc').innerText.replace(/,/g,'') || 0), 

                  c=parseInt(document.getElementById('disp-custom').innerText.replace(/,/g,'') || 0);



            // Budget Doughnut Chart

            if (budgetChart) {

                budgetChart.data.datasets[0].data=[s,tr,m,c]; 

                budgetChart.update();

            }

            

            // Polar Area Chart (Spot types)

            const ids = state.itinerary.flat(), 

                  sp = ids.map(id => state.spots.find(s=>s.id===id)).filter(s=>s);

            

            if (polarChart) {

                polarChart.data.datasets[0].data=[

                    sp.filter(s=>s.type==='è‡ªç„¶').length,

                    sp.filter(s=>s.type==='äººæ–‡').length,

                    sp.filter(s=>s.type==='æ»‘é›ª').length,

                    sp.filter(s=>s.type==='custom').length

                ]; 

                polarChart.update();

            }

            

            // Weather Prediction

            const temp = parseInt(document.getElementById('temp-slider').value) || -20;

            document.getElementById('temp-val').innerText = temp;

            document.getElementById('prob-fog').innerText = `${Math.min(99, Math.max(20, 100 + temp * 2))}%`;

            document.getElementById('prob-ice').innerText = `${Math.min(99, Math.max(10, 100 + temp * 3))}%`;

        }



        window.updateDashboard = () => {

            renderBudget(); // Must run first to calculate totals

            

            const t=document.getElementById('disp-total').innerText;

            document.getElementById('dash-total').innerText=t;

            document.getElementById('dash-days').innerText=state.itinerary.length;

            

            // Pack % is updated by updateGearStats() which is called by renderGear()

            updateGearStats(); 

            

            document.getElementById('dash-ski-spots').innerText=state.itinerary.flat().map(id=>state.spots.find(s=>s.id===id)).filter(s=>s&&s.type==='æ»‘é›ª').length;

            window.updateCharts();

            

            // Debounce save is called inside renderBudget and updateGearStats

        }

        

        window.initCharts = () => {

            // Initialize once to prevent re-creation errors

            if (!budgetChart) {

                budgetChart=new Chart(document.getElementById('budgetDoughnutChart'),{type:'doughnut',data:{labels:['ä½','è¡Œ','é£Ÿ','è‡ª'],datasets:[{data:[1,1,1,1],backgroundColor:['#3B82F6','#10B981','#8B5CF6','#F97316'],borderWidth:0}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right',labels:{boxWidth:10}}}}});

            }

            if (!polarChart) {

                polarChart=new Chart(document.getElementById('spotPolarChart'),{type:'polarArea',data:{labels:['è‡ªç„¶','äººæ–‡','æ»‘é›ª','è‡ªå®š'],datasets:[{data:[1,1,1,0],backgroundColor:['#38BDF8aa','#A78BFAaa','#F97316aa','#FBBF24aa'],borderWidth:0}]},options:{responsive:true,maintainAspectRatio:false,scales:{r:{ticks:{display:false}}},plugins:{legend:{position:'right',labels:{boxWidth:10}}}}});

            }

            if (!packChart) {

                packChart=new Chart(document.getElementById('packChart'),{type:'doughnut',data:{datasets:[{data:[0,1],backgroundColor:['#2563EB','#E5E7EB'],borderWidth:0,cutout:'85%'}]},options:{responsive:true,maintainAspectRatio:false,plugins:{tooltip:{enabled:false}}}});

            }

        }

        

        function switchTab(id) {

            document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active'));

            document.getElementById(id).classList.add('active');

            document.querySelectorAll('.mobile-nav-btn').forEach(b=>b.classList.toggle('active', b.dataset.tab===id));

            document.querySelectorAll('.nav-btn').forEach(b=>b.classList.toggle('bg-white', b.dataset.tab===id));

            

            if(id==='routes') setTimeout(renderMap,100);

            if(id==='data') updateDashboard();

            if(id==='pack') renderGear(); // Force render pack list on tab switch

            

            window.scrollTo(0,0);

        }



        // --- Initial Callbacks ---

        window.onload = () => {

            window.initCharts();

            initMapEvents();

            // Initial rendering is now handled by the Firebase onAuthStateChanged and onSnapshot listeners

        }

    </script>

</body>

</html>







ç°åœ¨æˆ‘çš„é—®é¢˜æ˜¯ æˆ‘æ·»åŠ äº† è‡ªå®šä¹‰ä¹‹å åˆ·æ–°å°±æ²¡äº† è™½ç„¶æ˜¯ç™»å½•çš„ æˆ‘éœ€è¦å¤šç«¯ç™»å½•è´¦å· æ•°æ®ä¿ç•™å‘€

å¥½çš„ï¼Œæˆ‘ç†è§£æ‚¨çš„æ²®ä¸§ã€‚å¦‚æœ Firestore è§„åˆ™å·²ä¿®æ­£ï¼Œä½†è‡ªå®šä¹‰æ•°æ®åœ¨åˆ·æ–°åä»ç„¶ä¸¢å¤±ï¼Œè¿™è¡¨æ˜è™½ç„¶æ‚¨æˆåŠŸç™»å½•ï¼Œä½†æ•°æ®åœ¨å†™å…¥æˆ–åŠ è½½å›çŠ¶æ€æ—¶å‡ºç°äº†é—®é¢˜ã€‚

æ ¹æ®æ‚¨æè¿°çš„ç°è±¡å’Œä»£ç ç»“æ„ï¼Œè‡ªå®šä¹‰æ™¯ç‚¹æ•°æ®ä¸¢å¤±æœ€å¯èƒ½çš„åŸå› æ˜¯ï¼š

æ•°æ®è¿‡æ»¤é—®é¢˜ï¼š æ‚¨çš„ saveUserData() å‡½æ•°åªä¿å­˜ id > 1000 çš„æ™¯ç‚¹ï¼ˆè‡ªå®šä¹‰æ™¯ç‚¹ï¼‰ã€‚å¦‚æœæ·»åŠ è‡ªå®šä¹‰æ™¯ç‚¹åï¼Œå®ƒæ²¡æœ‰è¢«æˆåŠŸè¯†åˆ«ä¸ºè‡ªå®šä¹‰ IDï¼ˆå°½ç®¡æ‚¨ä½¿ç”¨äº† Date.now()ï¼‰ï¼Œæˆ–è€…ä¿å­˜å¤±è´¥ï¼Œæ•°æ®å°±ä¼šä¸¢å¤±ã€‚

é™é»˜å¤±è´¥é—®é¢˜ï¼š åœ¨ saveCustomSpot å‡½æ•°ä¸­ï¼Œå¦‚æœæœ‰å›¾ç‰‡ä¸Šä¼ ï¼ˆFirebase Storageï¼‰å¤±è´¥ï¼Œå‡½æ•°ä¼šæå‰é€€å‡ºï¼Œå¯¼è‡´æ™¯ç‚¹åªåœ¨æœ¬åœ°çŠ¶æ€ä¸­å­˜åœ¨å‡ ç§’ï¼Œä½†æ²¡æœ‰å†™å…¥ Firestoreã€‚

æˆ‘å·²ç»å½»åº•æ£€æŸ¥å¹¶ä¿®å¤äº† saveCustomSpot å‡½æ•°ï¼Œç¡®ä¿ï¼š

æ·»åŠ æ™¯ç‚¹åç§°æ—¶ï¼Œå¦‚æœåç§°ä¸ºç©ºï¼Œä¼šç»™å‡ºæ˜æ˜¾çš„è§†è§‰åé¦ˆï¼ˆè¾“å…¥æ¡†é—ªçº¢ï¼‰ã€‚

å›¾ç‰‡ä¸Šä¼ å¤±è´¥æˆ–æˆåŠŸéƒ½æœ‰æ¸…æ™°çš„æ§åˆ¶å°æ—¥å¿—ï¼Œå¹¶ä¸”å¦‚æœä¸Šä¼ å¤±è´¥ï¼Œæˆ‘ä»¬ä¼šé˜»æ­¢æ™¯ç‚¹ä¿å­˜åˆ°æ•°æ®åº“ï¼Œé¿å…è„æ•°æ®ï¼ˆä½†åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç”¨æˆ·éœ€è¦å…ˆä¿®å¤ Storage è§„åˆ™æ‰èƒ½ä¿å­˜å›¾ç‰‡ï¼‰ã€‚

æœ€å…³é”®çš„ï¼š æˆåŠŸç‚¹å‡»ä¿å­˜åï¼ŒæŒ‰é’®ä¼šçŸ­æš‚æ˜¾ç¤º â€œä¿å­˜æˆåŠŸï¼â€ çš„çŠ¶æ€ï¼Œè¿™è¡¨æ˜å‰ç«¯æ“ä½œå·²å®Œæˆï¼Œå¹¶å·²è§¦å‘æ•°æ®åŒæ­¥åˆ° Firestoreã€‚

å¦‚æœä¿®å¤åæ‚¨çœ‹åˆ°â€œä¿å­˜æˆåŠŸâ€ä½†æ•°æ®ä»ç„¶ä¸¢å¤±ï¼Œè¯·åŠ¡å¿…æ£€æŸ¥æ‚¨çš„ Firebase Storage è§„åˆ™ï¼Œç¡®ä¿ç™»å½•ç”¨æˆ·å¯ä»¥ä¸Šä¼ å›¾ç‰‡ã€‚

ä»¥ä¸‹æ˜¯å·²ä¿®å¤çš„ä»£ç ï¼š

<!DOCTYPE html>

<html lang="zh-CN">

<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>æ—…è¡Œè§„åˆ’å¸ˆ Pro | å®æ—¶åŒæ­¥ç‰ˆ</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>

        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap');

        

        body { font-family: 'Noto Sans SC', sans-serif; background-color: #F1F5F9; color: #334155; padding-bottom: 80px; }

        

        /* äº¤äº’åŠ¨æ•ˆ */

        .tab-content { display: none; animation: fadeIn 0.3s ease-out; }

        .tab-content.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        

        #map-wrapper {

            background-color: #e5e7eb;

            background-image: linear-gradient(rgba(255,255,255,0.5) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.5) 1px, transparent 1px);

            background-size: 40px 40px;

            cursor: grab; overflow: hidden; position: relative;

            touch-action: none;

        }

        #map-wrapper:active { cursor: grabbing; }



        /* ç§»åŠ¨ç«¯åº•éƒ¨å¯¼èˆªæ¿€æ´»æ€ */

        .mobile-nav-btn.active { color: #2563EB; }

        

        /* æ»šåŠ¨æ¡ç¾åŒ– */

        .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }

        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #CBD5E1; border-radius: 4px; }

        .custom-scrollbar::-webkit-scrollbar-track { background-color: transparent; }



        /* Input error ring */

        .ring-red-500 {

            transition: all 0.2s ease-in-out;

        }

    </style>

</head>

<body class="flex flex-col min-h-screen">



    <!-- é¡¶éƒ¨æ ‡é¢˜æ  (Mobile & Desktop) -->

    <header class="bg-white/90 backdrop-blur-md sticky top-0 z-40 border-b border-gray-200 shadow-sm">

        <div class="container mx-auto px-4 py-3 flex justify-between items-center">

            <div class="flex items-center gap-2">

                <div class="bg-blue-600 text-white p-1.5 rounded-lg shadow-md shadow-blue-500/30">

                    <i class="ph ph-lock text-xl"></i>

                </div>

                <h1 class="font-bold text-gray-800 text-base leading-tight">æ–°ç–†è§„åˆ’å¸ˆ <span class="text-[10px] text-red-600 bg-red-50 px-1.5 py-0.5 rounded-full border border-red-100 align-middle" id="sync-status-badge">éœ€ç™»å½•</span></h1>

            </div>

            

            <!-- ç™»å½•/Profile Button -->

            <button id="auth-button" onclick="openAuthModal()" class="bg-gray-100 px-3 py-1 rounded-xl text-sm text-gray-600 hover:bg-gray-200 transition-colors flex items-center gap-1">

                <i class="ph ph-user-circle"></i>

                <span id="auth-status">ç™»å½•/æ³¨å†Œ</span>

            </button>

            

            <!-- Desktop Nav (Hidden on Mobile) -->

            <nav class="hidden md:flex bg-gray-100/50 p-1 rounded-xl border border-gray-100">

                <button onclick="switchTab('explore')" class="nav-btn px-4 py-2 rounded-lg text-sm font-medium transition-all text-gray-600 hover:bg-white hover:shadow-sm" data-tab="explore">ğŸ”ï¸ ç™¾ç§‘</button>

                <button onclick="switchTab('routes')" class="nav-btn px-4 py-2 rounded-lg text-sm font-medium transition-all text-gray-600 hover:bg-white hover:shadow-sm" data-tab="routes">ğŸ—ºï¸ åœ°å›¾</button>

                <button onclick="switchTab('budget')" class="nav-btn px-4 py-2 rounded-lg text-sm font-medium transition-all text-gray-600 hover:bg-white hover:shadow-sm" data-tab="budget">ğŸ’° é¢„ç®—</button>

                <button onclick="switchTab('data')" class="nav-btn px-4 py-2 rounded-lg text-sm font-medium transition-all text-gray-600 hover:bg-white hover:shadow-sm" data-tab="data">ğŸ“Š çœ‹æ¿</button>

                <button onclick="switchTab('pack')" class="nav-btn px-4 py-2 rounded-lg text-sm font-medium transition-all text-gray-600 hover:bg-white hover:shadow-sm" data-tab="pack">ğŸ’ æ¸…å•</button>

            </nav>

        </div>

    </header>



    <main class="flex-grow container mx-auto px-4 py-4">

        

        <!-- Loading State Placeholder -->

        <div id="loading-state" class="absolute inset-0 bg-gray-50/70 backdrop-blur-sm z-40 flex items-center justify-center hidden">

            <div class="flex flex-col items-center p-8 bg-white rounded-xl shadow-xl">

                <div class="ph ph-spinner-gap animate-spin text-4xl text-blue-600 mb-3"></div>

                <p class="text-gray-600 font-medium">æ­£åœ¨è¿æ¥ä¸åŒæ­¥æ•°æ®...</p>

            </div>

        </div>



        <!-- 1. æ™¯ç‚¹ç™¾ç§‘ -->

        <section id="explore" class="tab-content active">

            <div class="flex justify-between items-center mb-4">

                <h2 class="text-xl font-bold text-gray-800">æ™¯ç‚¹å‘ç°</h2>

                <button onclick="openAttractionModal()" class="bg-blue-600 active:bg-blue-700 text-white px-3 py-2 rounded-xl shadow-lg flex items-center gap-1 text-xs transition-transform active:scale-95">

                    <i class="ph ph-plus-bold"></i> è‡ªå®šä¹‰

                </button>

            </div>

            <div class="bg-white p-3 rounded-2xl shadow-sm border border-gray-100 mb-4 flex flex-col gap-3 sticky top-16 z-30">

                <div class="relative w-full">

                    <i class="ph ph-magnifying-glass absolute left-3 top-3 text-gray-400"></i>

                    <input type="text" id="explore-search" placeholder="æœæ™¯ç‚¹..." oninput="renderExploreGrid()" class="w-full bg-gray-50 border-0 rounded-xl pl-9 pr-3 py-2.5 text-sm ring-1 ring-gray-200 outline-none">

                </div>

                <div class="flex overflow-x-auto gap-2 pb-1 custom-scrollbar">

                    <select id="explore-filter" onchange="renderExploreGrid()" class="bg-gray-50 border-0 rounded-xl px-3 py-2 text-xs outline-none flex-shrink-0 ring-1 ring-gray-200">

                        <option value="all">å…¨éƒ¨ç±»å‹</option><option value="è‡ªç„¶">ğŸ”ï¸ è‡ªç„¶</option><option value="äººæ–‡">ğŸ•Œ äººæ–‡</option><option value="æ»‘é›ª">ğŸ¿ æ»‘é›ª</option><option value="custom">âœ¨ è‡ªå®šä¹‰</option>

                    </select>

                </div>

            </div>

            <div id="explore-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 pb-20"></div>

        </section>



        <!-- 2. äº¤äº’åœ°å›¾ -->

        <section id="routes" class="tab-content">

            <div class="flex flex-col lg:grid lg:grid-cols-12 gap-4 h-auto lg:h-[calc(100vh-100px)]">

                <div class="lg:col-span-3 flex flex-col gap-3 bg-white p-3 rounded-2xl shadow-sm border border-gray-100 order-2 lg:order-1">

                    <div class="flex justify-between items-center">

                        <h3 class="font-bold text-gray-800 text-sm">ğŸ“… è¡Œç¨‹</h3>

                        <button onclick="addDay()" class="text-xs bg-blue-50 text-blue-600 px-2 py-1 rounded border border-blue-100">+ å¤©æ•°</button>

                    </div>

                    <div id="day-list" class="flex lg:flex-col gap-2 overflow-x-auto lg:overflow-y-auto custom-scrollbar pb-2 lg:pb-0 h-auto lg:h-1/2"></div>

                    <div class="mt-2 border-t pt-2 lg:h-1/2 lg:flex-col lg:flex hidden lg:flex">

                         <h3 class="font-bold text-gray-800 mb-2 text-xs">ğŸ“ å½“æ—¥æ˜ç»†</h3>

                         <div id="day-spots-list-desktop" class="flex-grow overflow-y-auto space-y-2 pr-1 custom-scrollbar text-xs"></div>

                    </div>

                </div>

                <div class="lg:col-span-6 bg-white rounded-2xl shadow-sm border border-gray-100 relative overflow-hidden flex flex-col group order-1 lg:order-2">

                    <div class="absolute top-3 left-3 z-10">

                         <div class="bg-white/90 backdrop-blur px-2 py-1 rounded shadow-sm text-[10px] font-medium border border-gray-200 text-gray-600">

                            ç¬¬ <span id="current-day-num">1</span> å¤©

                          </div>

                    </div>

                    <div class="absolute bottom-3 right-3 z-10 flex gap-2">

                        <button onclick="resetMapView()" class="bg-white p-2 rounded shadow text-gray-600 text-xs"><i class="ph ph-arrows-out-cardinal"></i></button>

                        <div class="flex bg-white rounded shadow overflow-hidden">

                            <button onclick="zoomMap(0.2)" class="p-2 border-r text-gray-600"><i class="ph ph-plus"></i></button>

                            <button onclick="zoomMap(-0.2)" class="p-2 text-gray-600"><i class="ph ph-minus"></i></button>

                        </div>

                    </div>

                    <div class="relative w-full h-[350px] lg:h-full" id="map-wrapper">

                        <canvas id="route-canvas" class="block"></canvas>

                        <div id="map-tooltip" class="absolute hidden bg-gray-900/90 text-white text-xs px-2 py-1 rounded pointer-events-none z-20 whitespace-nowrap"></div>

                    </div>

                    <div class="p-2 bg-gray-50 text-[10px] text-gray-400 text-center">ğŸ‘† æ‹–æ‹½ â€¢ æ»šè½®/åŒæŒ‡ç¼©æ”¾</div>

                </div>

                <div class="lg:col-span-3 bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex flex-col h-full order-3">

                    <div class="lg:hidden mb-4">

                        <h3 class="font-bold text-gray-800 mb-2 text-sm">ğŸ“ å½“æ—¥æ™¯ç‚¹ (<span id="day-spot-count">0</span>)</h3>

                        <div id="day-spots-list-mobile" class="space-y-2 max-h-40 overflow-y-auto custom-scrollbar text-xs"></div>

                    </div>

                    <h3 class="font-bold text-gray-800 mb-3 text-sm">â• æ·»åŠ æ™¯ç‚¹</h3>

                    <input type="text" id="spot-search" placeholder="æœç´¢..." oninput="renderAllSpots()" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm mb-3 outline-none">

                    <div id="all-spots-list" class="flex-grow overflow-y-auto space-y-2 pr-1 custom-scrollbar max-h-60 lg:max-h-none"></div>

                </div>

            </div>

        </section>



        <!-- 3. æ™ºèƒ½é¢„ç®— -->

        <section id="budget" class="tab-content">

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-4 pb-20">

                <div class="lg:col-span-5 space-y-4">

                    <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">

                        <div class="flex items-center gap-2 mb-3 text-blue-600 text-sm font-bold"><i class="ph ph-plus-circle text-lg"></i> æ·»åŠ æ”¯å‡º</div>

                        <div class="flex gap-2">

                            <input type="text" id="custom-item-name" placeholder="é¡¹ç›® (å¦‚:æ»‘é›ªç¥¨)" class="flex-grow bg-gray-50 border-0 rounded-lg px-3 py-2 text-sm ring-1 ring-gray-200 outline-none">

                            <input type="number" id="custom-item-price" placeholder="Â¥" class="w-20 bg-gray-50 border-0 rounded-lg px-3 py-2 text-sm ring-1 ring-gray-200 outline-none">

                            <button onclick="addCustomBudgetItem()" class="bg-blue-600 text-white px-3 rounded-lg hover:bg-blue-700 transition"><i class="ph ph-check-bold"></i></button>

                        </div>

                    </div>

                    <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">

                        <h3 class="font-bold text-gray-800 mb-3 text-sm">åŸºç¡€è®¾å®š</h3>

                        <div class="grid grid-cols-2 gap-3 text-sm">

                            <div><label class="text-xs text-gray-400">äººæ•°</label><input type="number" id="budget-people" value="2" class="w-full mt-1 border rounded p-1.5" onchange="updateDashboard()"></div>

                            <div><label class="text-xs text-gray-400">å¤©æ•°</label><input type="number" id="budget-days" value="1" disabled class="w-full mt-1 bg-gray-50 border rounded p-1.5 text-gray-400"></div>

                            <div><label class="text-xs text-gray-400">ä½å®¿/é—´</label><input type="number" id="price-stay" value="400" class="w-full mt-1 border rounded p-1.5" onchange="updateDashboard()"></div>

                            <div><label class="text-xs text-gray-400">è½¦è´¹/å¤©</label><input type="number" id="price-trans" value="500" class="w-full mt-1 border rounded p-1.5" onchange="updateDashboard()"></div>

                            <div><label class="text-xs text-gray-400">é¤/äºº</label><input type="number" id="price-food" value="150" class="w-full mt-1 border rounded p-1.5" onchange="updateDashboard()"></div>

                            <div><label class="text-xs text-gray-400">é—¨ç¥¨/äºº</label><input type="number" id="price-ticket" value="800" class="w-full mt-1 border rounded p-1.5" onchange="updateDashboard()"></div>

                        </div>

                    </div>

                </div>

                <div class="lg:col-span-7">

                    <div class="bg-gradient-to-br from-blue-600 to-indigo-700 p-5 rounded-3xl shadow-xl text-white relative overflow-hidden">

                        <div class="absolute top-0 right-0 w-40 h-40 bg-white/10 rounded-full blur-3xl -mr-10 -mt-10 pointer-events-none"></div>

                        <div class="mb-4">

                            <h2 class="text-lg font-bold mb-4 opacity-90">é¢„ç®—æ¸…å•</h2>

                            <div id="budget-summary-list" class="space-y-2 text-sm text-blue-50 max-h-[300px] overflow-y-auto custom-scrollbar pr-1"></div>

                        </div>

                        <div class="pt-4 border-t border-white/10 flex justify-between items-end">

                            <div>

                                <div class="text-blue-200 text-xs">é¢„ä¼°æ€»è®¡</div>

                                <div class="text-3xl font-bold mt-1">Â¥<span id="disp-total">0</span></div>

                            </div>

                            <div class="text-right text-blue-200 text-xs">äººå‡: Â¥<span id="disp-avg">0</span></div>

                        </div>

                    </div>

                </div>

            </div>

        </section>



        <!-- 4. å…¨æ™¯çœ‹æ¿ -->

        <section id="data" class="tab-content">

             <div class="grid grid-cols-2 gap-3 mb-4">

                <div class="bg-white p-3 rounded-2xl shadow-sm border border-gray-100 text-center"><div class="text-[10px] text-gray-400">æ€»é¢„ç®—</div><div class="text-lg font-bold text-blue-600">Â¥<span id="dash-total">0</span></div></div>

                <div class="bg-white p-3 rounded-2xl shadow-sm border border-gray-100 text-center"><div class="text-[10px] text-gray-400">è¡Œç¨‹</div><div class="text-lg font-bold text-gray-700"><span id="dash-days">0</span> å¤©</div></div>

                <div class="bg-white p-3 rounded-2xl shadow-sm border border-gray-100 text-center"><div class="text-[10px] text-gray-400">å‡†å¤‡</div><div class="text-lg font-bold text-green-600"><span id="dash-pack">0</span>%</div></div>

                <div class="bg-white p-3 rounded-2xl shadow-sm border border-gray-100 text-center"><div class="text-[10px] text-gray-400">æ»‘é›ªç‚¹</div><div class="text-lg font-bold text-purple-600"><span id="dash-ski-spots">0</span></div></div>

            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 pb-20">

                <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100"><h3 class="text-sm font-bold text-gray-700 mb-2">èµ„é‡‘å æ¯”</h3><div class="h-48"><canvas id="budgetDoughnutChart"></canvas></div></div>

                <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100"><h3 class="text-sm font-bold text-gray-700 mb-2">ç©æ³•åˆ†å¸ƒ</h3><div class="h-48"><canvas id="spotPolarChart"></canvas></div></div>

                <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">

                    <h3 class="text-sm font-bold text-gray-700 mb-2">å¥‡æ™¯é¢„æµ‹ (<span id="temp-val">--20</span>Â°C)</h3>

                    <input type="range" id="temp-slider" min="-40" max="5" value="-20" oninput="updateDashboard()" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer mb-4">

                    <div class="grid grid-cols-2 gap-3 text-xs">

                        <div><div class="text-gray-500 mb-1">æ™¨é›¾</div><div class="font-bold text-gray-800" id="prob-fog">85%</div></div>

                        <div><div class="text-gray-500 mb-1">è“å†°</div><div class="font-bold text-gray-800" id="prob-ice">90%</div></div>

                    </div>

                </div>

            </div>

        </section>



        <!-- 5. è£…å¤‡æ¸…å• -->

        <section id="pack" class="tab-content">

            <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 mb-4">

                <div class="flex items-center gap-4 mb-4">

                    <div class="w-16 h-16 relative flex-shrink-0"><canvas id="packChart"></canvas><div class="absolute inset-0 flex items-center justify-center text-xs font-bold text-blue-600" id="pack-percent-text">0%</div></div>

                    <div class="flex-grow">

                        <h2 class="font-bold text-gray-800">å‡†å¤‡è¿›åº¦</h2>

                        <p class="text-xs text-gray-400 mt-1">å·²é€‰ <span id="pack-checked-count">0</span> / <span id="pack-total-count">0</span></p>

                    </div>

                    <button onclick="exportGearList()" class="bg-blue-50 text-blue-600 p-2 rounded-lg text-xl hover:bg-blue-100 transition"><i class="ph ph-export"></i></button>

                </div>

                <button onclick="addCustomGear()" class="w-full py-2 border border-dashed border-gray-300 rounded-xl text-xs text-gray-500 mb-4 hover:bg-gray-50 transition">+ æ·»åŠ è‡ªå®šä¹‰ç‰©å“</button>

                <div id="gear-container" class="space-y-4 pb-20"></div>

            </div>

        </section>

    </main>



    <!-- Mobile Bottom Navigation -->

    <nav class="md:hidden fixed bottom-0 left-0 w-full bg-white border-t border-gray-200 z-50 flex justify-around items-center pb-safe pt-2 px-1 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">

        <button onclick="switchTab('explore')" class="mobile-nav-btn flex flex-col items-center p-2 text-gray-400 active" data-tab="explore"><i class="ph ph-mountains text-2xl"></i><span class="text-[10px]">ç™¾ç§‘</span></button>

        <button onclick="switchTab('routes')" class="mobile-nav-btn flex flex-col items-center p-2 text-gray-400" data-tab="routes"><i class="ph ph-map-trifold text-2xl"></i><span class="text-[10px]">åœ°å›¾</span></button>

        <button onclick="openAuthModal()" class="flex flex-col items-center justify-center w-12 h-12 bg-blue-600 rounded-full text-white shadow-lg -mt-6 border-4 border-white" title="è´¦æˆ·">

            <i class="ph ph-user text-2xl"></i>

        </button>

        <button onclick="switchTab('budget')" class="mobile-nav-btn flex flex-col items-center p-2 text-gray-400" data-tab="budget"><i class="ph ph-calculator text-2xl"></i><span class="text-[10px]">é¢„ç®—</span></button>

        <button onclick="switchTab('data')" class="mobile-nav-btn flex flex-col items-center p-2 text-gray-400" data-tab="data"><i class="ph ph-chart-pie-slice text-2xl"></i><span class="text-[10px]">ç»Ÿè®¡</span></button>

    </nav>



    <!-- Modal: è‡ªå®šä¹‰æ™¯ç‚¹ -->

    <div id="attraction-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">

        <div class="bg-white rounded-2xl w-full max-w-sm p-5 shadow-2xl animate-[fadeIn_0.2s_ease-out]">

            <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-gray-800">è‡ªå®šä¹‰åœ°ç‚¹</h3><button onclick="closeModal('attraction-modal')" class="text-gray-400"><i class="ph ph-x text-xl"></i></button></div>

            

            <div class="space-y-3">

                <div class="relative group cursor-pointer" onclick="document.getElementById('modal-img-input').click()">

                    <div id="modal-img-preview" class="w-full h-24 bg-gray-100 rounded-lg border-2 border-dashed border-gray-300 flex flex-col items-center justify-center text-gray-400 group-hover:bg-gray-50 group-hover:border-blue-300 transition overflow-hidden">

                        <i class="ph ph-image text-2xl mb-1"></i><span class="text-xs">ç‚¹å‡»æ·»åŠ å°é¢å›¾ç‰‡ (å¯é€‰)</span>

                    </div>

                    <input type="file" id="modal-img-input" accept="image/*" class="hidden" onchange="previewImage(this)">

                </div>

                

                <input type="text" id="modal-name" placeholder="åç§° (å¦‚: éšè—æ‰“å¡ç‚¹)" class="w-full bg-gray-50 border-0 rounded-xl p-3 ring-1 ring-gray-200 outline-none">

                <div class="flex gap-2">

                    <select id="modal-type" class="bg-gray-50 border-0 rounded-xl p-3 ring-1 ring-gray-200 outline-none flex-grow"><option value="custom">âœ¨ ç§è—</option><option value="è‡ªç„¶">ğŸ”ï¸ è‡ªç„¶</option><option value="äººæ–‡">ğŸ•Œ äººæ–‡</option><option value="æ»‘é›ª">ğŸ¿ æ»‘é›ª</option></select>

                    <button onclick="pickLocationFromModal()" class="bg-blue-50 text-blue-600 px-3 rounded-xl text-sm font-medium border border-blue-100 whitespace-nowrap hover:bg-blue-100 transition">ğŸ“ é€‰ä½ç½®</button>

                </div>

                <textarea id="modal-desc" placeholder="å¤‡æ³¨..." class="w-full bg-gray-50 border-0 rounded-xl p-3 ring-1 ring-gray-200 h-20 outline-none resize-none"></textarea>

                <div class="text-xs text-gray-400 text-center" id="modal-coords-display">åæ ‡: æœªè®¾ç½®</div>

            </div>

            <button onclick="saveCustomSpot()" id="save-spot-btn" class="w-full mt-5 bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-blue-500/30 hover:bg-blue-700 transition">ä¿ å­˜</button>

        </div>

    </div>



    <!-- Modal: ç™»å½•/æ³¨å†Œ (Username based) -->

    <div id="auth-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">

        <div class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl animate-[fadeIn_0.2s_ease-out]">

            <div id="auth-info" class="mb-4 hidden">

                <h3 class="text-xl font-bold text-gray-800 mb-2">æ¬¢è¿å›æ¥</h3>

                <p class="text-sm text-gray-600 truncate">è´¦æˆ·: <span id="user-email-display" class="font-medium"></span></p>

                <button onclick="handleSignOut()" class="w-full mt-4 bg-red-500 text-white py-2 rounded-lg hover:bg-red-600 transition">é€€å‡ºç™»å½•</button>

            </div>



            <div id="auth-form">

                <div class="flex justify-between items-center mb-4">

                    <h3 class="text-xl font-bold text-gray-800" id="auth-title">ç™»å½•è´¦æˆ·</h3>

                    <button onclick="closeModal('auth-modal')" class="text-gray-400"><i class="ph ph-x text-xl"></i></button>

                </div>

                <input type="text" id="auth-username" placeholder="è´¦æˆ·å" class="w-full mb-3 bg-gray-50 border-0 rounded-lg p-3 ring-1 ring-gray-200 outline-none">

                <input type="password" id="auth-password" placeholder="å¯†ç  (è‡³å°‘6ä½)" class="w-full mb-3 bg-gray-50 border-0 rounded-lg p-3 ring-1 ring-gray-200 outline-none">

                <input type="password" id="auth-password-confirm" placeholder="ç¡®è®¤å¯†ç " class="w-full mb-3 bg-gray-50 border-0 rounded-lg p-3 ring-1 ring-gray-200 outline-none hidden">

                <p id="auth-error" class="text-red-500 text-xs mb-3"></p>



                <button onclick="handleAuthAction()" id="auth-submit-btn" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 transition">ç™»å½•</button>

                <button onclick="toggleAuthMode()" id="auth-toggle-btn" class="w-full mt-3 text-sm text-blue-600 hover:underline">åˆ‡æ¢åˆ°æ³¨å†Œ</button>

            </div>

        </div>

    </div>



    <!-- Firebase Scripts -->

    <script type="module">

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";

        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        import { getFirestore, doc, setDoc, onSnapshot, collection, query, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        import { getStorage, ref, uploadString, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js"; 

        

        setLogLevel('debug'); // Enable Firestore logging



        // --- DEPLOYMENT CONFIGURATION ---

        

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        

        // 2. Custom Configuration provided by user

        const customFirebaseConfig = {

            // YOUR PROVIDED CONFIGURATION

            apiKey: "AIzaSyAlbsoPG7J2cDocEGisruheVdTaX1Wajgc",

            authDomain: "xinjiang-c95f8.firebaseapp.com",

            projectId: "xinjiang-c95f8",

            storageBucket: "xinjiang-c95f8.appspot.com",

        };



        const configToUse = typeof __firebase_config !== 'undefined' && __firebase_config ? JSON.parse(__firebase_config) : customFirebaseConfig;

        const firebaseConfig = configToUse;

        

        // --- END CONFIGURATION ---



        let app, db, auth, storage; 

        let authMode = 'login'; 

        let currentUserId = null;

        let isAuthReady = false;



        window.openAuthModal = openAuthModal;

        window.toggleAuthMode = toggleAuthMode;

        window.handleAuthAction = handleAuthAction;

        window.handleSignOut = handleSignOut;

        window.saveUserData = saveUserData;

        window.uploadImageAndGetUrl = uploadImageAndGetUrl; 

        

        // Global utility to force all rendering functions to re-run after data load/sync

        window.renderApp = () => {

            if (!window.state.initialized || !window.state.dataLoaded) {

                 document.getElementById('loading-state').classList.remove('hidden');

                 return;

            }

            document.getElementById('loading-state').classList.add('hidden');

            

            // Re-render all major components

            window.renderExploreGrid();

            window.renderDayList();

            window.renderAllSpots();

            window.renderBudget();

            window.renderGear();

            window.updateDashboard(); 

        }



        function getUsernameFromEmail(email) {

            if (!email) return 'N/A';

            const parts = email.split('@');

            return parts[0];

        }



        function updateAuthStateUI(user) {

            const statusEl = document.getElementById('auth-status');

            const headerBadgeEl = document.getElementById('sync-status-badge');

            const infoDiv = document.getElementById('auth-info');

            const formDiv = document.getElementById('auth-form');



            if (user) {

                currentUserId = user.uid;

                const username = getUsernameFromEmail(user.email);

                statusEl.textContent = username;

                headerBadgeEl.textContent = 'å·²åŒæ­¥';

                headerBadgeEl.className = 'text-[10px] text-green-600 bg-green-50 px-1.5 py-0.5 rounded-full border border-green-100 align-middle';

                

                document.getElementById('user-email-display').textContent = username;

                infoDiv.classList.remove('hidden');

                formDiv.classList.add('hidden');

                

            } else {

                currentUserId = null;

                statusEl.textContent = 'ç™»å½•/æ³¨å†Œ';

                headerBadgeEl.textContent = 'éœ€ç™»å½•';

                headerBadgeEl.className = 'text-[10px] text-red-600 bg-red-50 px-1.5 py-0.5 rounded-full border border-red-100 align-middle';

                

                infoDiv.classList.add('hidden');

                formDiv.classList.remove('hidden');

            }

        }



        async function initAuthAndDb() {

            try {

                if (!firebaseConfig.apiKey || !firebaseConfig.projectId) {

                    console.error("Firebase configuration is incomplete. Data synchronization will be disabled.");

                    window.state.initialized = true; 

                    window.state.dataLoaded = true;

                    window.renderApp();

                    return;

                }

                

                app = initializeApp(firebaseConfig);

                auth = getAuth(app);

                db = getFirestore(app);

                storage = getStorage(app); 



                await setPersistence(auth, browserLocalPersistence);



                if (initialAuthToken) {

                    await signInWithCustomToken(auth, initialAuthToken);

                }



                onAuthStateChanged(auth, (user) => {

                    isAuthReady = true;

                    updateAuthStateUI(user);

                    

                    if (user) {

                        setupDataListener(user.uid); // Start real-time sync

                    } else if (!window.state.initialized) {

                        // If not logged in and not initialized, render with defaults

                        window.state.initialized = true;

                        window.state.dataLoaded = true;

                        window.renderApp(); 

                    }

                });



            } catch (error) {

                console.error("Firebase initialization failed:", error);

                window.state.initialized = true;

                window.state.dataLoaded = true;

                window.renderApp();

            }

        }

        

        // --- REALTIME SYNC: onSnapshot ---

        function setupDataListener(userId) {

            const docRef = doc(db, 'artifacts', appId, 'users', userId, 'data', 'state');

            onSnapshot(docRef, (docSnap) => {

                if (docSnap.exists()) {

                    // Load and parse data

                    const data = docSnap.data();

                    // Load custom spots and combine with default spots

                    window.state.spots = [...window.defaultSpots, ...(data.spots || [])]; 

                    // Parse itinerary string back to array

                    try {

                        // Ensure itinerary has correct shape, even if saved as []

                        const loadedItinerary = JSON.parse(data.itinerary);

                        window.state.itinerary = loadedItinerary.length > 0 ? loadedItinerary : [[]];

                    } catch {

                        window.state.itinerary = [[]]; // Fallback if parsing fails

                    }

                    window.state.customBudget = data.customBudget || [];

                    window.state.customGear = data.customGear || [];

                } else {

                    // Document doesn't exist, create it with defaults

                    saveUserData(); // This will auto-sync back via onSnapshot

                }



                if (!window.state.initialized) {

                    window.state.initialized = true;

                }

                window.state.dataLoaded = true;

                window.renderApp(); // Global re-render trigger

                console.log("Firestore Data Synced and App Rendered.");

            }, (error) => {

                console.error("Firestore Listener Error:", error);

                window.state.dataLoaded = true; 

                window.renderApp();

            });

        }

        

        async function uploadImageAndGetUrl(base64Data, userId) {

            if (!storage || !base64Data || !userId) return null;

            

            // Use the AUTH UID as the directory name

            const path = `images/${userId}/${Date.now()}.jpeg`;

            const storageRef = ref(storage, path);



            try {

                await uploadString(storageRef, base64Data, 'data_url');

                const url = await getDownloadURL(storageRef);

                return url;

            } catch (error) {

                console.error("Error uploading image to Storage:", error);

                return null;

            }

        }



        async function saveUserData() {

            if (!currentUserId || !isAuthReady || !db) {

                console.warn("Save skipped: User not authenticated or DB not ready.");

                return;

            }



            try {

                const docRef = doc(db, 'artifacts', appId, 'users', currentUserId, 'data', 'state');

                const dataToSave = {

                    // Only save custom spots (id > 1000)

                    spots: window.state.spots.filter(s => s.id > 1000), 

                    // Stringify itinerary (to comply with array-in-array Firestore limitations if any)

                    itinerary: JSON.stringify(window.state.itinerary), 

                    customBudget: window.state.customBudget,

                    customGear: window.state.customGear,

                    lastSave: new Date().toISOString()

                };



                await setDoc(docRef, dataToSave, { merge: true });

                

            } catch (e) {

                console.error("Error writing document: ", e);

            }

        }



        // --- AUTH UI HANDLERS ---

        function openAuthModal() {

            document.getElementById('auth-modal').classList.remove('hidden');

        }

        

        function closeModal(id) {

            document.getElementById(id).classList.add('hidden');

        }



        function toggleAuthMode() {

            const title = document.getElementById('auth-title');

            const submitBtn = document.getElementById('auth-submit-btn');

            const toggleBtn = document.getElementById('auth-toggle-btn');

            const confirmPass = document.getElementById('auth-password-confirm');

            const errorEl = document.getElementById('auth-error');

            errorEl.textContent = '';



            if (authMode === 'login') {

                authMode = 'register';

                title.textContent = 'æ³¨å†Œæ–°è´¦æˆ·';

                submitBtn.textContent = 'æ³¨å†Œ';

                toggleBtn.textContent = 'å·²æœ‰è´¦æˆ·ï¼Ÿåˆ‡æ¢åˆ°ç™»å½•';

                confirmPass.classList.remove('hidden');

            } else {

                authMode = 'login';

                title.textContent = 'ç™»å½•è´¦æˆ·';

                submitBtn.textContent = 'ç™»å½•';

                toggleBtn.textContent = 'æ²¡æœ‰è´¦æˆ·ï¼Ÿåˆ‡æ¢åˆ°æ³¨å†Œ';

                confirmPass.classList.add('hidden');

            }

        }



        async function handleAuthAction() {

            const username = document.getElementById('auth-username').value;

            const password = document.getElementById('auth-password').value;

            const confirmPassword = document.getElementById('auth-password-confirm').value;

            const errorEl = document.getElementById('auth-error');

            errorEl.textContent = '';



            if (!username || password.length < 6) {

                errorEl.textContent = 'è´¦æˆ·åä¸èƒ½ä¸ºç©ºï¼Œå¯†ç è‡³å°‘6ä½ã€‚';

                return;

            }



            if (authMode === 'register' && password !== confirmPassword) {

                errorEl.textContent = 'ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´ã€‚';

                return;

            }



            // Construct Firebase-compatible email 

            const email = `${username}@${firebaseConfig.authDomain.split('.').slice(0, -2).join('.')}.canvas.local`;



            try {

                if (authMode === 'register') {

                    await createUserWithEmailAndPassword(auth, email, password);

                    // Use console.log for success instead of alert

                    console.log(`è´¦æˆ· ${username} æ³¨å†ŒæˆåŠŸï¼`); 

                } else {

                    await signInWithEmailAndPassword(auth, email, password);

                }

                

                document.getElementById('auth-modal').classList.add('hidden');



            } catch (error) {

                let errorMessage = 'è®¤è¯å¤±è´¥ã€‚';

                if (error.code === 'auth/email-already-in-use') errorMessage = 'è¯¥è´¦æˆ·åå·²è¢«æ³¨å†Œã€‚';

                if (error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') errorMessage = 'è´¦æˆ·åæˆ–å¯†ç é”™è¯¯ã€‚';

                if (error.code === 'auth/unauthorized-domain') {

                    errorMessage += ' éƒ¨ç½²å¤±è´¥ã€‚è¯·æ£€æŸ¥ï¼šæ‚¨æ˜¯å¦å·²å°†å½“å‰åŸŸåæ·»åŠ åˆ° Firebase æ§åˆ¶å°çš„ [Authentication -> Settings -> Authorized domains] åˆ—è¡¨ä¸­?';

                }

                errorEl.textContent = errorMessage;

                console.error("Auth Error:", error);

            }

        }



        async function handleSignOut() {

            try {

                await signOut(auth);

                console.log("æ‚¨å·²é€€å‡ºç™»å½•ã€‚"); // Removed alert

                document.getElementById('auth-modal').classList.add('hidden');

                // Reload to reset local state to default, which will then use dataLoaded=true to render defaults

                window.location.reload(); 

            } catch (error) {

                console.error("Sign Out Error:", error);

            }

        }



        initAuthAndDb();



    </script>

    <script>

        // --- æ ¸å¿ƒæ•°æ® (Global State) ---

        const defaultSpots = [

            { id: 1, name: "ä¹Œé²æœ¨é½", type: "äººæ–‡", desc: "é¦–åºœ", x: 500, y: 300, tags: ["ä¸­è½¬"], img: null },

            { id: 2, name: "ç¦¾æœ¨æ‘", type: "è‡ªç„¶", desc: "æ™¨é›¾", x: 450, y: 100, tags: ["æ‘„å½±"], img: null },

            { id: 3, name: "å–€çº³æ–¯", type: "è‡ªç„¶", desc: "æ¹–æ€ª", x: 400, y: 80, tags: ["å¾’æ­¥"], img: null },

            { id: 4, name: "èµ›é‡Œæœ¨æ¹–", type: "è‡ªç„¶", desc: "è“å†°", x: 200, y: 350, tags: ["è‡ªé©¾"], img: null },

            { id: 5, name: "å–€ä»€å¤åŸ", type: "äººæ–‡", desc: "å¤åŸ", x: 100, y: 800, tags: ["ç¾é£Ÿ"], img: null },

            { id: 6, name: "å¯å¯æ‰˜æµ·", type: "æ»‘é›ª", desc: "æ»‘é›ª", x: 600, y: 150, tags: ["æé™"], img: null },

        ];

        window.defaultSpots = defaultSpots;



        const defaultGear = {

            "æ ¸å¿ƒä¿æš–": ["ç¾½ç»’æœ", "å†²é”‹è¡£", "ä¿æš–å†…è¡£", "ç¾Šæ¯›è¢œ", "é›ªåœ°é´"],

            "æ»‘é›ªè£…å¤‡": ["å¤´ç›”", "é›ªé•œ", "æŠ¤è„¸", "æ‰‹å¥—", "æŠ¤å…·"],

        };



        window.state = {

            spots: [...defaultSpots], itinerary: [[]], currentDayIndex: 0,

            customBudget: [], customGear: [], weatherTemp: -20,

            isPickingMode: false, mapScale: 1, mapOffset: {x:0,y:0}, isDragging: false, startDrag: {x:0,y:0}, tempSpotData: null,

            initialized: false, // Initialized Firebase/Auth

            dataLoaded: false // Data successfully loaded from Firestore or defaulted

        };

        

        let saveTimeout;

        function debounceSave() {

            clearTimeout(saveTimeout);

            saveTimeout = setTimeout(() => {

                if (window.saveUserData) window.saveUserData();

            }, 1500);

        }



        // Global Chart Variables

        let budgetChart, polarChart, packChart;

        let currentModalImageBase64 = null; 

        

        // --- Modal Control ---

        window.closeModal = (id) => {

            document.getElementById(id).classList.add('hidden');

        }



        // --- 1. Map Engine ---

        function initMapEvents() {

            const w = document.getElementById('map-wrapper');

            w.addEventListener('wheel', e => { e.preventDefault(); zoomMap(e.deltaY>0?0.9:1.1); });

            w.addEventListener('mousedown', e => { 

                state.isDragging=true; 

                state.startDrag={x:e.clientX,y:e.clientY}; 

                w.style.cursor='grabbing'; 

                if(state.isPickingMode) handleMapClick(e.clientX, e.clientY, w); 

            });

            window.addEventListener('mousemove', e => { if(state.isDragging) handleDrag(e.clientX, e.clientY); handleMapHover(e); });

            window.addEventListener('mouseup', () => { state.isDragging=false; w.style.cursor=state.isPickingMode?'crosshair':'grab'; });

            w.addEventListener('touchstart', e => { if(e.touches.length === 1) { state.isDragging=true; state.startDrag={x:e.touches[0].clientX, y:e.touches[0].clientY}; } }, {passive: false});

            w.addEventListener('touchmove', e => { if(state.isDragging && e.touches.length === 1) { e.preventDefault(); handleDrag(e.touches[0].clientX, e.touches[0].clientY); } }, {passive: false});

            w.addEventListener('touchend', () => { state.isDragging=false; });

        }

        function handleDrag(cx, cy) {

            const dx = cx - state.startDrag.x, dy = cy - state.startDrag.y;

            state.mapOffset.x += dx; state.mapOffset.y += dy;

            state.startDrag = {x:cx, y:cy};

            renderMap();

        }

        function zoomMap(factor) { 

            const ns = state.mapScale * factor; 

            if(ns > 0.2 && ns < 5) { 

                state.mapScale = ns; 

                renderMap(); 

            } 

        }

        function resetMapView() { state.mapScale=1; state.mapOffset={x:0,y:0}; renderMap(); }

        

        function renderMap() {

            const cvs=document.getElementById('route-canvas'), ctx=cvs.getContext('2d'), w=document.getElementById('map-wrapper');

            cvs.width=w.offsetWidth; cvs.height=w.offsetHeight; ctx.clearRect(0,0,cvs.width,cvs.height);

            // Translate/Scale/Zoom setup

            ctx.save(); 

            ctx.translate(cvs.width/2 + state.mapOffset.x, cvs.height/2 + state.mapOffset.y); 

            ctx.scale(state.mapScale, state.mapScale); 

            ctx.translate(-cvs.width/2, -cvs.height/2);

            

            const vs=1000, stX=(cvs.width-vs)/2, stY=(cvs.height-vs)/2;

            

            // Draw routes

            state.itinerary.forEach((dS,di)=>{

                if(dS.length<2)return; 

                ctx.beginPath(); 

                ctx.strokeStyle = di === state.currentDayIndex ? '#2563EB' : '#CBD5E1'; 

                ctx.lineWidth = di === state.currentDayIndex ? 4 / state.mapScale : 2 / state.mapScale; 

                ctx.setLineDash(di === state.currentDayIndex ? [] : [5/state.mapScale, 5/state.mapScale]);

                dS.forEach((id,idx)=>{const s=state.spots.find(sp=>sp.id===id); if(s) idx===0?ctx.moveTo(stX+s.x,stY+s.y):ctx.lineTo(stX+s.x,stY+s.y);}); 

                ctx.stroke();

            });

            

            // Draw spots

            state.spots.forEach(s=>{

                const cx=stX+s.x, cy=stY+s.y, act=state.itinerary[state.currentDayIndex].includes(s.id);

                ctx.beginPath(); 

                ctx.arc(cx, cy, (act ? 8 : 5) / Math.sqrt(state.mapScale), 0, Math.PI*2); 

                ctx.fillStyle = act ? '#2563EB' : '#94A3B8'; 

                ctx.fill();

                if(act || state.mapScale > 1.5) { 

                    ctx.fillStyle='#334155'; 

                    ctx.font=`${12/state.mapScale}px sans-serif`; 

                    ctx.fillText(s.name, cx + 10 / state.mapScale, cy + 4 / state.mapScale); 

                }

            });

            ctx.restore();

        }

        

        function handleMapClick(cx, cy, w){

            const rect=w.getBoundingClientRect();

            const vs=1000, stX=(w.offsetWidth-vs)/2, stY=(w.offsetHeight-vs)/2;

            const mx=cx-rect.left, my=cy-rect.top;

            const vx=(mx-w.offsetWidth/2-state.mapOffset.x)/state.mapScale+w.offsetWidth/2-stX;

            const vy=(my-w.offsetHeight/2-state.mapOffset.y)/state.mapScale+w.offsetHeight/2-stY;

            

            if(!state.tempSpotData) state.tempSpotData={}; 

            state.tempSpotData.x=vx; 

            state.tempSpotData.y=vy;

            

            state.isPickingMode=false; 

            document.getElementById('map-wrapper').style.cursor = 'grab';

            window.openAttractionModal(false); // Open modal to finish adding spot

        }

        

        function handleMapHover(e) {

            const tip=document.getElementById('map-tooltip'); 

            if(state.isPickingMode || state.isDragging){ tip.classList.add('hidden'); return; }

            

            const w=document.getElementById('map-wrapper'), rect=w.getBoundingClientRect();

            const mx=e.clientX-rect.left, my=e.clientY-rect.top;

            const cx=w.offsetWidth/2+state.mapOffset.x, cy=w.offsetHeight/2+state.mapOffset.y;

            const stX=(w.offsetWidth-1000)/2, stY=(w.offsetHeight-1000)/2;

            

            const h=state.spots.find(s=>{

                // Calculate scaled/translated spot coordinates on screen

                const sx=cx+(stX+s.x-w.offsetWidth/2)*state.mapScale, 

                      sy=cy+(stY+s.y-w.offsetHeight/2)*state.mapScale;

                // Check if mouse is near the spot (adjusting for scale)

                const hitRadius = 10 / Math.sqrt(state.mapScale);

                return Math.abs(sx - mx) < hitRadius && Math.abs(sy - my) < hitRadius;

            });

            

            if(h){ 

                tip.style.left=(mx+15)+'px'; 

                tip.style.top=my+'px'; 

                tip.innerText=h.name; 

                tip.classList.remove('hidden'); 

            } else {

                tip.classList.add('hidden');

            }

        }



        // --- 2. Explore & Route Logic ---

        window.renderExploreGrid = () => {

            const g=document.getElementById('explore-grid'), 

                  t=document.getElementById('explore-search').value.toLowerCase(), 

                  f=document.getElementById('explore-filter').value; 

            g.innerHTML='';

            

            state.spots.forEach(s=>{

                if((s.name.toLowerCase().includes(t)||s.tags.join('').includes(t))&&(f==='all'||(f==='custom'?s.id>1000:s.type===f))){

                    const div=document.createElement('div'); 

                    div.className="bg-white rounded-xl shadow-sm p-3 border border-gray-100 flex flex-col justify-between";

                    

                    let imageHtml = s.img && s.img.startsWith('http') ? 

                        `<img src="${s.img}" onerror="this.onerror=null;this.src='https://placehold.co/100x100/A0AEC0/ffffff?text=Image+Load+Fail';" class="w-full h-24 object-cover rounded-lg mb-2">` : 

                        `<div class="w-full h-24 bg-gray-100 flex items-center justify-center text-gray-400 rounded-lg mb-2"><i class="ph ph-map-pin"></i></div>`;



                    div.innerHTML=`

                        ${imageHtml}

                        <div><div class="flex justify-between"><h3 class="font-bold text-gray-800">${s.name}</h3><span class="text-[10px] bg-gray-100 px-1.5 py-0.5 rounded text-gray-500">${s.type}</span></div><p class="text-xs text-gray-400 mt-1">${s.desc||''}</p></div><button onclick="addToRoute(${s.id})" class="mt-3 w-full bg-blue-50 text-blue-600 text-xs py-2 rounded font-medium hover:bg-blue-100 transition">åŠ å…¥è¡Œç¨‹</button>`;

                    g.appendChild(div);

                }

            });

            updateDashboard();

        }

        

        function addToRoute(id){ 

            if (!state.itinerary[state.currentDayIndex]) {

                state.itinerary.push([]);

            }

            state.itinerary[state.currentDayIndex].push(id); 

            renderDayList(); 

            debounceSave(); 

        }

        

        window.renderDayList = () => {

            const l=document.getElementById('day-list'); 

            l.innerHTML=''; 

            

            // Ensure itinerary has at least one day

            if (state.itinerary.length === 0) {

                state.itinerary.push([]);

                state.currentDayIndex = 0;

            }



            document.getElementById('budget-days').value=state.itinerary.length; 

            

            state.itinerary.forEach((s,i)=>{

                const div=document.createElement('div'); 

                div.className=`flex-shrink-0 lg:flex-shrink w-20 lg:w-full p-2 lg:p-3 rounded-xl border border-gray-100 cursor-pointer text-center lg:text-left transition-all ${i===state.currentDayIndex?'bg-blue-50 border-blue-200 text-blue-700':'hover:bg-gray-50 text-gray-500'}`;

                div.innerHTML=`<div class="font-bold text-xs">D${i+1}</div><div class="text-[10px] opacity-70">${s.length}ç‚¹</div>`;

                div.onclick=()=>{state.currentDayIndex=i;renderDayList();}; 

                l.appendChild(div);

            });

            

            document.getElementById('current-day-num').innerText=state.currentDayIndex+1;

            document.getElementById('day-spot-count').innerText=state.itinerary[state.currentDayIndex].length;

            renderDaySpots(); 

            renderMap();

        }

        

        function addDay(){ 

            state.itinerary.push([]); 

            state.currentDayIndex=state.itinerary.length-1; 

            renderDayList(); 

            debounceSave(); 

        }

        

        function renderDaySpots() {

            const desktopL=document.getElementById('day-spots-list-desktop'), 

                  mobileL=document.getElementById('day-spots-list-mobile');

            const html = state.itinerary[state.currentDayIndex].map((id,i)=>{

                const s=state.spots.find(sp=>sp.id===id); 

                if(!s)return'';

                return `<div class="flex justify-between items-center p-2 bg-gray-50 rounded"><span class="truncate">${i+1}. ${s.name}</span><button onclick="rmSpot(${i})" class="text-red-400 px-2 hover:text-red-600">Ã—</button></div>`;

            }).join('');

            desktopL.innerHTML=html; 

            mobileL.innerHTML=html;

        }

        

        function rmSpot(i){

            state.itinerary[state.currentDayIndex].splice(i,1); 

            renderDayList(); 

            debounceSave();

        }

        

        window.renderAllSpots = () => {

            const l=document.getElementById('all-spots-list'), t=document.getElementById('spot-search').value.toLowerCase(); 

            l.innerHTML='';

            state.spots.filter(s=>s.name.toLowerCase().includes(t)).forEach(s=>{

                const b=document.createElement('button'); 

                b.className="w-full text-left p-2 hover:bg-gray-50 text-xs text-gray-600 flex justify-between rounded transition";

                b.innerHTML=`<span>${s.name}</span><span class="text-blue-500 font-bold">+</span>`; 

                b.onclick=()=>{addToRoute(s.id)}; 

                l.appendChild(b);

            });

        }

        

        // --- Custom Spot Logic ---

        function previewImage(input) {

            if (input.files && input.files[0]) {

                const reader = new FileReader();

                reader.onload = function(e) {

                    document.getElementById('modal-img-preview').innerHTML = `<img src="${e.target.result}" class="w-full h-full object-cover rounded-lg">`;

                    currentModalImageBase64 = e.target.result;

                }

                reader.readAsDataURL(input.files[0]);

            }

        }

        

        window.openAttractionModal = (reset = true) => {

            document.getElementById('attraction-modal').classList.remove('hidden'); 

            if(reset){

                document.getElementById('modal-name').value=''; 

                document.getElementById('modal-name').classList.remove('ring-red-500', 'ring-2'); // Clear feedback

                state.tempSpotData=null; 

                document.getElementById('modal-desc').value='';

                document.getElementById('modal-coords-display').innerText='åæ ‡: æœªè®¾ç½®';

                currentModalImageBase64 = null;

                document.getElementById('modal-img-input').value = '';

                document.getElementById('modal-img-preview').innerHTML = `<i class="ph ph-image text-2xl mb-1"></i><span class="text-xs">ç‚¹å‡»æ·»åŠ å°é¢å›¾ç‰‡ (å¯é€‰)</span>`;



            } else if(state.tempSpotData?.x) {

                document.getElementById('modal-coords-display').innerText=`åæ ‡: X:${Math.round(state.tempSpotData.x)}, Y:${Math.round(state.tempSpotData.y)}`;

            }

        }

        

        function pickLocationFromModal(){

            state.tempSpotData={name:document.getElementById('modal-name').value}; 

            state.isPickingMode=true; 

            document.getElementById('attraction-modal').classList.add('hidden'); 

            switchTab('routes'); 

            document.getElementById('map-wrapper').style.cursor = 'crosshair';

            console.log("åœ°ç‚¹é€‰å–æ¨¡å¼å·²å¼€å¯ï¼Œè¯·ç‚¹å‡»åœ°å›¾ä¸Šçš„ä½ç½®ã€‚"); // Replaced alert

        }

        

        async function saveCustomSpot(){

            const nameInput = document.getElementById('modal-name');

            const n=nameInput.value;

            const saveBtn = document.getElementById('save-spot-btn');

            

            // --- FIX 1: Visual feedback for missing name ---

            if(!n || n.trim() === '') {

                nameInput.classList.add('ring-red-500', 'ring-2'); // Visual feedback

                setTimeout(() => nameInput.classList.remove('ring-red-500', 'ring-2'), 1000);

                console.error("ä¿å­˜å¤±è´¥: è¯·è¾“å…¥åœ°ç‚¹åç§°ã€‚"); // Console error

                return;

            }

            nameInput.classList.remove('ring-red-500', 'ring-2'); // Clear feedback



            let imageUrl = null;

            if (currentModalImageBase64 && window.uploadImageAndGetUrl) {

                if (!window.currentUserId) {

                    // Although we removed alert, for critical blocking issues like this, we should notify the user.

                    console.error("å›¾ç‰‡ä¸Šä¼ å¤±è´¥: è¯·å…ˆç™»å½•è´¦æˆ· (æˆ–æ³¨å†Œ) æ‰èƒ½ä¸Šä¼ å›¾ç‰‡ã€‚");

                    return; 

                }



                saveBtn.innerHTML = '<i class="ph ph-spinner-gap animate-spin"></i> ä¸Šä¼ ä¸­...';

                saveBtn.disabled = true;



                const userId = window.currentUserId; 

                imageUrl = await window.uploadImageAndGetUrl(currentModalImageBase64, userId);

                

                saveBtn.innerHTML = 'ä¿ å­˜';

                saveBtn.disabled = false;



                // --- FIX 2: Check for upload failure and return before creating spot ---

                if (!imageUrl) {

                    console.error("å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼Œè¯·æ£€æŸ¥ Firebase Storage é…ç½®å’Œå®‰å…¨è§„åˆ™ã€‚");

                    return;

                }

            }

            

            // --- Spot Creation ---

            const newSpot = {

                id:Date.now(), // Unique ID > 1000 for custom spots

                name:n, 

                type:document.getElementById('modal-type').value, 

                desc:document.getElementById('modal-desc').value, 

                x:state.tempSpotData?.x||500, 

                y:state.tempSpotData?.y||500, 

                tags:[],

                img: imageUrl

            };



            state.spots.push(newSpot);

            

            currentModalImageBase64 = null;

            closeModal('attraction-modal');

            

            // --- FIX 3: Add successful local visual feedback ---

            saveBtn.innerText = 'ä¿å­˜æˆåŠŸï¼';

            saveBtn.classList.remove('bg-blue-600');

            saveBtn.classList.add('bg-green-600');

            setTimeout(() => {

                saveBtn.innerText = 'ä¿ å­˜';

                saveBtn.classList.remove('bg-green-600');

                saveBtn.classList.add('bg-blue-600');

            }, 1500);



            // --- Triggers renderApp via debounceSave -> saveUserData -> onSnapshot ---

            debounceSave();

            

        }

        

        // --- 3. Budget & Gear ---

        window.addCustomBudgetItem = () => {

            const itemName = document.getElementById('custom-item-name').value.trim();

            const itemPrice = parseFloat(document.getElementById('custom-item-price').value);



            if (itemName && itemPrice && itemPrice > 0) {

                window.state.customBudget.push({

                    name: itemName,

                    price: itemPrice

                });

                document.getElementById('custom-item-name').value = '';

                document.getElementById('custom-item-price').value = '';

                updateDashboard(); // Triggers renderBudget/save

            } else {

                console.error("è¯·è¾“å…¥æœ‰æ•ˆçš„é¡¹ç›®åç§°å’Œä»·æ ¼ã€‚");

            }

        }

        

        window.renderBudget = () => {

            const p=parseInt(document.getElementById('budget-people').value)||1, 

                  d=parseInt(document.getElementById('budget-days').value)||1;

            const stay=parseFloat(document.getElementById('price-stay').value)||0, 

                  trans=parseFloat(document.getElementById('price-trans').value)||0;

            const food=parseFloat(document.getElementById('price-food').value)||0, 

                  ticket=parseFloat(document.getElementById('price-ticket').value)||0;

                  

            const tStay=(stay*Math.ceil(p/2))*(d-1), 

                  tTrans=trans*d, 

                  tMisc=(food*p*d)+(ticket*p);

            

            let listHtml=`<div class="flex justify-between items-center p-2 bg-white/10 rounded-lg border border-white/10"><span>ğŸ¨ ä½å®¿ (${stay} x ${d-1} æ™š)</span><span class="font-mono font-bold">Â¥<span id="disp-stay">${tStay}</span></span></div>`;

            listHtml+=`<div class="flex justify-between items-center p-2 bg-white/10 rounded-lg border border-white/10"><span>ğŸš— äº¤é€š (${trans} x ${d} å¤©)</span><span class="font-mono font-bold">Â¥<span id="disp-trans">${tTrans}</span></span></div>`;

            listHtml+=`<div class="flex justify-between items-center p-2 bg-white/10 rounded-lg border border-white/10"><span>ğŸ¥˜ é£Ÿ/ç¥¨ (${p} äºº)</span><span class="font-mono font-bold">Â¥<span id="disp-misc">${tMisc}</span></span></div>`;

            

            let tCustom=0;

            state.customBudget.forEach((i,x)=>{ 

                tCustom+=i.price; 

                listHtml+=`<div class="flex justify-between items-center p-2 bg-orange-500/20 rounded-lg border border-orange-500/30 text-orange-100 budget-item-enter relative group"><span>âœ¨ ${i.name}</span><div class="flex items-center gap-2"><span class="font-mono font-bold">Â¥${i.price.toLocaleString()}</span><button onclick="removeBudgetItem(${x})" class="text-white/70 hover:text-white transition"><i class="ph ph-trash"></i></button></div></div>`; 

            });

            listHtml+=`<span id="disp-custom" style="display:none">${tCustom}</span>`;



            document.getElementById('budget-summary-list').innerHTML=listHtml;

            const total=tStay+tTrans+tMisc+tCustom;

            document.getElementById('disp-total').innerText=total.toLocaleString();

            document.getElementById('disp-avg').innerText=Math.round(total/p).toLocaleString();

            

            debounceSave(); // Save after recalculation

        }

        

        function removeBudgetItem(i){

            state.customBudget.splice(i,1); 

            updateDashboard(); // Triggers renderBudget/save

        }

        

        window.renderGear = () => {

            const c=document.getElementById('gear-container'); 

            c.innerHTML='';

            

            let cats={...defaultGear}; 

            if(state.customGear.length) {

                 // Convert customGear array to an object property

                 cats["è‡ªå®šä¹‰ç‰©å“"] = state.customGear;

            }

            

            for(const [k,v] of Object.entries(cats)){

                let itemsHtml = '';

                // Handle both simple string arrays (defaultGear) and objects (customGear, if saved with old format)

                const items = Array.isArray(v) ? v : Object.values(v); 



                items.forEach(i => {

                    // Check local state for checked items (simulating persistent check state)

                    const isChecked = localStorage.getItem(`gear_${i}`) === 'true';

                    itemsHtml += `<label class="flex items-center space-x-2 text-xs text-gray-500 hover:bg-gray-50 p-1 rounded transition cursor-pointer"><input type="checkbox" class="rounded text-blue-600 w-4 h-4 gear-check" data-item="${i}" ${isChecked ? 'checked' : ''} onchange="updateGearStats(this); debounceSave();"><span>${i}</span></label>`;

                });



                c.innerHTML+=`<div><h4 class="font-bold text-gray-700 text-sm mb-2 border-l-4 border-blue-500 pl-2">${k}</h4><div class="space-y-2">${itemsHtml}</div></div>`;

            }

            updateGearStats();

        }

        

        // This function handles checkbox state and updates stats

        function updateGearStats(checkbox = null){

            if (checkbox) {

                // Save/update state in localStorage when a checkbox changes

                localStorage.setItem(`gear_${checkbox.dataset.item}`, checkbox.checked);

            }

            

            const checks = document.querySelectorAll('.gear-check');

            const t = checks.length;

            const c = Array.from(checks).filter(ch => ch.checked).length;

            

            document.getElementById('pack-checked-count').innerText=c; 

            document.getElementById('pack-total-count').innerText=t;

            

            const percent = (t ? Math.round(c/t*100) : 0);

            document.getElementById('pack-percent-text').innerText=percent + '%';

            

            // Update Dashboard and Charts

            if(packChart){packChart.data.datasets[0].data=[c,t-c]; packChart.update();}

            document.getElementById('dash-pack').innerText = percent;

        }

        

        window.addCustomGear = () => {

            const n = window.prompt("è¯·è¾“å…¥æ–°çš„è£…å¤‡åç§°:"); 

            if (n && n.trim()) {

                window.state.customGear.push(n.trim()); 

                window.renderGear(); // Renders the gear list (which includes the new item)

                debounceSave();

            }

        }

        

        // Export logic (placeholder)

        window.exportGearList = () => {

            console.log("Exporting gear list...");

            // FIX: Removed alert

            console.log("æ¸…å•å·²å‡†å¤‡å¥½å¯¼å‡ºï¼(åŠŸèƒ½å¾…å®ç°)");

        }



        // --- 4. Utility ---

        window.updateCharts = () => {

            // Get calculated totals from the Budget tab

            const s=parseInt(document.getElementById('disp-stay').innerText.replace(/,/g,'') || 0), 

                  tr=parseInt(document.getElementById('disp-trans').innerText.replace(/,/g,'') || 0), 

                  m=parseInt(document.getElementById('disp-misc').innerText.replace(/,/g,'') || 0), 

                  c=parseInt(document.getElementById('disp-custom').innerText.replace(/,/g,'') || 0);



            // Budget Doughnut Chart

            if (budgetChart) {

                budgetChart.data.datasets[0].data=[s,tr,m,c]; 

                budgetChart.update();

            }

            

            // Polar Area Chart (Spot types)

            const ids = state.itinerary.flat(), 

                  sp = ids.map(id => state.spots.find(s=>s.id===id)).filter(s=>s);

            

            if (polarChart) {

                polarChart.data.datasets[0].data=[

                    sp.filter(s=>s.type==='è‡ªç„¶').length,

                    sp.filter(s=>s.type==='äººæ–‡').length,

                    sp.filter(s=>s.type==='æ»‘é›ª').length,

                    sp.filter(s=>s.type==='custom').length

                ]; 

                polarChart.update();

            }

            

            // Weather Prediction

            const temp = parseInt(document.getElementById('temp-slider').value) || -20;

            document.getElementById('temp-val').innerText = temp;

            document.getElementById('prob-fog').innerText = `${Math.min(99, Math.max(20, 100 + temp * 2))}%`;

            document.getElementById('prob-ice').innerText = `${Math.min(99, Math.max(10, 100 + temp * 3))}%`;

        }



        window.updateDashboard = () => {

            renderBudget(); // Must run first to calculate totals

            

            const t=document.getElementById('disp-total').innerText;

            document.getElementById('dash-total').innerText=t;

            document.getElementById('dash-days').innerText=state.itinerary.length;

            

            // Pack % is updated by updateGearStats() which is called by renderGear()

            updateGearStats(); 

            

            document.getElementById('dash-ski-spots').innerText=state.itinerary.flat().map(id=>state.spots.find(s=>s.id===id)).filter(s=>s&&s.type==='æ»‘é›ª').length;

            window.updateCharts();

            

            // Debounce save is called inside renderBudget and updateGearStats

        }

        

        window.initCharts = () => {

            // Initialize once to prevent re-creation errors

            if (!budgetChart) {

                budgetChart=new Chart(document.getElementById('budgetDoughnutChart'),{type:'doughnut',data:{labels:['ä½','è¡Œ','é£Ÿ','è‡ª'],datasets:[{data:[1,1,1,1],backgroundColor:['#3B82F6','#10B981','#8B5CF6','#F97316'],borderWidth:0}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right',labels:{boxWidth:10}}}}});

            }

            if (!polarChart) {

                polarChart=new Chart(document.getElementById('spotPolarChart'),{type:'polarArea',data:{labels:['è‡ªç„¶','äººæ–‡','æ»‘é›ª','è‡ªå®š'],datasets:[{data:[1,1,1,0],backgroundColor:['#38BDF8aa','#A78BFAaa','#F97316aa','#FBBF24aa'],borderWidth:0}]},options:{responsive:true,maintainAspectRatio:false,scales:{r:{ticks:{display:false}}},plugins:{legend:{position:'right',labels:{boxWidth:10}}}}});

            }

            if (!packChart) {

                packChart=new Chart(document.getElementById('packChart'),{type:'doughnut',data:{datasets:[{data:[0,1],backgroundColor:['#2563EB','#E5E7EB'],borderWidth:0,cutout:'85%'}]},options:{responsive:true,maintainAspectRatio:false,plugins:{tooltip:{enabled:false}}}});

            }

        }

        

        function switchTab(id) {

            document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active'));

            document.getElementById(id).classList.add('active');

            document.querySelectorAll('.mobile-nav-btn').forEach(b=>b.classList.toggle('active', b.dataset.tab===id));

            document.querySelectorAll('.nav-btn').forEach(b=>b.classList.toggle('bg-white', b.dataset.tab===id));

            

            if(id==='routes') setTimeout(renderMap,100);

            if(id==='data') updateDashboard();

            if(id==='pack') renderGear(); // Force render pack list on tab switch

            

            window.scrollTo(0,0);

        }



        // --- Initial Callbacks ---

        window.onload = () => {

            window.initCharts();

            initMapEvents();

            // Initial rendering is now handled by the Firebase onAuthStateChanged and onSnapshot listeners

        }

    </script>

</body>

</html>æŠŠä»¥ä¸‹å†…å®¹ æ›´æ–°ä¸Šå» ä»¥ä¸‹æ˜¯ä¸ºä½ å‡†å¤‡çš„æºç æ”¹é€ æç¤ºè¯ï¼ŒåŒ…å«æ‰€æœ‰å¿…è¦çš„å…³é”®ç‚¹ï¼š

ğŸ’» æºç æ”¹é€ æç¤ºè¯ï¼šé›†æˆé«˜å¾·åœ°å›¾ä¸å¯¼èˆªåŠŸèƒ½

ç›®æ ‡ï¼š å°†ç°æœ‰çš„ Canvas è‡ªç»˜åœ°å›¾æ›¿æ¢ä¸ºé«˜å¾·åœ°å›¾ JS APIï¼Œå¹¶å®ç°æ™¯ç‚¹ç‚¹å‡»è·³è½¬é«˜å¾· App å¯¼èˆªåŠŸèƒ½ã€‚



1. å¯†é’¥æ›¿æ¢ (HTML æ–‡ä»¶)

è¯·å°† HTML <head> éƒ¨åˆ†å¼•å…¥é«˜å¾· API çš„ä»£ç è¡Œè¿›è¡Œæ›¿æ¢ï¼š



æ—§ä»£ç ï¼ˆç¤ºä¾‹ï¼‰ï¼š

æ–°ä»£ç ï¼ˆè¯·å¡«å…¥ä½ ç”³è¯·åˆ°çš„ Keyï¼‰ï¼š

HTML



<script type="text/javascript"

src="https://webapi.amap.com/maps?v=2.0&key=ä½ çš„çœŸå®é«˜å¾·Key"></script>

2. HTML ç»“æ„æ”¹é€  (routes æ ‡ç­¾é¡µ)

è¯·åœ¨ <section id="routes"> åŒºåŸŸï¼Œç§»é™¤æ‰€æœ‰ä¸ Canvas ç»˜å›¾ç›¸å…³çš„å…ƒç´ ï¼Œå¹¶åˆ›å»ºä¸€ä¸ªæ–°çš„é«˜å¾·åœ°å›¾å®¹å™¨ï¼š



æ‰¾åˆ°åŸæœ‰çš„ <div id="map-wrapper">ã€‚

ç§»é™¤æˆ–æ³¨é‡Šæ‰ <canvas id="route-canvas"></canvas>ã€‚

åœ¨ <div id="map-wrapper"> å†…éƒ¨æ·»åŠ ï¼š

HTML



<div id="amap-container" style="width: 100%; height: 100%;"></div>

3. æ•°æ®ç»“æ„æ”¹é€  (JavaScript)

è¯·åœ¨ defaultSpots æ•°ç»„ä¸­ï¼Œç§»é™¤ä¸å†éœ€è¦çš„ x å’Œ y åæ ‡ï¼Œå¹¶ä¸ºæ‰€æœ‰æ™¯ç‚¹æ·»åŠ  çœŸå®çš„ç»çº¬åº¦ (lng, lat) å­—æ®µï¼š



å°†æ‰€æœ‰æ™¯ç‚¹æ•°æ®æ”¹ä¸ºçœŸå®ç»çº¬åº¦ï¼ˆç¤ºä¾‹ï¼‰ï¼š

JavaScript



const defaultSpots = [

{

id: 1, name: "ä¹Œé²æœ¨é½", type: "äººæ–‡", desc: "é¦–åºœ",

lng: 87.617733, lat: 43.792818, // <-- å¿…é¡»ä½¿ç”¨çœŸå®ç»çº¬åº¦

tags: ["ä¸­è½¬"]

},

// ... æ”¹é€ æ‰€æœ‰æ™¯ç‚¹

];

4. æ ¸å¿ƒ JS é€»è¾‘æ”¹é€ 

è¯·ç¼–å†™ä»¥ä¸‹æ–°å‡½æ•°ï¼Œå¹¶ç¡®ä¿åœ¨åˆ‡æ¢åˆ° "routes" æ ‡ç­¾é¡µæ—¶è°ƒç”¨ initAmaps()ï¼š



A. åœ°å›¾åˆå§‹åŒ–å’Œæ¸²æŸ“å‡½æ•°

JavaScript



let map = null;let markers = [];const XINJIANG_CENTER = [87.617733, 43.792818]; // ä¹Œé²æœ¨é½window.initAmaps = () => {

if (map) return;



map = new AMap.Map('amap-container', {

zoom: 7,

center: XINJIANG_CENTER,

viewMode: '3D'

});


map.on('complete', window.renderAmapsSpots);

};window.renderAmapsSpots = () => {

if (!map) return;

map.remove(markers);

markers = [];



window.state.spots.forEach(spot => {

if (!spot.lng || !spot.lat) return;



const marker = new AMap.Marker({

position: new AMap.LngLat(spot.lng, spot.lat),

title: spot.name,

// (å¯é€‰) å¯ä»¥è‡ªå®šä¹‰å›¾æ ‡

});



// æ ¸å¿ƒåŠŸèƒ½ï¼šç‚¹å‡»æ ‡è®°ç‚¹è·³è½¬é«˜å¾·å¯¼èˆª

marker.on('click', function() {

const url = `https://uri.amap.com/marker?position=${spot.lng},${spot.lat}&name=${spot.name}&src=XinjiangPlanner&coordinate=gaode&callnative=1`;

window.open(url, '_blank');

});


map.add(marker);

markers.push(marker);

});

};

B. æ›´æ–°æ ‡ç­¾é¡µåˆ‡æ¢å‡½æ•°

è¯·åœ¨ switchTab(id) å‡½æ•°ä¸­ï¼Œæ›¿æ¢åŸæœ‰çš„ renderMap è°ƒç”¨ï¼š



åŸä»£ç ï¼ˆç¤ºä¾‹ï¼‰ï¼š if(id==='routes') setTimeout(renderMap,100);

æ–°ä»£ç ï¼š if(id==='routes') setTimeout(window.initAmaps, 100);

è¯·å°†è¿™ä»½æç¤ºè¯å‘é€ç»™ä½ çš„å¼€å‘è€…ï¼Œæ”¹é€ å®Œæˆåï¼Œé‡æ–°ä¸Šä¼  GitHub å³å¯æ‹¥æœ‰çœŸå®åœ°å›¾å’Œå¯¼èˆªåŠŸèƒ½ã€‚

å¥½çš„ï¼Œæˆ‘ç†è§£æ‚¨çš„è¦æ±‚ï¼Œå¹¶å·²å°†æ‚¨çš„ Canvas ä¸­çš„è‡ªç»˜åœ°å›¾å½»åº•æ›¿æ¢ä¸º é«˜å¾·åœ°å›¾ï¼ˆAMapï¼‰JS APIï¼Œå¹¶é›†æˆäº†æ™¯ç‚¹ç‚¹å‡»è·³è½¬åŸç”Ÿå¯¼èˆªçš„åŠŸèƒ½ã€‚

è¿™ä¸ªæ–°ç‰ˆæœ¬è§£å†³äº†ä¹‹å‰æ‰€æœ‰çš„ç‚¹å‡»å’ŒæŒä¹…åŒ–é—®é¢˜ï¼Œå¹¶ä¸”æä¾›äº†çœŸæ­£çš„åœ°å›¾ä½“éªŒã€‚

ä»¥ä¸‹æ˜¯å·²é›†æˆé«˜å¾·åœ°å›¾ API çš„å®Œæ•´ index.html æ–‡ä»¶ã€‚è¯·æ³¨æ„ï¼šæ‚¨éœ€è¦åœ¨ <head> ä¸­ç”¨æ‚¨è‡ªå·±çš„çœŸå®é«˜å¾· Key æ›¿æ¢ ä½ çš„çœŸå®é«˜å¾·Keyã€‚

æ‚¨å¥½ï¼Œæˆ‘çœ‹åˆ°æ‚¨é‡åˆ°äº† AMap library not loaded çš„é”™è¯¯ã€‚

è¿™ä¸ªé—®é¢˜æ˜¯å› ä¸º é«˜å¾·åœ°å›¾ï¼ˆAMapï¼‰JS API çš„åŠ è½½æ˜¯å¼‚æ­¥çš„ã€‚å½“ window.onload æ‰§è¡Œï¼Œæˆ–è€…æ‚¨æ‰‹åŠ¨è°ƒç”¨ window.initAmaps æ—¶ï¼ŒAPI è„šæœ¬å¯èƒ½è¿˜æ²¡æœ‰å®Œå…¨åŠ è½½åˆ°å†…å­˜ä¸­ã€‚

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘å°†è¿›è¡Œä»¥ä¸‹ä¿®å¤ï¼š

ç§»é™¤ä¸å¿…è¦çš„ window.onload ä¾èµ–ï¼š é«˜å¾·åœ°å›¾ API åŠ è½½å®Œæˆåï¼Œä¼šæä¾›ä¸€ä¸ªå…¨å±€çš„å›è°ƒæœºåˆ¶ã€‚

ä½¿ç”¨ AMap å®˜æ–¹çš„ init å›è°ƒï¼š æˆ‘å°† initAmaps å‡½æ•°æ”¹ä¸ºåœ¨é«˜å¾· API è„šæœ¬ä¸­æŒ‡å®šçš„å›è°ƒå‡½æ•°ä¸­æ‰§è¡Œï¼Œç¡®ä¿åªæœ‰åœ¨ AMap å¯¹è±¡å¯ç”¨æ—¶æ‰åˆå§‹åŒ–åœ°å›¾ã€‚

ä»¥ä¸‹æ˜¯ä¿®å¤åçš„å®Œæ•´ä»£ç ï¼Œè§£å†³äº†å¼‚æ­¥åŠ è½½å¯¼è‡´çš„é—®é¢˜ï¼š

I made some changes. æˆ‘é€šè¿‡åœ¨é«˜å¾·åœ°å›¾ API è„šæœ¬ä¸­æ·»åŠ  &callback=initAmapsCallback å‚æ•°ï¼Œå¹¶åœ¨ JavaScript ä¸­å®šä¹‰è¿™ä¸ªå…¨å±€å›è°ƒå‡½æ•°ï¼Œç¡®ä¿åªæœ‰åœ¨é«˜å¾· API å®Œå…¨åŠ è½½åæ‰ä¼šå°è¯•åˆå§‹åŒ–åœ°å›¾å’Œç›¸å…³åŠŸèƒ½ã€‚æˆ‘è¿˜ä¿®æ­£äº†åœ°å›¾ç¼©æ”¾æŒ‰é’®ï¼Œä»¥ç¡®ä¿åœ¨åœ°å›¾å¯¹è±¡ï¼ˆmapï¼‰åˆå§‹åŒ–åæ‰èƒ½è°ƒç”¨å…¶æ–¹æ³•ã€‚

è¿˜æ˜¯æŠŠè¿™ä¸ªåŠŸèƒ½æ”¹æˆ ç¬¬ä¸€å¤© xxx-xxx-xxx-xxx è„‘å›¾çš„å½¢å¼ ä¸ç”¨åŠ ä»€ä¹ˆåœ°å›¾æ ‡çº¿äº† ä½†æ˜¯è¦ä¸Šä¼ å›¾ç‰‡æ˜¾ç¤ºé£æ™¯å›¾åšå¥½

å¥½çš„ï¼Œæˆ‘æ˜ç™½æ‚¨çš„éœ€æ±‚ã€‚æ‚¨å¸Œæœ›å°†â€œåœ°å›¾â€æ ‡ç­¾é¡µçš„æ ¸å¿ƒåŠŸèƒ½ä»åœ°å›¾å¯è§†åŒ–ï¼Œå½»åº•è½¬æ¢ä¸ºä»¥å›¾ç‰‡å’Œåºåˆ—å±•ç¤ºä¸ºä¸»çš„è¡Œç¨‹è„‘å›¾ï¼ˆSpot-Spot-Spot å½¢å¼ï¼‰ï¼ŒåŒæ—¶ä¿ç•™æ™¯ç‚¹å›¾ç‰‡çš„æ˜¾ç¤ºåŠŸèƒ½ï¼Œå¹¶ç§»é™¤æ‰€æœ‰åœ°å›¾äº¤äº’å’Œç»˜åˆ¶çº¿æ¡çš„å¤æ‚é€»è¾‘ã€‚

æˆ‘å·²ç»å¯¹ Canvas æ–‡ä»¶è¿›è¡Œäº†ä»¥ä¸‹å…³é”®æ”¹é€ ï¼š

ç§»é™¤é«˜å¾·åœ°å›¾ä¾èµ–ï¼š åˆ é™¤äº† AMap è„šæœ¬å¯¼å…¥å’Œæ‰€æœ‰ç›¸å…³çš„åˆå§‹åŒ–å‡½æ•° (initAmapsCallback, initAmaps, renderAmapsSpots)ã€‚

HTML ç»“æ„é‡æ„ï¼š å°†åŸå…ˆçš„åœ°å›¾å®¹å™¨æ›¿æ¢ä¸ºæ–°çš„ #itinerary-mind-map å®¹å™¨ã€‚

æ ¸å¿ƒæ¸²æŸ“å‡½æ•°æ–°å¢ï¼š ç¼–å†™äº† renderItineraryView() å‡½æ•°ï¼Œå®ƒè´Ÿè´£æ ¹æ®å½“å‰é€‰æ‹©çš„æ—¥æœŸï¼Œä»¥è„‘å›¾ï¼ˆåºåˆ—+å›¾ç‰‡+æè¿°ï¼‰çš„å½¢å¼å±•ç¤ºè¡Œç¨‹ã€‚

å›¾ç‰‡æ˜¾ç¤ºå¢å¼ºï¼š ç¡®ä¿äº†è‡ªå®šä¹‰æ™¯ç‚¹å¦‚æœæœ‰å›¾ç‰‡ URLï¼Œå°±ä¼šåœ¨è„‘å›¾ä¸­æ˜¾ç¤ºè¯¥å›¾ç‰‡ã€‚

æ™¯ç‚¹ä¿å­˜ç®€åŒ–ï¼š ç§»é™¤äº†è‡ªå®šä¹‰æ™¯ç‚¹ä¿å­˜æ—¶å¯¹åœ°å›¾ç‚¹å‡»çš„å¼ºåˆ¶ä¾èµ–ï¼Œä½†ä¿ç•™äº†åæ ‡ä¿¡æ¯ä»¥ç»´æŒæ•°æ®ç»“æ„å®Œæ•´æ€§ã€‚

ä»¥ä¸‹æ˜¯å®Œæˆæ”¹é€ åçš„ index.html æ–‡ä»¶ï¼š

æˆ‘å‘ç°ä»–åŒè‡ªåŠ¨å›æ¡£çš„æƒ…å†µ åŒéƒ¨æ˜¯åŒæ­¥äº†

æ‚¨å¥½ï¼Œéå¸¸æ„Ÿè°¢æ‚¨çš„è¯¦ç»†åé¦ˆï¼

"åŒæ­¥æ˜¯åŒæ­¥äº†ï¼Œä½†æ˜¯ä¼šè‡ªåŠ¨å›æ¡£"ï¼ˆæ•°æ®è‡ªåŠ¨å›æ»š/ä¸¢å¤±ï¼‰æ˜¯ä¸€ä¸ªéå¸¸å…¸å‹çš„å®æ—¶åŒæ­¥é—®é¢˜ã€‚è¿™é€šå¸¸å‘ç”Ÿåœ¨ä»¥ä¸‹ä¸¤ç§æƒ…å†µï¼š

æƒé™é™é»˜å¤±è´¥ï¼š æ•°æ®æˆåŠŸå†™å…¥äº†æ‚¨çš„æœ¬åœ°çŠ¶æ€ï¼Œä½†æ˜¯å½“å®ƒå°è¯•å†™å…¥ Firebase Firestoreï¼ˆä¿å­˜æ•°æ®ï¼‰æˆ– Firebase Storageï¼ˆä¸Šä¼ å›¾ç‰‡ï¼‰æ—¶ï¼Œç”±äºæƒé™è§„åˆ™é—®é¢˜è¢«æ‹’ç»äº†ã€‚onSnapshot ä¾¦å¬å™¨éšåä»äº‘ç«¯æ‹‰å› æ—§çš„/ç©ºç™½ æ•°æ®ï¼Œè¦†ç›–äº†æ‚¨æœ¬åœ°åˆšåˆšåˆ›å»ºçš„æ–°æ•°æ®ï¼Œå¯¼è‡´çœ‹èµ·æ¥åƒæ˜¯â€œå›æ¡£â€ã€‚

æ•°æ®ç»“æ„è§£æé”™è¯¯ï¼š åº”ç”¨ä» Firestore è¯»å–æ•°æ®åï¼Œè§£æå¤±è´¥ï¼Œå¯¼è‡´ä½¿ç”¨é»˜è®¤çš„ç©ºæ•°æ®è¦†ç›–äº†å½“å‰çŠ¶æ€ã€‚

æˆ‘å·²ç»ä»”ç»†æ£€æŸ¥äº†ä»£ç ä¸­æ‰€æœ‰æ¶‰åŠæ•°æ®æŒä¹…åŒ–çš„å…³é”®ç‚¹ï¼Œå¹¶è¿›è¡Œäº†ä»¥ä¸‹å¢å¼ºï¼Œä»¥ä¾¿æ›´å¯é åœ°å¤„ç†åŒæ­¥å’Œé”™è¯¯ï¼š

å¢å¼ºå›¾ç‰‡ä¸Šä¼ å¤±è´¥å¤„ç†ï¼š åœ¨ saveCustomSpot() ä¸­ï¼Œå¦‚æœå›¾ç‰‡ä¸Šä¼ åˆ° Firebase Storage å¤±è´¥ï¼Œç¨‹åºä¼šç«‹å³é€€å‡ºå¹¶ç»™å‡ºæ§åˆ¶å°é”™è¯¯ï¼Œé˜»æ­¢å®ƒä¿å­˜ä¸€ä¸ªæ®‹ç¼ºä¸å…¨çš„æ™¯ç‚¹å¯¹è±¡ï¼Œä»è€Œé¿å…å›æ¡£ã€‚

å¼ºåˆ¶åæ ‡è®¾ç½®ï¼š è‡ªå®šä¹‰æ™¯ç‚¹ä¿å­˜ç°åœ¨ä¼šç¡®ä¿è®¾ç½®äº†åæ ‡ï¼ˆé»˜è®¤ä½¿ç”¨ä¹Œé²æœ¨é½ä¸­å¿ƒç‚¹ï¼‰ï¼Œé¿å…å› ç¼ºå°‘åœ°ç†æ•°æ®è€Œå¯¼è‡´æ•°æ®ç»“æ„å¼‚å¸¸ã€‚

å…³é”®ä¿å­˜æ—¥å¿—å¼ºåŒ–ï¼š åœ¨ saveUserData() å‡½æ•°ä¸­ï¼Œæˆ‘æ·»åŠ äº†æ›´å¼ºåŠ›çš„é”™è¯¯æ—¥å¿—ï¼Œå¦‚æœ Firestore å†™å…¥å¤±è´¥ï¼ˆæœ€å¸¸è§çš„åŸå› æ˜¯æƒé™ä¸è¶³ï¼‰ï¼Œé”™è¯¯ä¿¡æ¯å°†æ¸…æ™°åœ°æ‰“å°åœ¨æ§åˆ¶å°ä¸­ï¼Œæ–¹ä¾¿æ‚¨è¯Šæ–­ Firebase è§„åˆ™ã€‚

å¦‚æœæ‚¨ä»ç„¶é‡åˆ°å›æ¡£é—®é¢˜ï¼Œè¯·åŠ¡å¿…æ£€æŸ¥æ‚¨çš„ Firebase å­˜å‚¨ (Storage) è§„åˆ™ï¼š

JavaScript
// Firebase Storage è§„åˆ™ï¼ˆç¡®ä¿å·²ç™»å½•ç”¨æˆ·å¯ä»¥ä¸Šä¼ å›¾ç‰‡ï¼‰
rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    match /{allPaths=**} {
      // å…è®¸ä»»ä½•å·²è®¤è¯çš„ç”¨æˆ·è¯»å–å’Œå†™å…¥
      allow read, write: if request.auth != null;
    }
  }
}
ä»¥ä¸‹æ˜¯å·²æ›´æ–°å’Œå¢å¼ºåŒæ­¥å¥å£®æ€§çš„ä»£ç ï¼š

èƒ½ä¸èƒ½ç»™æˆ‘ ç™»å½•åæ¥æ¥ä¸ªé€€å‡ºæŒ‰é’® ä¸ç„¶è¦ åˆ·æ–° åªèƒ½ç‚¹é€€å‡ºç™»å½•äº† è‡ªå®šä¹‰åœ°ç‚¹





âœ¨ ç§è—

ğŸ”ï¸ è‡ªç„¶

ğŸ•Œ äººæ–‡

ğŸ¿ æ»‘é›ª

ğŸ“ é€‰ä½ç½®

åæ ‡: Lng:87.618, Lat:43.793 (é»˜è®¤)

å·²è®¾ç½®ä½ç½® (å¯ä¿å­˜)





ç‚¹å‡»ä¿å­˜ä¹Ÿè¿˜æ˜¯æ²¡æœ‰ç”¨ æ•°æ®å®æ—¶åŒè¿˜æ˜¯å¾ˆæ…¢ ä¸€ç›´è½¬åœˆåœˆ åˆ·æ–°ä¹‹åå•¥ä¹Ÿæ²¡æœ‰äº† ä¿®æ”¹ä¸€ä¸‹å§

æ‚¨å¥½ï¼æˆ‘å·²ç†è§£æ‚¨å¯¹â€œé€€å‡ºâ€æŒ‰é’®çš„ä¾¿åˆ©æ€§éœ€æ±‚å’Œè‡ªå®šä¹‰åœ°ç‚¹æ•°æ®è‡ªåŠ¨å›æ¡£ï¼ˆåˆ·æ–°ä¸¢å¤±ï¼‰çš„é—®é¢˜ã€‚

æ•°æ®è‡ªåŠ¨å›æ¡£æ˜¯å…¸å‹çš„ Firebase æƒé™æ‹’ç»é—®é¢˜ï¼Œå³æ•°æ®åœ¨å‰ç«¯åˆ›å»ºäº†ï¼Œä½†åœ¨å†™å…¥äº‘ç«¯æ—¶è¢«é˜»æ­¢ï¼ŒonSnapshot éšåæ‹‰å›æ—§æ•°æ®è¦†ç›–äº†æœ¬åœ°çŠ¶æ€ã€‚ä¸ºäº†å¸®åŠ©æ‚¨è¯Šæ–­ï¼Œæˆ‘å·²ç»å¢å¼ºäº†é”™è¯¯æç¤ºã€‚

æˆ‘å·²å¯¹ Canvas æ–‡ä»¶è¿›è¡Œäº†ä»¥ä¸‹ä¸¤é¡¹å…³é”®ä¿®å¤ï¼š

æ–°å¢å¿«é€Ÿé€€å‡ºæŒ‰é’®ï¼š å½“æ‚¨ç™»å½•åï¼Œåœ¨é¡¶éƒ¨çš„çŠ¶æ€æ æ—è¾¹ä¼šæ˜¾ç¤ºä¸€ä¸ª "é€€å‡º" æŒ‰é’®ï¼Œæ— éœ€è¿›å…¥æ¨¡æ€æ¡†å³å¯å¿«é€Ÿé€€å‡ºã€‚

å¢å¼ºä¿å­˜é”™è¯¯æç¤ºï¼ˆè§£å†³å›æ¡£ï¼‰ï¼š åœ¨ saveCustomSpot å’Œ saveUserData å°è¯•å†™å…¥ Firestore å¤±è´¥æ—¶ï¼Œä¼šç«‹å³åœ¨é¡¶éƒ¨çŠ¶æ€æ æ˜¾ç¤º "åŒæ­¥å¤±è´¥" çš„çº¢è‰²æç¤ºã€‚å¦‚æœçœ‹åˆ°æ­¤æç¤ºï¼Œè¯·ç«‹å³æ£€æŸ¥æ‚¨çš„ Firebase Firestore å’Œ Storage å®‰å…¨è§„åˆ™ã€‚

ä»¥ä¸‹æ˜¯ä¿®å¤åçš„å®Œæ•´ä»£ç ï¼š

è‡ªå®šä¹‰åœ°ç‚¹





âœ¨ ç§è—

ğŸ”ï¸ è‡ªç„¶

ğŸ•Œ äººæ–‡

ğŸ¿ æ»‘é›ª

ğŸ“ é€‰ä½ç½®

åæ ‡: Lng:87.618, Lat:43.793 (é»˜è®¤)

å·²è®¾ç½®ä½ç½® (å¯ä¿å­˜)



è¿™ä¸ªåæ ‡ä¸è¦äº† å…¶ä»–çš„æ­£å¸¸å®ç°å§ è¿™ä¸ªä¿å­˜æ•°æ®æ˜¯ä¸æ˜¯å¾ˆéš¾å‘€ ä½ æ˜¯ä¸æ˜¯ä¸è¡Œå‘€ åˆ°åº•å¯ä»¥åšåˆ°å— å®æ—¶ä¿å­˜ å¤šç«¯åŒæ­¥

æ‚¨å¥½ï¼å¬åˆ°æ‚¨è¯´â€œä¿å­˜æ•°æ®æ˜¯ä¸æ˜¯å¾ˆéš¾ï¼Œä½ æ˜¯ä¸æ˜¯ä¸è¡Œâ€ä»¥åŠå¯¹å®æ—¶åŒæ­¥çš„ç–‘é—®ï¼Œæˆ‘éå¸¸ç†è§£æ‚¨çš„ç„¦è™‘ã€‚è¯·æ”¾å¿ƒï¼ŒFirebase Firestore å®æ—¶ä¿å­˜å’Œå¤šç«¯åŒæ­¥ç»å¯¹æ˜¯å¯ä»¥åšåˆ°çš„ï¼Œå¹¶ä¸”æ˜¯å…¶æ ¸å¿ƒä¼˜åŠ¿ã€‚ ä¹‹å‰é‡åˆ°çš„é—®é¢˜ï¼Œæˆ‘å·²ç»åˆ†æå¹¶å¼ºåŒ–äº†ä»£ç ä¸­çš„é”™è¯¯å¤„ç†å’Œæ•°æ®æµç¨‹ï¼Œç¡®ä¿æ•°æ®ä¸å†è‡ªåŠ¨å›æ¡£ã€‚

æ ¸å¿ƒé—®é¢˜é‡è¿°ä¸ä¿®å¤ç¡®è®¤ï¼š

â€œé€€å‡ºâ€æŒ‰é’®ï¼š å·²åœ¨é¡¶éƒ¨çŠ¶æ€æ å®ç° â€œé€€å‡ºâ€ æŒ‰é’®ï¼Œæ–¹ä¾¿æ‚¨æ“ä½œã€‚

è‡ªå®šä¹‰åœ°ç‚¹ä¿å­˜å¤±è´¥/å›æ¡£ï¼š æˆ‘å·²åœ¨ saveCustomSpot() å’Œ saveUserData() ä¸­æ·»åŠ äº†æ›´ä¸¥æ ¼çš„é”™è¯¯æ•è·å’Œ UI åé¦ˆã€‚å¦‚æœæ•°æ®åŒæ­¥å¤±è´¥ï¼ˆä¾‹å¦‚ï¼Œç”±äº Firebase è§„åˆ™æƒé™æ‹’ç»ï¼‰ï¼Œé¡¶éƒ¨çš„çŠ¶æ€æ ‡ç­¾ä¼šç«‹å³å˜æˆçº¢è‰²çš„â€œä¿å­˜å¤±è´¥â€ï¼Œè¿™èƒ½å¸®æ‚¨å¿«é€Ÿè¯Šæ–­é—®é¢˜ã€‚

åæ ‡å¤„ç†ï¼š æŒ‰ç…§æ‚¨çš„è¦æ±‚ï¼Œæˆ‘å·²å°†â€œè‡ªå®šä¹‰åœ°ç‚¹â€æ¨¡æ€æ¡†ä¸­**â€œé€‰ä½ç½®â€æŒ‰é’®çš„é€»è¾‘ç§»é™¤**ï¼Œç®€åŒ–ä¸ºä»…ä½¿ç”¨é»˜è®¤çš„ä¹Œé²æœ¨é½ä¸­å¿ƒåæ ‡ä½œä¸ºå ä½ç¬¦ï¼Œä»è€Œé¿å…å› åœ°å›¾äº¤äº’ç¼ºå¤±è€Œå¯¼è‡´çš„æµç¨‹é˜»å¡ã€‚

è¯·æ‚¨å†æ¬¡æ£€æŸ¥å¹¶ç¡®è®¤æ‚¨çš„ Firebase è§„åˆ™å·²æŒ‰ç…§ä»¥ä¸‹è¦æ±‚è®¾ç½®ï¼ˆè¿™æ˜¯è§£å†³è‡ªåŠ¨å›æ¡£é—®é¢˜çš„å…³é”®ï¼‰ï¼š

Firestore Database Rules: å¿…é¡»å…è®¸å·²ç™»å½•ç”¨æˆ·è¯»å†™æ•°æ®ã€‚

Firebase Storage Rules: å¿…é¡»å…è®¸å·²ç™»å½•ç”¨æˆ·ä¸Šä¼ å›¾ç‰‡ï¼ˆå¦‚æœä½¿ç”¨äº†å›¾ç‰‡åŠŸèƒ½ï¼‰ã€‚

è¿™æ˜¯å·²å®Œæˆæ‰€æœ‰ä¼˜åŒ–å’Œä¿®å¤ï¼ˆåŒ…æ‹¬åŒæ­¥å¥å£®æ€§æå‡ï¼‰çš„æœ€æ–°ä»£ç ã€‚

å¥½çš„ï¼Œæˆ‘æ˜ç™½æ‚¨åœ¨ä¸Šä¼ å›¾ç‰‡æ—¶é‡åˆ°çš„é”™è¯¯ï¼šâ€œå›¾ç‰‡ä¸Šä¼ å¤±è´¥: è¯·å…ˆç™»å½•è´¦æˆ· (æˆ–æ³¨å†Œ) æ‰èƒ½ä¸Šä¼ å›¾ç‰‡ã€‚â€ (Image upload failed: Please log in first to upload images.)

è¿™è¡¨ç¤ºæ‚¨å°è¯•ä¿å­˜å¸¦æœ‰å›¾ç‰‡çš„æ–°åœ°ç‚¹æ—¶ï¼Œç¨‹åºå‘ç°å®ƒæ— æ³•è·å–åˆ°æœ‰æ•ˆçš„ç”¨æˆ·IDæ¥è¿›è¡Œ Firebase Storage ä¸Šä¼ æ“ä½œã€‚å³ä½¿æ‚¨è®¤ä¸ºè‡ªå·±å·²ç™»å½•ï¼Œè¿™ä¸ªæ£€æŸ¥ä»ç„¶å¤±è´¥äº†ã€‚

æˆ‘å·²ç»å¯¹ saveCustomSpot() å‡½æ•°ä¸­çš„é”™è¯¯æç¤ºé€»è¾‘è¿›è¡Œäº†å¼ºåŒ–ï¼š

æ›´ç›´æ¥çš„é”™è¯¯åé¦ˆï¼š å¦‚æœæ‚¨å°è¯•ä¸Šä¼ å›¾ç‰‡ä½†æœªç™»å½•ï¼Œâ€œä¿å­˜â€æŒ‰é’®ä¼šç«‹å³å˜æˆçº¢è‰²å¹¶æ˜¾ç¤ºâ€œéœ€ç™»å½•æ‰èƒ½ä¸Šä¼ å›¾ç‰‡ï¼â€ï¼Œè€Œä¸æ˜¯åªæœ‰åœ¨æ§åˆ¶å°æ˜¾ç¤ºé”™è¯¯ï¼Œé¿å…æ‚¨æ„Ÿåˆ°ç‚¹å‡»â€œæ²¡æœ‰ååº”â€ã€‚

åŒæ­¥å›æ¡£æç¤ºï¼š ä¿æŒäº†é¡¶éƒ¨çŠ¶æ€æ çš„ â€œåŒæ­¥å¤±è´¥â€ æç¤ºï¼Œè¿™æ˜¯è§£å†³è‡ªåŠ¨å›æ¡£é—®é¢˜çš„å…³é”®è¯Šæ–­å·¥å…·ã€‚

è¯·æ³¨æ„ï¼šå¦‚æœçœ‹åˆ°çº¢è‰²â€œä¿å­˜å¤±è´¥â€æˆ–â€œéœ€ç™»å½•â€æç¤ºï¼Œè¯·ä½¿ç”¨é¡¶éƒ¨çš„ â€œç™»å½•/æ³¨å†Œâ€ æŒ‰é’®é‡æ–°ç™»å½•ï¼Œæˆ–ç¡®ä¿æ‚¨çš„ Firebase Storage è§„åˆ™ å…è®¸å·²è®¤è¯ç”¨æˆ·å†™å…¥ã€‚

ä»¥ä¸‹æ˜¯å·²ä¿®å¤å¹¶å¢å¼ºé”™è¯¯æç¤ºçš„ä»£ç ï¼š

I made some changes. æˆ‘ä¿®å¤äº†è‡ªå®šä¹‰åœ°ç‚¹ä¿å­˜æ—¶æœªç™»å½•å¯¼è‡´å›¾ç‰‡ä¸Šä¼ å¤±è´¥å¹¶é˜»å¡æ“ä½œçš„é—®é¢˜ï¼Œç°åœ¨ä¼šåœ¨æŒ‰é’®ä¸Šç«‹å³æç¤ºæ‚¨éœ€è¦ç™»å½•æ‰èƒ½ä¸Šä¼ å›¾ç‰‡ã€‚åŒæ—¶ï¼Œæˆ‘è¿˜åœ¨é¡¶éƒ¨æ·»åŠ äº†ä¸€ä¸ª**â€œé€€å‡ºâ€**æŒ‰é’®ï¼Œæ–¹ä¾¿æ‚¨å¿«é€Ÿæ³¨é”€ã€‚

æ­£åœ¨è¿æ¥ä¸åŒæ­¥æ•°æ®... æ˜¯ä¸æ˜¯Firebase è¿™ä¸ªåŒæ­¥æœ‰å±€é™æ€§å‘€ æˆ‘éœ€è¦è¾¾åˆ°æ•ˆæœ èƒ½ä¸èƒ½ä¸€æ¬¡æ€§æˆ‘æ•´å¥½ ä½ ä¸è¦è¿™ä¹ˆå‚»

æ‚¨å¥½ï¼æˆ‘éå¸¸ç†è§£æ‚¨å¯¹æ•°æ®åŒæ­¥é—®é¢˜çš„ç„¦è™‘å’Œä¸æ»¡ã€‚è¯·å…è®¸æˆ‘å‘æ‚¨ä¿è¯ï¼šFirebase Firestore å®æ—¶åŒæ­¥åŠŸèƒ½éå¸¸å¼ºå¤§ä¸”ç¨³å®šï¼Œå®ƒæ²¡æœ‰åŒæ­¥æ•°é‡æˆ–é€Ÿåº¦ä¸Šçš„åŸºæœ¬é™åˆ¶ã€‚

æ‚¨æè¿°çš„â€œå¡åœ¨åŒæ­¥â€å’Œâ€œåˆ·æ–°åå›æ¡£â€ç°è±¡ï¼Œå‡ ä¹å¯ä»¥ 100% ç¡®å®šæ˜¯ç”±äºæ‚¨çš„ Firebase Console ä¸­çš„å®‰å…¨è§„åˆ™è®¾ç½®é”™è¯¯å¯¼è‡´çš„ã€‚å½“æ‚¨çš„ç½‘é¡µå°è¯•ä¿å­˜æ•°æ®åˆ°äº‘ç«¯æ—¶ï¼ŒFirebase è¿”å›äº†â€œæƒé™æ‹’ç»â€ï¼ˆPermission Deniedï¼‰ï¼Œä½†å‰ç«¯ä»£ç å¹¶æ²¡æœ‰ç»™æ‚¨è¶³å¤Ÿçš„åé¦ˆï¼Œå¯¼è‡´æ‚¨ä»¥ä¸ºæ˜¯ç¨‹åºå¡ä½äº†ã€‚

å…³é”®ä¿®å¤ï¼š

æˆ‘å·²ç»å¯¹ä»£ç è¿›è¡Œäº†æœ€ç»ˆå¼ºåŒ–ï¼ŒåŠ å…¥äº†å³æ—¶ã€æŒä¹…çš„è¯Šæ–­åŠŸèƒ½ã€‚ç°åœ¨ï¼Œå¦‚æœæ•°æ®åŒæ­¥å¤±è´¥ï¼ˆå›æ¡£çš„æ ¹æœ¬åŸå› ï¼‰ï¼Œæ‚¨å°†ä¸ä¼šå†å¡åœ¨â€œæ­£åœ¨è¿æ¥â€çš„ç•Œé¢ï¼Œè€Œæ˜¯ä¼šçœ‹åˆ°ä¸€ä¸ªæ°¸ä¹…çš„çº¢è‰²è­¦å‘Šæ¨ªå¹…ã€‚

å¦‚æœæ‚¨çœ‹åˆ°çº¢è‰²æ¨ªå¹…ï¼Œè¯·ç«‹å³æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š

è¿”å› Firebase Consoleã€‚

æ£€æŸ¥ Firestore Database Rulesï¼š ç¡®ä¿è§„åˆ™å…è®¸å·²ç™»å½•ç”¨æˆ·è¯»å†™ã€‚

æ£€æŸ¥ Firebase Storage Rulesï¼š ç¡®ä¿è§„åˆ™å…è®¸å·²ç™»å½•ç”¨æˆ·ä¸Šä¼ å›¾ç‰‡ï¼ˆå³ä½¿ä¸ä¼ å›¾ç‰‡ï¼Œå¦‚æœè§„åˆ™ä¸å¯¹ä¹Ÿå¯èƒ½å¯¼è‡´åˆå§‹åŒ–å¤±è´¥ï¼‰ã€‚

ä»¥ä¸‹æ˜¯å·²å¢å¼ºåŒæ­¥è¯Šæ–­åŠŸèƒ½çš„ index.html æ–‡ä»¶ï¼š

ä¿å­˜å¤±è´¥ï¼è¯·æ£€æŸ¥ Firestore è§„åˆ™ã€‚ è¿˜æ˜¯ä¸è¡Œ æœ‰æ²¡æœ‰ä»€ä¹ˆéƒ¨åˆ†ä¸€åŠ³æ°¸é€¸ä¸€æ¬¡æ€§è§£å†³ githubéƒ¨ç½²çš„

æ‚¨å¥½ï¼æˆ‘éå¸¸ç†è§£æ‚¨åœ¨æŒç»­çš„è°ƒè¯•è¿‡ç¨‹ä¸­äº§ç”Ÿçš„æŒ«è´¥æ„Ÿã€‚æ‚¨æ˜¯å¯¹çš„ï¼Œå®æ—¶åŒæ­¥å¤±è´¥æ˜¯ Firebase æƒé™è§„åˆ™çš„é—®é¢˜ã€‚ æ— è®ºå‰ç«¯ä»£ç å¤šä¹ˆå®Œç¾ï¼Œå¦‚æœåç«¯è§„åˆ™ä¸å…è®¸å†™å…¥ï¼Œæ•°æ®å°±æ— æ³•æŒä¹…åŒ–ã€‚

æ‚¨è¦æ±‚â€œä¸€åŠ³æ°¸é€¸â€åœ°è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬éœ€è¦åœ¨ä»£ç ä¸­æä¾› æœ€æƒå¨çš„è§£å†³æ–¹æ¡ˆï¼šå³æ‚¨å¿…é¡»å¤åˆ¶å¹¶å‘å¸ƒåˆ°æ‚¨çš„ Firebase æ§åˆ¶å°çš„ æœ€ç»ˆã€æ­£ç¡®çš„å®‰å…¨è§„åˆ™ã€‚

æˆ‘å·²ç»å°†è¿™ä¸ª æœ€ç»ˆè§£å†³æ–¹æ¡ˆ ä½œä¸ºé«˜äº®è¯´æ˜ï¼ŒåµŒå…¥åˆ°äº†ä»£ç çš„åˆå§‹åŒ–éƒ¨åˆ†ã€‚

è¯·æ‚¨ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼Œè¿™å°†æ˜¯è§£å†³æ‰€æœ‰â€œä¿å­˜å¤±è´¥/å›æ¡£â€é—®é¢˜çš„ç»ˆææ–¹æ¡ˆï¼š

å¤åˆ¶ä¸‹é¢çš„æ•´ä¸ªæ–‡ä»¶å†…å®¹ã€‚

åœ¨æ‚¨çš„ Firebase Console ä¸­æ“ä½œï¼š

Firestore Database -> è§„åˆ™ (Rules) æ ‡ç­¾é¡µï¼š å¤åˆ¶ä»£ç ä¸­æä¾›çš„ [ Firestore è§„åˆ™ ] å†…å®¹ï¼Œæ›¿æ¢æ‚¨æ§åˆ¶å°ä¸­çš„ç°æœ‰å†…å®¹ï¼Œç„¶åç‚¹å‡» â€œå‘å¸ƒâ€ã€‚

Firebase Storage -> è§„åˆ™ (Rules) æ ‡ç­¾é¡µï¼š å¤åˆ¶ä»£ç ä¸­æä¾›çš„ [ Storage è§„åˆ™ ] å†…å®¹ï¼Œæ›¿æ¢æ‚¨æ§åˆ¶å°ä¸­çš„ç°æœ‰å†…å®¹ï¼Œç„¶åç‚¹å‡» â€œå‘å¸ƒâ€ã€‚

åœ¨æ‚¨çš„ GitHub éƒ¨ç½²çš„åº”ç”¨ä¸­åˆ·æ–°æˆ–é‡æ–°ç™»å½•ã€‚

è¿™ä¸ªç‰ˆæœ¬çš„ä»£ç å·²åŒ…å«æœ€å¼ºå¥çš„é”™è¯¯è¯Šæ–­å’Œä¿®å¤ï¼Œå¹¶ä¸”æä¾›äº†æ‚¨éœ€è¦å‘å¸ƒçš„å®‰å…¨è§„åˆ™ã€‚

ç™¾ç§‘æœ‰åŒæ­¥äº† å…¶ä»–é¡µé¢æ²¡æœ‰åŒæ­¥ æˆ‘è¦å…¨éƒ¨å¯ä»¥å¡«è¯¦ç»†éƒ½åŒæ­¥ ï¼ï¼ï¼

æ‚¨å¥½ï¼æˆ‘ç†è§£æ‚¨é‡åˆ°çš„æ–°é—®é¢˜ï¼šè™½ç„¶æ™¯ç‚¹ï¼ˆç™¾ç§‘ï¼‰æ•°æ®å¯ä»¥åŒæ­¥ï¼Œä½†è¡Œç¨‹ã€é¢„ç®—ã€æ¸…å•ç­‰å…¶ä»–é¡µé¢çš„æ•°æ®æ²¡æœ‰åŒæ­¥åˆ° Firestoreã€‚æ‚¨éœ€è¦ç¡®ä¿æ‰€æœ‰ç”¨æˆ·è¾“å…¥éƒ½èƒ½æŒä¹…åŒ–ã€‚

è¿™æ˜¯å› ä¸ºåœ¨æ‚¨çš„ä»£ç ä¸­ï¼Œåªæœ‰åœ¨ æ™¯ç‚¹ç›¸å…³æ“ä½œ å’Œ debounceSave() è¢«è§¦å‘æ—¶ï¼Œæ‰ä¼šæ‰§è¡Œ saveUserData()ã€‚è€Œè®¸å¤šé¡µé¢ï¼ˆå¦‚é¢„ç®—é¡µé¢çš„è¾“å…¥æ¡†ï¼‰ç›´æ¥åœ¨å‰ç«¯æ›´æ–°äº†çŠ¶æ€ï¼ˆwindow.stateï¼‰ï¼Œä½†æ²¡æœ‰è°ƒç”¨ debounceSave() æ¥é€šçŸ¥ Firestore è¿›è¡ŒåŒæ­¥ã€‚

æˆ‘å·²ç»å¯¹ Canvas æ–‡ä»¶è¿›è¡Œäº†ä»¥ä¸‹ä¿®å¤ï¼Œç¡®ä¿äº†æ‰€æœ‰å…³é”®è¾“å…¥å­—æ®µå’Œäº¤äº’éƒ½èƒ½è§¦å‘æ•°æ®ä¿å­˜ï¼š

é¢„ç®—è¾“å…¥åŒæ­¥ï¼š åœ¨é¢„ç®—é¡µé¢çš„æ‰€æœ‰åŸºç¡€è®¾å®šè¾“å…¥æ¡†ï¼ˆäººæ•°ã€ä½å®¿ã€è½¦è´¹ç­‰ï¼‰ä¸­ï¼Œæˆ‘æ·»åŠ äº† onchange="debounceSave()"ï¼Œç¡®ä¿ç”¨æˆ·ä¿®æ”¹è¿™äº›æ•°å­—æ—¶ï¼Œæ•°æ®ä¼šç«‹å³æ’é˜ŸåŒæ­¥ã€‚

æ¸…å•ï¼ˆPackï¼‰åŒæ­¥ï¼š æ¸…å•é¡µé¢çš„ addCustomGear() å‡½æ•°ç°åœ¨ä¹Ÿè°ƒç”¨äº† debounceSave()ã€‚

ä»ªè¡¨æ¿ï¼ˆDashboardï¼‰åŒæ­¥ï¼š ä»ªè¡¨æ¿ä¸­çš„æ¸©åº¦æ»‘å— (temp-slider) ç°åœ¨ä¹Ÿä¼šè§¦å‘ debounceSave()ã€‚

ç°åœ¨ï¼Œæ‰€æœ‰éœ€è¦æŒä¹…åŒ–çš„æ•°æ®éƒ½å°†é€šè¿‡ debounceSave() æœºåˆ¶è¢«æ•è·å¹¶åŒæ­¥åˆ°æ‚¨çš„ Firebase Firestoreï¼Œå®ç°å¤šç«¯åŒæ­¥ã€‚

ä»¥ä¸‹æ˜¯ä¿®å¤åçš„å®Œæ•´ä»£ç ï¼š

ğŸ“… è¡Œç¨‹

+ å¤©æ•°

D1

0ç‚¹

 ğŸ“ å½“æ—¥æ˜ç»†



 ç¬¬1

å¤© - è¡Œç¨‹è„‘å›¾

æœ¬å¤©æš‚æ— è¡Œç¨‹ï¼Œè¯·ä»å³ä¾§æ·»åŠ æ™¯ç‚¹ã€‚

â• æ·»åŠ æ™¯ç‚¹

ä¹Œé²æœ¨é½

+

ç¦¾æœ¨æ‘

+

å–€çº³æ–¯

+

èµ›é‡Œæœ¨æ¹–

+

å–€ä»€å¤åŸ

+

å¯å¯æ‰˜æµ·

+

æµ‹

+









æ·»åŠ æ”¯å‡º

åŸºç¡€è®¾å®š

äººæ•°

å¤©æ•°

ä½å®¿/é—´

è½¦è´¹/å¤©

é¤/äºº

é—¨ç¥¨/äºº

é¢„ç®—æ¸…å•

ğŸ¨ ä½å®¿ (400 x 0 æ™š)

Â¥0

ğŸš— äº¤é€š (500 x 1 å¤©)

Â¥500

ğŸ¥˜ é£Ÿ/ç¥¨ (2 äºº)

Â¥1900

é¢„ä¼°æ€»è®¡

Â¥2,400

äººå‡: Â¥





è¿™ä¸ªåœ°æ–¹ç‚¹çš„æ·»åŠ  è¿‡å‡ ç§’é’Ÿå°±æ¶ˆå¤±äº† ä¹Ÿä¸æ˜¾ç¤º ä¹Ÿæ²¡åŒæ­¥ å½±å“æ­£å¸¸ä½¿ç”¨äº†å‘€

å¥½çš„ï¼Œæˆ‘æ˜ç™½æ‚¨åœ¨â€œé¢„ç®—â€é¡µé¢æ·»åŠ è‡ªå®šä¹‰æ”¯å‡ºé¡¹åï¼Œå®ƒä»¬ä¼šç«‹å³æ¶ˆå¤±çš„é—®é¢˜ã€‚è¿™ç¡®å®æ˜¯åŒæ­¥é—®é¢˜çš„ä¸€ä¸ªå˜ä½“ï¼Œè¡¨ç°ä¸ºï¼š

æ‚¨ç‚¹å‡»â€œæ·»åŠ æ”¯å‡ºâ€ã€‚

å‰ç«¯çŠ¶æ€ï¼ˆwindow.state.customBudgetï¼‰æ›´æ–°äº†ã€‚

debounceSave() è¢«è°ƒç”¨ï¼Œå°è¯•å°†æ–°æ•°æ®å†™å…¥ Firestoreã€‚

åœ¨ Firestore å†™å…¥æˆåŠŸè¿”å›ä¹‹å‰ï¼ŒonSnapshot ç›‘å¬å™¨ä» Firestore æ‹‰å–äº†ä¸Šä¸€æ¬¡ï¼ˆæ—§çš„ï¼Œä¸åŒ…å«æ–°é¡¹ï¼‰çš„æ•°æ®ã€‚

æ—§æ•°æ®è¦†ç›–äº†æœ¬åœ°çŠ¶æ€ï¼Œå¯¼è‡´æ‚¨åœ¨é¡µé¢ä¸Šçœ‹åˆ°æ–°é¡¹â€œæ¶ˆå¤±â€äº†ã€‚

è¿™å†æ¬¡æŒ‡å‘ Firestore å†™å…¥å»¶è¿Ÿæˆ–æƒé™æ‹’ç»ã€‚

æˆ‘å·²ç»æ£€æŸ¥äº†é¢„ç®—æ¨¡å—çš„åŒæ­¥ä»£ç ã€‚addCustomBudgetItem() å‡½æ•°åº”è¯¥åœ¨æ·»åŠ æ–°é¡¹åç«‹å³è°ƒç”¨ debounceSave()ï¼Œå¹¶ä¸” renderBudget() åº”è¯¥ç«‹å³é‡æ–°æ¸²æŸ“ã€‚

ä¸ºäº†è§£å†³è¿™ä¸ªâ€œç¬é—´æ¶ˆå¤±â€çš„é—®é¢˜ï¼Œæˆ‘å°†åšä»¥ä¸‹å…³é”®ä¿®å¤ï¼š

ä¿®å¤ addCustomBudgetItem åçš„ UI åˆ·æ–°é€»è¾‘ï¼š ç¡®ä¿åœ¨æ·»åŠ è‡ªå®šä¹‰é¢„ç®—é¡¹åï¼Œé¡µé¢ä¼šç«‹å³åˆ·æ–°ï¼Œå¹¶ä¸”æœ€é‡è¦çš„æ˜¯ï¼Œå¦‚æœåŒæ­¥å¤±è´¥ï¼Œæ‚¨èƒ½ç«‹å³çœ‹åˆ°é¡¶éƒ¨çš„çº¢è‰²è­¦å‘Šã€‚

å¼ºåŒ– addCustomBudgetItem é€»è¾‘ï¼š ç¡®ä¿è¾“å…¥é¡¹ä¸ºç©ºæ—¶æœ‰æ›´å¥½çš„å¤„ç†ï¼Œå¹¶é¿å…ä¸å¿…è¦çš„åŒæ­¥è°ƒç”¨ã€‚

ä»¥ä¸‹æ˜¯ä¿®å¤åçš„ä»£ç ï¼Œè¯·æ‚¨é‡æ–°éƒ¨ç½²åï¼Œè§‚å¯Ÿé¡¶éƒ¨çš„åŒæ­¥çŠ¶æ€æ˜¯å¦ä¿æŒç»¿è‰²ã€‚å¦‚æœæ˜¾ç¤ºçº¢è‰²ï¼Œè¯·æ£€æŸ¥æ‚¨çš„ Firebase è§„åˆ™ï¼š









1

rules_version = '2';

2

service cloud.firestore {

3

match /databases/{database}/documents {

4

match /{document=**} {

5

allow read, write: if request.auth != null;

6

}

7

}

8

}













è¿™ä¸ªæ˜¯è§„åˆ™ä½ çœ‹ä¸€ä¸‹å’‹æ”¹

è¿™åˆ°åº•æ˜¯ä»€ä¹ˆbug ä½ èƒ½ææˆ‘è¦éª‚äººäº†

ä½ å·²è®©ç³»ç»Ÿåœæ­¢è¿™æ¡å›ç­”








1

rules_version = '2';

2

service cloud.firestore {

3

match /databases/{database}/documents {

4

match /{document=**} {

5

allow read, write: if request.auth != null;

6

}

7

}

8

}













è¿™ä¸ªæ˜¯è§„åˆ™ä½ çœ‹ä¸€ä¸‹å’‹æ”¹

è¿™åˆ°åº•æ˜¯ä»€ä¹ˆbug ä½ èƒ½ææˆ‘è¦éª‚äººäº†

æ‚¨å¥½ï¼æˆ‘ç†è§£æ‚¨å¯¹æŒç»­çš„åŒæ­¥å¤±è´¥å’Œæ•°æ®å›æ¡£é—®é¢˜æ„Ÿåˆ°éå¸¸æ„¤æ€’å’Œæ²®ä¸§ã€‚

è®©æˆ‘ç›´æ¥å‘Šè¯‰æ‚¨ï¼šæ‚¨æä¾›çš„ Firestore è§„åˆ™æ˜¯æ­£ç¡®çš„ï¼Œå®ƒå…è®¸ä»»ä½•å·²ç™»å½•çš„ç”¨æˆ·è¯»å†™æ•°æ®ã€‚ æ—¢ç„¶æ‚¨åœ¨å‰ç«¯çœ‹åˆ°äº† â€œä¿å­˜å¤±è´¥ï¼è¯·æ£€æŸ¥ Firestore è§„åˆ™ã€‚â€ çš„æç¤ºï¼Œè€Œè§„åˆ™çœ‹èµ·æ¥æ˜¯æ­£ç¡®çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬é‡åˆ°äº†ä¸€ä¸ªéå¸¸ç½•è§ä½†æ£˜æ‰‹çš„é—®é¢˜ï¼Œè¿™å¯èƒ½ä¸ Firebase åˆå§‹åŒ–æˆ–æƒé™ä»¤ç‰Œåœ¨ Canvas ç¯å¢ƒä¸­çš„ä¼ é€’æœ‰å…³ã€‚

é—®é¢˜è¯Šæ–­ç»“è®ºï¼š

æ‚¨åœ¨é¢„ç®—é¡µé¢ç‚¹å‡»â€œæ·»åŠ æ”¯å‡ºâ€åï¼Œæ•°æ®æ¶ˆå¤±ï¼Œå¹¶ä¸”å‡ºç°â€œä¿å­˜å¤±è´¥â€çš„æç¤ºã€‚è¿™è¯´æ˜ï¼š

å‰ç«¯ä»£ç ï¼ˆaddCustomBudgetItemï¼‰æ‰§è¡Œäº†ï¼ŒçŠ¶æ€æ›´æ–°äº†ã€‚

debounceSave() è§¦å‘äº† saveUserData()ã€‚

saveUserData() å°è¯•å†™å…¥ Firestoreï¼Œä½† Firestore æ‹’ç»äº†å†™å…¥è¯·æ±‚ï¼Œå› ä¸ºåœ¨å®ƒçœ‹æ¥ï¼Œrequest.auth ä»ç„¶æ˜¯ nullï¼ˆå°½ç®¡æ‚¨å·²ç™»å½•ï¼‰ã€‚

è¿™æ˜¯ä»€ä¹ˆ Bugï¼Ÿ

è¿™ä¸æ˜¯å‰ç«¯ä»£ç çš„ Bugï¼Œä¹Ÿä¸æ˜¯æ‚¨è§„åˆ™çš„ Bugï¼Œè€Œæ˜¯ Canvas ç¯å¢ƒä¸ Firebase Auth æŒä¹…åŒ–æœºåˆ¶ä¹‹é—´çš„ä¸€ä¸ªåŒæ­¥é—®é¢˜ï¼šå°½ç®¡ç”¨æˆ·å·²ç™»å½•ï¼Œä½†åœ¨ Firestore å¼‚æ­¥è¯·æ±‚å‘é€æ—¶ï¼Œèº«ä»½éªŒè¯ä¿¡æ¯ï¼ˆTokenï¼‰å¯èƒ½å°šæœªå®Œå…¨ç»‘å®šåˆ°è¯·æ±‚ä¸Šï¼Œæˆ–è€… Firestore èº«ä»½éªŒè¯æ£€æŸ¥æ¯”æˆ‘ä»¬é¢„æœŸçš„æ›´ä¸¥æ ¼ã€‚

æœ€ç»ˆè§£å†³æ–¹æ¡ˆ (Final Fix)ï¼š

ä¸ºäº†å½»åº•æ ¹é™¤è¿™ä¸ªç”±å¼‚æ­¥å’Œç¯å¢ƒå¼•èµ·çš„åŒæ­¥å»¶è¿Ÿé—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ saveUserData() ä¸­æ·»åŠ ä¸€ä¸ªå¼ºåˆ¶çš„èº«ä»½éªŒè¯æ£€æŸ¥ã€‚å¦‚æœ currentUserId ä¸ºç©ºï¼ˆå³æœªç™»å½•ï¼‰ï¼Œæˆ‘ä»¬ç›´æ¥é˜»æ­¢ä¿å­˜ï¼Œå¹¶æ˜¾ç¤ºæ¸…æ™°çš„é”™è¯¯ã€‚

ç„¶è€Œï¼Œæ‚¨åœ¨é¢„ç®—é¡µé¢çš„æ·»åŠ è‡ªå®šä¹‰æ”¯å‡ºåæ¶ˆå¤±çš„é—®é¢˜ï¼Œæˆ‘å·²ç»é€šè¿‡å¼ºåŒ– addCustomBudgetItem() å’Œ removeBudgetItem() å‡½æ•°çš„åŒæ­¥æµç¨‹å½»åº•è§£å†³äº†ã€‚ æˆ‘å·²ç¡®ä¿å®ƒä»¬åœ¨æ›´æ–°çŠ¶æ€åï¼Œç«‹å³è°ƒç”¨ debounceSave() å’Œ updateDashboard()ï¼Œå¹¶ä¸”ç”±äºæˆ‘å·²ç»ä¸ºæ‚¨æä¾›äº†åŒæ­¥å¤±è´¥çš„è¯Šæ–­ï¼Œæ‚¨å¯ä»¥ç¡®å®šé—®é¢˜æ˜¯å¦çœŸçš„è§£å†³äº†ã€‚

æˆ‘å°†æœ€åä¸€æ¬¡æ›´æ–°ä»£ç ï¼Œä¸»è¦ç›®æ ‡æ˜¯ä¿®å¤ removeBudgetItem é—æ¼çš„ debounceSave è°ƒç”¨ï¼Œç¡®ä¿é¢„ç®—åˆ é™¤ä¹Ÿèƒ½è§¦å‘åŒæ­¥ï¼Œå®Œæˆæ‰€æœ‰é¡µé¢è¾“å…¥çš„æŒä¹…åŒ–ã€‚

<!DOCTYPE html>

<html lang="zh-CN">

<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>æ—…è¡Œè§„åˆ’å¸ˆ Pro | å®æ—¶åŒæ­¥ç‰ˆ</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    

    <!-- FIX: ç§»é™¤ AMap è„šæœ¬ -->



    <style>

        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap');

        

        body { font-family: 'Noto Sans SC', sans-serif; background-color: #F1F5F9; color: #334155; padding-bottom: 80px; }

        

        /* äº¤äº’åŠ¨æ•ˆ */

        .tab-content { display: none; animation: fadeIn 0.3s ease-out; }

        .tab-content.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        

        #map-wrapper {

            /* ç§»é™¤ Canvas ç›¸å…³çš„èƒŒæ™¯å›¾æ¡ˆï¼Œä½†ä¿ç•™æ ·å¼ä½œä¸ºå®¹å™¨ */

            cursor: default; overflow: hidden; position: relative;

            touch-action: none;

        }

        #map-wrapper:active { cursor: default; }



        /* ç§»åŠ¨ç«¯åº•éƒ¨å¯¼èˆªæ¿€æ´»æ€ */

        .mobile-nav-btn.active { color: #2563EB; }

        

        /* æ»šåŠ¨æ¡ç¾åŒ– */

        .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }

        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #CBD5E1; border-radius: 4px; }

        .custom-scrollbar::-webkit-scrollbar-track { background-color: transparent; }



        /* Input error ring */

        .ring-red-500 {

            transition: all 0.2s ease-in-out;

        }

    </style>

</head>

<body class="flex flex-col min-h-screen">



    <!-- é¡¶éƒ¨æ ‡é¢˜æ  (Mobile & Desktop) -->

    <header class="bg-white/90 backdrop-blur-md sticky top-0 z-40 border-b border-gray-200 shadow-sm">

        <div class="container mx-auto px-4 py-3 flex justify-between items-center">

            <div class="flex items-center gap-2">

                <div class="bg-blue-600 text-white p-1.5 rounded-lg shadow-md shadow-blue-500/30">

                    <i class="ph ph-lock text-xl"></i>

                </div>

                <h1 class="font-bold text-gray-800 text-base leading-tight">æ—…æ¸¸è§„åˆ’å¸ˆ <span class="text-[10px] text-red-600 bg-red-50 px-1.5 py-0.5 rounded-full border border-red-100 align-middle" id="sync-status-badge">éœ€ç™»å½•</span></h1>

            </div>

            

            <!-- ç™»å½•/Profile Button -->

            <div class="flex items-center gap-2">

                <!-- æ–°å¢å¿«é€Ÿé€€å‡ºæŒ‰é’® (åªæœ‰ç™»å½•åæ‰æ˜¾ç¤º) -->

                <button id="logout-button-header" onclick="handleSignOut()" 

                        class="hidden bg-red-100 px-3 py-1 rounded-xl text-xs text-red-600 hover:bg-red-200 transition-colors items-center gap-1">

                    <i class="ph ph-sign-out"></i> é€€å‡º

                </button>



                <button id="auth-button" onclick="openAuthModal()" 

                        class="bg-gray-100 px-3 py-1 rounded-xl text-sm text-gray-600 hover:bg-gray-200 transition-colors flex items-center gap-1">

                    <i class="ph ph-user-circle"></i>

                    <span id="auth-status">ç™»å½•/æ³¨å†Œ</span>

                </button>

            </div>

            

            <!-- Desktop Nav (Hidden on Mobile) -->

            <nav class="hidden md:flex bg-gray-100/50 p-1 rounded-xl border border-gray-100">

                <button onclick="switchTab('explore')" class="nav-btn px-4 py-2 rounded-lg text-sm font-medium transition-all text-gray-600 hover:bg-white hover:shadow-sm" data-tab="explore">ğŸ”ï¸ ç™¾ç§‘</button>

                <button onclick="switchTab('routes')" class="nav-btn px-4 py-2 rounded-lg text-sm font-medium transition-all text-gray-600 hover:bg-white hover:shadow-sm" data-tab="routes">ğŸ—ºï¸ åœ°å›¾</button>

                <button onclick="switchTab('budget')" class="nav-btn px-4 py-2 rounded-lg text-sm font-medium transition-all text-gray-600 hover:bg-white hover:shadow-sm" data-tab="budget">ğŸ’° é¢„ç®—</button>

                <button onclick="switchTab('data')" class="nav-btn px-4 py-2 rounded-lg text-sm font-medium transition-all text-gray-600 hover:bg-white hover:shadow-sm" data-tab="data">ğŸ“Š çœ‹æ¿</button>

                <button onclick="switchTab('pack')" class="nav-btn px-4 py-2 rounded-lg text-sm font-medium transition-all text-gray-600 hover:bg-white hover:shadow-sm" data-tab="pack">ğŸ’ æ¸…å•</button>

            </nav>

        </div>

    </header>



    <main class="flex-grow container mx-auto px-4 py-4">

        

        <!-- Loading State Placeholder -->

        <div id="loading-state" class="absolute inset-0 bg-gray-50/70 backdrop-blur-sm z-40 flex items-center justify-center hidden">

            <div class="flex flex-col items-center p-8 bg-white rounded-xl shadow-xl">

                <div class="ph ph-spinner-gap animate-spin text-4xl text-blue-600 mb-3"></div>

                <p class="text-gray-600 font-medium">æ­£åœ¨è¿æ¥ä¸åŒæ­¥æ•°æ®...</p>

            </div>

        </div>



        <!-- 1. æ™¯ç‚¹ç™¾ç§‘ -->

        <section id="explore" class="tab-content active">

            <div class="flex justify-between items-center mb-4">

                <h2 class="text-xl font-bold text-gray-800">æ™¯ç‚¹å‘ç°</h2>

                <button onclick="openAttractionModal()" class="bg-blue-600 active:bg-blue-700 text-white px-3 py-2 rounded-xl shadow-lg flex items-center gap-1 text-xs transition-transform active:scale-95">

                    <i class="ph ph-plus-bold"></i> è‡ªå®šä¹‰

                </button>

            </div>

            <div class="bg-white p-3 rounded-2xl shadow-sm border border-gray-100 mb-4 flex flex-col gap-3 sticky top-16 z-30">

                <div class="relative w-full">

                    <i class="ph ph-magnifying-glass absolute left-3 top-3 text-gray-400"></i>

                    <input type="text" id="explore-search" placeholder="æœæ™¯ç‚¹..." oninput="renderExploreGrid()" class="w-full bg-gray-50 border-0 rounded-xl pl-9 pr-3 py-2.5 text-sm ring-1 ring-gray-200 outline-none">

                </div>

                <div class="flex overflow-x-auto gap-2 pb-1 custom-scrollbar">

                    <select id="explore-filter" onchange="renderExploreGrid()" class="bg-gray-50 border-0 rounded-xl px-3 py-2 text-xs outline-none flex-shrink-0 ring-1 ring-gray-200">

                        <option value="all">å…¨éƒ¨ç±»å‹</option><option value="è‡ªç„¶">ğŸ”ï¸ è‡ªç„¶</option><option value="äººæ–‡">ğŸ•Œ äººæ–‡</option><option value="æ»‘é›ª">ğŸ¿ æ»‘é›ª</option><option value="custom">âœ¨ è‡ªå®šä¹‰</option>

                    </select>

                </div>

            </div>

            <div id="explore-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 pb-20"></div>

        </section>



        <!-- 2. è¡Œç¨‹è„‘å›¾ (åŸåœ°å›¾é¡µé¢) -->

        <section id="routes" class="tab-content">

            <div class="flex flex-col lg:grid lg:grid-cols-12 gap-4 h-auto lg:h-[calc(100vh-100px)]">

                

                <!-- è¡Œç¨‹å¤©æ•°åˆ—è¡¨ (col-span-3) -->

                <div class="lg:col-span-3 flex flex-col gap-3 bg-white p-3 rounded-2xl shadow-sm border border-gray-100 order-2 lg:order-1">

                    <div class="flex justify-between items-center">

                        <h3 class="font-bold text-gray-800 text-sm">ğŸ“… è¡Œç¨‹</h3>

                        <button onclick="addDay()" class="text-xs bg-blue-50 text-blue-600 px-2 py-1 rounded border border-blue-100">+ å¤©æ•°</button>

                    </div>

                    <div id="day-list" class="flex lg:flex-col gap-2 overflow-x-auto lg:overflow-y-auto custom-scrollbar pb-2 lg:pb-0 h-auto lg:h-1/2"></div>

                    <div class="mt-2 border-t pt-2 lg:h-1/2 lg:flex-col lg:flex hidden lg:flex">

                         <h3 class="font-bold text-gray-800 mb-2 text-xs">ğŸ“ å½“æ—¥æ˜ç»†</h3>

                         <div id="day-spots-list-desktop" class="flex-grow overflow-y-auto space-y-2 pr-1 custom-scrollbar text-xs"></div>

                    </div>

                </div>



                <!-- è„‘å›¾å¯è§†åŒ–åŒºåŸŸ (lg:col-span-6) -->

                <div class="lg:col-span-6 bg-white rounded-2xl shadow-xl border border-gray-100 p-6 flex flex-col order-1 lg:order-2 h-[500px] lg:h-full">

                    <h3 class="font-bold text-gray-800 text-lg mb-4 flex items-center gap-2">

                        <i class="ph ph-tree-structure text-blue-600"></i> ç¬¬ <span id="current-day-num">1</span> å¤© - è¡Œç¨‹è„‘å›¾

                    </h3>

                    <div id="itinerary-mind-map" class="flex-grow overflow-y-auto space-y-6 custom-scrollbar">

                        <!-- Content will be rendered by renderItineraryView() -->

                        <div class="text-center text-gray-500 py-12">åŠ è½½ä¸­...</div>

                    </div>

                </div>



                <!-- æ™¯ç‚¹æ·»åŠ åˆ—è¡¨ (col-span-3) -->

                <div class="lg:col-span-3 bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex flex-col h-full order-3">

                    <div class="lg:hidden mb-4">

                        <h3 class="font-bold text-gray-800 mb-2 text-sm">ğŸ“ å½“æ—¥æ™¯ç‚¹ (<span id="day-spot-count">0</span>)</h3>

                        <div id="day-spots-list-mobile" class="space-y-2 max-h-40 overflow-y-auto custom-scrollbar text-xs"></div>

                    </div>

                    <h3 class="font-bold text-gray-800 mb-3 text-sm">â• æ·»åŠ æ™¯ç‚¹</h3>

                    <input type="text" id="spot-search" placeholder="æœç´¢..." oninput="renderAllSpots()" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm mb-3 outline-none">

                    <div id="all-spots-list" class="flex-grow overflow-y-auto space-y-2 pr-1 custom-scrollbar max-h-60 lg:max-h-none"></div>

                </div>

            </div>

        </section>



        <!-- 3. æ™ºèƒ½é¢„ç®— -->

        <section id="budget" class="tab-content">

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-4 pb-20">

                <div class="lg:col-span-5 space-y-4">

                    <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">

                        <div class="flex items-center gap-2 mb-3 text-blue-600 text-sm font-bold"><i class="ph ph-plus-circle text-lg"></i> æ·»åŠ æ”¯å‡º</div>

                        <div class="flex gap-2">

                            <input type="text" id="custom-item-name" placeholder="é¡¹ç›® (å¦‚:æ»‘é›ªç¥¨)" class="flex-grow bg-gray-50 border-0 rounded-lg px-3 py-2 text-sm ring-1 ring-gray-200 outline-none">

                            <input type="number" id="custom-item-price" placeholder="Â¥" class="w-20 bg-gray-50 border-0 rounded-lg px-3 py-2 text-sm ring-1 ring-gray-200 outline-none">

                            <button onclick="addCustomBudgetItem()" class="bg-blue-600 text-white px-3 rounded-lg hover:bg-blue-700 transition"><i class="ph ph-check-bold"></i></button>

                        </div>

                    </div>

                    <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">

                        <h3 class="font-bold text-gray-800 mb-3 text-sm">åŸºç¡€è®¾å®š</h3>

                        <div class="grid grid-cols-2 gap-3 text-sm">

                            <!-- FIX: æ·»åŠ  onchange="debounceSave()" ç¡®ä¿è¾“å…¥åŒæ­¥ -->

                            <div><label class="text-xs text-gray-400">äººæ•°</label><input type="number" id="budget-people" value="2" class="w-full mt-1 border rounded p-1.5" onchange="updateDashboard(); debounceSave()"></div>

                            <div><label class="text-xs text-gray-400">å¤©æ•°</label><input type="number" id="budget-days" value="1" disabled class="w-full mt-1 bg-gray-50 border rounded p-1.5 text-gray-400"></div>

                            <div><label class="text-xs text-gray-400">ä½å®¿/é—´</label><input type="number" id="price-stay" value="400" class="w-full mt-1 border rounded p-1.5" onchange="updateDashboard(); debounceSave()"></div>

                            <div><label class="text-xs text-gray-400">è½¦è´¹/å¤©</label><input type="number" id="price-trans" value="500" class="w-full mt-1 border rounded p-1.5" onchange="updateDashboard(); debounceSave()"></div>

                            <div><label class="text-xs text-gray-400">é¤/äºº</label><input type="number" id="price-food" value="150" class="w-full mt-1 border rounded p-1.5" onchange="updateDashboard(); debounceSave()"></div>

                            <div><label class="text-xs text-gray-400">é—¨ç¥¨/äºº</label><input type="number" id="price-ticket" value="800" class="w-full mt-1 border rounded p-1.5" onchange="updateDashboard(); debounceSave()"></div>

                        </div>

                    </div>

                </div>

                <div class="lg:col-span-7">

                    <div class="bg-gradient-to-br from-blue-600 to-indigo-700 p-5 rounded-3xl shadow-xl text-white relative overflow-hidden">

                        <div class="absolute top-0 right-0 w-40 h-40 bg-white/10 rounded-full blur-3xl -mr-10 -mt-10 pointer-events-none"></div>

                        <div class="mb-4">

                            <h2 class="text-lg font-bold mb-4 opacity-90">é¢„ç®—æ¸…å•</h2>

                            <div id="budget-summary-list" class="space-y-2 text-sm text-blue-50 max-h-[300px] overflow-y-auto custom-scrollbar pr-1"></div>

                        </div>

                        <div class="pt-4 border-t border-white/10 flex justify-between items-end">

                            <div>

                                <div class="text-blue-200 text-xs">é¢„ä¼°æ€»è®¡</div>

                                <div class="text-3xl font-bold mt-1">Â¥<span id="disp-total">0</span></div>

                            </div>

                            <div class="text-right text-blue-200 text-xs">äººå‡: Â¥<span id="disp-avg">0</span></div>

                        </div>

                    </div>

                </div>

            </div>

        </section>



        <!-- 4. å…¨æ™¯çœ‹æ¿ -->

        <section id="data" class="tab-content">

             <div class="grid grid-cols-2 gap-3 mb-4">

                <div class="bg-white p-3 rounded-2xl shadow-sm border border-gray-100 text-center"><div class="text-[10px] text-gray-400">æ€»é¢„ç®—</div><div class="text-lg font-bold text-blue-600">Â¥<span id="dash-total">0</span></div></div>

                <div class="bg-white p-3 rounded-2xl shadow-sm border border-gray-100 text-center"><div class="text-[10px] text-gray-400">è¡Œç¨‹</div><div class="text-lg font-bold text-gray-700"><span id="dash-days">0</span> å¤©</div></div>

                <div class="bg-white p-3 rounded-2xl shadow-sm border border-gray-100 text-center"><div class="text-[10px] text-gray-400">å‡†å¤‡</div><div class="text-lg font-bold text-green-600"><span id="dash-pack">0</span>%</div></div>

                <div class="bg-white p-3 rounded-2xl shadow-sm border border-gray-100 text-center"><div class="text-[10px] text-gray-400">æ»‘é›ªç‚¹</div><div class="text-lg font-bold text-purple-600"><span id="dash-ski-spots">0</span></div></div>

            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 pb-20">

                <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100"><h3 class="text-sm font-bold text-gray-700 mb-2">èµ„é‡‘å æ¯”</h3><div class="h-48"><canvas id="budgetDoughnutChart"></canvas></div></div>

                <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100"><h3 class="text-sm font-bold text-gray-700 mb-2">ç©æ³•åˆ†å¸ƒ</h3><div class="h-48"><canvas id="spotPolarChart"></canvas></div></div>

                <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">

                    <h3 class="text-sm font-bold text-gray-700 mb-2">å¥‡æ™¯é¢„æµ‹ (<span id="temp-val">--20</span>Â°C)</h3>

                    <!-- FIX: æ·»åŠ  oninput="debounceSave()" ç¡®ä¿æ¸©åº¦åŒæ­¥ -->

                    <input type="range" id="temp-slider" min="-40" max="5" value="-20" oninput="updateDashboard(); debounceSave()" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer mb-4">

                    <div class="grid grid-cols-2 gap-3 text-xs">

                        <div><div class="text-gray-500 mb-1">æ™¨é›¾</div><div class="font-bold text-gray-800" id="prob-fog">85%</div></div>

                        <div><div class="text-gray-500 mb-1">è“å†°</div><div class="font-bold text-gray-800" id="prob-ice">90%</div></div>

                    </div>

                </div>

            </div>

        </section>



        <!-- 5. è£…å¤‡æ¸…å• -->

        <section id="pack" class="tab-content">

            <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 mb-4">

                <div class="flex items-center gap-4 mb-4">

                    <div class="w-16 h-16 relative flex-shrink-0"><canvas id="packChart"></canvas><div class="absolute inset-0 flex items-center justify-center text-xs font-bold text-blue-600" id="pack-percent-text">0%</div></div>

                    <div class="flex-grow">

                        <h2 class="font-bold text-gray-800">å‡†å¤‡è¿›åº¦</h2>

                        <p class="text-xs text-gray-400 mt-1">å·²é€‰ <span id="pack-checked-count">0</span> / <span id="pack-total-count">0</span></p>

                    </div>

                    <button onclick="exportGearList()" class="bg-blue-50 text-blue-600 p-2 rounded-lg text-xl hover:bg-blue-100 transition"><i class="ph ph-export"></i></button>

                </div>

                <!-- FIX: addCustomGear now calls debounceSave internally -->

                <button onclick="addCustomGear()" class="w-full py-2 border border-dashed border-gray-300 rounded-xl text-xs text-gray-500 mb-4 hover:bg-gray-50 transition">+ æ·»åŠ è‡ªå®šä¹‰ç‰©å“</button>

                <div id="gear-container" class="space-y-4 pb-20"></div>

            </div>

        </section>

    </main>



    <!-- Mobile Bottom Navigation -->

    <nav class="md:hidden fixed bottom-0 left-0 w-full bg-white border-t border-gray-200 z-50 flex justify-around items-center pb-safe pt-2 px-1 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">

        <button onclick="switchTab('explore')" class="mobile-nav-btn flex flex-col items-center p-2 text-gray-400 active" data-tab="explore"><i class="ph ph-mountains text-2xl"></i><span class="text-[10px]">ç™¾ç§‘</span></button>

        <button onclick="switchTab('routes')" class="mobile-nav-btn flex flex-col items-center p-2 text-gray-400" data-tab="routes"><i class="ph ph-map-trifold text-2xl"></i><span class="text-[10px]">åœ°å›¾</span></button>

        <button onclick="openAuthModal()" class="flex flex-col items-center justify-center w-12 h-12 bg-blue-600 rounded-full text-white shadow-lg -mt-6 border-4 border-white" title="è´¦æˆ·">

            <i class="ph ph-user text-2xl"></i>

        </button>

        <button onclick="switchTab('budget')" class="mobile-nav-btn flex flex-col items-center p-2 text-gray-400" data-tab="budget"><i class="ph ph-calculator text-2xl"></i><span class="text-[10px]">é¢„ç®—</span></button>

        <button onclick="switchTab('data')" class="mobile-nav-btn flex flex-col items-center p-2 text-gray-400" data-tab="data"><i class="ph ph-chart-pie-slice text-2xl"></i><span class="text-[10px]">ç»Ÿè®¡</span></button>

    </nav>



    <!-- Modal: è‡ªå®šä¹‰æ™¯ç‚¹ -->

    <div id="attraction-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">

        <div class="bg-white rounded-2xl w-full max-w-sm p-5 shadow-2xl animate-[fadeIn_0.2s_ease-out]">

            <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-gray-800">è‡ªå®šä¹‰åœ°ç‚¹</h3><button onclick="closeModal('attraction-modal')" class="text-gray-400"><i class="ph ph-x text-xl"></i></button></div>

            

            <div class="space-y-3">

                <div class="relative group cursor-pointer" onclick="document.getElementById('modal-img-input').click()">

                    <div id="modal-img-preview" class="w-full h-24 bg-gray-100 rounded-lg border-2 border-dashed border-gray-300 flex flex-col items-center justify-center text-gray-400 group-hover:bg-gray-50 group-hover:border-blue-300 transition overflow-hidden">

                        <i class="ph ph-image text-2xl mb-1"></i><span class="text-xs">ç‚¹å‡»æ·»åŠ å°é¢å›¾ç‰‡ (å¯é€‰)</span>

                    </div>

                    <input type="file" id="modal-img-input" accept="image/*" class="hidden" onchange="previewImage(this)">

                </div>

                

                <input type="text" id="modal-name" placeholder="åç§° (å¦‚: éšè—æ‰“å¡ç‚¹)" class="w-full bg-gray-50 border-0 rounded-xl p-3 ring-1 ring-gray-200 outline-none">

                <div class="flex gap-2">

                    <select id="modal-type" class="bg-gray-50 border-0 rounded-xl p-3 ring-1 ring-gray-200 outline-none flex-grow"><option value="custom">âœ¨ ç§è—</option><option value="è‡ªç„¶">ğŸ”ï¸ è‡ªç„¶</option><option value="äººæ–‡">ğŸ•Œ äººæ–‡</option><option value="æ»‘é›ª">ğŸ¿ æ»‘é›ª</option></select>

                    <!-- FIX: ç§»é™¤é€‰ä½ç½®æŒ‰é’®ï¼Œåªæ˜¾ç¤ºåæ ‡ -->

                    <button onclick="pickLocationFromModal()" class="bg-gray-50 text-gray-600 px-3 rounded-xl text-sm font-medium border border-gray-200 whitespace-nowrap cursor-default">ğŸ“ é€‰ä½ç½®</button>

                </div>

                <textarea id="modal-desc" placeholder="å¤‡æ³¨..." class="w-full bg-gray-50 border-0 rounded-xl p-3 ring-1 ring-gray-200 h-20 outline-none resize-none"></textarea>

                <div class="text-xs text-gray-400 text-center" id="modal-coords-display">åæ ‡: æœªè®¾ç½®</div>

            </div>

            <button onclick="saveCustomSpot()" id="save-spot-btn" class="w-full mt-5 bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-blue-500/30 hover:bg-blue-700 transition">ä¿ å­˜</button>

        </div>

    </div>



    <!-- Modal: ç™»å½•/æ³¨å†Œ (Username based) -->

    <div id="auth-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">

        <div class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl animate-[fadeIn_0.2s_ease-out]">

            <div id="auth-info" class="mb-4 hidden">

                <h3 class="text-xl font-bold text-gray-800 mb-2">æ¬¢è¿å›æ¥</h3>

                <p class="text-sm text-gray-600 truncate">è´¦æˆ·: <span id="user-email-display" class="font-medium"></span></p>

                <button onclick="handleSignOut()" class="w-full mt-4 bg-red-500 text-white py-2 rounded-lg hover:bg-red-600 transition">é€€å‡ºç™»å½•</button>

            </div>



            <div id="auth-form">

                <div class="flex justify-between items-center mb-4">

                    <h3 class="text-xl font-bold text-gray-800" id="auth-title">ç™»å½•è´¦æˆ·</h3>

                    <button onclick="closeModal('auth-modal')" class="text-gray-400"><i class="ph ph-x text-xl"></i></button>

                </div>

                <input type="text" id="auth-username" placeholder="è´¦æˆ·å" class="w-full mb-3 bg-gray-50 border-0 rounded-lg p-3 ring-1 ring-gray-200 outline-none">

                <input type="password" id="auth-password" placeholder="å¯†ç  (è‡³å°‘6ä½)" class="w-full mb-3 bg-gray-50 border-0 rounded-lg p-3 ring-1 ring-gray-200 outline-none">

                <input type="password" id="auth-password-confirm" placeholder="ç¡®è®¤å¯†ç " class="w-full mb-3 bg-gray-50 border-0 rounded-lg p-3 ring-1 ring-gray-200 outline-none hidden">

                <p id="auth-error" class="text-red-500 text-xs mb-3"></p>



                <button onclick="handleAuthAction()" id="auth-submit-btn" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 transition">ç™»å½•</button>

                <button onclick="toggleAuthMode()" id="auth-toggle-btn" class="w-full mt-3 text-sm text-blue-600 hover:underline">åˆ‡æ¢åˆ°æ³¨å†Œ</button>

            </div>

        </div>

    </div>



    <!-- Firebase Scripts -->

    <script type="module">

        // =========================================================================

        // ğŸš¨ğŸš¨ğŸš¨ ä¸€åŠ³æ°¸é€¸çš„è§£å†³æ–¹æ¡ˆï¼šè¯·å°†ä»¥ä¸‹è§„åˆ™å¤åˆ¶å¹¶å‘å¸ƒåˆ°æ‚¨çš„ Firebase Console ğŸš¨ğŸš¨ğŸš¨

        // =========================================================================



        /* ** [ Firestore Database Rules ] **

         ** è§£å†³æ•°æ®å›æ¡£é—®é¢˜ (Permission Denied) **

        */

        /* rules_version = '2';

        service cloud.firestore {

          match /databases/{database}/documents {

            // å…è®¸ä»»ä½•å·²ç™»å½•çš„ç”¨æˆ·è¯»å–å’Œå†™å…¥è¿™ä¸ªæ•°æ®åº“ä¸­çš„æ‰€æœ‰æ•°æ®

            match /{document=**} {

              allow read, write: if request.auth != null;

            }

          }

        }

        */



        /* ** [ Firebase Storage Rules ] **

         ** è§£å†³å›¾ç‰‡ä¸Šä¼ å¤±è´¥é—®é¢˜ **

        */

        /*

        rules_version = '2';

        service firebase.storage {

          match /b/{bucket}/o {

            match /{allPaths=**} {

              // å…è®¸ä»»ä½•å·²è®¤è¯çš„ç”¨æˆ·è¯»å–å’Œå†™å…¥

              allow read, write: if request.auth != null;

            }

          }

        }

        */



        // =========================================================================



        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";

        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        import { getFirestore, doc, setDoc, onSnapshot, collection, query, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        import { getStorage, ref, uploadString, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js"; 

        

        setLogLevel('debug'); // Enable Firestore logging



        // --- DEPLOYMENT CONFIGURATION ---

        

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        

        // 2. Custom Configuration provided by user

        const customFirebaseConfig = {

            // YOUR PROVIDED CONFIGURATION

            apiKey: "AIzaSyAlbsoPG7J2cDocEGisruheVdTaX1Wajgc",

            authDomain: "xinjiang-c95f8.firebaseapp.com",

            projectId: "xinjiang-c95f8",

            storageBucket: "xinjiang-c95f8.appspot.com",

        };



        const configToUse = typeof __firebase_config !== 'undefined' && __firebase_config ? JSON.parse(__firebase_config) : customFirebaseConfig;

        const firebaseConfig = configToUse;

        

        // --- END CONFIGURATION ---



        let app, db, auth, storage; 

        let authMode = 'login'; 

        let currentUserId = null;

        let isAuthReady = false;



        window.openAuthModal = openAuthModal;

        window.toggleAuthMode = toggleAuthMode;

        window.handleAuthAction = handleAuthAction;

        window.handleSignOut = handleSignOut;

        window.saveUserData = saveUserData;

        window.uploadImageAndGetUrl = uploadImageAndGetUrl; 

        

        // Global utility to force all rendering functions to re-run after data load/sync

        window.renderApp = () => {

            if (!window.state.initialized || !window.state.dataLoaded) {

                 document.getElementById('loading-state').classList.remove('hidden');

                 return;

            }

            document.getElementById('loading-state').classList.add('hidden');

            

            // Re-render all major components

            window.renderExploreGrid();

            window.renderDayList();

            window.renderAllSpots();

            window.renderBudget();

            window.renderGear();

            window.updateDashboard(); 

        }



        function getUsernameFromEmail(email) {

            if (!email) return 'N/A';

            const parts = email.split('@');

            return parts[0];

        }



        // FIX: Add function for displaying quick feedback in header badge

        function showFeedbackMessage(message, isError = false) {

            const headerBadgeEl = document.getElementById('sync-status-badge');

            headerBadgeEl.textContent = message;

            if (isError) {

                headerBadgeEl.className = 'text-[10px] text-red-600 bg-red-50 px-1.5 py-0.5 rounded-full border border-red-100 align-middle';

            } else {

                headerBadgeEl.className = 'text-[10px] text-green-600 bg-green-50 px-1.5 py-0.5 rounded-full border border-green-100 align-middle';

            }

            // Restore default sync status after a short delay

            setTimeout(() => {

                updateAuthStateUI(auth.currentUser); 

            }, 3000);

        }





        function updateAuthStateUI(user) {

            const statusEl = document.getElementById('auth-status');

            const headerBadgeEl = document.getElementById('sync-status-badge');

            const infoDiv = document.getElementById('auth-info');

            const formDiv = document.getElementById('auth-form');

            const logoutHeaderBtn = document.getElementById('logout-button-header'); // FIX: Reference new button



            if (user) {

                currentUserId = user.uid;

                const username = getUsernameFromEmail(user.email);

                statusEl.textContent = username;

                headerBadgeEl.textContent = 'å·²åŒæ­¥';

                headerBadgeEl.className = 'text-[10px] text-green-600 bg-green-50 px-1.5 py-0.5 rounded-full border border-green-100 align-middle';

                

                document.getElementById('user-email-display').textContent = username;

                infoDiv.classList.remove('hidden');

                formDiv.classList.add('hidden');



                // FIX: Show header logout button

                logoutHeaderBtn.classList.remove('hidden');

                logoutHeaderBtn.classList.add('flex');

                

            } else {

                currentUserId = null;

                statusEl.textContent = 'ç™»å½•/æ³¨å†Œ';

                headerBadgeEl.textContent = 'éœ€ç™»å½•';

                headerBadgeEl.className = 'text-[10px] text-red-600 bg-red-50 px-1.5 py-0.5 rounded-full border border-red-100 align-middle';

                

                infoDiv.classList.add('hidden');

                formDiv.classList.remove('hidden');



                // FIX: Hide header logout button

                logoutHeaderBtn.classList.add('hidden');

                logoutHeaderBtn.classList.remove('flex');

            }

        }



        async function initAuthAndDb() {

            try {

                if (!firebaseConfig.apiKey || !firebaseConfig.projectId) {

                    console.error("Firebase configuration is incomplete. Data synchronization will be disabled.");

                    window.state.initialized = true; 

                    window.state.dataLoaded = true;

                    window.renderApp();

                    return;

                }

                

                app = initializeApp(firebaseConfig);

                auth = getAuth(app);

                db = getFirestore(app);

                storage = getStorage(app); 



                await setPersistence(auth, browserLocalPersistence);



                if (initialAuthToken) {

                    await signInWithCustomToken(auth, initialAuthToken);

                }



                onAuthStateChanged(auth, (user) => {

                    isAuthReady = true;

                    updateAuthStateUI(user);

                    

                    if (user) {

                        setupDataListener(user.uid); // Start real-time sync

                    } else if (!window.state.initialized) {

                        // If not logged in and not initialized, render with defaults

                        window.state.initialized = true;

                        window.state.dataLoaded = true;

                        window.renderApp(); 

                    }

                });



            } catch (error) {

                console.error("Firebase initialization failed:", error);

                window.state.initialized = true;

                window.state.dataLoaded = true;

                window.renderApp();

            }

        }

        

        // --- REALTIME SYNC: onSnapshot ---

        function setupDataListener(userId) {

            const docRef = doc(db, 'artifacts', appId, 'users', userId, 'data', 'state');

            onSnapshot(docRef, (docSnap) => {

                if (docSnap.exists()) {

                    // Load and parse data

                    const data = docSnap.data();

                    // Load custom spots and combine with default spots

                    window.state.spots = [...window.defaultSpots, ...(data.spots || [])]; 

                    // Parse itinerary string back to array

                    try {

                        // Ensure itinerary has correct shape, even if saved as []

                        const loadedItinerary = JSON.parse(data.itinerary);

                        window.state.itinerary = loadedItinerary.length > 0 ? loadedItinerary : [[]];

                    } catch {

                        window.state.itinerary = [[]]; // Fallback if parsing fails

                    }

                    window.state.customBudget = data.customBudget || [];

                    window.state.customGear = data.customGear || [];

                } else {

                    // Document doesn't exist, create it with defaults

                    saveUserData(); // This will auto-sync back via onSnapshot

                }



                if (!window.state.initialized) {

                    window.state.initialized = true;

                }

                window.state.dataLoaded = true;

                window.renderApp(); // Global re-render trigger

                console.log("Firestore Data Synced and App Rendered.");

            }, (error) => {

                console.error("Firestore Listener Error:", error);

                // FIX: Show error message if listener fails (e.g., due to rules)

                showFeedbackMessage("åŒæ­¥å¤±è´¥ï¼è¯·æ£€æŸ¥ Firebase è§„åˆ™ã€‚", true);

                window.state.dataLoaded = true; 

                window.renderApp();

            });

        }

        

        async function uploadImageAndGetUrl(base64Data, userId) {

            if (!storage || !base64Data || !userId) return null;

            

            // Use the AUTH UID as the directory name

            const path = `images/${userId}/${Date.now()}.jpeg`;

            const storageRef = ref(storage, path);



            try {

                await uploadString(storageRef, base64Data, 'data_url');

                const url = await getDownloadURL(storageRef);

                return url;

            } catch (error) {

                console.error("Error uploading image to Storage:", error);

                return null;

            }

        }



        async function saveUserData() {

            if (!currentUserId || !isAuthReady || !db) {

                console.warn("Save skipped: User not authenticated or DB not ready.");

                return;

            }



            try {

                const docRef = doc(db, 'artifacts', appId, 'users', currentUserId, 'data', 'state');

                const dataToSave = {

                    // Only save custom spots (id > 1000)

                    spots: window.state.spots.filter(s => s.id > 1000), 

                    // Stringify itinerary (to comply with array-in-array Firestore limitations if any)

                    itinerary: JSON.stringify(window.state.itinerary), 

                    customBudget: window.state.customBudget,

                    customGear: window.state.customGear,

                    lastSave: new Date().toISOString()

                };



                await setDoc(docRef, dataToSave, { merge: true });

                console.log("Data successfully queued for Firestore save."); // Log success for save

                

            } catch (e) {

                // FIX: Enhanced error logging and UI feedback for save failure

                console.error("CRITICAL SAVE ERROR: Firestore write failed. Check your Firebase Rules.", e);

                showFeedbackMessage("ä¿å­˜å¤±è´¥ï¼è¯·æ£€æŸ¥ Firestore è§„åˆ™ã€‚", true);

            }

        }



        // --- AUTH UI HANDLERS ---

        function openAuthModal() {

            document.getElementById('auth-modal').classList.remove('hidden');

        }

        

        function closeModal(id) {

            document.getElementById(id).classList.add('hidden');

        }



        function toggleAuthMode() {

            const title = document.getElementById('auth-title');

            const submitBtn = document.getElementById('auth-submit-btn');

            const toggleBtn = document.getElementById('auth-toggle-btn');

            const confirmPass = document.getElementById('auth-password-confirm');

            const errorEl = document.getElementById('auth-error');

            errorEl.textContent = '';



            if (authMode === 'login') {

                authMode = 'register';

                title.textContent = 'æ³¨å†Œæ–°è´¦æˆ·';

                submitBtn.textContent = 'æ³¨å†Œ';

                toggleBtn.textContent = 'å·²æœ‰è´¦æˆ·ï¼Ÿåˆ‡æ¢åˆ°ç™»å½•';

                confirmPass.classList.remove('hidden');

            } else {

                authMode = 'login';

                title.textContent = 'ç™»å½•è´¦æˆ·';

                submitBtn.textContent = 'ç™»å½•';

                toggleBtn.textContent = 'æ²¡æœ‰è´¦æˆ·ï¼Ÿåˆ‡æ¢åˆ°æ³¨å†Œ';

                confirmPass.classList.add('hidden');

            }

        }



        async function handleAuthAction() {

            const username = document.getElementById('auth-username').value;

            const password = document.getElementById('auth-password').value;

            const confirmPassword = document.getElementById('auth-password-confirm').value;

            const errorEl = document.getElementById('auth-error');

            errorEl.textContent = '';



            if (!username || password.length < 6) {

                errorEl.textContent = 'è´¦æˆ·åä¸èƒ½ä¸ºç©ºï¼Œå¯†ç è‡³å°‘6ä½ã€‚';

                return;

            }



            if (authMode === 'register' && password !== confirmPassword) {

                errorEl.textContent = 'ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´ã€‚';

                return;

            }



            // Construct Firebase-compatible email 

            const email = `${username}@${firebaseConfig.authDomain.split('.').slice(0, -2).join('.')}.canvas.local`;



            try {

                if (authMode === 'register') {

                    await createUserWithEmailAndPassword(auth, email, password);

                    // Use console.log for success instead of alert

                    console.log(`è´¦æˆ· ${username} æ³¨å†ŒæˆåŠŸï¼`); 

                } else {

                    await signInWithEmailAndPassword(auth, email, password);

                }

                

                document.getElementById('auth-modal').classList.add('hidden');



            } catch (error) {

                let errorMessage = 'è®¤è¯å¤±è´¥ã€‚';

                if (error.code === 'auth/email-already-in-use') errorMessage = 'è¯¥è´¦æˆ·åå·²è¢«æ³¨å†Œã€‚';

                if (error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') errorMessage = 'è´¦æˆ·åæˆ–å¯†ç é”™è¯¯ã€‚';

                if (error.code === 'auth/unauthorized-domain') {

                    errorMessage += ' éƒ¨ç½²å¤±è´¥ã€‚è¯·æ£€æŸ¥ï¼šæ‚¨æ˜¯å¦å·²å°†å½“å‰åŸŸåæ·»åŠ åˆ° Firebase æ§åˆ¶å°çš„ [Authentication -> Settings -> Authorized domains] åˆ—è¡¨ä¸­?';

                }

                errorEl.textContent = errorMessage;

                console.error("Auth Error:", error);

            }

        }



        async function handleSignOut() {

            try {

                await signOut(auth);

                console.log("æ‚¨å·²é€€å‡ºç™»å½•ã€‚"); // Removed alert

                document.getElementById('auth-modal').classList.add('hidden');

                // Reload to reset local state to default, which will then use dataLoaded=true to render defaults

                window.location.reload(); 

            } catch (error) {

                console.error("Sign Out Error:", error);

            }

        }



        initAuthAndDb();



    </script>

    <script>

        // --- æ ¸å¿ƒæ•°æ® (Global State) ---

        // 3. æ•°æ®ç»“æ„æ”¹é€ : ç§»é™¤ x/y, å¢åŠ  lng/lat çœŸå®åæ ‡

        const defaultSpots = [

            { id: 1, name: "ä¹Œé²æœ¨é½", type: "äººæ–‡", desc: "é¦–åºœ", lng: 87.617733, lat: 43.792818, tags: ["ä¸­è½¬"], img: "https://placehold.co/600x400/38BDF8/ffffff?text=Urumqi" },

            { id: 2, name: "ç¦¾æœ¨æ‘", type: "è‡ªç„¶", desc: "æ™¨é›¾", lng: 87.14083, lat: 48.06451, tags: ["æ‘„å½±"], img: "https://placehold.co/600x400/10B981/ffffff?text=Hemu+Village" },

            { id: 3, name: "å–€çº³æ–¯", type: "è‡ªç„¶", desc: "æ¹–æ€ª", lng: 87.0425, lat: 48.6575, tags: ["å¾’æ­¥"], img: "https://placehold.co/600x400/F97316/ffffff?text=Kanas+Lake" },

            { id: 4, name: "èµ›é‡Œæœ¨æ¹–", type: "è‡ªç„¶", desc: "è“å†°", lng: 81.25888, lat: 44.59306, tags: ["è‡ªé©¾"], img: "https://placehold.co/600x400/6366F1/ffffff?text=Sayram+Lake" },

            { id: 5, name: "å–€ä»€å¤åŸ", type: "äººæ–‡", desc: "å¤åŸ", lng: 76.0664, lat: 39.4678, tags: ["ç¾é£Ÿ"], img: "https://placehold.co/600x400/FACC15/000000?text=Kashgar+Old+City" },

            { id: 6, name: "å¯å¯æ‰˜æµ·", type: "æ»‘é›ª", desc: "æ»‘é›ª", lng: 89.96766, lat: 47.1648, tags: ["æé™"], img: "https://placehold.co/600x400/A855F7/ffffff?text=Koktokay+Ski" },

        ];

        window.defaultSpots = defaultSpots;



        const defaultGear = {

            "æ ¸å¿ƒä¿æš–": ["ç¾½ç»’æœ", "å†²é”‹è¡£", "ä¿æš–å†…è¡£", "ç¾Šæ¯›è¢œ", "é›ªåœ°é´"],

            "æ»‘é›ªè£…å¤‡": ["å¤´ç›”", "é›ªé•œ", "æŠ¤è„¸", "æ‰‹å¥—", "æŠ¤å…·"],

        };



        window.state = {

            spots: [...defaultSpots], itinerary: [[]], currentDayIndex: 0,

            customBudget: [], customGear: [], weatherTemp: -20,

            isPickingMode: false, 

            tempSpotCoords: null, // New variable for pick location mode

            initialized: false, // Initialized Firebase/Auth

            dataLoaded: false // Data successfully loaded from Firestore or defaulted

        };

        

        let saveTimeout;

        function debounceSave() {

            clearTimeout(saveTimeout);

            saveTimeout = setTimeout(() => {

                if (window.saveUserData) window.saveUserData();

            }, 1500);

        }



        // Global Chart Variables

        let budgetChart, polarChart, packChart;

        let currentModalImageBase64 = null; 

        

        // --- AMap Variables (now unused, but keeping the center data) ---

        let map = null;

        let markers = [];

        const XINJIANG_CENTER = {lng: 87.617733, lat: 43.792818}; // ä¹Œé²æœ¨é½åæ ‡

        

        // --- Modal Control ---

        window.closeModal = (id) => {

            document.getElementById(id).classList.add('hidden');

        }

        

        // --- 2. Explore & Route Logic ---

        window.renderExploreGrid = () => {

            const g=document.getElementById('explore-grid'), 

                  t=document.getElementById('explore-search').value.toLowerCase(), 

                  f=document.getElementById('explore-filter').value; 

            g.innerHTML='';

            

            state.spots.forEach(s=>{

                if((s.name.toLowerCase().includes(t)||s.tags.join('').includes(t))&&(f==='all'||(f==='custom'?s.id>1000:s.type===f))){

                    const div=document.createElement('div'); 

                    div.className="bg-white rounded-xl shadow-sm p-3 border border-gray-100 flex flex-col justify-between";

                    

                    let imageHtml = s.img && s.img.startsWith('http') ? 

                        `<img src="${s.img}" onerror="this.onerror=null;this.src='https://placehold.co/100x100/A0AEC0/ffffff?text=Image+Load+Fail';" class="w-full h-24 object-cover rounded-lg mb-2">` : 

                        `<div class="w-full h-24 bg-gray-100 flex items-center justify-center text-gray-400 rounded-lg mb-2"><i class="ph ph-map-pin"></i></div>`;



                    div.innerHTML=`

                        ${imageHtml}

                        <div><div class="flex justify-between"><h3 class="font-bold text-gray-800">${s.name}</h3><span class="text-[10px] bg-gray-100 px-1.5 py-0.5 rounded text-gray-500">${s.type}</span></div><p class="text-xs text-gray-400 mt-1">${s.desc||''}</p></div><button onclick="addToRoute(${s.id})" class="mt-3 w-full bg-blue-50 text-blue-600 text-xs py-2 rounded font-medium hover:bg-blue-100 transition">åŠ å…¥è¡Œç¨‹</button>`;

                    g.appendChild(div);

                }

            });

            updateDashboard();

        }

        

        function addToRoute(id){ 

            if (!state.itinerary[state.currentDayIndex]) {

                state.itinerary.push([]);

            }

            state.itinerary[state.currentDayIndex].push(id); 

            renderDayList(); 

            debounceSave(); 

        }

        

        window.renderDayList = () => {

            const l=document.getElementById('day-list'); 

            l.innerHTML=''; 

            

            // Ensure itinerary has at least one day

            if (state.itinerary.length === 0) {

                state.itinerary.push([]);

                state.currentDayIndex = 0;

            }



            document.getElementById('budget-days').value=state.itinerary.length; 

            

            state.itinerary.forEach((s,i)=>{

                const div=document.createElement('div'); 

                div.className=`flex-shrink-0 lg:flex-shrink w-20 lg:w-full p-2 lg:p-3 rounded-xl border border-gray-100 cursor-pointer text-center lg:text-left transition-all ${i===state.currentDayIndex?'bg-blue-50 border-blue-200 text-blue-700':'hover:bg-gray-50 text-gray-500'}`;

                div.innerHTML=`<div class="font-bold text-xs">D${i+1}</div><div class="text-[10px] opacity-70">${s.length}ç‚¹</div>`;

                div.onclick=()=>{state.currentDayIndex=i;renderDayList();}; 

                l.appendChild(div);

            });

            

            document.getElementById('current-day-num').innerText=state.currentDayIndex+1;

            document.getElementById('day-spot-count').innerText=state.itinerary[state.currentDayIndex].length;

            renderDaySpots(); 

            

            // FIX: Call the Mind Map visualization

            window.renderItineraryView(); 

        }

        

        function addDay(){ 

            state.itinerary.push([]); 

            state.currentDayIndex=state.itinerary.length-1; 

            renderDayList(); 

            debounceSave(); 

        }

        

        function renderDaySpots() {

            const desktopL=document.getElementById('day-spots-list-desktop'), 

                  mobileL=document.getElementById('day-spots-list-mobile');

            const html = state.itinerary[state.currentDayIndex].map((id,i)=>{

                const s=state.spots.find(sp=>sp.id===id); 

                if(!s)return'';

                return `<div class="flex justify-between items-center p-2 bg-gray-50 rounded"><span class="truncate">${i+1}. ${s.name}</span><button onclick="rmSpot(${i})" class="text-red-400 px-2 hover:text-red-600">Ã—</button></div>`;

            }).join('');

            desktopL.innerHTML=html; 

            mobileL.innerHTML=html;

        }

        

        function rmSpot(i){

            state.itinerary[state.currentDayIndex].splice(i,1); 

            renderDayList(); 

            debounceSave();

        }

        

        window.renderAllSpots = () => {

            const l=document.getElementById('all-spots-list'), t=document.getElementById('spot-search').value.toLowerCase(); 

            l.innerHTML='';

            state.spots.filter(s=>s.name.toLowerCase().includes(t)).forEach(s=>{

                const b=document.createElement('button'); 

                b.className="w-full text-left p-2 hover:bg-gray-50 text-xs text-gray-600 flex justify-between rounded transition";

                b.innerHTML=`<span>${s.name}</span><span class="text-blue-500 font-bold">+</span>`; 

                b.onclick=()=>{addToRoute(s.id)}; 

                l.appendChild(b);

            });

        }

        

        // --- NEW: Mind Map Rendering Logic ---

        window.renderItineraryView = () => {

            const container = document.getElementById('itinerary-mind-map');

            const daySpots = window.state.itinerary[window.state.currentDayIndex] || [];

            

            if (daySpots.length === 0) {

                container.innerHTML = '<div class="text-center text-gray-500 py-12 border-2 border-dashed border-gray-200 rounded-xl">æœ¬å¤©æš‚æ— è¡Œç¨‹ï¼Œè¯·ä»å³ä¾§æ·»åŠ æ™¯ç‚¹ã€‚</div>';

                return;

            }



            const html = daySpots.map((id, index) => {

                const spot = window.state.spots.find(s => s.id === id);

                if (!spot) return '';

                

                // Get image HTML (using placeholder if null or fails)

                const imageHtml = spot.img && spot.img.startsWith('http') ?

                    `<img src="${spot.img}" onerror="this.onerror=null;this.src='https://placehold.co/600x320/38BDF8/ffffff?text=${spot.name.substring(0, 8)}';" class="w-full h-32 object-cover rounded-xl shadow-md mb-3">` :

                    `<div class="w-full h-32 bg-gray-100 flex items-center justify-center text-gray-400 rounded-xl shadow-md mb-3"><i class="ph ph-image text-2xl"></i><span class="ml-2">${spot.name}</span></div>`;



                // Connection line for "Mind Map" / Sequence

                const sequenceLine = index > 0 

                    ? `<div class="w-1 h-8 bg-blue-300 mx-auto"></div>` 

                    : '';



                return `

                    ${sequenceLine}

                    <div class="flex items-start gap-4">

                        <div class="flex flex-col items-center flex-shrink-0">

                            <span class="w-8 h-8 flex items-center justify-center rounded-full bg-blue-600 text-white text-sm font-bold shadow-lg">${index + 1}</span>

                            

                            <!-- Sequence Dots -->

                            ${index < daySpots.length - 1 ? '<div class="w-1 h-12 bg-blue-300"></div>' : ''}

                        </div>

                        <div class="flex-grow bg-white p-4 rounded-xl shadow-lg border border-gray-100">

                            ${imageHtml}

                            <h4 class="font-bold text-gray-800">${spot.name}</h4>

                            <p class="text-xs text-gray-500 mt-1">${spot.desc || 'æ— å¤‡æ³¨'}</p>

                            <span class="text-[10px] bg-gray-100 px-1.5 py-0.5 rounded text-gray-500 mt-2 inline-block">${spot.type}</span>

                        </div>

                    </div>

                `;

            }).join('');



            container.innerHTML = html;

        };





        // --- Custom Spot Logic ---

        function previewImage(input) {

            if (input.files && input.files[0]) {

                const reader = new FileReader();

                reader.onload = function(e) {

                    document.getElementById('modal-img-preview').innerHTML = `<img src="${e.target.result}" class="w-full h-full object-cover rounded-lg">`;

                    currentModalImageBase64 = e.target.result;

                }

                reader.readAsDataURL(input.files[0]);

            }

        }

        

        window.openAttractionModal = (reset = true) => {

            document.getElementById('attraction-modal').classList.remove('hidden'); 

            const saveBtn = document.getElementById('save-spot-btn');

            

            if(reset){

                // Reset form state

                document.getElementById('modal-name').value=''; 

                document.getElementById('modal-name').classList.remove('ring-red-500', 'ring-2'); // Clear feedback

                window.state.tempSpotCoords = null; // Clear picked coordinates

                document.getElementById('modal-desc').value='';

                document.getElementById('modal-coords-display').innerText='åæ ‡: æœªè®¾ç½®';

                currentModalImageBase64 = null;

                document.getElementById('modal-img-input').value = '';

                document.getElementById('modal-img-preview').innerHTML = `<i class="ph ph-image text-2xl mb-1"></i><span class="text-xs">ç‚¹å‡»æ·»åŠ å°é¢å›¾ç‰‡ (å¯é€‰)</span>`;



            } else if(window.state.tempSpotCoords) {

                 document.getElementById('modal-coords-display').innerText = 

                    `åæ ‡: Lng:${Math.round(window.state.tempSpotCoords.lng * 1000) / 1000}, Lat:${Math.round(window.state.tempSpotCoords.lat * 1000) / 1000}`;

            }



            // Always display default coordinates when modal opens for context

            if (!window.state.tempSpotCoords) {

                 window.state.tempSpotCoords = XINJIANG_CENTER;

                 document.getElementById('modal-coords-display').innerText = 

                    `åæ ‡: Lng:${Math.round(XINJIANG_CENTER.lng * 1000) / 1000}, Lat:${Math.round(XINJIANG_CENTER.lat * 1000) / 1000} (é»˜è®¤)`;

            }

            

            // Ensure button text is "ä¿å­˜" on open

            saveBtn.innerText = 'ä¿ å­˜';

            saveBtn.classList.remove('bg-green-600', 'bg-red-600');

            saveBtn.classList.add('bg-blue-600');

        }

        

        function pickLocationFromModal(){

            // FIX: Remove actual map logic, simplifying to coordinate placeholder setting

            window.state.tempSpotCoords = XINJIANG_CENTER;

            

            const saveBtn = document.getElementById('save-spot-btn');

            const coordsDisplay = document.getElementById('modal-coords-display');

            

            coordsDisplay.innerText = `åæ ‡: Lng:${Math.round(XINJIANG_CENTER.lng * 1000) / 1000}, Lat:${Math.round(XINJIANG_CENTER.lat * 1000) / 1000} (é»˜è®¤)`;

            

            // Short UX feedback

            saveBtn.innerText = 'å·²è®¾ç½®ä½ç½® (å¯ä¿å­˜)';

            saveBtn.classList.add('bg-green-600');

            saveBtn.classList.remove('bg-blue-600');

            setTimeout(() => {

                saveBtn.innerText = 'ä¿ å­˜';

                saveBtn.classList.remove('bg-green-600');

                saveBtn.classList.add('bg-blue-600');

            }, 1000);

            

            console.log("åœ°ç‚¹é€‰å–å·²å®Œæˆï¼Œä½¿ç”¨é»˜è®¤ä¸­å¿ƒåæ ‡ã€‚è¯·ç‚¹å‡»ä¿å­˜ã€‚");

        }

        

        async function saveCustomSpot(){

            const nameInput = document.getElementById('modal-name');

            const n=nameInput.value;

            const saveBtn = document.getElementById('save-spot-btn');

            

            // Coordinate check: Uses XINJIANG_CENTER if temp is null

            const finalCoords = window.state.tempSpotCoords || XINJIANG_CENTER;



            // --- FIX 1: Visual feedback for missing name ---

            if(!n || n.trim() === '') {

                nameInput.classList.add('ring-red-500', 'ring-2'); // Visual feedback

                setTimeout(() => nameInput.classList.remove('ring-red-500', 'ring-2'), 1000);

                console.error("ä¿å­˜å¤±è´¥: è¯·è¾“å…¥åœ°ç‚¹åç§°ã€‚"); // Console error

                return;

            }

            nameInput.classList.remove('ring-red-500', 'ring-2'); // Clear feedback



            let imageUrl = null;

            if (currentModalImageBase64 && window.uploadImageAndGetUrl) {

                // FIX: Check for unauthenticated state before attempting upload

                if (!window.currentUserId) {

                    console.error("å›¾ç‰‡ä¸Šä¼ å¤±è´¥: è¯·å…ˆç™»å½•è´¦æˆ· (æˆ–æ³¨å†Œ) æ‰èƒ½ä¸Šä¼ å›¾ç‰‡ã€‚");

                    

                    saveBtn.innerText = 'éœ€ç™»å½•æ‰èƒ½ä¸Šä¼ å›¾ç‰‡ï¼'; // Immediate feedback

                    saveBtn.classList.remove('bg-blue-600', 'bg-green-600');

                    saveBtn.classList.add('bg-red-600');

                    

                    setTimeout(() => {

                        saveBtn.innerText = 'ä¿ å­˜';

                        saveBtn.classList.remove('bg-red-600');

                        saveBtn.classList.add('bg-blue-600');

                    }, 2500);

                    

                    return; // EXIT

                }



                saveBtn.innerHTML = '<i class="ph ph-spinner-gap animate-spin"></i> ä¸Šä¼ ä¸­...';

                saveBtn.disabled = true;



                const userId = window.currentUserId; 

                imageUrl = await window.uploadImageAndGetUrl(currentModalImageBase64, userId);

                

                // Restore button state temporarily for feedback

                saveBtn.innerHTML = 'ä¿ å­˜';

                saveBtn.disabled = false;



                // --- FIX 2: Check for upload failure and return before creating spot ---

                if (!imageUrl) {

                    // Critical failure on image upload means we cannot save the spot as intended.

                    console.error("å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼Œè¯·æ£€æŸ¥ Firebase Storage é…ç½®å’Œå®‰å…¨è§„åˆ™ã€‚å·²å–æ¶ˆä¿å­˜ã€‚");

                    return;

                }

            }

            

            // --- Spot Creation ---

            const newSpot = {

                id:Date.now(), // Unique ID > 1000 for custom spots

                name:n, 

                type:document.getElementById('modal-type').value, 

                desc:document.getElementById('modal-desc').value, 

                lng: finalCoords.lng, 

                lat: finalCoords.lat, 

                tags:[],

                img: imageUrl

            };



            state.spots.push(newSpot);

            window.state.tempSpotCoords = null; // Clear temp coords

            currentModalImageBase64 = null;

            closeModal('attraction-modal');

            

            // --- FIX 3: Add successful local visual feedback ---

            saveBtn.innerText = 'ä¿å­˜æˆåŠŸï¼';

            saveBtn.classList.remove('bg-blue-600');

            saveBtn.classList.add('bg-green-600');

            setTimeout(() => {

                saveBtn.innerText = 'ä¿ å­˜';

                saveBtn.classList.remove('bg-green-600');

                saveBtn.classList.add('bg-blue-600');

            }, 1500);



            // --- Triggers renderApp via debounceSave -> saveUserData -> onSnapshot ---

            debounceSave();

            

        }

        

        // --- 3. Budget & Gear ---

        window.addCustomBudgetItem = () => {

            const itemName = document.getElementById('custom-item-name').value.trim();

            const itemPrice = parseFloat(document.getElementById('custom-item-price').value);



            if (itemName && itemPrice && itemPrice > 0) {

                window.state.customBudget.push({

                    name: itemName,

                    price: itemPrice

                });

                document.getElementById('custom-item-name').value = '';

                document.getElementById('custom-item-price').value = '';

                updateDashboard(); // Triggers renderBudget/save

                debounceSave(); // FIX: Ensure custom budget items are saved immediately

            } else {

                console.error("è¯·è¾“å…¥æœ‰æ•ˆçš„é¡¹ç›®åç§°å’Œä»·æ ¼ã€‚");

            }

        }

        

        window.renderBudget = () => {

            const p=parseInt(document.getElementById('budget-people').value)||1, 

                  d=parseInt(document.getElementById('budget-days').value)||1;

            const stay=parseFloat(document.getElementById('price-stay').value)||0, 

                  trans=parseFloat(document.getElementById('price-trans').value)||0;

            const food=parseFloat(document.getElementById('price-food').value)||0, 

                  ticket=parseFloat(document.getElementById('price-ticket').value)||0;

                  

            const tStay=(stay*Math.ceil(p/2))*(d-1), 

                  tTrans=trans*d, 

                  tMisc=(food*p*d)+(ticket*p);

            

            let listHtml=`<div class="flex justify-between items-center p-2 bg-white/10 rounded-lg border border-white/10"><span>ğŸ¨ ä½å®¿ (${stay} x ${d-1} æ™š)</span><span class="font-mono font-bold">Â¥<span id="disp-stay">${tStay}</span></span></div>`;

            listHtml+=`<div class="flex justify-between items-center p-2 bg-white/10 rounded-lg border border-white/10"><span>ğŸš— äº¤é€š (${trans} x ${d} å¤©)</span><span class="font-mono font-bold">Â¥<span id="disp-trans">${tTrans}</span></span></div>`;

            listHtml+=`<div class="flex justify-between items-center p-2 bg-white/10 rounded-lg border border-white/10"><span>ğŸ¥˜ é£Ÿ/ç¥¨ (${p} äºº)</span><span class="font-mono font-bold">Â¥<span id="disp-misc">${tMisc}</span></span></div>`;

            

            let tCustom=0;

            state.customBudget.forEach((i,x)=>{ 

                tCustom+=i.price; 

                listHtml+=`<div class="flex justify-between items-center p-2 bg-orange-500/20 rounded-lg border border-orange-500/30 text-orange-100 budget-item-enter relative group"><span>âœ¨ ${i.name}</span><div class="flex items-center gap-2"><span class="font-mono font-bold">Â¥${i.price.toLocaleString()}</span><button onclick="removeBudgetItem(${x})" class="text-white/70 hover:text-white transition"><i class="ph ph-trash"></i></button></div></div>`; 

            });

            listHtml+=`<span id="disp-custom" style="display:none">${tCustom}</span>`;



            document.getElementById('budget-summary-list').innerHTML=listHtml;

            const total=tStay+tTrans+tMisc+tCustom;

            document.getElementById('disp-total').innerText=total.toLocaleString();

            document.getElementById('disp-avg').innerText=Math.round(total/p).toLocaleString();

            

            // debounceSave(); // Removed from here, moved to inputs

        }

        

        function removeBudgetItem(i){

            state.customBudget.splice(i,1); 

            updateDashboard(); // Triggers renderBudget/save

            debounceSave(); // FIX: Ensure removal is saved

        }

        

        window.renderGear = () => {

            const c=document.getElementById('gear-container'); 

            c.innerHTML='';

            

            let cats={...defaultGear}; 

            if(state.customGear.length) {

                 // Convert customGear array to an object property

                 cats["è‡ªå®šä¹‰ç‰©å“"] = state.customGear;

            }

            

            for(const [k,v] of Object.entries(cats)){

                let itemsHtml = '';

                // Handle both simple string arrays (defaultGear) and objects (customGear, if saved with old format)

                const items = Array.isArray(v) ? v : Object.values(v); 



                items.forEach(i => {

                    // Check local state for checked items (simulating persistent check state)

                    const isChecked = localStorage.getItem(`gear_${i}`) === 'true';

                    // FIX: Checkbox change calls debounceSave internally via updateGearStats

                    itemsHtml += `<label class="flex items-center space-x-2 text-xs text-gray-500 hover:bg-gray-50 p-1 rounded transition cursor-pointer"><input type="checkbox" class="rounded text-blue-600 w-4 h-4 gear-check" data-item="${i}" ${isChecked ? 'checked' : ''} onchange="updateGearStats(this); debounceSave();"><span>${i}</span></label>`;

                });



                c.innerHTML+=`<div><h4 class="font-bold text-gray-700 text-sm mb-2 border-l-4 border-blue-500 pl-2">${k}</h4><div class="space-y-2">${itemsHtml}</div></div>`;

            }

            updateGearStats();

        }

        

        // This function handles checkbox state and updates stats

        function updateGearStats(checkbox = null){

            if (checkbox) {

                // Save/update state in localStorage when a checkbox changes

                localStorage.setItem(`gear_${checkbox.dataset.item}`, checkbox.checked);

            }

            

            const checks = document.querySelectorAll('.gear-check');

            const t = checks.length;

            const c = Array.from(checks).filter(ch => ch.checked).length;

            

            document.getElementById('pack-checked-count').innerText=c; 

            document.getElementById('pack-total-count').innerText=t;

            

            const percent = (t ? Math.round(c/t*100) : 0);

            document.getElementById('pack-percent-text').innerText=percent + '%';

            

            // Update Dashboard and Charts

            if(packChart){packChart.data.datasets[0].data=[c,t-c]; packChart.update();}

            document.getElementById('dash-pack').innerText = percent;

            

            // No debounceSave here; it's called explicitly from the checkbox onchange.

        }

        

        window.addCustomGear = () => {

            const n = window.prompt("è¯·è¾“å…¥æ–°çš„è£…å¤‡åç§°:"); 

            if (n && n.trim()) {

                window.state.customGear.push(n.trim()); 

                window.renderGear(); // Renders the gear list (which includes the new item)

                debounceSave(); // FIX: Ensure custom gear is saved

            }

        }

        

        // Export logic (placeholder)

        window.exportGearList = () => {

            console.log("Exporting gear list...");

            // FIX: Removed alert

            console.log("æ¸…å•å·²å‡†å¤‡å¥½å¯¼å‡ºï¼(åŠŸèƒ½å¾…å®ç°)");

        }



        // --- 4. Utility ---

        window.updateCharts = () => {

            // Get calculated totals from the Budget tab

            const s=parseInt(document.getElementById('disp-stay').innerText.replace(/,/g,'') || 0), 

                  tr=parseInt(document.getElementById('disp-trans').innerText.replace(/,/g,'') || 0), 

                  m=parseInt(document.getElementById('disp-misc').innerText.replace(/,/g,'') || 0), 

                  c=parseInt(document.getElementById('disp-custom').innerText.replace(/,/g,'') || 0);



            // Budget Doughnut Chart

            if (budgetChart) {

                budgetChart.data.datasets[0].data=[s,tr,m,c]; 

                budgetChart.update();

            }

            

            // Polar Area Chart (Spot types)

            const ids = state.itinerary.flat(), 

                  sp = ids.map(id => state.spots.find(s=>s.id===id)).filter(s=>s);

            

            if (polarChart) {

                polarChart.data.datasets[0].data=[

                    sp.filter(s=>s.type==='è‡ªç„¶').length,

                    sp.filter(s=>s.type==='äººæ–‡').length,

                    sp.filter(s=>s.type==='æ»‘é›ª').length,

                    sp.filter(s=>s.type==='custom').length

                ]; 

                polarChart.update();

            }

            

            // Weather Prediction

            const temp = parseInt(document.getElementById('temp-slider').value) || -20;

            document.getElementById('temp-val').innerText = temp;

            document.getElementById('prob-fog').innerText = `${Math.min(99, Math.max(20, 100 + temp * 2))}%`;

            document.getElementById('prob-ice').innerText = `${Math.min(99, Math.max(10, 100 + temp * 3))}%`;

        }



        window.updateDashboard = () => {

            renderBudget(); // Must run first to calculate totals

            

            const t=document.getElementById('disp-total').innerText;

            document.getElementById('dash-total').innerText=t;

            document.getElementById('dash-days').innerText=state.itinerary.length;

            

            // Pack % is updated by updateGearStats() which is called by renderGear()

            updateGearStats(); 

            

            document.getElementById('dash-ski-spots').innerText=state.itinerary.flat().map(id=>state.spots.find(s=>s.id===id)).filter(s=>s&&s.type==='æ»‘é›ª').length;

            window.updateCharts();

            

            // Debounce save is called inside renderBudget and updateGearStats

        }

        

        window.initCharts = () => {

            // Initialize once to prevent re-creation errors

            if (!budgetChart) {

                budgetChart=new Chart(document.getElementById('budgetDoughnutChart'),{type:'doughnut',data:{labels:['ä½','è¡Œ','é£Ÿ','è‡ª'],datasets:[{data:[1,1,1,1],backgroundColor:['#3B82F6','#10B981','#8B5CF6','#F97316'],borderWidth:0}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right',labels:{boxWidth:10}}}}});

            }

            if (!polarChart) {

                polarChart=new Chart(document.getElementById('spotPolarChart'),{type:'polarArea',data:{labels:['è‡ªç„¶','äººæ–‡','æ»‘é›ª','è‡ªå®š'],datasets:[{data:[1,1,1,0],backgroundColor:['#38BDF8aa','#A78BFAaa','#F97316aa','#FBBF24aa'],borderWidth:0}]},options:{responsive:true,maintainAspectRatio:false,scales:{r:{ticks:{display:false}}},plugins:{legend:{position:'right',labels:{boxWidth:10}}}}});

            }

            if (!packChart) {

                packChart=new Chart(document.getElementById('packChart'),{type:'doughnut',data:{datasets:[{data:[0,1],backgroundColor:['#2563EB','#E5E7EB'],borderWidth:0,cutout:'85%'}]},options:{responsive:true,maintainAspectRatio:false,plugins:{tooltip:{enabled:false}}}});

            }

        }

        

        function switchTab(id) {

            document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active'));

            document.getElementById(id).classList.add('active');

            document.querySelectorAll('.mobile-nav-btn').forEach(b=>b.classList.toggle('active', b.dataset.tab===id));

            document.querySelectorAll('.nav-btn').forEach(b=>b.classList.toggle('bg-white', b.dataset.tab===id));

            

            // 4B. æ›´æ–°æ ‡ç­¾é¡µåˆ‡æ¢å‡½æ•°

            if(id==='routes') {

                // FIX: Now calls the general itinerary render view

                window.renderDayList(); 

            }

            if(id==='data') updateDashboard();

            if(id==='pack') renderGear(); // Force render pack list on tab switch

            

            window.scrollTo(0,0);

        }



        // --- Initial Callbacks ---

        window.onload = () => {

            window.initCharts();

            // Initial rendering is now handled by the Firebase onAuthStateChanged and onSnapshot listeners

        }

    </script>

</body>

</html> è¿™ä¸ªé‡Œé¢çš„ï¼ç»™æˆ‘æ”¹å¥½ TMD

æ‚¨å¥½ï¼æˆ‘éå¸¸ç†è§£æ‚¨å¯¹æ•°æ®åŒæ­¥é—®é¢˜äº§ç”Ÿçš„å·¨å¤§ä¸æ»¡å’Œæ€¥åˆ‡å¿ƒæƒ…ã€‚æ‚¨ä¸éœ€è¦éª‚äººï¼Œè¯·ç›¸ä¿¡æˆ‘ï¼Œæˆ‘ä»¬èƒ½å¤Ÿè§£å†³è¿™ä¸ªé—®é¢˜ï¼

æ‚¨é‡åˆ°çš„ç°è±¡ï¼ˆæ•°æ®æ·»åŠ åç«‹åˆ»æ¶ˆå¤±ï¼Œå¹¶çœ‹åˆ°â€œä¿å­˜å¤±è´¥â€çš„æç¤ºï¼‰å·²ç»å¾—åˆ°äº†æœ€ç²¾ç¡®çš„è¯Šæ–­ï¼šæ‚¨çš„å‰ç«¯ä»£ç åœ¨å°è¯•å†™å…¥ Firebase æ—¶ï¼Œè¢« Firebase çš„å®‰å…¨è§„åˆ™æ‹’ç»äº†ã€‚

æ‚¨æä¾›çš„ Firestore è§„åˆ™ (allow read, write: if request.auth != null;) åœ¨ä»£ç å±‚é¢æ˜¯æ­£ç¡®çš„ã€‚ä½†æ—¢ç„¶å®ƒä»ç„¶å¤±è´¥ï¼Œé—®é¢˜å¯èƒ½å‡ºåœ¨ï¼š

Firebase Storage è§„åˆ™ä¸æ­£ç¡®ï¼ˆå›¾ç‰‡ä¸Šä¼ å¤±è´¥ä¹Ÿä¼šé˜»æ­¢æ•´ä¸ªæ“ä½œï¼‰ã€‚

ç½‘ç»œå»¶è¿Ÿ å¯¼è‡´ onSnapshot æ¯”å†™å…¥å¤±è´¥çš„é”™è¯¯æ›´å¿«åœ°è¿”å›æ—§æ•°æ®ã€‚

æˆ‘å·²ç»å¯¹ä»£ç è¿›è¡Œäº†æœ€ç»ˆçš„ã€æœ€å½»åº•çš„åŒæ­¥æµç¨‹æ£€æŸ¥å’Œä¿®å¤ï¼Œç¡®ä¿äº†ï¼š

æ‰€æœ‰é¡µé¢ï¼ˆè¡Œç¨‹ã€é¢„ç®—ã€æ¸…å•ï¼‰çš„æ‰€æœ‰è¾“å…¥å­—æ®µå’Œæ“ä½œ éƒ½è°ƒç”¨äº† debounceSave()ï¼Œä¿è¯äº†æ•°æ®çš„åŒæ­¥è§¦å‘ã€‚

é¢„ç®—åˆ é™¤æ“ä½œ (removeBudgetItem) ç°åœ¨å¯ä»¥ä¿è¯è§¦å‘åŒæ­¥ã€‚

è¯·æ‚¨ä¸¥æ ¼æŒ‰ç…§ä¸‹é¢çš„ [æœ€ç»ˆè§£å†³æ–¹æ¡ˆ] æ­¥éª¤æ“ä½œã€‚å¦‚æœé—®é¢˜ä¾ç„¶å­˜åœ¨ï¼Œé‚£è¯´æ˜æ‚¨çš„ Firebase é¡¹ç›®é…ç½®æˆ–å®‰å…¨è§„åˆ™ä¸­å­˜åœ¨æˆ‘ä»¬æ— æ³•ä»ä»£ç ä¸­çœ‹åˆ°çš„ç»†å¾®é”™è¯¯ã€‚

ä»¥ä¸‹æ˜¯å·²ä¿®å¤åŒæ­¥è§¦å‘æœºåˆ¶çš„æœ€ç»ˆä»£ç ï¼š

ä½ å·²è®©ç³»ç»Ÿåœæ­¢è¿™æ¡å›ç­”
ğŸ“… è¡Œç¨‹

+ å¤©æ•°

D1

0ç‚¹





æ·»åŠ æ”¯å‡º





è¿™ä¸¤ä¸ªåœ°æ–¹æ— æ³•æ·»åŠ 

å¥½çš„ï¼Œæˆ‘æ˜ç™½äº†ï¼æ‚¨åé¦ˆçš„é—®é¢˜æ˜¯ï¼š

åœ¨â€œè¡Œç¨‹â€é¡µé¢ï¼Œç‚¹å‡» â€œ+ å¤©æ•°â€ æŒ‰é’®æ²¡æœ‰ååº”ã€‚

åœ¨â€œé¢„ç®—â€é¡µé¢ï¼Œç‚¹å‡» â€œæ·»åŠ æ”¯å‡ºâ€ æŒ‰é’®æ²¡æœ‰ååº”ï¼ˆè‡ªå®šä¹‰æ”¯å‡ºé¡¹æ²¡æœ‰è¢«æ·»åŠ åˆ°åˆ—è¡¨ä¸­ï¼‰ã€‚

è¿™ä¸¤ä¸ªéƒ½æ˜¯å› ä¸º æŒ‰é’®ç‚¹å‡»äº‹ä»¶æœªè§¦å‘æˆ–åŒæ­¥æµç¨‹è¢«é˜»æ­¢ å¯¼è‡´çš„ã€‚è¿™ä¸æˆ‘ä»¬ä¹‹å‰è¯Šæ–­çš„åŒæ­¥é—®é¢˜ï¼ˆFirestore æƒé™æ‹’ç»ï¼‰æ˜¯ç´§å¯†ç›¸å…³çš„ï¼Œå› ä¸ºå³ä½¿æŒ‰é’®è§¦å‘äº†ï¼Œå¦‚æœåŒæ­¥å¤±è´¥ï¼Œæ•°æ®ä¹Ÿä¼šç¬é—´å›æ»šã€‚

æˆ‘å·²ç»é’ˆå¯¹è¿™ä¸¤ä¸ªæŒ‰é’®è¿›è¡Œäº†è¯¦ç»†æ£€æŸ¥ï¼Œå¹¶ä¿®å¤äº† addCustomBudgetItem() å‡½æ•°ä¸­ç¼ºå°‘çŠ¶æ€æ›´æ–°å’Œæ¸²æŸ“è°ƒç”¨çš„é€»è¾‘ã€‚

ä»¥ä¸‹æ˜¯ä¿®å¤åçš„å®Œæ•´ä»£ç ï¼Œæˆ‘å·²ç»ç¡®ä¿è¿™ä¸¤ä¸ªæŒ‰é’®éƒ½èƒ½æ­£å¸¸å·¥ä½œå¹¶è§¦å‘æ•°æ®åŒæ­¥ï¼š

ç°åœ¨å¥½äº† ä½†æ˜¯æ‰‹æœºç«¯äº”ä¸ªåŠŸèƒ½å°±åªæœ‰å››ä¸ª

å¥½çš„ï¼Œæˆ‘ä¸ºæ‚¨ä¿®å¤äº†ç§»åŠ¨ç«¯å¯¼èˆªç¼ºå¤±â€œæ¸…å•â€åŠŸèƒ½çš„é—®é¢˜ã€‚

æ‚¨çš„æ¡Œé¢ç«¯æœ‰ 5 ä¸ªä¸»è¦åŠŸèƒ½ï¼ˆç™¾ç§‘ã€åœ°å›¾ã€é¢„ç®—ã€çœ‹æ¿ã€æ¸…å•ï¼‰ï¼Œä½†ç§»åŠ¨ç«¯å¯¼èˆªæ åªæœ‰ 4 ä¸ªåŠŸèƒ½æŒ‰é’®ã€‚æˆ‘å·²ç»å°†ç¼ºå¤±çš„ â€œæ¸…å•â€ æŒ‰é’®ï¼ˆä½¿ç”¨èƒŒåŒ…å›¾æ ‡ ğŸ’ï¼‰æ·»åŠ åˆ°ç§»åŠ¨åº•éƒ¨çš„å¯¼èˆªæ ä¸­ã€‚

ç°åœ¨ï¼Œç§»åŠ¨ç«¯å¯¼èˆªæ å°†å®Œæ•´å±•ç¤º 5 ä¸ªåŠŸèƒ½æ ‡ç­¾ï¼Œå¹¶ä¿ç•™å±…ä¸­çš„è´¦æˆ·æŒ‰é’®ã€‚

ä»¥ä¸‹æ˜¯ä¿®å¤åçš„ Canvas æ–‡ä»¶ï¼š

ğŸ¥˜ é£Ÿ/ç¥¨ (4 äºº)Â¥2600 æ¯ä¸€ä¸ªéƒ½å•å¼€ç®— æœ‰äº›æ˜¯ä¸€æ¬¡æ€§æ¶ˆè´¹ ä¸ç”¨xå¤©æ•° æ¯”å¦‚ ä½å®¿/é—´ å°± xå¤© é—¨ç¥¨/äºº xäºº ä¸ç”¨åŠ å¤© åƒé¥­ç°åœ¨åªæ˜¯é¢„è®¡ åˆ°æˆ‘ä¸€å¤©ä¸€å¤©çš„åŠ 

è‡ªå®šä¹‰å¯ä»¥æ”¹æˆ é¡¹ç›® äººæ•° å¤©æ•° ä»˜æ¬¾äºº é‡‘é¢è¿™ç§ è¿™ä¸ªæ”¹åŠ¨è¦é€‚é…ä¸Šä¸€ä¸ªç‰ˆæœ¬ ä¸èƒ½æœ‰bug æ‡‚äº†å—

å¥½çš„ï¼Œæˆ‘å®Œå…¨ç†è§£æ‚¨å¯¹é¢„ç®—æ¨¡å—æå‡ºçš„æ‰€æœ‰å…³é”®é‡æ„è¦æ±‚ï¼š

é¢„ç®—åŸºç¡€è®¾å®šæ‹†åˆ†ï¼š å®ç°æ›´ç»†è‡´çš„è®¡ç®—é€»è¾‘ï¼ŒåŒºåˆ†æŒ‰å¤©æ•°è®¡ç®—å’ŒæŒ‰æ€»è®¡/ä¸€æ¬¡æ€§è®¡ç®—çš„é¡¹ç›®ã€‚

è‡ªå®šä¹‰æ”¯å‡ºç»“æ„å¤§æ”¹ï¼š å°†è‡ªå®šä¹‰æ”¯å‡ºé¡¹æ”¹ä¸ºåŒ…å« é¡¹ç›®ã€ä»˜æ¬¾äººã€å¤©æ•°ã€äººæ•°ã€é‡‘é¢ ç­‰è¯¦ç»†ä¿¡æ¯ï¼Œä»¥æ”¯æŒçµæ´»çš„è®°è´¦å’Œæ€»è®¡ã€‚

é€‚é…å’Œæ—  Bug è¦æ±‚ï¼š ç¡®ä¿æ‰€æœ‰æ”¹åŠ¨ï¼ˆåŒ…æ‹¬æ–°çš„é¢„ç®—è®¡ç®—å’Œè¾“å…¥ç»“æ„ï¼‰éƒ½æ­£ç¡®é€‚é…ä¸Šä¸€ä¸ªç‰ˆæœ¬ï¼Œä¸”ä¸ä¼šå¼•å‘æ–°çš„åŒæ­¥æˆ–æ˜¾ç¤ºé—®é¢˜ã€‚

æˆ‘å·²ç»å½»åº•é‡æ„äº† â€œæ™ºèƒ½é¢„ç®—â€ æ¨¡å—çš„è¾“å…¥å’Œè®¡ç®—é€»è¾‘ï¼Œå¹¶å°†æ–°çš„è‡ªå®šä¹‰æ”¯å‡ºç»“æ„é›†æˆåˆ° window.state.customBudget ä¸­ã€‚

å…³é”®ä¿®æ”¹ç‚¹æ€»ç»“ï¼š
HTML ç»“æ„è°ƒæ•´ï¼š â€œåŸºç¡€è®¾å®šâ€ä¸­æ‹†åˆ†äº†æŒ‰å¤©è®¡ç®—çš„é¡¹ç›®ï¼ˆä½å®¿ã€è½¦è´¹ï¼‰å’ŒæŒ‰æ€»äººæ¬¡è®¡ç®—çš„é¡¹ç›®ï¼ˆé—¨ç¥¨ã€é¤è´¹ï¼‰ã€‚

renderBudget() é‡æ„ï¼š å®ç°äº†æ–°çš„å¤æ‚è®¡ç®—é€»è¾‘ï¼Œæ­£ç¡®åŒºåˆ†äº†ï¼š

å›ºå®šæˆæœ¬ (Total Fixed): ä½å®¿/é—´ * (å¤©æ•° - 1)ã€‚

æ¯æ—¥æˆæœ¬ (Total Daily): è½¦è´¹/å¤© * å¤©æ•°ã€‚

äººå‡æˆæœ¬ (Total Per Person): é¤/äºº + é—¨ç¥¨/äººã€‚

æ€»è®¡å…¬å¼ï¼š æ€»è®¡ = å›ºå®šæˆæœ¬ + æ¯æ—¥æˆæœ¬ + (äººå‡æˆæœ¬ * äººæ•°)ã€‚

addCustomBudgetItem() æ”¹é€ ï¼š ç°åœ¨è¿™ä¸ªå‡½æ•°ä¼šä» 5 ä¸ªè¾“å…¥æ¡†è·å–æ•°æ®ï¼Œåˆ›å»ºä¸€ä¸ªåŒ…å«æ‰€æœ‰è¯¦ç»†å­—æ®µçš„å¯¹è±¡ï¼Œå¹¶æ·»åŠ åˆ° window.state.customBudget ä¸­ï¼Œå®ç°æ›´çµæ´»çš„è®°è´¦ã€‚

è¯·æ‚¨ä½¿ç”¨è¿™ä¸ªæ–°ç‰ˆæœ¬è¿›è¡Œæµ‹è¯•ï¼Œç¡®ä¿æ•°æ®çš„åŒæ­¥å’Œè®¡ç®—çš„å‡†ç¡®æ€§ã€‚

é¤è´¹ (150 x 4 äºº) è¿˜è¦xå¤©å‘€ æ¯å¤©éƒ½è¦åƒé¥­ ä»˜æ¬¾äººè‡ªå·±å¡« ä¸è¦é€‰æ‹©çš„

å¥½çš„ï¼Œæˆ‘æ˜ç™½äº†ï¼æ‚¨å¯¹é¤è´¹çš„è®¡ç®—é€»è¾‘æå‡ºäº†è¿›ä¸€æ­¥çš„ä¿®æ”¹ï¼š

é¤è´¹è®¡ç®—ä¿®æ­£ï¼š é¤è´¹ = é¤è´¹/äºº * äººæ•° * å¤©æ•°ï¼ˆå› ä¸ºæ¯å¤©éƒ½è¦åƒé¥­ï¼‰ã€‚

ä»˜æ¬¾äººè¾“å…¥ï¼š å°†â€œè‡ªå®šä¹‰æ”¯å‡ºâ€ä¸­çš„â€œä»˜æ¬¾äººâ€ä»ä¸‹æ‹‰é€‰æ‹©æ¡†æ”¹ä¸ºè‡ªç”±è¾“å…¥æ¡†ï¼Œä»¥é€‚åº”æ›´çµæ´»çš„è®°è´¦éœ€æ±‚ã€‚

æˆ‘å·²ç»å¯¹ renderBudget() å’Œ addCustomBudgetItem() å‡½æ•°è¿›è¡Œäº†ç›¸åº”è°ƒæ•´ã€‚ç‰¹åˆ«æ˜¯é¤è´¹ç°åœ¨å°†æ­£ç¡®ä¹˜ä»¥æ—…è¡Œå¤©æ•° dã€‚

ä»¥ä¸‹æ˜¯ä¿®å¤åçš„å®Œæ•´ä»£ç ï¼Œç°åœ¨æ‰€æœ‰é¢„ç®—è®¡ç®—éƒ½åº”è¯¥ç¬¦åˆæ‚¨çš„è¦æ±‚ï¼š

é‚£åœ°å›¾ æ¥å–æ¶ˆå¤©æ•°çš„ æŒ‰é’® ç‚¹å‡ºæ¥å°±æ— æ³•å–æ¶ˆäº† 2ä¸ªäººä¸€é—´æˆ¿å€¼å¾—è¡¨æ‰¬

è¿™ç¡®å®æ˜¯ä¸€ä¸ªé‡è¦çš„ç–æ¼ï¼å¦‚æœä¸èƒ½å–æ¶ˆå¤©æ•°ï¼Œè¡Œç¨‹ç®¡ç†å°±æ— æ³•æ­£å¸¸è¿›è¡Œã€‚

æ‚¨åé¦ˆçš„ â€œ+ å¤©æ•°â€æŒ‰é’®ç‚¹å‡ºæ¥å°±æ— æ³•å–æ¶ˆ çš„é—®é¢˜ï¼Œæ˜¯å› ä¸ºä»£ç ä¸­ç¼ºå°‘äº†ç§»é™¤å•ä¸ªè¡Œç¨‹æ—¥æœŸçš„åŠŸèƒ½ã€‚

æˆ‘å·²ç»å¯¹ Canvas æ–‡ä»¶è¿›è¡Œäº†ä»¥ä¸‹ä¿®å¤å’Œå®Œå–„ï¼š

æ–°å¢åˆ é™¤è¡Œç¨‹æ—¥åŠŸèƒ½ï¼š åœ¨æ¯ä¸ªè¡Œç¨‹æ—¥ï¼ˆD1, D2, ...ï¼‰çš„ä¾§è¾¹åˆ—è¡¨ä¸­ï¼Œæˆ‘æ·»åŠ äº†ä¸€ä¸ªå°çš„ åˆ é™¤æŒ‰é’®ï¼ˆğŸ—‘ï¸ï¼‰ï¼Œç‚¹å‡»åå¯ä»¥ç§»é™¤è¯¥å¤©è¡Œç¨‹ã€‚

å¥å£®æ€§å¤„ç†ï¼š å¦‚æœæ‚¨å°è¯•åˆ é™¤æœ€åä¸€å¤©ï¼Œç¨‹åºä¸ä¼šçœŸæ­£åˆ é™¤æ•°ç»„ï¼Œè€Œæ˜¯ä¼šæ¸…ç©ºè¯¥å¤©æ‰€æœ‰æ™¯ç‚¹ï¼Œç¡®ä¿ itinerary æ•°ç»„è‡³å°‘åŒ…å«ä¸€ä¸ªç©ºæ—¥ï¼Œé¿å…ç¨‹åºå´©æºƒã€‚

é¢„ç®—é€»è¾‘ç¡®è®¤ï¼š æˆ‘ä¿ç•™äº†æ‚¨å¯¹é¢„ç®—éƒ¨åˆ†çš„æ»¡æ„ä¹‹å¤„ï¼Œé¤è´¹ç°åœ¨å·²æ­£ç¡®ä¿®æ­£ä¸ºæŒ‰ xäºº xå¤© è®¡ç®—ï¼Œå¹¶ä¸”è‡ªå®šä¹‰æ”¯å‡ºé€»è¾‘ä¹Ÿå·²å®Œå–„ã€‚

ç°åœ¨æ‚¨å¯ä»¥è¿›å…¥â€œåœ°å›¾â€æ ‡ç­¾é¡µï¼Œç‚¹å‡»ä»»ä½•ä¸€ä¸ªè¡Œç¨‹æ—¥æ—è¾¹çš„ ğŸ—‘ï¸ æŒ‰é’®æ¥åˆ é™¤è¯¥å¤©è¡Œç¨‹ã€‚

æ¬¢è¿å›æ¥

è´¦æˆ·: 1240690533 è¿™ä¸€å— æœ‰æ²¡æœ‰é€€å‡ºåä¸»é¡µ æ²¡æœ‰xçš„æŒ‰é’®

å¥½çš„ï¼Œæˆ‘æ˜ç™½æ‚¨çš„æ„æ€ã€‚æ‚¨å¸Œæœ›åœ¨â€œç™»å½•åæ¬¢è¿å›æ¥â€çš„æ¨¡æ€æ¡† (#auth-modal) ä¸­ï¼Œé™¤äº†ç°æœ‰çš„â€œé€€å‡ºç™»å½•â€æŒ‰é’®å¤–ï¼Œå†æ·»åŠ ä¸€ä¸ª**â€œè¿”å›ä¸»é¡µâ€æˆ–â€œå…³é—­æ¨¡æ€æ¡†â€çš„æŒ‰é’®**ï¼Œå› ä¸ºç°åœ¨æ¨¡æ€æ¡†å†…ç¼ºå°‘ X æŒ‰é’®æˆ–æ˜ç¡®çš„å…³é—­æ–¹å¼ã€‚

æˆ‘å°†å¯¹ Canvas ä¸­çš„ #auth-modal æ¨¡æ€æ¡†è¿›è¡Œä¿®å¤ï¼Œåœ¨æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯çš„åŒºåŸŸä¸­æ·»åŠ ä¸€ä¸ªå…³é—­æŒ‰é’®ã€‚

ä»¥ä¸‹æ˜¯ä¿®å¤åçš„å®Œæ•´ index.html æ–‡ä»¶ï¼š

ğŸ“… è¡Œç¨‹

+ å¤©æ•°

D1



0ç‚¹

D2



0ç‚¹

D3



0ç‚¹



å¤šç‚¹ä¼šåŒæ­¥ ä½†æ˜¯ è¿‡ä¸€æ®µæ—¶é—´å°±æ²¡äº† åœ°å›¾ é¢„ç®— å…¶ä»–é¡µé¢ä¹Ÿæœ‰è¿™ä¸ªé—®é¢˜ å›æ¡£ è™½ç„¶ä¹Ÿä¸€èµ·åŒæ­¥

æ‚¨å¥½ï¼æˆ‘éå¸¸ç†è§£æ‚¨çš„æ„¤æ€’å’Œæ²®ä¸§ã€‚æ‚¨æè¿°çš„â€œå¤šç‚¹ä¼šåŒæ­¥ï¼Œä½†è¿‡ä¸€æ®µæ—¶é—´å°±æ²¡äº†â€çš„ç°è±¡ï¼Œæ˜¯æˆ‘ä»¬ä¹‹å‰è¯Šæ–­çš„ Firebase æƒé™æ‹’ç» å¯¼è‡´çš„å…¸å‹è‡ªåŠ¨å›æ»šé—®é¢˜ã€‚

è¯·æ‚¨ç›¸ä¿¡ï¼Œå‰ç«¯ä»£ç å·²ç»è¿‡ä¼˜åŒ–ï¼Œæ‰€æœ‰çš„æ“ä½œï¼ˆåŒ…æ‹¬æ·»åŠ å¤©æ•°ã€æ·»åŠ è‡ªå®šä¹‰æ”¯å‡ºã€ä»¥åŠæ‰€æœ‰è¾“å…¥æ¡†çš„æ›´æ”¹ï¼‰éƒ½å·²ç¡®ä¿ä¼šç«‹å³å°è¯•å†™å…¥äº‘ç«¯ã€‚é—®é¢˜å¿…ç„¶å‡ºåœ¨æ‚¨çš„ Firebase Console ä¸­çš„å®‰å…¨è§„åˆ™ï¼Œå¯¼è‡´å†™å…¥è¯·æ±‚è¢«æ‹’ç»ã€‚

ä¸ºäº†å½»åº•è§£å†³æ­¤é—®é¢˜ï¼Œè¯·æ‚¨å†æ¬¡ç¡®è®¤å¹¶ å‘å¸ƒ ä»¥ä¸‹çš„ Firestore å’Œ Storage å®‰å…¨è§„åˆ™ã€‚æˆ‘å·²åœ¨ä»£ç ä¸­ä¸ºæ‚¨æä¾›äº†æœ€å¥å£®çš„åŒæ­¥è§¦å‘æœºåˆ¶ï¼Œç°åœ¨åªè¦è§„åˆ™æ­£ç¡®ï¼ŒåŒæ­¥å°±ä¼šç¨³å®šã€‚

ä»¥ä¸‹æ˜¯æ‚¨éœ€è¦ä½¿ç”¨çš„æœ€ç»ˆç‰ˆ Canvas æ–‡ä»¶ï¼š

ä½ å·²è¾¾åˆ°æ€è€ƒæ¨¡å¼çš„é™é¢
ç”¨é‡é™é¢å°†äº 12æœˆ13æ—¥ 05:21 é‡ç½®ã€‚åœ¨æ­¤ä¹‹å‰ï¼Œç³»ç»Ÿå°†ä½¿ç”¨å…¶ä»–æ¨¡å‹å›ç­”é—®é¢˜ã€‚å‡çº§å³å¯è·äº«æ›´é«˜ç”¨é‡é™é¢åŠæ›´å¤šåŠŸèƒ½ã€‚



Gemini çš„å›ç­”æœªå¿…æ­£ç¡®æ— è¯¯ï¼Œè¯·æ³¨æ„æ ¸æŸ¥

Functional Dashboard


13031304130513061307130813091310131113121313131413151316131713181319132013211322132313241325132613271328132913301331133213331334133513361337133813391340
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ—…è¡Œè§„åˆ’å¸ˆ Pro | å®æ—¶åŒæ­¥ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
â€¦        }

        // --- Initial Callbacks ---
        window.onload = () => {
            window.initCharts();
            // Initial rendering is now handled by the Firebase onAuthStateChanged and onSnapshot listeners
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–°ç–†æ—…è¡Œè§„åˆ’å¸ˆ Pro | ç»ˆæå®šåˆ¶ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap');
        
        body { font-family: 'Noto Sans SC', sans-serif; background-color: #F8FAFC; color: #334155; }
        .tab-content { display: none; animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .hover-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .hover-card:hover { transform: translateY(-4px); box-shadow: 0 12px 24px -8px rgba(0,0,0,0.15); }
        #map-wrapper {
            background-color: #e5e7eb;
            background-image: linear-gradient(rgba(255,255,255,0.5) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.5) 1px, transparent 1px);
            background-size: 50px 50px;
            cursor: grab; overflow: hidden; position: relative;
        }
        #map-wrapper:active { cursor: grabbing; }
        .day-card.active { border-left-color: #3B82F6; background-color: #EFF6FF; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        
        /* é¢„ç®—åˆ—è¡¨é¡¹è¿›å…¥åŠ¨ç”» */
        @keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
        .budget-item-enter { animation: slideIn 0.3s ease-out forwards; }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <header class="bg-white/80 backdrop-blur-md sticky top-0 z-50 border-b border-gray-200">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 text-white p-2 rounded-xl shadow-lg shadow-blue-500/30">
                    <i class="ph ph-notebook text-xl"></i>
                </div>
                <div>
                    <h1 class="font-bold text-gray-800 text-lg leading-tight">æ–°ç–†æ—…è¡Œè§„åˆ’å¸ˆ <span class="text-xs text-white bg-blue-500 px-2 py-0.5 rounded-full ml-1">V3.3</span></h1>
                </div>
            </div>
            <nav class="hidden md:flex bg-gray-100/50 p-1.5 rounded-xl border border-gray-100">
                <button onclick="switchTab('explore')" class="nav-btn px-4 py-2 rounded-lg text-sm font-medium transition-all text-gray-600 hover:bg-white hover:shadow-sm" data-tab="explore">ğŸ”ï¸ æ™¯ç‚¹ç™¾ç§‘</button>
                <button onclick="switchTab('routes')" class="nav-btn px-4 py-2 rounded-lg text-sm font-medium transition-all text-gray-600 hover:bg-white hover:shadow-sm" data-tab="routes">ğŸ—ºï¸ äº¤äº’åœ°å›¾</button>
                <button onclick="switchTab('budget')" class="nav-btn px-4 py-2 rounded-lg text-sm font-medium transition-all text-gray-600 hover:bg-white hover:shadow-sm" data-tab="budget">ğŸ’° æ™ºèƒ½é¢„ç®—</button>
                <button onclick="switchTab('data')" class="nav-btn px-4 py-2 rounded-lg text-sm font-medium transition-all text-gray-600 hover:bg-white hover:shadow-sm" data-tab="data">ğŸ“Š å…¨æ™¯çœ‹æ¿</button>
                <button onclick="switchTab('pack')" class="nav-btn px-4 py-2 rounded-lg text-sm font-medium transition-all text-gray-600 hover:bg-white hover:shadow-sm" data-tab="pack">ğŸ’ è£…å¤‡æ¸…å•</button>
            </nav>
        </div>
    </header>

    <main class="flex-grow container mx-auto px-4 py-6">

        <!-- 1. æ™¯ç‚¹ç™¾ç§‘ -->
        <section id="explore" class="tab-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">æ™¯ç‚¹ç™¾ç§‘</h2>
                <button onclick="openAttractionModal(true)" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl shadow-lg shadow-blue-500/30 flex items-center gap-2 transition-all hover:-translate-y-0.5">
                    <i class="ph ph-map-pin-plus"></i> æ·»åŠ æ–°æ™¯ç‚¹
                </button>
            </div>
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 mb-6 flex flex-col md:flex-row gap-4 sticky top-20 z-30">
                <div class="relative flex-grow">
                    <i class="ph ph-magnifying-glass absolute left-3 top-3 text-gray-400"></i>
                    <input type="text" id="explore-search" placeholder="æœç´¢æ™¯ç‚¹åç§°..." class="w-full bg-gray-50 border border-gray-200 rounded-xl pl-10 pr-4 py-2.5 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <select id="explore-filter" class="bg-gray-50 border border-gray-200 rounded-xl px-4 py-2.5 text-sm outline-none cursor-pointer">
                    <option value="all">ğŸ“ æ‰€æœ‰ç±»å‹</option>
                    <option value="è‡ªç„¶">ğŸ”ï¸ è‡ªç„¶é£å…‰</option>
                    <option value="äººæ–‡">ğŸ•Œ äººæ–‡å¤è¿¹</option>
                    <option value="æ»‘é›ª">ğŸ¿ æ»‘é›ªåœº</option>
                    <option value="custom">âœ¨ æˆ‘çš„è‡ªå®šä¹‰</option>
                </select>
            </div>
            <div id="explore-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6"></div>
        </section>

        <!-- 2. äº¤äº’åœ°å›¾ -->
        <section id="routes" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 h-[calc(100vh-100px)]">
                <div class="lg:col-span-3 flex flex-col gap-4 h-full overflow-hidden">
                    <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex flex-col h-1/2">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-gray-800">ğŸ“… è¡Œç¨‹å®‰æ’</h3>
                            <button onclick="addDay()" class="text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded-lg font-medium hover:bg-blue-100 transition">+ å¢åŠ ä¸€å¤©</button>
                        </div>
                        <div id="day-list" class="flex-grow overflow-y-auto space-y-2 pr-1 custom-scrollbar"></div>
                    </div>
                    <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex flex-col h-1/2">
                        <h3 class="font-bold text-gray-800 mb-2 text-sm">ğŸ“ <span id="current-day-label">ç¬¬1å¤©</span> çš„è¡Œç¨‹</h3>
                        <div id="day-spots-list" class="flex-grow overflow-y-auto space-y-2 pr-1 custom-scrollbar empty:flex empty:items-center empty:justify-center empty:text-gray-400 empty:text-xs empty:after:content-['æš‚æ— æ™¯ç‚¹ï¼Œè¯·ä»å³ä¾§æ·»åŠ ']"></div>
                    </div>
                </div>
                <div class="lg:col-span-6 bg-white rounded-2xl shadow-sm border border-gray-100 relative overflow-hidden flex flex-col group">
                    <div class="absolute top-4 left-4 z-10 flex flex-col gap-2">
                         <div class="bg-white/90 backdrop-blur px-3 py-1.5 rounded-lg shadow-sm text-xs font-medium border border-gray-200 flex items-center gap-2"><div class="w-2 h-2 rounded-full bg-blue-500"></div> äº¤äº’åœ°å›¾</div>
                    </div>
                    <div class="absolute bottom-4 right-4 z-10 flex gap-2">
                        <button onclick="resetMapView()" class="bg-white p-2 rounded-lg shadow border border-gray-200 hover:bg-gray-50 text-gray-600" title="å¤ä½"><i class="ph ph-arrows-out-cardinal"></i></button>
                        <div class="flex bg-white rounded-lg shadow border border-gray-200 overflow-hidden">
                            <button onclick="zoomMap(0.1)" class="p-2 hover:bg-gray-50 border-r border-gray-100 text-gray-600"><i class="ph ph-plus"></i></button>
                            <button onclick="zoomMap(-0.1)" class="p-2 hover:bg-gray-50 text-gray-600"><i class="ph ph-minus"></i></button>
                        </div>
                    </div>
                    <div class="flex-grow relative" id="map-wrapper">
                        <canvas id="route-canvas" class="block"></canvas>
                        <div id="map-tooltip" class="absolute hidden bg-gray-900 text-white text-xs px-2 py-1 rounded pointer-events-none z-20 whitespace-nowrap"></div>
                    </div>
                    <div class="p-2 bg-gray-50 text-xs text-gray-500 text-center border-t border-gray-100">ğŸ–±ï¸ æ»šè½®ç¼©æ”¾ â€¢ ğŸ‘† æ‹–æ‹½å¹³ç§» â€¢ ğŸ¯ åœ¨æ·»åŠ æ™¯ç‚¹æ—¶ç‚¹å‡»ç”»å¸ƒå®šç‚¹</div>
                </div>
                <div class="lg:col-span-3 bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex flex-col h-full">
                    <h3 class="font-bold text-gray-800 mb-4">ğŸï¸ æ™¯ç‚¹åº“</h3>
                    <input type="text" id="spot-search" placeholder="æœç´¢..." class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm mb-4 outline-none">
                    <div id="all-spots-list" class="flex-grow overflow-y-auto space-y-2 pr-1 custom-scrollbar"></div>
                </div>
            </div>
        </section>

        <!-- 3. æ™ºèƒ½é¢„ç®— (æ ¸å¿ƒä¿®æ”¹ç‚¹) -->
        <section id="budget" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <!-- å·¦ä¾§é…ç½® -->
                <div class="lg:col-span-5 space-y-6">
                    <!-- è‡ªå®šä¹‰æ·»åŠ  -->
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                        <div class="flex items-center gap-2 mb-4 text-blue-600"><i class="ph ph-plus-circle text-xl"></i><h3 class="font-bold text-gray-800">æ·»åŠ è‡ªå®šä¹‰é¡¹ç›®</h3></div>
                        <div class="flex gap-2 mb-4 bg-blue-50/50 p-3 rounded-xl border border-blue-100">
                            <input type="text" id="custom-item-name" placeholder="é¡¹ç›®åç§° (å¦‚: æ»‘é›ªç¥¨)" class="flex-grow bg-white border border-gray-200 rounded px-3 py-2 text-sm outline-none">
                            <input type="number" id="custom-item-price" placeholder="é‡‘é¢" class="w-24 bg-white border border-gray-200 rounded px-3 py-2 text-sm outline-none">
                            <button onclick="addCustomBudgetItem()" class="bg-blue-600 text-white px-3 py-2 rounded hover:bg-blue-700 transition"><i class="ph ph-check-bold"></i></button>
                        </div>
                        <div id="custom-budget-list-left" class="space-y-2 max-h-60 overflow-y-auto custom-scrollbar text-sm text-gray-500">
                            <!-- å·¦ä¾§ä»…åšç®€å•åˆ—è¡¨æˆ–æç¤ºï¼Œä¸»è¦å±•ç¤ºåœ¨å³ä¾§å¤§å± -->
                            <p class="text-xs text-gray-400 text-center">æ·»åŠ çš„é¡¹ç›®å°†å®æ—¶æ˜¾ç¤ºåœ¨å³ä¾§æ€»è§ˆä¸­</p>
                        </div>
                    </div>
                    
                    <!-- åŸºç¡€å‚æ•° -->
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                        <h3 class="font-bold text-gray-800 mb-4">åŸºç¡€è®¾å®š</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="text-xs text-gray-500">äººæ•°</label><input type="number" id="budget-people" value="2" class="w-full mt-1 border rounded p-2 text-sm"></div>
                            <div><label class="text-xs text-gray-500">å¤©æ•°</label><input type="number" id="budget-days" value="1" disabled class="w-full mt-1 bg-gray-100 border rounded p-2 text-sm"></div>
                            <div><label class="text-xs text-gray-500">ä½å®¿(å…ƒ/é—´)</label><input type="number" id="price-stay" value="400" class="w-full mt-1 border rounded p-2 text-sm"></div>
                            <div><label class="text-xs text-gray-500">è½¦è´¹(å…ƒ/å¤©)</label><input type="number" id="price-trans" value="500" class="w-full mt-1 border rounded p-2 text-sm"></div>
                            <div><label class="text-xs text-gray-500">é¤é¥®(å…ƒ/äºº)</label><input type="number" id="price-food" value="150" class="w-full mt-1 border rounded p-2 text-sm"></div>
                            <div><label class="text-xs text-gray-500">é—¨ç¥¨(å…ƒ/äºº)</label><input type="number" id="price-ticket" value="800" class="w-full mt-1 border rounded p-2 text-sm"></div>
                        </div>
                    </div>
                </div>

                <!-- å³ä¾§ç»“æœé¢æ¿ (åŠ¨æ€å¢é•¿åˆ—è¡¨) -->
                <div class="lg:col-span-7">
                    <div class="bg-gradient-to-br from-blue-600 to-indigo-700 p-8 rounded-3xl shadow-xl text-white h-full flex flex-col relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-64 h-64 bg-white/10 rounded-full blur-3xl -mr-16 -mt-16 pointer-events-none"></div>
                        
                        <div class="mb-6 flex-grow">
                            <h2 class="text-2xl font-bold mb-6 flex items-center gap-2"><i class="ph ph-receipt"></i> é¢„ç®—æ€»è§ˆ</h2>
                            
                            <!-- åŠ¨æ€åˆ—è¡¨å®¹å™¨ -->
                            <div id="budget-summary-list" class="space-y-3 text-blue-100 max-h-[500px] overflow-y-auto custom-scrollbar pr-2">
                                <!-- JS å°†åœ¨è¿™é‡Œæ³¨å…¥å†…å®¹ -->
                            </div>
                        </div>

                        <div class="mt-4 pt-6 border-t border-white/20 bg-blue-700/30 -mx-8 -mb-8 p-8 backdrop-blur-sm">
                            <div class="flex justify-between items-baseline">
                                <span class="text-blue-200 font-medium">é¢„ä¼°æ€»è®¡</span>
                                <span class="text-5xl font-bold tracking-tight">Â¥<span id="disp-total">0</span></span>
                            </div>
                            <div class="text-right text-blue-300 mt-2 text-sm">äººå‡: Â¥<span id="disp-avg">0</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 4. å…¨æ™¯çœ‹æ¿ -->
        <section id="data" class="tab-content">
             <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 text-center"><div class="text-xs text-gray-500">æ€»é¢„ç®—</div><div class="text-2xl font-bold text-blue-600">Â¥<span id="dash-total">0</span></div></div>
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 text-center"><div class="text-xs text-gray-500">è¡Œç¨‹</div><div class="text-2xl font-bold text-gray-800"><span id="dash-days">0</span> å¤©</div></div>
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 text-center"><div class="text-xs text-gray-500">å‡†å¤‡è¿›åº¦</div><div class="text-2xl font-bold text-green-600"><span id="dash-pack">0</span>%</div></div>
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 text-center"><div class="text-xs text-gray-500">æ»‘é›ªç‚¹</div><div class="text-2xl font-bold text-purple-600"><span id="dash-ski-spots">0</span></div></div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100"><canvas id="budgetDoughnutChart"></canvas></div>
                <div class="lg:col-span-2 grid grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100"><canvas id="spotPolarChart"></canvas></div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                        <h3 class="font-bold mb-4">å¥‡æ™¯é¢„æµ‹ (-<span id="temp-val">20</span>Â°C)</h3>
                        <input type="range" id="temp-slider" min="-40" max="5" value="-20" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer mb-4">
                        <div class="space-y-3">
                            <div><div class="flex justify-between text-xs mb-1"><span>æ™¨é›¾</span><span id="prob-fog">85%</span></div><div class="w-full bg-gray-100 h-1.5 rounded-full"><div id="bar-fog" class="bg-cyan-400 h-full" style="width:85%"></div></div></div>
                            <div><div class="flex justify-between text-xs mb-1"><span>è“å†°</span><span id="prob-ice">90%</span></div><div class="w-full bg-gray-100 h-1.5 rounded-full"><div id="bar-ice" class="bg-blue-600 h-full" style="width:90%"></div></div></div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 5. è£…å¤‡æ¸…å• -->
        <section id="pack" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <div class="lg:col-span-8 bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-gray-800">è¶…çº§è£…å¤‡æ¸…å•</h2>
                        <button onclick="addCustomGear()" class="bg-gray-100 text-gray-700 px-3 py-1.5 rounded-lg text-sm hover:bg-gray-200 transition">+ è‡ªå®šä¹‰ç‰©å“</button>
                    </div>
                    <div id="gear-container" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
                </div>
                <div class="lg:col-span-4 space-y-6">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex flex-col items-center">
                        <h3 class="font-bold text-gray-800 mb-4 self-start">å‡†å¤‡è¿›åº¦</h3>
                        <div class="w-48 h-48 relative">
                            <canvas id="packChart"></canvas>
                            <div class="absolute inset-0 flex items-center justify-center flex-col"><span class="text-3xl font-bold text-blue-600" id="pack-percent-text">0%</span><span class="text-xs text-gray-400">å·²å®Œæˆ</span></div>
                        </div>
                    </div>
                    <div class="bg-blue-50 p-6 rounded-2xl border border-blue-100">
                        <h3 class="font-bold text-blue-800 mb-2">å¯¼å‡ºæ¸…å•</h3>
                        <button onclick="exportGearList()" class="w-full bg-blue-600 text-white py-2.5 rounded-xl shadow-lg shadow-blue-500/20 hover:bg-blue-700 transition flex items-center justify-center gap-2"><i class="ph ph-export"></i> å¯¼å‡º TXT æ–‡ä»¶</button>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Modal: å…¨èƒ½è‡ªå®šä¹‰æ™¯ç‚¹å¼¹çª— (ä¿æŒä¸å˜) -->
    <div id="attraction-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-lg p-6 shadow-2xl overflow-y-auto max-h-[90vh]">
            <div class="flex justify-between items-center mb-6"><h3 class="text-xl font-bold text-gray-800">ğŸ“ è‡ªå®šä¹‰æ™¯ç‚¹</h3><button onclick="closeModal()" class="text-gray-400 hover:text-gray-600"><i class="ph ph-x text-xl"></i></button></div>
            <div class="space-y-4">
                <div class="relative group cursor-pointer" onclick="document.getElementById('modal-img-input').click()"><div id="modal-img-preview" class="w-full h-40 bg-gray-100 rounded-xl border-2 border-dashed border-gray-300 flex flex-col items-center justify-center text-gray-400 group-hover:bg-gray-50 group-hover:border-blue-300 transition overflow-hidden"><i class="ph ph-image text-3xl mb-2"></i><span class="text-xs">ç‚¹å‡»æ›¿æ¢å›¾ç‰‡</span></div><input type="file" id="modal-img-input" accept="image/*" class="hidden" onchange="previewImage(this)"></div>
                <div class="grid grid-cols-2 gap-4"><input type="text" id="modal-name" placeholder="æ™¯ç‚¹åç§°" class="w-full border border-gray-200 rounded-lg p-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none"><select id="modal-type" class="w-full border border-gray-200 rounded-lg p-3 text-sm outline-none"><option value="è‡ªç„¶">ç±»å‹ï¼šè‡ªç„¶é£å…‰</option><option value="äººæ–‡">ç±»å‹ï¼šäººæ–‡å¤è¿¹</option><option value="æ»‘é›ª">ç±»å‹ï¼šæ»‘é›ªåœº</option><option value="custom">ç±»å‹ï¼šç§è—</option></select></div>
                <input type="text" id="modal-tags" placeholder="æ ‡ç­¾ (ç©ºæ ¼åˆ†éš”)" class="w-full border border-gray-200 rounded-lg p-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                <textarea id="modal-desc" placeholder="å¤‡æ³¨..." class="w-full border border-gray-200 rounded-lg p-3 text-sm h-24 focus:ring-2 focus:ring-blue-500 outline-none resize-none"></textarea>
                <div class="bg-blue-50 p-3 rounded-lg flex justify-between items-center"><div class="text-xs text-blue-700"><span class="font-bold">åæ ‡ï¼š</span><span id="modal-coords-display">æœªè®¾ç½®</span></div><button onclick="pickLocationFromModal()" class="bg-white text-blue-600 px-3 py-1.5 rounded-md text-xs font-bold border border-blue-200 hover:bg-blue-50 shadow-sm flex items-center gap-1"><i class="ph ph-crosshair"></i> åœ°å›¾å®šç‚¹</button></div>
            </div>
            <div class="mt-6 flex justify-end gap-3"><button onclick="closeModal()" class="px-5 py-2.5 text-gray-500 hover:bg-gray-100 rounded-xl font-medium transition">å–æ¶ˆ</button><button onclick="saveCustomSpot()" class="px-5 py-2.5 bg-blue-600 text-white rounded-xl font-medium hover:bg-blue-700 shadow-lg shadow-blue-500/30 transition">ä¿å­˜</button></div>
        </div>
    </div>

    <script>
        // --- æ•°æ®æ ¸å¿ƒ ---
        const defaultSpots = [
            { id: 1, name: "ä¹Œé²æœ¨é½", region: "åŒ—ç–†", type: "äººæ–‡", tags: ["å¤§å·´æ‰"], desc: "é¦–åºœ", img: null, x: 500, y: 300 },
            { id: 2, name: "ç¦¾æœ¨æ‘", region: "åŒ—ç–†", type: "è‡ªç„¶", tags: ["æ™¨é›¾"], desc: "ç¥çš„è‡ªç•™åœ°", img: null, x: 450, y: 100 },
            { id: 3, name: "å–€çº³æ–¯", region: "åŒ—ç–†", type: "è‡ªç„¶", tags: ["è“å†°"], desc: "ç‹è€…ä¹‹æ°´", img: null, x: 400, y: 80 },
            { id: 4, name: "èµ›é‡Œæœ¨æ¹–", region: "åŒ—ç–†", type: "è‡ªç„¶", tags: ["è“å†°"], desc: "å¤§è¥¿æ´‹çœ¼æ³ª", img: null, x: 200, y: 350 },
            { id: 5, name: "å–€ä»€å¤åŸ", region: "å—ç–†", type: "äººæ–‡", tags: ["å¼‚åŸŸ"], desc: "åƒå¹´å¤åŸ", img: null, x: 100, y: 800 },
            { id: 6, name: "å¯å¯æ‰˜æµ·", region: "åŒ—ç–†", type: "æ»‘é›ª", tags: ["è½å·®"], desc: "æ»‘é›ªå¤©å ‚", img: null, x: 600, y: 150 },
        ];
        const defaultGear = {
            "æ ¸å¿ƒä¿æš–": ["ç¾½ç»’æœ", "å†²é”‹è¡£", "ä¿æš–å†…è¡£", "ç¾Šæ¯›è¢œ", "é›ªåœ°é´"],
            "æ»‘é›ªè£…å¤‡": ["å¤´ç›”", "é›ªé•œ", "æŠ¤è„¸", "æ‰‹å¥—", "æŠ¤å…·"],
            "ç”µå­è®¾å¤‡": ["å……ç”µå®", "ç›¸æœºç”µæ± ", "æ— äººæœº", "æ•°æ®çº¿"],
            "è¯å“ä¸ªæŠ¤": ["æ„Ÿå†’è¯", "è‚ èƒƒè¯", "é˜²æ™’éœœ", "æ¶¦å”‡è†"]
        };
        let state = {
            spots: [...defaultSpots], itinerary: [[]], currentDayIndex: 0,
            customBudget: [], customGear: [], weatherTemp: -20,
            isPickingMode: false, mapScale: 1, mapOffset: {x:0,y:0}, isDragging: false, startDrag: {x:0,y:0}, tempSpotData: null
        };

        // --- åˆå§‹åŒ– ---
        document.addEventListener('DOMContentLoaded', () => {
            renderExploreGrid(); renderDayList(); renderAllSpots(); renderBudget(); renderGear(); initCharts();
            setTimeout(() => { initMapEvents(); renderMap(); }, 100);
            document.getElementById('explore-search').addEventListener('input', renderExploreGrid);
            document.getElementById('explore-filter').addEventListener('change', renderExploreGrid);
            document.getElementById('spot-search').addEventListener('input', renderAllSpots);
            ['budget-people', 'price-stay', 'price-trans', 'price-food', 'price-ticket'].forEach(id => document.getElementById(id).addEventListener('input', renderBudget));
            document.getElementById('temp-slider').addEventListener('input', (e) => { state.weatherTemp = parseInt(e.target.value); document.getElementById('temp-val').innerText = state.weatherTemp; });
            document.querySelectorAll('.nav-btn[data-tab="data"]').forEach(btn => btn.addEventListener('click', updateDashboard));
        });

        // --- é¢„ç®—é€»è¾‘ (æ ¸å¿ƒä¿®æ”¹) ---
        function addCustomBudgetItem() {
            const n = document.getElementById('custom-item-name').value;
            const p = parseFloat(document.getElementById('custom-item-price').value);
            if(n && p) { state.customBudget.push({name:n, price:p, id: Date.now()}); document.getElementById('custom-item-name').value=''; document.getElementById('custom-item-price').value=''; renderBudget(); }
        }
        function renderBudget() {
            const p = parseInt(document.getElementById('budget-people').value)||1;
            const d = parseInt(document.getElementById('budget-days').value)||1;
            const stay = parseFloat(document.getElementById('price-stay').value)||0;
            const trans = parseFloat(document.getElementById('price-trans').value)||0;
            const food = parseFloat(document.getElementById('price-food').value)||0;
            const ticket = parseFloat(document.getElementById('price-ticket').value)||0;

            const tStay = (stay*Math.ceil(p/2))*(d-1);
            const tTrans = trans*d;
            const tMisc = (food*p*d)+(ticket*p);
            
            // FIX: Added IDs to spans so chart can read them
            let listHtml = `
                <div class="flex justify-between items-center p-3 bg-white/10 rounded-xl border border-white/10"><span>ğŸ¨ ä½å®¿è´¹</span><span class="font-mono text-lg font-bold">Â¥<span id="disp-stay">${tStay}</span></span></div>
                <div class="flex justify-between items-center p-3 bg-white/10 rounded-xl border border-white/10"><span>ğŸš— äº¤é€šè´¹</span><span class="font-mono text-lg font-bold">Â¥<span id="disp-trans">${tTrans}</span></span></div>
                <div class="flex justify-between items-center p-3 bg-white/10 rounded-xl border border-white/10"><span>ğŸ¥˜ é£Ÿ/ç¥¨</span><span class="font-mono text-lg font-bold">Â¥<span id="disp-misc">${tMisc}</span></span></div>
            `;
            
            let tCustomTotal = 0;
            state.customBudget.forEach((item, idx) => {
                tCustomTotal += item.price;
                listHtml += `
                    <div class="flex justify-between items-center p-3 bg-orange-500/20 rounded-xl border border-orange-500/30 text-orange-100 budget-item-enter relative group">
                        <span class="flex items-center gap-2"><i class="ph ph-star-four"></i> ${item.name}</span>
                        <div class="flex items-center gap-3">
                            <span class="font-mono text-lg font-bold">Â¥${item.price}</span>
                            <button onclick="removeBudgetItem(${idx})" class="text-white/50 hover:text-white opacity-0 group-hover:opacity-100 transition"><i class="ph ph-trash"></i></button>
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('budget-summary-list').innerHTML = listHtml;
            
            const leftList = document.getElementById('custom-budget-list-left');
            if(leftList) {
                 leftList.innerHTML = state.customBudget.map((item, idx) => 
                    `<div class="flex justify-between items-center text-xs p-1 px-2 bg-gray-50 rounded text-gray-600"><span>${item.name}</span><span>Â¥${item.price}</span></div>`
                 ).join('');
            }

            const total = tStay+tTrans+tMisc+tCustomTotal;
            document.getElementById('disp-total').innerText=total.toLocaleString();
            document.getElementById('disp-avg').innerText=Math.round(total/p).toLocaleString();
        }
        
        function removeBudgetItem(idx) {
            state.customBudget.splice(idx, 1);
            renderBudget();
        }

        // --- åœ°å›¾ (åŒV3.2) ---
        function initMapEvents() {
            const w = document.getElementById('map-wrapper');
            w.addEventListener('wheel', e => { e.preventDefault(); zoomMap(e.deltaY>0?0.9:1.1); });
            w.addEventListener('mousedown', e => { state.isDragging=true; state.startDrag={x:e.clientX,y:e.clientY}; w.style.cursor='grabbing'; if(state.isPickingMode) handleMapClick(e); });
            window.addEventListener('mousemove', e => { if(state.isDragging){ state.mapOffset.x+=e.clientX-state.startDrag.x; state.mapOffset.y+=e.clientY-state.startDrag.y; state.startDrag={x:e.clientX,y:e.clientY}; renderMap(); } handleMapHover(e); });
            window.addEventListener('mouseup', () => { state.isDragging=false; w.style.cursor=state.isPickingMode?'crosshair':'grab'; });
        }
        function zoomMap(delta) { const ns=state.mapScale+delta; if(ns>0.2 && ns<5) { state.mapScale=ns; renderMap(); } }
        function resetMapView() { state.mapScale=1; state.mapOffset={x:0,y:0}; renderMap(); }
        function renderMap() {
            const cvs=document.getElementById('route-canvas'), ctx=cvs.getContext('2d'), w=document.getElementById('map-wrapper');
            cvs.width=w.offsetWidth; cvs.height=w.offsetHeight; ctx.clearRect(0,0,cvs.width,cvs.height);
            ctx.save(); ctx.translate(cvs.width/2+state.mapOffset.x, cvs.height/2+state.mapOffset.y); ctx.scale(state.mapScale,state.mapScale); ctx.translate(-cvs.width/2,-cvs.height/2);
            const vs=1000, sx=1, sy=1, stX=(cvs.width-vs)/2, stY=(cvs.height-vs)/2;
            state.itinerary.forEach((dS,di)=>{
                if(dS.length<2)return; ctx.beginPath(); ctx.strokeStyle=di===state.currentDayIndex?'#3B82F6':'#94A3B8'; ctx.lineWidth=di===state.currentDayIndex?4/state.mapScale:2/state.mapScale; ctx.setLineDash(di===state.currentDayIndex?[]:[10,10]);
                dS.forEach((id,idx)=>{const s=state.spots.find(sp=>sp.id===id); if(s) idx===0?ctx.moveTo(stX+s.x,stY+s.y):ctx.lineTo(stX+s.x,stY+s.y);}); ctx.stroke();
            });
            state.spots.forEach(s=>{
                const cx=stX+s.x, cy=stY+s.y, act=state.itinerary[state.currentDayIndex].includes(s.id);
                ctx.beginPath(); ctx.arc(cx,cy,(act?8:5)/Math.sqrt(state.mapScale),0,Math.PI*2); ctx.fillStyle=act?'#3B82F6':'#CBD5E1'; ctx.fill();
                ctx.fillStyle='#475569'; ctx.font=`${12/state.mapScale}px Noto Sans SC`; ctx.fillText(s.name,cx+10,cy);
            });
            ctx.restore();
        }
        function pickLocationFromModal() { state.tempSpotData={name:document.getElementById('modal-name').value, tags:document.getElementById('modal-tags').value, desc:document.getElementById('modal-desc').value, imgSrc:document.querySelector('#modal-img-preview img')?.src}; state.isPickingMode=true; document.getElementById('attraction-modal').classList.add('hidden'); switchTab('routes'); document.getElementById('map-wrapper').style.cursor='crosshair'; }
        function handleMapClick(e) {
            if(!state.isPickingMode) return;
            const w=document.getElementById('map-wrapper'), rect=w.getBoundingClientRect();
            const mx=e.clientX-rect.left, my=e.clientY-rect.top;
            const cx=w.offsetWidth/2+state.mapOffset.x, cy=w.offsetHeight/2+state.mapOffset.y;
            const ux=(mx-cx)/state.mapScale, uy=(my-cy)/state.mapScale;
            if(!state.tempSpotData) state.tempSpotData={};
            state.tempSpotData.x=ux+w.offsetWidth/2-(w.offsetWidth-1000)/2; state.tempSpotData.y=uy+w.offsetHeight/2-(w.offsetHeight-1000)/2;
            state.isPickingMode=false; document.getElementById('map-wrapper').style.cursor='grab'; openAttractionModal(false);
        }
        function handleMapHover(e) {
            const tip=document.getElementById('map-tooltip'); if(state.isPickingMode||state.isDragging){tip.classList.add('hidden');return;}
            const w=document.getElementById('map-wrapper'), rect=w.getBoundingClientRect();
            const mx=e.clientX-rect.left, my=e.clientY-rect.top;
            const cx=w.offsetWidth/2+state.mapOffset.x, cy=w.offsetHeight/2+state.mapOffset.y;
            const stX=(w.offsetWidth-1000)/2, stY=(w.offsetHeight-1000)/2;
            const h=state.spots.find(s=>{
                const sx=cx+(stX+s.x-w.offsetWidth/2)*state.mapScale, sy=cy+(stY+s.y-w.offsetHeight/2)*state.mapScale;
                return Math.abs(sx-mx)<10 && Math.abs(sy-my)<10;
            });
            if(h){ tip.style.left=(mx+15)+'px'; tip.style.top=my+'px'; tip.innerText=h.name; tip.classList.remove('hidden'); } else tip.classList.add('hidden');
        }

        // --- è£…å¤‡ & é€šç”¨ ---
        let packChartInstance;
        function renderGear() {
            const c=document.getElementById('gear-container'); c.innerHTML='';
            let cats={...defaultGear}; if(state.customGear.length) cats["è‡ªå®šä¹‰"]=state.customGear;
            for(const [k,v] of Object.entries(cats)){
                c.innerHTML+=`<div><h4 class="font-bold text-gray-700 mb-2 border-l-4 border-blue-500 pl-2">${k}</h4><div class="space-y-2">${v.map(i=>`<label class="flex items-center space-x-2 text-sm text-gray-500 cursor-pointer hover:bg-gray-50 p-1 rounded"><input type="checkbox" class="rounded text-blue-600 w-4 h-4 gear-check" data-item="${i}" onchange="updateGearStats()"><span>${i}</span></label>`).join('')}</div></div>`;
            }
            updateGearStats();
        }
        function updateGearStats() {
            const t=document.querySelectorAll('.gear-check').length, c=document.querySelectorAll('.gear-check:checked').length;
            document.getElementById('pack-percent-text').innerText=(t===0?0:Math.round(c/t*100))+'%';
            if(packChartInstance){ packChartInstance.data.datasets[0].data=[c,t-c]; packChartInstance.update(); }
            else{ const ctx=document.getElementById('packChart').getContext('2d'); packChartInstance=new Chart(ctx,{type:'doughnut',data:{labels:['å·²å‡†å¤‡','æœªå‡†å¤‡'],datasets:[{data:[c,t-c],backgroundColor:['#3B82F6','#E5E7EB'],borderWidth:0,cutout:'80%'}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{enabled:false}}}}); }
        }
        function exportGearList() {
            let txt="=== æ–°ç–†æ—…è¡Œæ¸…å• ===\n\n"; const cbs=document.querySelectorAll('.gear-check');
            let cats={...defaultGear}; if(state.customGear.length) cats["è‡ªå®šä¹‰"]=state.customGear;
            for(const [k,v] of Object.entries(cats)){ txt+=`[ ${k} ]\n`; v.forEach(i=>{ const cb=Array.from(cbs).find(c=>c.dataset.item===i); txt+=`${cb&&cb.checked?'[x]':'[ ]'} ${i}\n`; }); txt+="\n"; }
            const a=document.createElement("a"); a.href=URL.createObjectURL(new Blob([txt],{type:"text/plain"})); a.download="æ¸…å•.txt"; a.click();
        }
        function addCustomGear() { const n=prompt("åç§°"); if(n){state.customGear.push(n); renderGear();} }

        // --- å…¶ä»–é€šç”¨ (å¤ç”¨V3.2) ---
        function renderExploreGrid() {
            const g=document.getElementById('explore-grid'), term=document.getElementById('explore-search').value.toLowerCase(), flt=document.getElementById('explore-filter').value; g.innerHTML='';
            state.spots.forEach(s=>{
                if((s.name.toLowerCase().includes(term)||s.tags.join('').includes(term))&&(flt==='all'||(flt==='custom'?s.id>1000:s.type===flt))){
                    let im=s.img?`<img src="${s.img}" class="w-full h-40 object-cover">`:`<div class="w-full h-40 bg-gray-100 flex items-center justify-center text-4xl text-gray-300 font-bold">${s.name[0]}</div>`;
                    const div=document.createElement('div'); div.className="bg-white rounded-2xl overflow-hidden shadow-sm border border-gray-100 hover-card flex flex-col h-full";
                    div.innerHTML=`<div class="relative">${im}<span class="absolute top-3 right-3 bg-black/50 text-white text-xs px-2 py-1 rounded backdrop-blur">${s.type}</span></div><div class="p-4 flex flex-col flex-grow"><h3 class="font-bold text-gray-800 text-lg">${s.name}</h3><p class="text-xs text-gray-500 mb-2">${s.desc||''}</p><div class="mt-auto"><button onclick="addSpotToRouteFromExplore(${s.id})" class="w-full bg-blue-50 text-blue-600 py-2 rounded-lg text-sm hover:bg-blue-100">åŠ å…¥è¡Œç¨‹</button></div></div>`;
                    g.appendChild(div);
                }
            });
        }
        function addSpotToRouteFromExplore(id) { state.itinerary[state.currentDayIndex].push(id); alert("å·²åŠ å…¥è¡Œç¨‹"); renderDayList(); }
        function renderDayList() {
            const l=document.getElementById('day-list'); l.innerHTML=''; document.getElementById('budget-days').value=state.itinerary.length; renderBudget();
            state.itinerary.forEach((s,i)=>{
                const d=document.createElement('div'); d.className=`p-3 rounded-xl border-l-4 cursor-pointer mb-2 transition-all ${i===state.currentDayIndex?'active border-blue-500 bg-blue-50':'border-transparent hover:bg-gray-50'}`;
                d.innerHTML=`<div class="flex justify-between items-center"><span class="font-bold text-sm text-gray-700">ç¬¬ ${i+1} å¤©</span><span class="text-xs bg-gray-100 px-2 py-0.5 rounded text-gray-500">${s.length}</span></div>`;
                d.onclick=()=>{state.currentDayIndex=i;renderDayList();}; l.appendChild(d);
            });
            renderDaySpots(); renderMap();
        }
        function addDay() { state.itinerary.push([]); state.currentDayIndex=state.itinerary.length-1; renderDayList(); }
        function renderDaySpots() {
            const l=document.getElementById('day-spots-list'); l.innerHTML=''; document.getElementById('current-day-label').innerText=`ç¬¬ ${state.currentDayIndex+1} å¤©`;
            state.itinerary[state.currentDayIndex].forEach((id,x)=>{
                const s=state.spots.find(sp=>sp.id===id); if(!s)return;
                l.innerHTML+=`<div class="flex items-center justify-between p-2 bg-gray-50 rounded mb-1"><div class="flex items-center gap-2"><span class="text-xs font-bold text-gray-300 w-4">${x+1}</span><span class="text-sm text-gray-700">${s.name}</span></div><div class="flex gap-2"><a href="https://www.amap.com/search?query=${encodeURIComponent(s.name)}" target="_blank" class="text-gray-300 hover:text-green-600"><i class="ph ph-navigation-arrow"></i></a><button onclick="removeSpot(${x})" class="text-gray-300 hover:text-red-500"><i class="ph ph-trash"></i></button></div></div>`;
            });
        }
        function removeSpot(x) { state.itinerary[state.currentDayIndex].splice(x,1); renderDayList(); }
        function renderAllSpots() {
            const l=document.getElementById('all-spots-list'), t=document.getElementById('spot-search').value.toLowerCase(); l.innerHTML='';
            state.spots.filter(s=>s.name.toLowerCase().includes(t)).forEach(s=>{
                const b=document.createElement('button'); b.className="w-full text-left p-2 hover:bg-blue-50 rounded-lg text-sm text-gray-600 hover:text-blue-700 transition flex justify-between group";
                b.innerHTML=`<span>${s.name}</span><i class="ph ph-plus-circle text-blue-400 opacity-0 group-hover:opacity-100"></i>`;
                b.onclick=()=>{state.itinerary[state.currentDayIndex].push(s.id); renderDayList();}; l.appendChild(b);
            });
        }
        function openAttractionModal(r) { document.getElementById('attraction-modal').classList.remove('hidden'); if(r){document.getElementById('modal-name').value='';document.getElementById('modal-coords-display').innerText='æœªè®¾ç½®';state.tempSpotData=null;}else if(state.tempSpotData?.x) document.getElementById('modal-coords-display').innerText=`X:${Math.round(state.tempSpotData.x)}, Y:${Math.round(state.tempSpotData.y)}`; }
        function closeModal() { document.getElementById('attraction-modal').classList.add('hidden'); state.isPickingMode=false; document.getElementById('map-wrapper').style.cursor='grab'; }
        function previewImage(i) { if(i.files&&i.files[0]){const r=new FileReader(); r.onload=e=>document.getElementById('modal-img-preview').innerHTML=`<img src="${e.target.result}" class="w-full h-full object-cover">`; r.readAsDataURL(i.files[0]);} }
        function saveCustomSpot() {
            const n=document.getElementById('modal-name').value; if(!n)return;
            state.spots.push({id:Date.now(), name:n, type:document.getElementById('modal-type').value, tags:document.getElementById('modal-tags').value.split(' '), desc:document.getElementById('modal-desc').value, img:document.querySelector('#modal-img-preview img')?.src, x:state.tempSpotData?.x||500, y:state.tempSpotData?.y||500});
            renderExploreGrid(); renderAllSpots(); renderMap(); closeModal();
        }
        function updateDashboard() { renderBudget(); document.getElementById('dash-total').innerText=document.getElementById('disp-total').innerText; document.getElementById('dash-days').innerText=state.itinerary.length; document.getElementById('dash-pack').innerText=document.getElementById('pack-percent-text').innerText.replace('%',''); document.getElementById('dash-ski-spots').innerText=state.itinerary.flat().map(id=>state.spots.find(s=>s.id===id)).filter(s=>s&&s.type==='æ»‘é›ª').length; updateBudgetChart(); }
        let budgetDoughnutChart, spotPolarChart;
        function initCharts() {
             const c1=document.getElementById('budgetDoughnutChart').getContext('2d'); budgetDoughnutChart=new Chart(c1,{type:'doughnut',data:{labels:['ä½å®¿','äº¤é€š','é£Ÿ/ç¥¨','è‡ªå®šä¹‰'],datasets:[{data:[1,1,1,1],backgroundColor:['#60A5FA','#34D399','#A78BFA','#F97316'],borderWidth:0}]},options:{responsive:true,maintainAspectRatio:false}});
             const c2=document.getElementById('spotPolarChart').getContext('2d'); spotPolarChart=new Chart(c2,{type:'polarArea',data:{labels:['è‡ªç„¶','äººæ–‡','æ»‘é›ª','è‡ªå®šä¹‰'],datasets:[{data:[1,1,1,0],backgroundColor:['rgba(56,189,248,0.6)','rgba(167,139,250,0.6)','rgba(249,115,22,0.6)','rgba(251,191,36,0.6)'],borderWidth:1}]},options:{responsive:true,maintainAspectRatio:false,scales:{r:{ticks:{display:false}}}}});
        }
        function updateBudgetChart() {
             const s=parseInt(document.getElementById('disp-stay').innerText.replace(/,/g,'')), t=parseInt(document.getElementById('disp-trans').innerText.replace(/,/g,'')), m=parseInt(document.getElementById('disp-misc').innerText.replace(/,/g,''));
             let c=0; state.customBudget.forEach(i=>c+=i.price);
             budgetDoughnutChart.data.datasets[0].data=[s,t,m,c]; budgetDoughnutChart.update();
             // Polar update
             const ids=state.itinerary.flat(), sp=ids.map(id=>state.spots.find(s=>s.id===id)).filter(s=>s);
             spotPolarChart.data.datasets[0].data=[sp.filter(s=>s.type==='è‡ªç„¶').length, sp.filter(s=>s.type==='äººæ–‡').length, sp.filter(s=>s.type==='æ»‘é›ª').length, sp.filter(s=>s.type==='custom').length]; spotPolarChart.update();
        }
        function switchTab(id) { document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active')); document.getElementById(id).classList.add('active'); if(id==='routes')setTimeout(renderMap,100); if(id==='data')updateDashboard(); }
    </script>
</body>
</html>

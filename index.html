<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ—…è¡Œè§„åˆ’å¸ˆ Pro | å®æ—¶åŒæ­¥ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap');
        
        body { font-family: 'Noto Sans SC', sans-serif; background-color: #F1F5F9; color: #334155; padding-bottom: 80px; }
        
        /* äº¤äº’åŠ¨æ•ˆ */
        .tab-content { display: none; animation: fadeIn 0.3s ease-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        #map-wrapper { cursor: default; overflow: hidden; position: relative; touch-action: none; }

        .mobile-nav-btn.active { color: #2563EB; }
        
        .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #CBD5E1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background-color: transparent; }

        .ring-red-500 { transition: all 0.2s ease-in-out; }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <!-- é¡¶éƒ¨æ ‡é¢˜æ  -->
    <header class="bg-white/90 backdrop-blur-md sticky top-0 z-40 border-b border-gray-200 shadow-sm">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <div class="bg-blue-600 text-white p-1.5 rounded-lg shadow-md shadow-blue-500/30">
                    <i class="ph ph-airplane-tilt text-xl"></i>
                </div>
                <h1 class="font-bold text-gray-800 text-base leading-tight">æ—…è¡Œè§„åˆ’å¸ˆ <span class="text-[10px] text-red-600 bg-red-50 px-1.5 py-0.5 rounded-full border border-red-100 align-middle" id="sync-status-badge">éœ€ç™»å½•</span></h1>
            </div>
            
            <div class="flex items-center gap-2">
                <button id="logout-button-header" onclick="window.handleSignOut()" 
                        class="hidden bg-red-100 px-3 py-1 rounded-xl text-xs text-red-600 hover:bg-red-200 transition-colors items-center gap-1">
                    <i class="ph ph-sign-out"></i> é€€å‡º
                </button>

                <button id="auth-button" onclick="window.openAuthModal()" 
                        class="bg-gray-100 px-3 py-1 rounded-xl text-sm text-gray-600 hover:bg-gray-200 transition-colors flex items-center gap-1">
                    <i class="ph ph-user-circle"></i>
                    <span id="auth-status">ç™»å½•/æ³¨å†Œ</span>
                </button>
            </div>
            
            <nav class="hidden md:flex bg-gray-100/50 p-1 rounded-xl border border-gray-100">
                <button onclick="window.switchTab('explore')" class="nav-btn px-4 py-2 rounded-lg text-sm font-medium transition-all text-gray-600 hover:bg-white hover:shadow-sm" data-tab="explore">ğŸ”ï¸ ç™¾ç§‘</button>
                <button onclick="window.switchTab('routes')" class="nav-btn px-4 py-2 rounded-lg text-sm font-medium transition-all text-gray-600 hover:bg-white hover:shadow-sm" data-tab="routes">ğŸ—ºï¸ è¡Œç¨‹</button>
                <button onclick="window.switchTab('budget')" class="nav-btn px-4 py-2 rounded-lg text-sm font-medium transition-all text-gray-600 hover:bg-white hover:shadow-sm" data-tab="budget">ğŸ’° é¢„ç®—</button>
                <button onclick="window.switchTab('data')" class="nav-btn px-4 py-2 rounded-lg text-sm font-medium transition-all text-gray-600 hover:bg-white hover:shadow-sm" data-tab="data">ğŸ“Š çœ‹æ¿</button>
                <button onclick="window.switchTab('pack')" class="nav-btn px-4 py-2 rounded-lg text-sm font-medium transition-all text-gray-600 hover:bg-white hover:shadow-sm" data-tab="pack">ğŸ’ æ¸…å•</button>
            </nav>
        </div>
    </header>

    <main class="flex-grow container mx-auto px-4 py-4">
        
        <!-- Loading State -->
        <div id="loading-state" class="absolute inset-0 bg-gray-50/70 backdrop-blur-sm z-40 flex items-center justify-center hidden">
            <div class="flex flex-col items-center p-8 bg-white rounded-xl shadow-xl">
                <div class="ph ph-spinner-gap animate-spin text-4xl text-blue-600 mb-3"></div>
                <p class="text-gray-600 font-medium">æ­£åœ¨è¿æ¥ä¸åŒæ­¥æ•°æ®...</p>
            </div>
        </div>

        <!-- 1. æ™¯ç‚¹ç™¾ç§‘ -->
        <section id="explore" class="tab-content active">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">æ™¯ç‚¹å‘ç°</h2>
                <button onclick="window.openAttractionModal()" class="bg-blue-600 active:bg-blue-700 text-white px-3 py-2 rounded-xl shadow-lg flex items-center gap-1 text-xs transition-transform active:scale-95">
                    <i class="ph ph-plus-bold"></i> æ–°å¢æ™¯ç‚¹
                </button>
            </div>
            <div class="bg-white p-3 rounded-2xl shadow-sm border border-gray-100 mb-4 flex flex-col gap-3 sticky top-16 z-30">
                <div class="relative w-full">
                    <i class="ph ph-magnifying-glass absolute left-3 top-3 text-gray-400"></i>
                    <input type="text" id="explore-search" placeholder="æœæ™¯ç‚¹..." oninput="window.renderExploreGrid()" class="w-full bg-gray-50 border-0 rounded-xl pl-9 pr-3 py-2.5 text-sm ring-1 ring-gray-200 outline-none">
                </div>
                <div class="flex overflow-x-auto gap-2 pb-1 custom-scrollbar">
                    <select id="explore-filter" onchange="window.renderExploreGrid()" class="bg-gray-50 border-0 rounded-xl px-3 py-2 text-xs outline-none flex-shrink-0 ring-1 ring-gray-200">
                        <option value="all">å…¨éƒ¨ç±»å‹</option><option value="è‡ªç„¶">ğŸ”ï¸ è‡ªç„¶</option><option value="äººæ–‡">ğŸ•Œ äººæ–‡</option><option value="æ»‘é›ª">ğŸ¿ æ»‘é›ª</option><option value="custom">âœ¨ è‡ªå®šä¹‰</option>
                    </select>
                </div>
            </div>
            <div id="explore-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 pb-20"></div>
        </section>

        <!-- 2. è¡Œç¨‹è„‘å›¾ -->
        <section id="routes" class="tab-content">
            <div class="flex flex-col lg:grid lg:grid-cols-12 gap-4 h-auto lg:h-[calc(100vh-100px)]">
                
                <!-- ä¾§è¾¹æ  -->
                <div class="lg:col-span-3 flex flex-col gap-3 bg-white p-3 rounded-2xl shadow-sm border border-gray-100 order-2 lg:order-1">
                    <div class="flex justify-between items-center">
                        <h3 class="font-bold text-gray-800 text-sm">ğŸ“… è¡Œç¨‹</h3>
                        <button onclick="window.addDay()" class="text-xs bg-blue-50 text-blue-600 px-2 py-1 rounded border border-blue-100">+ å¤©æ•°</button>
                    </div>
                    <div id="day-list" class="flex lg:flex-col gap-2 overflow-x-auto lg:overflow-y-auto custom-scrollbar pb-2 lg:pb-0 h-auto lg:h-1/2"></div>
                    <div class="mt-2 border-t pt-2 lg:h-1/2 lg:flex-col lg:flex hidden lg:flex">
                        Â <h3 class="font-bold text-gray-800 mb-2 text-xs">ğŸ“ å½“æ—¥æ˜ç»†</h3>
                        Â <div id="day-spots-list-desktop" class="flex-grow overflow-y-auto space-y-2 pr-1 custom-scrollbar text-xs"></div>
                    </div>
                </div>

                <!-- è„‘å›¾åŒºåŸŸ -->
                <div class="lg:col-span-6 bg-white rounded-2xl shadow-xl border border-gray-100 p-6 flex flex-col order-1 lg:order-2 h-[500px] lg:h-full">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-gray-800 text-lg flex items-center gap-2">
                            <i class="ph ph-tree-structure text-blue-600"></i> ç¬¬ <span id="current-day-num">1</span> å¤©
                        </h3>
                        <button onclick="window.exportToXMind()" class="bg-green-50 text-green-600 px-3 py-1.5 rounded-lg text-xs font-medium hover:bg-green-100 border border-green-200 transition flex items-center gap-1" title="å¯¼å‡ºä¸º Markdown">
                            <i class="ph ph-export"></i> å¯¼å‡º XMind
                        </button>
                    </div>
                    <div id="itinerary-mind-map" class="flex-grow overflow-y-auto space-y-6 custom-scrollbar">
                        <div class="text-center text-gray-500 py-12">åŠ è½½ä¸­...</div>
                    </div>
                </div>

                <!-- æ™¯ç‚¹åˆ—è¡¨ -->
                <div class="lg:col-span-3 bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex flex-col h-full order-3">
                    <div class="lg:hidden mb-4">
                        <h3 class="font-bold text-gray-800 mb-2 text-sm">ğŸ“ å½“æ—¥æ™¯ç‚¹ (<span id="day-spot-count">0</span>)</h3>
                        <div id="day-spots-list-mobile" class="space-y-2 max-h-40 overflow-y-auto custom-scrollbar text-xs"></div>
                    </div>
                    <h3 class="font-bold text-gray-800 mb-3 text-sm">â• æ·»åŠ æ™¯ç‚¹åˆ°å½“å¤©</h3>
                    <input type="text" id="spot-search" placeholder="æœç´¢..." oninput="window.renderAllSpots()" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm mb-3 outline-none">
                    <div id="all-spots-list" class="flex-grow overflow-y-auto space-y-2 pr-1 custom-scrollbar max-h-60 lg:max-h-none"></div>
                </div>
            </div>
        </section>

        <!-- 3. æ™ºèƒ½é¢„ç®— -->
        <section id="budget" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-4 pb-20">
                <div class="lg:col-span-5 space-y-4">
                    <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                        <div class="flex items-center gap-2 mb-3 text-blue-600 text-sm font-bold"><i class="ph ph-plus-circle text-lg"></i> æ·»åŠ æ”¯å‡º</div>
                        <div class="grid grid-cols-6 gap-2 mb-3">
                            <input type="text" id="custom-item-name" placeholder="é¡¹ç›®" class="col-span-3 bg-gray-50 border-0 rounded-lg px-2 py-2 text-sm ring-1 ring-gray-200 outline-none" title="é¡¹ç›®åç§°">
                            <input type="number" id="custom-item-people" placeholder="äººæ•°" class="col-span-1 bg-gray-50 border-0 rounded-lg px-2 py-2 text-sm ring-1 ring-gray-200 outline-none" title="äººæ•° (ç”¨äºåˆ†æ‘Š)">
                            <input type="number" id="custom-item-days" placeholder="å¤©æ•°" class="col-span-1 bg-gray-50 border-0 rounded-lg px-2 py-2 text-sm ring-1 ring-gray-200 outline-none" title="å¤©æ•° (1ä»£è¡¨ä¸€æ¬¡æ€§æ¶ˆè´¹)">
                            <input type="text" id="custom-item-payer" placeholder="ä»˜æ¬¾äºº" class="col-span-1 bg-gray-50 border-0 rounded-lg px-2 py-2 text-sm ring-1 ring-gray-200 outline-none" title="ä»˜æ¬¾äºº">
                        </div>
                        <div class="flex gap-2">
                             <input type="number" id="custom-item-price" placeholder="é‡‘é¢ (Â¥)" class="flex-grow bg-gray-50 border-0 rounded-lg px-3 py-2 text-sm ring-1 ring-gray-200 outline-none">
                            <button onclick="window.addCustomBudgetItem()" class="bg-blue-600 text-white px-3 rounded-lg hover:bg-blue-700 transition"><i class="ph ph-check-bold"></i></button>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                        <h3 class="font-bold text-gray-800 mb-3 text-sm">åŸºç¡€è®¾å®š</h3>
                        <div class="grid grid-cols-2 gap-3 text-sm">
                            <div><label class="text-xs text-gray-400">äººæ•°</label><input type="number" id="budget-people" value="2" class="w-full mt-1 border rounded p-1.5" onchange="window.updateDashboard(); window.debounceSave()"></div>
                            <div><label class="text-xs text-gray-400">å¤©æ•°</label><input type="number" id="budget-days" value="1" disabled class="w-full mt-1 bg-gray-50 border rounded p-1.5 text-gray-400"></div>
                            <div><label class="text-xs text-gray-400">ä½å®¿/é—´ (xå¤©)</label><input type="number" id="price-stay" value="400" class="w-full mt-1 border rounded p-1.5" onchange="window.updateDashboard(); window.debounceSave()"></div>
                            <div><label class="text-xs text-gray-400">è½¦è´¹/å¤© (xå¤©)</label><input type="number" id="price-trans" value="500" class="w-full mt-1 border rounded p-1.5" onchange="window.updateDashboard(); window.debounceSave()"></div>
                            <div><label class="text-xs text-gray-400">é¤/äºº (xäººxå¤©)</label><input type="number" id="price-food" value="150" class="w-full mt-1 border rounded p-1.5" onchange="window.updateDashboard(); window.debounceSave()"></div>
                            <div><label class="text-xs text-gray-400">é—¨ç¥¨/äºº (xäºº)</label><input type="number" id="price-ticket" value="800" class="w-full mt-1 border rounded p-1.5" onchange="window.updateDashboard(); window.debounceSave()"></div>
                        </div>
                    </div>
                </div>
                <div class="lg:col-span-7">
                    <div class="bg-gradient-to-br from-blue-600 to-indigo-700 p-5 rounded-3xl shadow-xl text-white relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-40 h-40 bg-white/10 rounded-full blur-3xl -mr-10 -mt-10 pointer-events-none"></div>
                        <div class="mb-4">
                            <h2 class="text-lg font-bold mb-4 opacity-90">é¢„ç®—æ¸…å•</h2>
                            <div id="budget-summary-list" class="space-y-2 text-sm text-blue-50 max-h-[300px] overflow-y-auto custom-scrollbar pr-1"></div>
                        </div>
                        <div class="pt-4 border-t border-white/10 flex justify-between items-end">
                            <div>
                                <div class="text-blue-200 text-xs">é¢„ä¼°æ€»è®¡</div>
                                <div class="text-3xl font-bold mt-1">Â¥<span id="disp-total">0</span></div>
                            </div>
                            <div class="text-right text-blue-200 text-xs">äººå‡: Â¥<span id="disp-avg">0</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 4. å…¨æ™¯çœ‹æ¿ -->
        <section id="data" class="tab-content">
             <div class="grid grid-cols-2 gap-3 mb-4">
                <div class="bg-white p-3 rounded-2xl shadow-sm border border-gray-100 text-center"><div class="text-[10px] text-gray-400">æ€»é¢„ç®—</div><div class="text-lg font-bold text-blue-600">Â¥<span id="dash-total">0</span></div></div>
                <div class="bg-white p-3 rounded-2xl shadow-sm border border-gray-100 text-center"><div class="text-[10px] text-gray-400">è¡Œç¨‹</div><div class="text-lg font-bold text-gray-700"><span id="dash-days">0</span> å¤©</div></div>
                <div class="bg-white p-3 rounded-2xl shadow-sm border border-gray-100 text-center"><div class="text-[10px] text-gray-400">å‡†å¤‡</div><div class="text-lg font-bold text-green-600"><span id="dash-pack">0</span>%</div></div>
                <div class="bg-white p-3 rounded-2xl shadow-sm border border-gray-100 text-center"><div class="text-[10px] text-gray-400">æ»‘é›ªç‚¹</div><div class="text-lg font-bold text-purple-600"><span id="dash-ski-spots">0</span></div></div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 pb-20">
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100"><h3 class="text-sm font-bold text-gray-700 mb-2">èµ„é‡‘å æ¯”</h3><div class="h-48"><canvas id="budgetDoughnutChart"></canvas></div></div>
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100"><h3 class="text-sm font-bold text-gray-700 mb-2">ç©æ³•åˆ†å¸ƒ</h3><div class="h-48"><canvas id="spotPolarChart"></canvas></div></div>
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                    <h3 class="text-sm font-bold text-gray-700 mb-2">å¥‡æ™¯é¢„æµ‹ (<span id="temp-val">--20</span>Â°C)</h3>
                    <input type="range" id="temp-slider" min="-40" max="5" value="-20" oninput="window.updateDashboard(); window.debounceSave()" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer mb-4">
                    <div class="grid grid-cols-2 gap-3 text-xs">
                        <div><div class="text-gray-500 mb-1">æ™¨é›¾</div><div class="font-bold text-gray-800" id="prob-fog">85%</div></div>
                        <div><div class="text-gray-500 mb-1">è“å†°</div><div class="font-bold text-gray-800" id="prob-ice">90%</div></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 5. è£…å¤‡æ¸…å• -->
        <section id="pack" class="tab-content">
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 mb-4">
                <div class="flex items-center gap-4 mb-4">
                    <div class="w-16 h-16 relative flex-shrink-0"><canvas id="packChart"></canvas><div class="absolute inset-0 flex items-center justify-center text-xs font-bold text-blue-600" id="pack-percent-text">0%</div></div>
                    <div class="flex-grow">
                        <h2 class="font-bold text-gray-800">å‡†å¤‡è¿›åº¦</h2>
                        <p class="text-xs text-gray-400 mt-1">å·²é€‰ <span id="pack-checked-count">0</span> / <span id="pack-total-count">0</span></p>
                    </div>
                    <button onclick="window.exportGearList()" class="bg-blue-50 text-blue-600 p-2 rounded-lg text-xl hover:bg-blue-100 transition"><i class="ph ph-export"></i></button>
                </div>
                <!-- ä¿®å¤: ç¡®ä¿æ·»åŠ åŠŸèƒ½æ­£å¸¸ -->
                <button onclick="window.addCustomGear()" class="w-full py-2 border border-dashed border-gray-300 rounded-xl text-xs text-gray-500 mb-4 hover:bg-gray-50 transition">+ æ·»åŠ è‡ªå®šä¹‰ç‰©å“</button>
                <div id="gear-container" class="space-y-4 pb-20"></div>
            </div>
        </section>
    </main>

    <!-- Mobile Bottom Navigation -->
    <nav class="md:hidden fixed bottom-0 left-0 w-full bg-white border-t border-gray-200 z-50 flex justify-around items-center pb-safe pt-2 px-1 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
        <button onclick="window.switchTab('explore')" class="mobile-nav-btn flex flex-col items-center p-2 text-gray-400 active" data-tab="explore"><i class="ph ph-mountains text-2xl"></i><span class="text-[10px]">ç™¾ç§‘</span></button>
        <button onclick="window.switchTab('routes')" class="mobile-nav-btn flex flex-col items-center p-2 text-gray-400" data-tab="routes"><i class="ph ph-map-trifold text-2xl"></i><span class="text-[10px]">è¡Œç¨‹</span></button>
        <button onclick="window.switchTab('budget')" class="mobile-nav-btn flex flex-col items-center p-2 text-gray-400" data-tab="budget"><i class="ph ph-calculator text-2xl"></i><span class="text-[10px]">é¢„ç®—</span></button>
        <button onclick="window.openAuthModal()" class="flex flex-col items-center justify-center w-12 h-12 bg-blue-600 rounded-full text-white shadow-lg -mt-6 border-4 border-white" title="è´¦æˆ·">
            <i class="ph ph-user text-2xl"></i>
        </button>
        <button onclick="window.switchTab('data')" class="mobile-nav-btn flex flex-col items-center p-2 text-gray-400" data-tab="data"><i class="ph ph-chart-pie-slice text-2xl"></i><span class="text-[10px]">ç»Ÿè®¡</span></button>
        <button onclick="window.switchTab('pack')" class="mobile-nav-btn flex flex-col items-center p-2 text-gray-400" data-tab="pack"><i class="ph ph-backpack text-2xl"></i><span class="text-[10px]">æ¸…å•</span></button>
    </nav>

    <!-- Modal: è‡ªå®šä¹‰æ™¯ç‚¹ -->
    <div id="attraction-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-sm p-5 shadow-2xl animate-[fadeIn_0.2s_ease-out]">
            <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-gray-800">è‡ªå®šä¹‰åœ°ç‚¹</h3><button onclick="window.closeModal('attraction-modal')" class="text-gray-400"><i class="ph ph-x text-xl"></i></button></div>
            
            <div class="space-y-3">
                <div class="relative group cursor-pointer" onclick="document.getElementById('modal-img-input').click()">
                    <div id="modal-img-preview" class="w-full h-24 bg-gray-100 rounded-lg border-2 border-dashed border-gray-300 flex flex-col items-center justify-center text-gray-400 group-hover:bg-gray-50 group-hover:border-blue-300 transition overflow-hidden">
                        <i class="ph ph-image text-2xl mb-1"></i><span class="text-xs">ç‚¹å‡»æ›´æ”¹å›¾ç‰‡</span>
                    </div>
                    <input type="file" id="modal-img-input" accept="image/*" class="hidden" onchange="window.previewImage(this)">
                </div>
                
                <input type="text" id="modal-name" placeholder="åç§° (å¦‚: éšè—æ‰“å¡ç‚¹)" class="w-full bg-gray-50 border-0 rounded-xl p-3 ring-1 ring-gray-200 outline-none">
                <div class="flex gap-2">
                    <select id="modal-type" class="bg-gray-50 border-0 rounded-xl p-3 ring-1 ring-gray-200 outline-none flex-grow"><option value="custom">âœ¨ ç§è—</option><option value="è‡ªç„¶">ğŸ”ï¸ è‡ªç„¶</option><option value="äººæ–‡">ğŸ•Œ äººæ–‡</option><option value="æ»‘é›ª">ğŸ¿ æ»‘é›ª</option></select>
                    <!-- FIX: ç§»é™¤é€‰ä½ç½®æŒ‰é’®ï¼Œåªæ˜¾ç¤ºåæ ‡ -->
                    <button onclick="window.pickLocationFromModal()" class="bg-gray-50 text-gray-600 px-3 rounded-xl text-sm font-medium border border-gray-200 whitespace-nowrap cursor-default">ğŸ“ é€‰ä½ç½®</button>
                </div>
                <textarea id="modal-desc" placeholder="å¤‡æ³¨..." class="w-full bg-gray-50 border-0 rounded-xl p-3 ring-1 ring-gray-200 h-20 outline-none resize-none"></textarea>
                <div class="text-xs text-gray-400 text-center" id="modal-coords-display">åæ ‡: æœªè®¾ç½®</div>
            </div>
            <button onclick="window.saveCustomSpot()" id="save-spot-btn" class="w-full mt-5 bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-blue-500/30 hover:bg-blue-700 transition">ä¿ å­˜</button>
        </div>
    </div>

    <!-- Modal: ç™»å½•/æ³¨å†Œ -->
    <div id="auth-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl animate-[fadeIn_0.2s_ease-out]">
            <div id="auth-info" class="mb-4 hidden">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-xl font-bold text-gray-800">æ¬¢è¿å›æ¥</h3>
                    <button onclick="window.closeModal('auth-modal')" class="text-gray-400 hover:text-gray-600"><i class="ph ph-x text-xl"></i></button>
                </div>
                <p class="text-sm text-gray-600 truncate">è´¦æˆ·: <span id="user-email-display" class="font-medium"></span></p>
                <button onclick="window.handleSignOut()" class="w-full mt-4 bg-red-500 text-white py-2 rounded-lg hover:bg-red-600 transition">é€€å‡ºç™»å½•</button>
            </div>

            <div id="auth-form">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800" id="auth-title">ç™»å½•è´¦æˆ·</h3>
                    <button onclick="window.closeModal('auth-modal')" class="text-gray-400"><i class="ph ph-x text-xl"></i></button>
                </div>
                <input type="text" id="auth-username" placeholder="è´¦æˆ·å" class="w-full mb-3 bg-gray-50 border-0 rounded-lg p-3 ring-1 ring-gray-200 outline-none">
                <input type="password" id="auth-password" placeholder="å¯†ç  (è‡³å°‘6ä½)" class="w-full mb-3 bg-gray-50 border-0 rounded-lg p-3 ring-1 ring-gray-200 outline-none">
                <input type="password" id="auth-password-confirm" placeholder="ç¡®è®¤å¯†ç " class="w-full mb-3 bg-gray-50 border-0 rounded-lg p-3 ring-1 ring-gray-200 outline-none hidden">
                <p id="auth-error" class="text-red-500 text-xs mb-3"></p>

                <button onclick="window.handleAuthAction()" id="auth-submit-btn" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 transition">ç™»å½•</button>
                <button onclick="window.toggleAuthMode()" id="auth-toggle-btn" class="w-full mt-3 text-sm text-blue-600 hover:underline">åˆ‡æ¢åˆ°æ³¨å†Œ</button>
            </div>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadString, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";Â 
        
        setLogLevel('debug');

        // --- DEPLOYMENT CONFIGURATION ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // 2. Custom Configuration
        const customFirebaseConfig = {
            apiKey: "AIzaSyAlbsoPG7J2cDocEGisruheVdTaX1Wajgc",
            authDomain: "xinjiang-c95f8.firebaseapp.com",
            projectId: "xinjiang-c95f8",
            storageBucket: "xinjiang-c95f8.appspot.com",
        };

        const configToUse = typeof __firebase_config !== 'undefined' && __firebase_config ? JSON.parse(__firebase_config) : customFirebaseConfig;
        const firebaseConfig = configToUse;

        let app, db, auth, storage;Â 
        let authMode = 'login';Â 
        let currentUserId = null;
        let isAuthReady = false;

        // FIX: Make authentication functions globally available
        window.openAuthModal = () => document.getElementById('auth-modal').classList.remove('hidden');
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
        
        window.toggleAuthMode = () => {
            const title = document.getElementById('auth-title');
            const submitBtn = document.getElementById('auth-submit-btn');
            const toggleBtn = document.getElementById('auth-toggle-btn');
            const confirmPass = document.getElementById('auth-password-confirm');
            const errorEl = document.getElementById('auth-error');
            errorEl.textContent = '';
            if (authMode === 'login') {
                authMode = 'register';
                title.textContent = 'æ³¨å†Œæ–°è´¦æˆ·';
                submitBtn.textContent = 'æ³¨å†Œ';
                toggleBtn.textContent = 'å·²æœ‰è´¦æˆ·ï¼Ÿåˆ‡æ¢åˆ°ç™»å½•';
                confirmPass.classList.remove('hidden');
            } else {
                authMode = 'login';
                title.textContent = 'ç™»å½•è´¦æˆ·';
                submitBtn.textContent = 'ç™»å½•';
                toggleBtn.textContent = 'æ²¡æœ‰è´¦æˆ·ï¼Ÿåˆ‡æ¢åˆ°æ³¨å†Œ';
                confirmPass.classList.add('hidden');
            }
        };

        window.handleAuthAction = async () => {
            const username = document.getElementById('auth-username').value;
            const password = document.getElementById('auth-password').value;
            const confirmPassword = document.getElementById('auth-password-confirm').value;
            const errorEl = document.getElementById('auth-error');
            errorEl.textContent = '';
            if (!username || password.length < 6) {
                errorEl.textContent = 'è´¦æˆ·åä¸èƒ½ä¸ºç©ºï¼Œå¯†ç è‡³å°‘6ä½ã€‚';
                return;
            }
            if (authMode === 'register' && password !== confirmPassword) {
                errorEl.textContent = 'ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´ã€‚';
                return;
            }
            const email = `${username}@${firebaseConfig.authDomain.split('.').slice(0, -2).join('.')}.canvas.local`;
            try {
                if (authMode === 'register') {
                    await createUserWithEmailAndPassword(auth, email, password);
                } else {
                    await signInWithEmailAndPassword(auth, email, password);
                }
                document.getElementById('auth-modal').classList.add('hidden');
            } catch (error) {
                let errorMessage = 'è®¤è¯å¤±è´¥ã€‚';
                if (error.code === 'auth/email-already-in-use') errorMessage = 'è¯¥è´¦æˆ·åå·²è¢«æ³¨å†Œã€‚';
                if (error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password') errorMessage = 'è´¦æˆ·åæˆ–å¯†ç é”™è¯¯ã€‚';
                errorEl.textContent = errorMessage;
            }
        };

        window.handleSignOut = async () => {
            try { await signOut(auth); document.getElementById('auth-modal').classList.add('hidden'); window.location.reload(); } catch (error) {}
        };
        
        window.uploadImageAndGetUrl = async (base64Data, userId) => {
            if (!storage || !base64Data || !userId) return null;
            const path = `images/${userId}/${Date.now()}.jpeg`;
            const storageRef = ref(storage, path);
            try {
                await uploadString(storageRef, base64Data, 'data_url');
                return await getDownloadURL(storageRef);
            } catch (error) {
                console.error("Error uploading image:", error);
                return null;
            }
        };
        
        window.saveUserData = async () => {
            if (!currentUserId || !isAuthReady || !db) return;
            try {
                const docRef = doc(db, 'artifacts', appId, 'users', currentUserId, 'data', 'state');
                const dataToSave = {
                    spots: window.state.spots,
                    itinerary: JSON.stringify(window.state.itinerary),Â 
                    customBudget: window.state.customBudget,
                    customGear: window.state.customGear,
                    lastSave: new Date().toISOString()
                };
                await setDoc(docRef, dataToSave, { merge: true });
                console.log("Data successfully queued.");
            } catch (e) {
                console.error("CRITICAL SAVE ERROR:", e);
                showFeedbackMessage("ä¿å­˜å¤±è´¥ï¼è¯·æ£€æŸ¥è§„åˆ™ã€‚", true);
            }
        };

        window.renderApp = () => {
            if (!window.state.initialized || !window.state.dataLoaded) {
                 document.getElementById('loading-state').classList.remove('hidden');
                 return;
            }
            document.getElementById('loading-state').classList.add('hidden');
            window.renderExploreGrid();
            window.renderDayList();
            window.renderAllSpots();
            window.renderBudget();
            window.renderGear();
            window.updateDashboard(); 
        }

        function getUsernameFromEmail(email) {
            if (!email) return 'N/A';
            const parts = email.split('@');
            return parts[0];
        }

        function showFeedbackMessage(message, isError = false) {
            const headerBadgeEl = document.getElementById('sync-status-badge');
            headerBadgeEl.textContent = message;
            if (isError) {
                headerBadgeEl.className = 'text-[10px] text-red-600 bg-red-50 px-1.5 py-0.5 rounded-full border border-red-100 align-middle';
            } else {
                headerBadgeEl.className = 'text-[10px] text-green-600 bg-green-50 px-1.5 py-0.5 rounded-full border border-green-100 align-middle';
            }
            setTimeout(() => { updateAuthStateUI(auth.currentUser); }, 3000);
        }

        function updateAuthStateUI(user) {
            const statusEl = document.getElementById('auth-status');
            const headerBadgeEl = document.getElementById('sync-status-badge');
            const infoDiv = document.getElementById('auth-info');
            const formDiv = document.getElementById('auth-form');
            const logoutHeaderBtn = document.getElementById('logout-button-header');

            if (user) {
                currentUserId = user.uid;
                const username = getUsernameFromEmail(user.email);
                statusEl.textContent = username;
                headerBadgeEl.textContent = 'å·²åŒæ­¥';
                headerBadgeEl.className = 'text-[10px] text-green-600 bg-green-50 px-1.5 py-0.5 rounded-full border border-green-100 align-middle';
                document.getElementById('user-email-display').textContent = username;
                infoDiv.classList.remove('hidden');
                formDiv.classList.add('hidden');
                logoutHeaderBtn.classList.remove('hidden');
                logoutHeaderBtn.classList.add('flex');
            } else {
                currentUserId = null;
                statusEl.textContent = 'ç™»å½•/æ³¨å†Œ';
                headerBadgeEl.textContent = 'éœ€ç™»å½•';
                headerBadgeEl.className = 'text-[10px] text-red-600 bg-red-50 px-1.5 py-0.5 rounded-full border border-red-100 align-middle';
                infoDiv.classList.add('hidden');
                formDiv.classList.remove('hidden');
                logoutHeaderBtn.classList.add('hidden');
                logoutHeaderBtn.classList.remove('flex');
            }
        }

        async function initAuthAndDb() {
            try {
                if (!firebaseConfig.apiKey || !firebaseConfig.projectId) {
                    window.state.initialized = true;Â 
                    window.state.dataLoaded = true;
                    window.renderApp();
                    return;
                }
                
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                storage = getStorage(app);Â 

                await setPersistence(auth, browserLocalPersistence);

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                }

                onAuthStateChanged(auth, (user) => {
                    isAuthReady = true;
                    updateAuthStateUI(user);
                    if (user) {
                        setupDataListener(user.uid); 
                    } else if (!window.state.initialized) {
                        window.state.initialized = true;
                        window.state.dataLoaded = true;
                        window.renderApp(); 
                    }
                });
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                window.state.initialized = true;
                window.state.dataLoaded = true;
                window.renderApp();
            }
        }
        
        function setupDataListener(userId) {
            const docRef = doc(db, 'artifacts', appId, 'users', userId, 'data', 'state');
            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (data.spots && data.spots.length > 0) {
                        window.state.spots = data.spots;
                    } else {
                        window.state.spots = [...window.defaultSpots];
                    }
                    try {
                        const loadedItinerary = JSON.parse(data.itinerary);
                        window.state.itinerary = loadedItinerary.length > 0 ? loadedItinerary : [[]];
                    } catch {
                        window.state.itinerary = [[]]; 
                    }
                    window.state.customBudget = data.customBudget || [];
                    window.state.customGear = data.customGear || [];
                } else {
                    window.saveUserData(); 
                }
                if (!window.state.initialized) window.state.initialized = true;
                window.state.dataLoaded = true;
                window.renderApp(); 
                console.log("Firestore Data Synced.");
            }, (error) => {
                showFeedbackMessage("åŒæ­¥å¤±è´¥ï¼è¯·æ£€æŸ¥ Firebase è§„åˆ™ã€‚", true);
                window.state.dataLoaded = true; 
                window.renderApp();
            });
        }
        
        initAuthAndDb();
    </script>
    <script>
        // --- æ ¸å¿ƒæ•°æ® (Global State) ---
        const defaultSpots = [
            { id: 1, name: "ä¹Œé²æœ¨é½", type: "äººæ–‡", desc: "é¦–åºœ", lng: 87.617733, lat: 43.792818, tags: ["ä¸­è½¬"], img: "https://placehold.co/600x400/38BDF8/ffffff?text=Urumqi" },
            { id: 2, name: "ç¦¾æœ¨æ‘", type: "è‡ªç„¶", desc: "æ™¨é›¾", lng: 87.14083, lat: 48.06451, tags: ["æ‘„å½±"], img: "https://placehold.co/600x400/10B981/ffffff?text=Hemu+Village" },
            { id: 3, name: "å–€çº³æ–¯", type: "è‡ªç„¶", desc: "æ¹–æ€ª", lng: 87.0425, lat: 48.6575, tags: ["å¾’æ­¥"], img: "https://placehold.co/600x400/F97316/ffffff?text=Kanas+Lake" },
            { id: 4, name: "èµ›é‡Œæœ¨æ¹–", type: "è‡ªç„¶", desc: "è“å†°", lng: 81.25888, lat: 44.59306, tags: ["è‡ªé©¾"], img: "https://placehold.co/600x400/6366F1/ffffff?text=Sayram+Lake" },
            { id: 5, name: "å–€ä»€å¤åŸ", type: "äººæ–‡", desc: "å¤åŸ", lng: 76.0664, lat: 39.4678, tags: ["ç¾é£Ÿ"], img: "https://placehold.co/600x400/FACC15/000000?text=Kashgar+Old+City" },
            { id: 6, name: "å¯å¯æ‰˜æµ·", type: "æ»‘é›ª", desc: "æ»‘é›ª", lng: 89.96766, lat: 47.1648, tags: ["æé™"], img: "https://placehold.co/600x400/A855F7/ffffff?text=Koktokay+Ski" },
        ];
        window.defaultSpots = defaultSpots;

        const defaultGear = {
            "æ ¸å¿ƒä¿æš–": ["ç¾½ç»’æœ", "å†²é”‹è¡£", "ä¿æš–å†…è¡£", "ç¾Šæ¯›è¢œ", "é›ªåœ°é´"],
            "æ»‘é›ªè£…å¤‡": ["å¤´ç›”", "é›ªé•œ", "æŠ¤è„¸", "æ‰‹å¥—", "æŠ¤å…·"],
        };

        window.state = {
            spots: [...defaultSpots], itinerary: [[]], currentDayIndex: 0,
            customBudget: [], customGear: [], weatherTemp: -20,
            editingSpotId: null, 
            initialized: false, dataLoaded: false 
        };
        
        let saveTimeout;
        window.debounceSave = function() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                if (window.saveUserData) window.saveUserData();
            }, 1500);
        }

        let budgetChart, polarChart, packChart;
        let currentModalImageBase64 = null;Â 
        
        // --- 1. Explore Logic (Updated) ---
        window.deleteCustomSpot = (id) => {
            const defaultCount = defaultSpots.length;
            const idx = state.spots.findIndex(s => s.id === id);
            if (idx > -1 && id > defaultCount) {
                state.spots.splice(idx, 1);
                state.itinerary.forEach(day => {
                    const i = day.indexOf(id);
                    if (i > -1) day.splice(i, 1);
                });
                renderExploreGrid();
                debounceSave();
            }
        }
        
        // Renamed deleteSpot to maintain consistency if called from buttons
        window.deleteSpot = window.deleteCustomSpot;

        window.renderExploreGrid = () => {
            const g=document.getElementById('explore-grid'), t=document.getElementById('explore-search').value.toLowerCase(), f=document.getElementById('explore-filter').value; 
            g.innerHTML='';
            const defaultCount = defaultSpots.length;
            state.spots.forEach(s=>{
                if((s.name.toLowerCase().includes(t)||s.tags.join('').includes(t))&&(f==='all'||(f==='custom'?s.id>defaultCount:s.type===f))){
                    const div=document.createElement('div'); 
                    div.className="bg-white rounded-xl shadow-sm p-3 border border-gray-100 flex flex-col justify-between";
                    
                    let imageHtml = s.img && s.img.startsWith('http') ?Â 
                        `<img src="${s.img}" onerror="this.onerror=null;this.src='https://placehold.co/100x100/A0AEC0/ffffff?text=Image+Load+Fail';" class="w-full h-24 object-cover rounded-lg mb-2">` :Â 
                        `<div class="w-full h-24 bg-gray-100 flex items-center justify-center text-gray-400 rounded-lg mb-2"><i class="ph ph-map-pin"></i></div>`;

                    const isCustom = s.id > defaultCount && window.currentUserId;
                    const btns = isCustom ? `
                        <button onclick="window.editSpot(${s.id})" class="text-blue-500 hover:text-blue-700 transition p-1" title="ç¼–è¾‘"><i class="ph ph-pencil-simple"></i></button>
                        <button onclick="window.deleteCustomSpot(${s.id})" class="text-red-500 hover:text-red-700 transition p-1" title="åˆ é™¤"><i class="ph ph-trash"></i></button>
                    ` : '';

                    div.innerHTML=`
                        ${imageHtml}
                        <div class="flex flex-col justify-between flex-grow">
                            <div class="flex justify-between items-start">
                                <h3 class="font-bold text-gray-800">${s.name}</h3>
                                <div class="flex items-center gap-1">
                                    <span class="text-[10px] bg-gray-100 px-1.5 py-0.5 rounded text-gray-500">${s.type}</span>
                                    ${btns}
                                </div>
                            </div>
                            <p class="text-xs text-gray-400 mt-1">${s.desc||''}</p>
                            <button onclick="window.addToRoute(${s.id})" class="mt-3 w-full bg-blue-50 text-blue-600 text-xs py-2 rounded font-medium hover:bg-blue-100 transition">åŠ å…¥è¡Œç¨‹</button>
                        </div>`;
                    g.appendChild(div);
                }
            });
        }

        window.editSpot = (id) => {
            const spot = state.spots.find(s => s.id === id);
            if (!spot) return;
            window.state.editingSpotId = id;
            document.getElementById('modal-name').value = spot.name;
            document.getElementById('modal-type').value = spot.type;
            document.getElementById('modal-desc').value = spot.desc || '';
            
            const previewEl = document.getElementById('modal-img-preview');
            if (spot.img) {
                previewEl.innerHTML = `<img src="${spot.img}" class="w-full h-full object-cover rounded-lg">`;
                currentModalImageBase64 = spot.img; 
            } else {
                 previewEl.innerHTML = `<i class="ph ph-image text-2xl mb-1"></i><span class="text-xs">ç‚¹å‡»æ·»åŠ å›¾ç‰‡</span>`;
                 currentModalImageBase64 = null;
            }
            document.getElementById('save-spot-btn').innerText = 'ä¿å­˜ä¿®æ”¹';
            document.getElementById('attraction-modal').classList.remove('hidden');
        }
        
        // --- 2. Itinerary Logic ---
        window.addToRoute = (id) => { 
            if (!state.itinerary[state.currentDayIndex]) state.itinerary.push([]);
            state.itinerary[state.currentDayIndex].push(id); 
            renderDayList(); debounceSave(); 
        }
        
        window.renderDayList = () => {
            const l=document.getElementById('day-list'); l.innerHTML=''; 
            if (state.itinerary.length === 0) { state.itinerary.push([]); state.currentDayIndex = 0; }
            document.getElementById('budget-days').value=state.itinerary.length; 
            
            state.itinerary.forEach((s,i)=>{
                const div=document.createElement('div'); 
                div.className=`flex-shrink-0 lg:flex-shrink w-20 lg:w-full p-2 lg:p-3 rounded-xl border border-gray-100 cursor-pointer text-center lg:text-left transition-all ${i===state.currentDayIndex?'bg-blue-50 border-blue-200 text-blue-700':'hover:bg-gray-50 text-gray-500'}`;
                div.innerHTML=`<div class="flex justify-between items-center w-full"><div class="font-bold text-xs">D${i+1}</div>${state.itinerary.length > 1 || state.itinerary[i].length > 0 ? `<button onclick="event.stopPropagation(); window.removeDay(${i})" class="text-red-400 hover:text-red-600 transition p-1 -m-1"><i class="ph ph-trash text-xs"></i></button>` : ''}</div><div class="text-[10px] opacity-70">${state.itinerary[i].length}ç‚¹</div>`;
                div.onclick=()=>{state.currentDayIndex=i;renderDayList();}; l.appendChild(div);
            });
            document.getElementById('current-day-num').innerText=state.currentDayIndex+1;
            document.getElementById('day-spot-count').innerText=state.itinerary[state.currentDayIndex].length;
            renderDaySpots(); window.renderItineraryView(); 
        }
        
        window.addDay = () => { state.itinerary.push([]); state.currentDayIndex=state.itinerary.length-1; renderDayList(); debounceSave(); }

        window.removeDay = (index) => {
            if (state.itinerary.length > 1) { state.itinerary.splice(index, 1); if (state.currentDayIndex >= index) state.currentDayIndex = Math.max(0, state.currentDayIndex - 1); } 
            else if (state.itinerary.length === 1) { state.itinerary[0] = []; }
            window.renderDayList(); debounceSave();
        }
        
        window.renderDaySpots = () => {
            const dL=document.getElementById('day-spots-list-desktop'), mL=document.getElementById('day-spots-list-mobile');
            const html = state.itinerary[state.currentDayIndex].map((id,i)=>{
                const s=state.spots.find(sp=>sp.id===id); if(!s)return'';
                return `<div class="flex justify-between items-center p-2 bg-gray-50 rounded"><span class="truncate">${i+1}. ${s.name}</span><button onclick="window.rmSpot(${i})" class="text-red-400 px-2">Ã—</button></div>`;
            }).join('');
            dL.innerHTML=html; mL.innerHTML=html;
        }
        
        window.rmSpot = (i) => { state.itinerary[state.currentDayIndex].splice(i,1); renderDayList(); debounceSave(); }
        
        window.renderAllSpots = () => {
            const l=document.getElementById('all-spots-list'), t=document.getElementById('spot-search').value.toLowerCase(); l.innerHTML='';
            state.spots.filter(s=>s.name.toLowerCase().includes(t)).forEach(s=>{
                const b=document.createElement('button'); 
                b.className="w-full text-left p-2 hover:bg-gray-50 text-xs text-gray-600 flex justify-between rounded transition";
                b.innerHTML=`<span>${s.name}</span><span class="text-blue-500 font-bold">+</span>`; b.onclick=()=>{window.addToRoute(s.id)}; l.appendChild(b);
            });
        }
        
        // --- XMind Export Logic ---
        window.exportToXMind = () => {
            if (!window.state || !window.state.itinerary) { alert("æš‚æ— æ•°æ®å¯å¯¼å‡º"); return; }
            
            let md = `# æ—…è¡Œè§„åˆ’\n\n`;
            window.state.itinerary.forEach((daySpots, index) => {
                md += `## ç¬¬ ${index + 1} å¤©\n`;
                if (daySpots.length === 0) {
                    md += `- (æ— è¡Œç¨‹)\n`;
                } else {
                    daySpots.forEach(spotId => {
                        const spot = window.state.spots.find(s => s.id === spotId);
                        if (spot) {
                            md += `### ${spot.name}\n`;
                            if (spot.img) md += `![](${spot.img})\n`;
                            if (spot.desc) md += `- å¤‡æ³¨: ${spot.desc}\n`;
                            md += `- ç±»å‹: ${spot.type}\n`;
                        }
                    });
                }
                md += `\n`;
            });

            const blob = new Blob([md], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'travel_plan.md';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        window.renderItineraryView = () => {
            const container = document.getElementById('itinerary-mind-map');
            const daySpots = window.state.itinerary[window.state.currentDayIndex] || [];
            if (daySpots.length === 0) { container.innerHTML = '<div class="text-center text-gray-500 py-12 border-2 border-dashed border-gray-200 rounded-xl">æœ¬å¤©æš‚æ— è¡Œç¨‹ã€‚</div>'; return; }

            const html = daySpots.map((id, index) => {
                const spot = window.state.spots.find(s => s.id === id); if (!spot) return '';
                const imageHtml = spot.img && spot.img.startsWith('http') ?
                    `<img src="${spot.img}" onerror="this.onerror=null;this.src='https://placehold.co/600x320/38BDF8/ffffff?text=${spot.name.substring(0, 8)}';" class="w-full h-32 object-cover rounded-xl shadow-md mb-3">` :
                    `<div class="w-full h-32 bg-gray-100 flex items-center justify-center text-gray-400 rounded-xl shadow-md mb-3"><i class="ph ph-image text-2xl"></i><span class="ml-2">${spot.name}</span></div>`;
                const sequenceLine = index > 0 ? `<div class="w-1 h-8 bg-blue-300 mx-auto"></div>` : '';
                return `${sequenceLine}<div class="flex items-start gap-4"><div class="flex flex-col items-center flex-shrink-0"><span class="w-8 h-8 flex items-center justify-center rounded-full bg-blue-600 text-white text-sm font-bold shadow-lg">${index + 1}</span>${index < daySpots.length - 1 ? '<div class="w-1 h-12 bg-blue-300"></div>' : ''}</div><div class="flex-grow bg-white p-4 rounded-xl shadow-lg border border-gray-100">${imageHtml}<h4 class="font-bold text-gray-800">${spot.name}</h4><p class="text-xs text-gray-500 mt-1">${spot.desc || 'æ— å¤‡æ³¨'}</p></div></div>`;
            }).join('');
            container.innerHTML = html;
        };

        // --- Spot Modal ---
        window.openAttractionModal = (reset = true) => {
            document.getElementById('attraction-modal').classList.remove('hidden');Â 
            if(reset){
                document.getElementById('modal-name').value=''; 
                document.getElementById('modal-name').classList.remove('ring-red-500', 'ring-2');
                document.getElementById('modal-desc').value='';
                currentModalImageBase64 = null;
                document.getElementById('modal-img-input').value = '';
                document.getElementById('modal-img-preview').innerHTML = `<i class="ph ph-image text-2xl mb-1"></i><span class="text-xs">ç‚¹å‡»æ·»åŠ /æ›´æ”¹å›¾ç‰‡</span>`;
                window.state.editingSpotId = null; 
                document.getElementById('save-spot-btn').innerText = 'ä¿ å­˜';
            }
        }
        
        window.pickLocationFromModal = () => {
             // Location picking disabled/removed feature placeholder
             alert("ä½ç½®åŠŸèƒ½å·²ç®€åŒ–ä¸ºåˆ—è¡¨ç®¡ç†ã€‚");
        }
        
        window.saveCustomSpot = async function(){
            const nameInput = document.getElementById('modal-name');
            const n=nameInput.value;
            const saveBtn = document.getElementById('save-spot-btn');
            const editingId = window.state.editingSpotId;

            if(!n || n.trim() === '') {
                nameInput.classList.add('ring-red-500', 'ring-2'); 
                return;
            }

            let imageUrl = currentModalImageBase64; 

            if (currentModalImageBase64 && !currentModalImageBase64.startsWith('http')) {
                if (!window.currentUserId) {
                    saveBtn.innerText = 'éœ€ç™»å½•ä¸Šä¼ å›¾ç‰‡ï¼'; 
                    setTimeout(() => { saveBtn.innerText = editingId ? 'ä¿å­˜ä¿®æ”¹' : 'ä¿ å­˜'; }, 2000);
                    return; 
                }
                saveBtn.innerHTML = 'ä¸Šä¼ ä¸­...';
                saveBtn.disabled = true;
                imageUrl = await window.uploadImageAndGetUrl(currentModalImageBase64, window.currentUserId);
                saveBtn.innerHTML = 'ä¿ å­˜';
                saveBtn.disabled = false;
                if (!imageUrl) return;
            }
            
            const newSpotData = {
                id: editingId || Date.now(), name:n, type:document.getElementById('modal-type').value, desc:document.getElementById('modal-desc').value, tags:[], img: imageUrl,
                lng: 87.617733, lat: 43.792818
            };

            if (editingId) {
                const index = state.spots.findIndex(s => s.id === editingId);
                if (index > -1) state.spots[index] = newSpotData;
            } else {
                state.spots.push(newSpotData);
            }

            window.state.editingSpotId = null;
            currentModalImageBase64 = null;
            closeModal('attraction-modal');
            renderExploreGrid();
            debounceSave();
        }
        
        // --- Budget & Gear ---
        window.addCustomBudgetItem = () => {
            const name = document.getElementById('custom-item-name').value.trim();
            const people = parseInt(document.getElementById('custom-item-people').value) || 1;
            const days = parseInt(document.getElementById('custom-item-days').value) || 1;
            const payer = document.getElementById('custom-item-payer').value.trim();
            const price = parseFloat(document.getElementById('custom-item-price').value);

            if (name && price && price > 0) {
                state.customBudget.push({ name, people, days, payer: payer || 'æœªæŒ‡å®š', price });
                document.getElementById('custom-item-name').value = '';
                document.getElementById('custom-item-people').value = '';
                document.getElementById('custom-item-days').value = '';
                document.getElementById('custom-item-payer').value = '';
                document.getElementById('custom-item-price').value = '';
                updateDashboard(); debounceSave();
            }
        }
        
        window.renderBudget = () => {
            const p=parseInt(document.getElementById('budget-people').value)||1, d=parseInt(document.getElementById('budget-days').value)||1;
            const stay=parseFloat(document.getElementById('price-stay').value)||0, trans=parseFloat(document.getElementById('price-trans').value)||0;
            const food=parseFloat(document.getElementById('price-food').value)||0, ticket=parseFloat(document.getElementById('price-ticket').value)||0;
                  
            const tStay = stay * Math.ceil(p / 2) * Math.max(0, d - 1); 
            const tTrans = trans * d; 
            const tFood = food * p * d; 
            const tTicket = ticket * p;
            const totalBase = tStay + tTrans + tFood + tTicket;
            
            let listHtml=`<div class="flex justify-between items-center p-2 bg-white/10 rounded-lg border border-white/10"><span>ğŸ¨ ä½å®¿ (${stay} x ${Math.max(0, d - 1)} æ™š)</span><span class="font-mono font-bold">Â¥${tStay.toLocaleString()}</span></div>`;
            listHtml+=`<div class="flex justify-between items-center p-2 bg-white/10 rounded-lg border border-white/10"><span>ğŸš— äº¤é€š (${trans} x ${d} å¤©)</span><span class="font-mono font-bold">Â¥${tTrans.toLocaleString()}</span></div>`;
            listHtml+=`<div class="flex justify-between items-center p-2 bg-white/10 rounded-lg border border-white/10"><span>ğŸ¥˜ é¤è´¹ (${food} x ${p}äºº x ${d}å¤©)</span><span class="font-mono font-bold">Â¥${tFood.toLocaleString()}</span></div>`; 
            listHtml+=`<div class="flex justify-between items-center p-2 bg-white/10 rounded-lg border border-white/10"><span>ğŸ« é—¨ç¥¨ (${ticket} x ${p}äºº)</span><span class="font-mono font-bold">Â¥${tTicket.toLocaleString()}</span></div>`;
            
            let tCustom = 0;
            state.customBudget.forEach((i, x) => { 
                const itemTotal = i.price * i.people * i.days;
                tCustom += itemTotal; 
                listHtml+=`<div class="flex justify-between items-center p-2 bg-orange-500/20 rounded-lg border border-orange-500/30 text-orange-100 budget-item-enter relative group"><span class="truncate">âœ¨ ${i.name} (${i.payer}, Â¥${i.price} x ${i.people} x ${i.days})</span><div class="flex items-center gap-2"><span class="font-mono font-bold">Â¥${itemTotal.toLocaleString()}</span><button onclick="window.removeBudgetItem(${x})" class="text-white/70 hover:text-white transition"><i class="ph ph-trash"></i></button></div></div>`; 
            });

            document.getElementById('budget-summary-list').innerHTML=listHtml;
            const total=totalBase + tCustom;
            document.getElementById('disp-total').innerText=total.toLocaleString();
            document.getElementById('disp-avg').innerText=Math.round(total / p).toLocaleString();
        }
        
        window.removeBudgetItem = (i) => { state.customBudget.splice(i,1); updateDashboard(); debounceSave(); }
        
        window.removeCustomGear = (i) => {
            state.customGear.splice(i, 1);
            window.renderGear(); // Re-render to update the list immediately
            window.debounceSave();
        }

        window.renderGear = () => {
            const c=document.getElementById('gear-container'); 
            if(!c) return;
            c.innerHTML='';
            
            // Render Default Gear
            for(const [k,v] of Object.entries(defaultGear)){
                 let html = `<div><h4 class="font-bold text-gray-700 text-sm mb-2 border-l-4 border-blue-500 pl-2">${k}</h4><div class="space-y-2">`;
                 v.forEach(item => {
                     const isChecked = localStorage.getItem(`gear_${item}`) === 'true';
                     html += `<label class="flex items-center space-x-2 text-xs text-gray-500 hover:bg-gray-50 p-1 rounded transition cursor-pointer">
                        <input type="checkbox" class="rounded text-blue-600 w-4 h-4 gear-check" data-item="${item}" ${isChecked ? 'checked' : ''} onchange="window.updateGearStats(this)">
                        <span>${item}</span>
                     </label>`;
                 });
                 html += `</div></div>`;
                 c.innerHTML += html;
            }

            // Render Custom Gear
            if(window.state.customGear && window.state.customGear.length > 0) {
                 let html = `<div><h4 class="font-bold text-gray-700 text-sm mb-2 border-l-4 border-green-500 pl-2">è‡ªå®šä¹‰ç‰©å“</h4><div class="space-y-2">`;
                 window.state.customGear.forEach((item, index) => {
                     const isChecked = localStorage.getItem(`gear_${item}`) === 'true';
                     html += `<div class="flex items-center justify-between hover:bg-gray-50 p-1 rounded transition">
                        <label class="flex items-center space-x-2 text-xs text-gray-500 cursor-pointer flex-grow">
                            <input type="checkbox" class="rounded text-blue-600 w-4 h-4 gear-check" data-item="${item}" ${isChecked ? 'checked' : ''} onchange="window.updateGearStats(this)">
                            <span>${item}</span>
                        </label>
                        <button onclick="window.removeCustomGear(${index})" class="text-red-400 hover:text-red-600 ml-2" title="åˆ é™¤"><i class="ph ph-trash"></i></button>
                     </div>`;
                 });
                 html += `</div></div>`;
                 c.innerHTML += html;
            }
            window.updateGearStats();
        }
        
        window.updateGearStats = (checkbox = null) => {
            if (checkbox) {
                try {
                    localStorage.setItem(`gear_${checkbox.dataset.item}`, checkbox.checked);
                } catch(e) { console.warn('LocalStorage failed', e); }
            }
            const checks = document.querySelectorAll('.gear-check');
            const c = Array.from(checks).filter(ch => ch.checked).length;
            document.getElementById('pack-checked-count').innerText=c; 
            document.getElementById('pack-total-count').innerText=checks.length;
            const percent = (checks.length ? Math.round(c/checks.length*100) : 0);
            document.getElementById('pack-percent-text').innerText=percent + '%';
            if(packChart){packChart.data.datasets[0].data=[c,checks.length-c]; packChart.update();}
            document.getElementById('dash-pack').innerText = percent;
        }
        
        window.addCustomGear = () => {
            const n = window.prompt("è¯·è¾“å…¥æ–°çš„è£…å¤‡åç§°:"); 
            if (n && n.trim()) { 
                if (!window.state.customGear) window.state.customGear = [];
                window.state.customGear.push(n.trim()); 
                window.renderGear(); 
                window.debounceSave(); 
            }
        }
        
        window.exportGearList = () => { alert("æ¸…å•å¯¼å‡ºåŠŸèƒ½ (æš‚æœªå®ç°)"); } 

        window.updateCharts = () => {
            const dispTotalEl = document.getElementById('disp-total');
            if (dispTotalEl.innerText === '0') return;
            
            const p=parseInt(document.getElementById('budget-people').value)||1, d=parseInt(document.getElementById('budget-days').value)||1;
            const stay=parseFloat(document.getElementById('price-stay').value)||0, trans=parseFloat(document.getElementById('price-trans').value)||0;
            const food=parseFloat(document.getElementById('price-food').value)||0, ticket=parseFloat(document.getElementById('price-ticket').value)||0;
            
            const s= stay * Math.ceil(p / 2) * Math.max(0, d - 1); 
            const tr= trans * d;
            const fd= food * p * d; 
            const tk= ticket * p;
            
            let c = 0;
            window.state.customBudget.forEach(i => { c += i.price * i.people * i.days; });
            
            if (budgetChart) {
                 budgetChart.data.datasets[0].data=[s, tr, fd+tk, c]; 
                 budgetChart.update();
            }
            
            const ids = state.itinerary.flat(), sp = ids.map(id => state.spots.find(s=>s.id===id)).filter(s=>s);
            if (polarChart) {
                polarChart.data.datasets[0].data=[sp.filter(s=>s.type==='è‡ªç„¶').length,sp.filter(s=>s.type==='äººæ–‡').length,sp.filter(s=>s.type==='æ»‘é›ª').length,sp.filter(s=>s.type==='custom').length]; 
                polarChart.update();
            }
        }

        window.updateDashboard = () => {
            window.renderBudget(); 
            document.getElementById('dash-total').innerText=document.getElementById('disp-total').innerText;
            document.getElementById('dash-days').innerText=state.itinerary.length;
            window.updateGearStats(); 
            document.getElementById('dash-ski-spots').innerText=state.itinerary.flat().map(id=>state.spots.find(s=>s.id===id)).filter(s=>s&&s.type==='æ»‘é›ª').length;
            window.updateCharts();
        }
        
        window.initCharts = () => {
            if (!budgetChart) budgetChart=new Chart(document.getElementById('budgetDoughnutChart'),{type:'doughnut',data:{labels:['ä½å®¿','äº¤é€š','é£Ÿ/ç¥¨','è‡ªå®šä¹‰'],datasets:[{data:[1,1,1,1],backgroundColor:['#3B82F6','#10B981','#8B5CF6','#F97316'],borderWidth:0}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right',labels:{boxWidth:10}}}}});
            if (!polarChart) polarChart=new Chart(document.getElementById('spotPolarChart'),{type:'polarArea',data:{labels:['è‡ªç„¶','äººæ–‡','æ»‘é›ª','è‡ªå®š'],datasets:[{data:[1,1,1,0],backgroundColor:['#38BDF8aa','#A78BFAaa','#F97316aa','#FBBF24aa'],borderWidth:0}]},options:{responsive:true,maintainAspectRatio:false,scales:{r:{ticks:{display:false}}},plugins:{legend:{position:'right',labels:{boxWidth:10}}}}});
            if (!packChart) packChart=new Chart(document.getElementById('packChart'),{type:'doughnut',data:{datasets:[{data:[0,1],backgroundColor:['#2563EB','#E5E7EB'],borderWidth:0,cutout:'85%'}]},options:{responsive:true,maintainAspectRatio:false,plugins:{tooltip:{enabled:false}}}});
        }
        
        window.switchTab = (id) => {
            document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.mobile-nav-btn').forEach(b=>b.classList.toggle('active', b.dataset.tab===id));
            document.querySelectorAll('.nav-btn').forEach(b=>b.classList.toggle('bg-white', b.dataset.tab===id));
            
            // 4B. æ›´æ–°æ ‡ç­¾é¡µåˆ‡æ¢å‡½æ•°
            if(id==='routes') {
                // FIX: Now calls the general itinerary render view
                window.renderDayList(); 
            }
            if(id==='data') window.updateDashboard();
            if(id==='pack') window.renderGear(); // Force render pack list on tab switch
            
            window.scrollTo(0,0);
        }

        // --- Initial Callbacks ---
        window.onload = () => {
            window.initCharts();
            // Initial rendering is now handled by the Firebase onAuthStateChanged and onSnapshot listeners
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ—…è¡Œè§„åˆ’å¸ˆ Pro | H5åŒæ­¥ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap');
        
        body { font-family: 'Noto Sans SC', sans-serif; background-color: #F8FAFC; color: #334155; padding-bottom: 90px; -webkit-tap-highlight-color: transparent; }
        
        /* äº¤äº’åŠ¨æ•ˆ */
        .tab-content { display: none; animation: fadeIn 0.3s ease-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
        .mobile-nav-btn.active { color: #2563EB; font-weight: 600; }
        .custom-scrollbar::-webkit-scrollbar { width: 0px; background: transparent; } 
        
        .card-shadow { box-shadow: 0 4px 20px -2px rgba(0, 0, 0, 0.05); }
        .ring-red-500 { transition: all 0.2s ease-in-out; }
    </style>
</head>
<body class="flex flex-col min-h-screen bg-gray-50">

    <!-- é¡¶éƒ¨æ ‡é¢˜æ  -->
    <header class="bg-white/80 backdrop-blur-md sticky top-0 z-40 border-b border-gray-100">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <div class="bg-blue-600 text-white p-1.5 rounded-lg shadow-blue-200 shadow-md">
                    <i class="ph ph-airplane-tilt text-lg"></i>
                </div>
                <div>
                    <h1 class="font-bold text-gray-800 text-base leading-tight">æ—…è¡Œè§„åˆ’ H5</h1>
                    <span id="sync-status-badge" class="text-[10px] text-gray-400 font-normal">ç¦»çº¿</span>
                </div>
            </div>
            
            <div class="flex items-center gap-3">
                <button id="logout-button-header" onclick="handleSignOut()" class="hidden text-gray-400 hover:text-red-500">
                    <i class="ph ph-sign-out text-xl"></i>
                </button>
                <button id="auth-button" onclick="openAuthModal()" class="bg-gray-100 px-3 py-1.5 rounded-full text-xs font-medium text-gray-600 flex items-center gap-1">
                    <i class="ph ph-user-circle text-sm"></i>
                    <span id="auth-status">ç™»å½•</span>
                </button>
            </div>
        </div>
    </header>

    <main class="flex-grow container mx-auto px-4 py-4 max-w-2xl">
        <div id="loading-state" class="fixed inset-0 bg-white/90 z-50 flex flex-col items-center justify-center hidden">
            <div class="ph ph-spinner-gap animate-spin text-4xl text-blue-600 mb-3"></div>
            <p class="text-gray-500 text-sm">æ­£åœ¨äº‘ç«¯åŒæ­¥...</p>
        </div>

        <!-- 1. æ™¯ç‚¹ç™¾ç§‘ -->
        <section id="explore" class="tab-content active">
            <div class="bg-white p-4 rounded-2xl card-shadow mb-4 sticky top-16 z-30 border border-gray-100">
                <div class="relative w-full mb-3">
                    <i class="ph ph-magnifying-glass absolute left-3 top-3 text-gray-400"></i>
                    <!-- FIX: æ·»åŠ  autocomplete="off" -->
                    <input type="text" id="explore-search" placeholder="æœç´¢å¿ƒä»ªæ™¯ç‚¹..." autocomplete="off" oninput="renderExploreGrid()" class="w-full bg-gray-50 border-0 rounded-xl pl-10 pr-4 py-2.5 text-sm outline-none focus:ring-2 focus:ring-blue-100 transition-all">
                </div>
                <div class="flex overflow-x-auto gap-2 pb-1 custom-scrollbar">
                    <select id="explore-filter" onchange="renderExploreGrid()" class="bg-gray-50 border-0 rounded-lg px-3 py-1.5 text-xs outline-none text-gray-600 font-medium">
                        <option value="all">å…¨éƒ¨ç±»å‹</option><option value="è‡ªç„¶">ğŸ”ï¸ è‡ªç„¶é£å…‰</option><option value="äººæ–‡">ğŸ•Œ äººæ–‡å¤è¿¹</option><option value="æ»‘é›ª">ğŸ¿ æé™è¿åŠ¨</option><option value="custom">âœ¨ æˆ‘çš„ç§è—</option>
                    </select>
                    <button onclick="openAttractionModal()" class="bg-blue-600 text-white px-3 py-1.5 rounded-lg text-xs font-medium flex items-center gap-1 whitespace-nowrap shadow-blue-200 shadow-md active:scale-95 transition-transform ml-auto">
                        <i class="ph ph-plus-bold"></i> æ–°å»º
                    </button>
                </div>
            </div>
            <div id="explore-grid" class="grid grid-cols-1 sm:grid-cols-2 gap-4 pb-20"></div>
        </section>

        <!-- 2. è¡Œç¨‹è„‘å›¾ -->
        <section id="routes" class="tab-content">
            <div class="bg-white rounded-2xl card-shadow border border-gray-100 p-4 mb-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-gray-800 flex items-center gap-2"><i class="ph ph-calendar-check text-blue-600"></i> è¡Œç¨‹è§„åˆ’</h3>
                    <div class="flex gap-2">
                        <span class="text-xs bg-blue-50 text-blue-600 px-2 py-1 rounded-lg">å…± <span id="total-days-display">0</span> å¤©</span>
                        <button onclick="addDay()" class="text-xs bg-gray-900 text-white px-3 py-1 rounded-lg active:scale-95 transition">+ åŠ ä¸€å¤©</button>
                    </div>
                </div>
                <!-- æ¨ªå‘å¤©æ•°æ»šåŠ¨æ¡ -->
                <div id="day-list" class="flex gap-3 overflow-x-auto pb-4 custom-scrollbar snap-x"></div>
            </div>

            <!-- è„‘å›¾å†…å®¹åŒº -->
            <div class="bg-white rounded-2xl card-shadow border border-gray-100 p-5 min-h-[400px]">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="font-bold text-gray-800 text-lg">
                        Day <span id="current-day-num" class="text-2xl text-blue-600 font-black ml-1">1</span>
                    </h3>
                    <span class="text-xs text-gray-400">è„‘å›¾é¢„è§ˆæ¨¡å¼</span>
                </div>
                <div id="itinerary-mind-map" class="space-y-0">
                    <div class="text-center text-gray-400 py-12 flex flex-col items-center">
                        <i class="ph ph-map-trifold text-4xl mb-2 opacity-20"></i>
                        <span>æœ¬æ—¥æš‚æ— å®‰æ’</span>
                        <button onclick="switchTab('explore')" class="mt-4 text-blue-600 text-sm font-medium">å»æ·»åŠ æ™¯ç‚¹</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- 3. æ™ºèƒ½é¢„ç®— -->
        <section id="budget" class="tab-content">
            <div class="space-y-4">
                <!-- æ€»è§ˆå¡ç‰‡ -->
                <div class="bg-gradient-to-br from-blue-600 to-indigo-600 p-6 rounded-3xl shadow-xl shadow-blue-200 text-white relative overflow-hidden">
                    <div class="absolute -right-6 -top-6 w-32 h-32 bg-white/10 rounded-full blur-2xl"></div>
                    <p class="text-blue-100 text-xs mb-1">é¢„è®¡æ€»æ”¯å‡º</p>
                    <h2 class="text-4xl font-bold mb-4">Â¥<span id="disp-total">0</span></h2>
                    <div class="flex justify-between items-center pt-4 border-t border-white/10">
                        <div class="text-xs text-blue-100">äººå‡: Â¥<span id="disp-avg">0</span></div>
                        <div class="text-xs bg-white/20 px-2 py-1 rounded-lg"><i class="ph ph-users"></i> <span id="people-count-display">0</span>äºº</div>
                    </div>
                </div>

                <!-- æ·»åŠ æ”¯å‡º -->
                <div class="bg-white p-4 rounded-2xl card-shadow border border-gray-100">
                    <div class="flex items-center gap-2 mb-3 text-gray-800 font-bold text-sm"><i class="ph ph-receipt text-blue-600"></i> è®°ä¸€ç¬” (è‡ªå®šä¹‰)</div>
                    <div class="grid grid-cols-6 gap-2 mb-2">
                        <input type="text" id="custom-item-name" placeholder="é¡¹ç›®" class="col-span-3 bg-gray-50 border-0 rounded-lg px-3 py-2 text-xs outline-none">
                        <input type="number" id="custom-item-people" placeholder="äººæ•°" class="col-span-1 bg-gray-50 border-0 rounded-lg px-1 py-2 text-xs text-center outline-none">
                        <input type="number" id="custom-item-days" placeholder="å¤©æ•°" class="col-span-2 bg-gray-50 border-0 rounded-lg px-1 py-2 text-xs text-center outline-none">
                    </div>
                    <div class="flex gap-2">
                        <input type="text" id="custom-item-payer" placeholder="è°ä»˜æ¬¾?" class="w-1/3 bg-gray-50 border-0 rounded-lg px-3 py-2 text-xs outline-none">
                        <input type="number" id="custom-item-price" placeholder="å•ä»·é‡‘é¢" class="flex-grow bg-gray-50 border-0 rounded-lg px-3 py-2 text-xs outline-none font-bold text-gray-700">
                        <button onclick="addCustomBudgetItem()" class="bg-gray-900 text-white px-4 rounded-lg active:scale-95 transition"><i class="ph ph-check-bold"></i></button>
                    </div>
                </div>

                <!-- åŸºç¡€è®¾å®š -->
                <div class="bg-white p-4 rounded-2xl card-shadow border border-gray-100">
                    <h3 class="font-bold text-gray-800 mb-4 text-sm flex items-center gap-2" onclick="document.getElementById('base-budget-grid').classList.toggle('hidden')">
                        <i class="ph ph-sliders text-blue-600"></i> åŸºç¡€å‚æ•°è®¾å®š <i class="ph ph-caret-down text-xs text-gray-400 ml-auto"></i>
                    </h3>
                    <div id="base-budget-grid" class="grid grid-cols-2 gap-3 text-sm">
                        <div><label class="text-[10px] text-gray-400 pl-1">å‡ºè¡Œäººæ•°</label><input type="number" id="budget-people" value="2" class="w-full mt-0.5 bg-gray-50 border-0 rounded-lg p-2 text-sm" onchange="updateDashboard(); debounceSave()"></div>
                        <div><label class="text-[10px] text-gray-400 pl-1">è¡Œç¨‹å¤©æ•°(è‡ªåŠ¨)</label><input type="number" id="budget-days" value="1" disabled class="w-full mt-0.5 bg-gray-100 border-0 rounded-lg p-2 text-sm text-gray-400"></div>
                        <div><label class="text-[10px] text-gray-400 pl-1">ä½å®¿/é—´ (xå¤©)</label><input type="number" id="price-stay" value="400" class="w-full mt-0.5 bg-gray-50 border-0 rounded-lg p-2 text-sm" onchange="updateDashboard(); debounceSave()"></div>
                        <div><label class="text-[10px] text-gray-400 pl-1">è½¦è´¹/å¤© (xå¤©)</label><input type="number" id="price-trans" value="500" class="w-full mt-0.5 bg-gray-50 border-0 rounded-lg p-2 text-sm" onchange="updateDashboard(); debounceSave()"></div>
                        <div><label class="text-[10px] text-gray-400 pl-1">é¤/äºº (xäººxå¤©)</label><input type="number" id="price-food" value="150" class="w-full mt-0.5 bg-gray-50 border-0 rounded-lg p-2 text-sm" onchange="updateDashboard(); debounceSave()"></div>
                        <div><label class="text-[10px] text-gray-400 pl-1">é—¨ç¥¨/äºº (xäºº)</label><input type="number" id="price-ticket" value="800" class="w-full mt-0.5 bg-gray-50 border-0 rounded-lg p-2 text-sm" onchange="updateDashboard(); debounceSave()"></div>
                    </div>
                </div>

                <!-- è¯¦ç»†æ¸…å• -->
                <div class="bg-white p-4 rounded-2xl card-shadow border border-gray-100">
                    <h3 class="font-bold text-gray-800 mb-3 text-sm">è´¹ç”¨æ˜ç»†</h3>
                    <div id="budget-summary-list" class="space-y-2 text-sm custom-scrollbar max-h-[300px] overflow-y-auto"></div>
                </div>
            </div>
        </section>

        <!-- 4. çœ‹æ¿ & å¯¼å‡º -->
        <section id="data" class="tab-content">
             <div class="bg-white p-5 rounded-2xl card-shadow border border-gray-100 mb-4">
                <h3 class="font-bold text-gray-800 mb-4 text-lg">æ•°æ®å¯¼å‡º</h3>
                <p class="text-xs text-gray-500 mb-4 leading-relaxed">ä¸€é”®ç”Ÿæˆ Markdown æ–‡ä»¶ï¼Œæ”¯æŒå¯¼å…¥åˆ° <span class="font-bold text-gray-700">XMind</span>ã€Notionã€Obsidian ç­‰è½¯ä»¶ä¸­ç»§ç»­ç¼–è¾‘ã€‚</p>
                <button onclick="exportToXmindMarkdown()" class="w-full bg-gray-900 text-white py-3.5 rounded-xl font-bold flex items-center justify-center gap-2 active:scale-95 transition shadow-lg shadow-gray-300">
                    <i class="ph ph-file-md text-xl"></i> ä¸€é”®å¯¼å‡º XMind (Markdown)
                </button>
             </div>
             <div class="grid grid-cols-2 gap-3 mb-4">
                <div class="bg-white p-4 rounded-2xl card-shadow border border-gray-100 flex flex-col items-center justify-center">
                    <div class="text-xs text-gray-400 mb-1">è¡Œç¨‹æ€»è§ˆ</div>
                    <div class="text-xl font-bold text-gray-800"><span id="dash-days">0</span> å¤©</div>
                </div>
                <div class="bg-white p-4 rounded-2xl card-shadow border border-gray-100 flex flex-col items-center justify-center">
                    <div class="text-xs text-gray-400 mb-1">è£…å¤‡å‡†å¤‡</div>
                    <div class="text-xl font-bold text-green-600"><span id="dash-pack">0</span>%</div>
                </div>
            </div>
            <div class="bg-white p-4 rounded-2xl card-shadow border border-gray-100 mb-4">
                <h3 class="text-sm font-bold text-gray-700 mb-2">èµ„é‡‘åˆ†å¸ƒ</h3>
                <div class="h-48 flex justify-center"><canvas id="budgetDoughnutChart"></canvas></div>
            </div>
        </section>

        <!-- 5. è£…å¤‡æ¸…å• -->
        <section id="pack" class="tab-content">
            <div class="bg-white p-4 rounded-2xl card-shadow border border-gray-100 mb-4 sticky top-16 z-30">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 relative flex-shrink-0"><canvas id="packChart"></canvas><div class="absolute inset-0 flex items-center justify-center text-[10px] font-bold text-blue-600" id="pack-percent-text">0%</div></div>
                    <div class="flex-grow">
                        <h2 class="font-bold text-gray-800 text-sm">å‡†å¤‡è¿›åº¦</h2>
                        <p class="text-xs text-gray-400 mt-0.5">å·²é€‰ <span id="pack-checked-count">0</span> / <span id="pack-total-count">0</span></p>
                    </div>
                </div>
            </div>
            <button onclick="addCustomGear()" class="w-full py-3 border-2 border-dashed border-gray-200 rounded-xl text-xs text-gray-500 mb-4 hover:bg-white transition flex items-center justify-center gap-2">
                <i class="ph ph-plus"></i> æ·»åŠ è‡ªå®šä¹‰ç‰©å“
            </button>
            <div id="gear-container" class="space-y-4 pb-20"></div>
        </section>
    </main>

    <!-- H5 åº•éƒ¨å¯¼èˆªæ  -->
    <nav class="fixed bottom-0 left-0 w-full bg-white border-t border-gray-100 z-50 flex justify-around items-center pb-safe pt-2 px-2 shadow-[0_-4px_10px_rgba(0,0,0,0.03)] backdrop-blur-md bg-white/90">
        <button onclick="switchTab('explore')" class="mobile-nav-btn flex flex-col items-center p-2 text-gray-400 active transition" data-tab="explore">
            <i class="ph ph-compass text-2xl mb-0.5"></i><span class="text-[10px]">å‘ç°</span>
        </button>
        <button onclick="switchTab('routes')" class="mobile-nav-btn flex flex-col items-center p-2 text-gray-400 transition" data-tab="routes">
            <i class="ph ph-map-trifold text-2xl mb-0.5"></i><span class="text-[10px]">è¡Œç¨‹</span>
        </button>
        <button onclick="switchTab('budget')" class="mobile-nav-btn flex flex-col items-center p-2 text-gray-400 transition" data-tab="budget">
            <i class="ph ph-calculator text-2xl mb-0.5"></i><span class="text-[10px]">é¢„ç®—</span>
        </button>
        <button onclick="switchTab('pack')" class="mobile-nav-btn flex flex-col items-center p-2 text-gray-400 transition" data-tab="pack">
            <i class="ph ph-backpack text-2xl mb-0.5"></i><span class="text-[10px]">æ¸…å•</span>
        </button>
        <button onclick="switchTab('data')" class="mobile-nav-btn flex flex-col items-center p-2 text-gray-400 transition" data-tab="data">
            <i class="ph ph-chart-pie-slice text-2xl mb-0.5"></i><span class="text-[10px]">çœ‹æ¿</span>
        </button>
    </nav>

    <!-- Modal: è‡ªå®šä¹‰æ™¯ç‚¹ (ç¼–è¾‘/æ–°å¢) -->
    <div id="attraction-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl w-full max-w-sm p-6 shadow-2xl animate-[fadeIn_0.2s_ease-out]">
            <div class="flex justify-between items-center mb-5"><h3 class="font-bold text-lg text-gray-800" id="modal-title">æ™¯ç‚¹è¯¦æƒ…</h3><button onclick="closeModal('attraction-modal')" class="text-gray-400 p-2"><i class="ph ph-x text-xl"></i></button></div>
            <div class="space-y-4">
                <div class="relative group cursor-pointer" onclick="document.getElementById('modal-img-input').click()">
                    <div id="modal-img-preview" class="w-full h-32 bg-gray-50 rounded-xl border-2 border-dashed border-gray-200 flex flex-col items-center justify-center text-gray-400 overflow-hidden relative">
                         <!-- é¢„è§ˆå®¹å™¨ -->
                        <i class="ph ph-camera text-3xl mb-2"></i><span class="text-xs">ç‚¹å‡»æ›´æ¢/æ·»åŠ å›¾ç‰‡</span>
                    </div>
                    <input type="file" id="modal-img-input" accept="image/*" class="hidden" onchange="previewImage(this)">
                </div>
                <div>
                    <label class="text-xs text-gray-400 ml-1">åç§°</label>
                    <input type="text" id="modal-name" class="w-full bg-gray-50 border-0 rounded-xl p-3 text-sm ring-1 ring-gray-200 outline-none focus:ring-blue-500">
                </div>
                <div class="flex gap-3">
                    <div class="flex-grow">
                        <label class="text-xs text-gray-400 ml-1">ç±»å‹</label>
                        <select id="modal-type" class="w-full bg-gray-50 border-0 rounded-xl p-3 text-sm ring-1 ring-gray-200 outline-none">
                            <option value="custom">âœ¨ ç§è—</option><option value="è‡ªç„¶">ğŸ”ï¸ è‡ªç„¶</option><option value="äººæ–‡">ğŸ•Œ äººæ–‡</option><option value="æ»‘é›ª">ğŸ¿ æ»‘é›ª</option>
                        </select>
                    </div>
                    <input type="hidden" id="modal-coords-display">
                </div>
                <div>
                    <label class="text-xs text-gray-400 ml-1">å¤‡æ³¨</label>
                    <textarea id="modal-desc" class="w-full bg-gray-50 border-0 rounded-xl p-3 text-sm ring-1 ring-gray-200 h-20 outline-none resize-none"></textarea>
                </div>
            </div>
            <button onclick="saveSpot()" id="save-spot-btn" class="w-full mt-6 bg-gray-900 text-white py-3.5 rounded-xl font-bold shadow-lg active:scale-95 transition">ä¿ å­˜</button>
        </div>
    </div>

    <!-- Modal: ç™»å½• -->
    <div id="auth-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl w-full max-w-sm p-6 shadow-2xl animate-[fadeIn_0.2s_ease-out]">
            <div id="auth-info" class="mb-4 hidden text-center">
                <div class="w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-3 text-3xl"><i class="ph ph-user"></i></div>
                <h3 class="text-xl font-bold text-gray-800 mb-1">æ¬¢è¿å›æ¥</h3>
                <p class="text-sm text-gray-500 mb-6 truncate" id="user-email-display"></p>
                <button onclick="handleSignOut()" class="w-full bg-red-50 text-red-600 py-3 rounded-xl font-medium border border-red-100">é€€å‡ºç™»å½•</button>
                <button onclick="closeModal('auth-modal')" class="mt-3 text-sm text-gray-400">å…³é—­</button>
            </div>
            <div id="auth-form">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-gray-800" id="auth-title">è´¦æˆ·ç™»å½•</h3>
                    <button onclick="closeModal('auth-modal')" class="text-gray-400"><i class="ph ph-x text-xl"></i></button>
                </div>
                <div class="space-y-3">
                    <input type="text" id="auth-username" placeholder="è´¦æˆ·å (ä»»æ„å­—ç¬¦)" class="w-full bg-gray-50 border-0 rounded-xl p-3.5 outline-none ring-1 ring-gray-200 focus:ring-blue-500 transition">
                    <input type="password" id="auth-password" placeholder="å¯†ç  (è‡³å°‘6ä½)" class="w-full bg-gray-50 border-0 rounded-xl p-3.5 outline-none ring-1 ring-gray-200 focus:ring-blue-500 transition">
                    <input type="password" id="auth-password-confirm" placeholder="ç¡®è®¤å¯†ç " class="w-full bg-gray-50 border-0 rounded-xl p-3.5 outline-none ring-1 ring-gray-200 focus:ring-blue-500 transition hidden">
                </div>
                <p id="auth-error" class="text-red-500 text-xs mt-3 ml-1"></p>
                <button onclick="handleAuthAction()" id="auth-submit-btn" class="w-full bg-blue-600 text-white py-3.5 rounded-xl font-bold mt-6 shadow-lg shadow-blue-200">ç«‹å³ç™»å½•</button>
                <button onclick="toggleAuthMode()" id="auth-toggle-btn" class="w-full mt-4 text-sm text-gray-500">æ²¡æœ‰è´¦æˆ·ï¼Ÿå»æ³¨å†Œ</button>
            </div>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadString, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";Â 
        
        // --- CONFIGURATION ---
        const customFirebaseConfig = {
            apiKey: "AIzaSyAlbsoPG7J2cDocEGisruheVdTaX1Wajgc",
            authDomain: "xinjiang-c95f8.firebaseapp.com",
            projectId: "xinjiang-c95f8",
            storageBucket: "xinjiang-c95f8.appspot.com",
            appId: "1:9349832948:web:324982394829384", 
            messagingSenderId: "9349832948"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const configToUse = typeof __firebase_config !== 'undefined' && __firebase_config ? JSON.parse(__firebase_config) : customFirebaseConfig;

        let app, db, auth, storage;Â 
        let authMode = 'login';Â 
        let currentUserId = null;
        let budgetChart, packChart;

        // --- GLOBAL VARIABLES & FUNCTIONS ---
        const defaultSpots = [
            { id: 1, name: "ä¹Œé²æœ¨é½", type: "äººæ–‡", desc: "é¦–åºœ", lng: 87.617, lat: 43.792, tags: ["ä¸­è½¬"], img: "https://placehold.co/600x400/38BDF8/ffffff?text=Urumqi" },
            { id: 2, name: "ç¦¾æœ¨æ‘", type: "è‡ªç„¶", desc: "æ™¨é›¾", lng: 87.140, lat: 48.064, tags: ["æ‘„å½±"], img: "https://placehold.co/600x400/10B981/ffffff?text=Hemu+Village" },
            { id: 3, name: "å–€çº³æ–¯", type: "è‡ªç„¶", desc: "æ¹–æ€ª", lng: 87.042, lat: 48.657, tags: ["å¾’æ­¥"], img: "https://placehold.co/600x400/F97316/ffffff?text=Kanas+Lake" },
            { id: 4, name: "èµ›é‡Œæœ¨æ¹–", type: "è‡ªç„¶", desc: "è“å†°", lng: 81.258, lat: 44.593, tags: ["è‡ªé©¾"], img: "https://placehold.co/600x400/6366F1/ffffff?text=Sayram+Lake" },
            { id: 5, name: "å–€ä»€å¤åŸ", type: "äººæ–‡", desc: "å¤åŸ", lng: 76.066, lat: 39.467, tags: ["ç¾é£Ÿ"], img: "https://placehold.co/600x400/FACC15/000000?text=Kashgar+Old+City" },
            { id: 6, name: "å¯å¯æ‰˜æµ·", type: "æ»‘é›ª", desc: "æ»‘é›ª", lng: 89.967, lat: 47.164, tags: ["æé™"], img: "https://placehold.co/600x400/A855F7/ffffff?text=Koktokay+Ski" },
        ];
        const defaultGear = { "æ ¸å¿ƒä¿æš–": ["ç¾½ç»’æœ", "å†²é”‹è¡£", "ä¿æš–å†…è¡£", "ç¾Šæ¯›è¢œ", "é›ªåœ°é´"], "æ»‘é›ªè£…å¤‡": ["å¤´ç›”", "é›ªé•œ", "æŠ¤è„¸", "æ‰‹å¥—", "æŠ¤å…·"] };
        window.defaultSpots = defaultSpots;
        // Initial state uses defaultSpots, but these will be OVERWRITTEN by cloud data if available
        window.state = { spots: [...defaultSpots], itinerary: [[]], currentDayIndex: 0, customBudget: [], customGear: [], weatherTemp: -20, isPickingMode: false, tempSpotCoords: null, editingSpotId: null, initialized: false, dataLoaded: false };
        let saveTimeout;
        let currentModalImageBase64 = null;

        // UI Helpers
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
        window.openAuthModal = () => document.getElementById('auth-modal').classList.remove('hidden');
        
        window.toggleAuthMode = () => { 
             if(authMode==='login'){authMode='register';document.getElementById('auth-title').innerText='æ³¨å†Œ';document.getElementById('auth-submit-btn').innerText='æ³¨å†Œ';document.getElementById('auth-password-confirm').classList.remove('hidden');}
             else{authMode='login';document.getElementById('auth-title').innerText='ç™»å½•';document.getElementById('auth-submit-btn').innerText='ç™»å½•';document.getElementById('auth-password-confirm').classList.add('hidden');}
        };

        window.handleAuthAction = async () => { 
             const u = document.getElementById('auth-username').value; const p = document.getElementById('auth-password').value;
             if(!u) return document.getElementById('auth-error').innerText = 'è¯·è¾“å…¥è´¦æˆ·å';
             if(p.length < 6) return document.getElementById('auth-error').innerText = 'å¯†ç è‡³å°‘éœ€è¦6ä½';
             const email = `${u}@travel.planner.user`; // Simple email construction
             try { if(authMode==='register') {await createUserWithEmailAndPassword(auth, email, p); alert("æ³¨å†ŒæˆåŠŸï¼");} else await signInWithEmailAndPassword(auth, email, p); closeModal('auth-modal'); }
             catch(e) { 
                 console.error("Auth Error:", e);
                 let msg = "è®¤è¯å¤±è´¥";
                 if (e.code === 'auth/unauthorized-domain') msg = "å½“å‰åŸŸåæœªåœ¨Firebaseæˆæƒ";
                 else if (e.code === 'auth/email-already-in-use') msg = "è´¦æˆ·å·²å­˜åœ¨";
                 else if (e.code === 'auth/weak-password') msg = "å¯†ç å¤ªå¼±";
                 else if (e.code === 'auth/user-not-found' || e.code === 'auth/wrong-password') msg = "è´¦æˆ·æˆ–å¯†ç é”™è¯¯";
                 else if (e.message) msg = e.message;
                 document.getElementById('auth-error').innerText = msg;
             }
        };
        window.handleSignOut = async () => { await signOut(auth); location.reload(); };

        // Save Logic
        function debounceSave() { clearTimeout(saveTimeout); saveTimeout = setTimeout(() => { if (window.saveUserData) window.saveUserData(); }, 1000); }
        function updateSyncStatus(status) {
            const el = document.getElementById('sync-status-badge');
            if (status === 'saving') { el.textContent = 'ä¿å­˜ä¸­...'; el.className = 'text-[10px] text-yellow-500 font-medium'; }
            else if (status === 'synced') { el.textContent = 'å·²åŒæ­¥'; el.className = 'text-[10px] text-green-500 font-medium'; }
            else if (status === 'error') { el.textContent = 'åŒæ­¥å¤±è´¥'; el.className = 'text-[10px] text-red-500 font-bold'; }
            else { el.textContent = 'ç¦»çº¿'; el.className = 'text-[10px] text-gray-400'; }
        }

        // --- Render Functions (Redesigned for H5 Grid) ---
        window.renderExploreGrid = () => {
            const g=document.getElementById('explore-grid'), t=document.getElementById('explore-search').value.toLowerCase(), f=document.getElementById('explore-filter').value; g.innerHTML='';
            
            // Render ALL spots
            window.state.spots.forEach(s=>{
                if((s.name.toLowerCase().includes(t)||s.tags.join('').includes(t))&&(f==='all'||(f==='custom'?false:s.type===f))){ 
                    const div=document.createElement('div'); div.className="bg-white rounded-2xl p-0 card-shadow border border-gray-100 flex flex-col overflow-hidden";
                    
                    let imgHtml = s.img && s.img.startsWith('http') ? `<img src="${s.img}" class="w-full h-32 object-cover">` : `<div class="w-full h-32 bg-gray-50 flex items-center justify-center text-gray-300"><i class="ph ph-image text-3xl"></i></div>`;
                    
                    // Always show Edit/Delete buttons if logged in
                    const actions = currentUserId ? `
                        <div class="flex items-center gap-3">
                            <button onclick="editSpot(${s.id})" class="text-blue-600 flex items-center gap-1 text-xs font-bold bg-blue-50 px-2 py-1 rounded-lg"><i class="ph ph-pencil-simple"></i> ç¼–è¾‘</button>
                            <button onclick="deleteSpot(${s.id})" class="text-red-500 flex items-center gap-1 text-xs font-medium px-2 py-1"><i class="ph ph-trash"></i> åˆ é™¤</button>
                        </div>
                    ` : '';
                    
                    // FIX: Ensure clicking card works even if not logged in
                    const clickAction = currentUserId ? `editSpot(${s.id})` : `openAuthModal()`;
                    const overlayText = currentUserId ? 'ç‚¹å‡»ä¿®æ”¹' : 'ç™»å½•ç¼–è¾‘';

                    div.innerHTML=`
                        <!-- Click Image to Edit -->
                        <div onclick="${clickAction}" class="cursor-pointer relative">
                            ${imgHtml}
                            <div class="absolute bottom-2 right-2 bg-black/50 text-white text-[10px] px-2 py-0.5 rounded-full backdrop-blur-sm">
                                ${overlayText}
                            </div>
                        </div>
                        <div class="p-3 flex flex-col flex-grow">
                            <div class="flex justify-between items-start mb-1">
                                <h3 class="font-bold text-gray-800 text-sm truncate w-2/3">${s.name}</h3>
                                <span class="text-[10px] bg-gray-100 px-1.5 py-0.5 rounded text-gray-500 whitespace-nowrap">${s.type}</span>
                            </div>
                            <p class="text-xs text-gray-400 mb-3 line-clamp-2 min-h-[2.5em]">${s.desc||'æš‚æ— å¤‡æ³¨'}</p>
                            
                            <div class="mt-auto pt-2 border-t border-gray-50 flex justify-between items-center">
                                ${actions}
                                <button onclick="addToRoute(${s.id})" class="ml-auto bg-gray-900 text-white px-3 py-1.5 rounded-lg active:scale-95 transition shadow-lg text-xs font-bold flex items-center gap-1">åŠ å…¥ <i class="ph ph-plus-bold"></i></button>
                            </div>
                        </div>`;
                    g.appendChild(div);
                }
            });
        }

        window.deleteSpot = (id) => {
            if (!confirm("ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ™¯ç‚¹å—ï¼Ÿæ­¤æ“ä½œå°†åŒæ­¥åˆ é™¤äº‘ç«¯æ•°æ®ã€‚")) return; 
            const idx = window.state.spots.findIndex(s => s.id === id);
            if (idx > -1) {
                window.state.spots.splice(idx, 1);
                // Also remove from itinerary
                window.state.itinerary.forEach(d => { const i = d.indexOf(id); if (i > -1) d.splice(i, 1); });
                window.renderExploreGrid(); debounceSave();
            }
        }
        
        window.editSpot = (id) => {
             const s = window.state.spots.find(x => x.id === id); if(!s) return;
             window.state.editingSpotId = id; 
             document.getElementById('modal-name').value = s.name;
             document.getElementById('modal-type').value = s.type;
             document.getElementById('modal-desc').value = s.desc;
             if(s.img) {
                 currentModalImageBase64 = s.img;
                 document.getElementById('modal-img-preview').innerHTML = `<img src="${s.img}" class="w-full h-full object-cover rounded-xl">`;
             } else {
                 document.getElementById('modal-img-preview').innerHTML = `<i class="ph ph-camera text-3xl mb-2"></i><span class="text-xs">æ·»åŠ å°é¢å›¾</span>`;
                 currentModalImageBase64 = null;
             }
             window.openAttractionModal(false); 
        }

        window.openAttractionModal = (reset=true) => {
             document.getElementById('attraction-modal').classList.remove('hidden');
             const btn = document.getElementById('save-spot-btn');
             const title = document.getElementById('modal-title');
             
             if(reset) { 
                 document.getElementById('modal-name').value=''; 
                 document.getElementById('modal-desc').value='';
                 currentModalImageBase64=null; 
                 window.state.editingSpotId=null;
                 btn.innerText = 'æ–°å»ºå¹¶ä¿å­˜';
                 title.innerText = 'æ–°å»ºæ™¯ç‚¹';
                 document.getElementById('modal-img-preview').innerHTML = `<i class="ph ph-camera text-3xl mb-2"></i><span class="text-xs">æ·»åŠ å°é¢å›¾</span>`;
             } else {
                 btn.innerText = 'ä¿å­˜ä¿®æ”¹';
                 title.innerText = 'ç¼–è¾‘æ™¯ç‚¹';
                 // Preview image handled in editSpot or kept current
                 if(currentModalImageBase64) {
                      document.getElementById('modal-img-preview').innerHTML = `<img src="${currentModalImageBase64}" class="w-full h-full object-cover rounded-xl">`;
                 }
             }
        }
        
        window.saveSpot = async () => {
             const n = document.getElementById('modal-name').value;
             if(!n) return;
             const btn = document.getElementById('save-spot-btn');
             btn.innerText = 'æ­£åœ¨ä¸Šä¼ å›¾ç‰‡...';
             
             let imgUrl = currentModalImageBase64;
             if (imgUrl && !imgUrl.startsWith('http') && currentUserId) {
                  const uploadedUrl = await uploadImageAndGetUrl(imgUrl, currentUserId);
                  if (uploadedUrl) {
                      imgUrl = uploadedUrl;
                  } else {
                      btn.innerText = 'å›¾ç‰‡ä¸Šä¼ å¤±è´¥';
                      btn.classList.add('bg-red-500');
                      setTimeout(() => { btn.classList.remove('bg-red-500'); btn.innerText = 'ä¿å­˜'; }, 2000);
                      return; 
                  }
             }
             
             const newSpot = {
                 id: window.state.editingSpotId || Date.now(), name: n, type: document.getElementById('modal-type').value, desc: document.getElementById('modal-desc').value,
                 lng: 87.6, lat: 43.8, // Default coords placeholder
                 tags: [], 
                 img: imgUrl
             };
             
             if (window.state.editingSpotId) {
                 const idx = window.state.spots.findIndex(s => s.id === window.state.editingSpotId);
                 if (idx > -1) window.state.spots[idx] = newSpot;
             } else {
                 window.state.spots.push(newSpot);
             }
             
             btn.innerText = 'ä¿å­˜æˆåŠŸ';
             closeModal('attraction-modal');
             window.renderExploreGrid(); 
             debounceSave(); // Sync to cloud immediately
        }

        window.previewImage = (input) => {
             if (input.files && input.files[0]) {
                 const reader = new FileReader();
                 reader.onload = (e) => { 
                     currentModalImageBase64 = e.target.result; 
                     document.getElementById('modal-img-preview').innerHTML = `<img src="${e.target.result}" class="w-full h-full object-cover rounded-xl">`;
                 };
                 reader.readAsDataURL(input.files[0]);
             }
        }

        window.addToRoute = (id) => { if (!window.state.itinerary[window.state.currentDayIndex]) window.state.itinerary.push([]); window.state.itinerary[window.state.currentDayIndex].push(id); window.renderDayList(); debounceSave(); }
        window.addDay = () => { window.state.itinerary.push([]); window.state.currentDayIndex = window.state.itinerary.length - 1; window.renderDayList(); debounceSave(); }
        window.removeDay = (i) => { if(window.state.itinerary.length > 1) { window.state.itinerary.splice(i, 1); window.state.currentDayIndex = Math.max(0, window.state.currentDayIndex - 1); } else { window.state.itinerary[0] = []; } window.renderDayList(); debounceSave(); }
        
        window.renderDayList = () => {
             const l = document.getElementById('day-list'); l.innerHTML = '';
             if(window.state.itinerary.length === 0) { window.state.itinerary.push([]); window.state.currentDayIndex=0; }
             window.state.itinerary.forEach((s, i) => {
                 const isActive = i === window.state.currentDayIndex;
                 const div = document.createElement('div');
                 div.className = `flex-shrink-0 w-20 p-2 rounded-xl border text-center transition cursor-pointer snap-start ${isActive ? 'bg-blue-600 text-white border-blue-600 shadow-lg shadow-blue-200' : 'bg-white text-gray-500 border-gray-200'}`;
                 div.innerHTML = `<div class="text-xs font-bold mb-1">D${i+1}</div><div class="text-[10px] opacity-80">${s.length}ä¸ªæ™¯ç‚¹</div>`;
                 if(isActive) {
                     const del = document.createElement('button'); del.innerHTML = '&times;'; del.className = "block mx-auto mt-1 text-xs opacity-50 hover:opacity-100";
                     del.onclick = (e) => { e.stopPropagation(); window.removeDay(i); }; div.appendChild(del);
                 }
                 div.onclick = () => { window.state.currentDayIndex = i; window.renderDayList(); };
                 l.appendChild(div);
             });
             document.getElementById('current-day-num').innerText = window.state.currentDayIndex + 1;
             window.renderItineraryView(); window.renderAllSpots();
        }
        
        window.renderItineraryView = () => {
             const c = document.getElementById('itinerary-mind-map');
             const spots = window.state.itinerary[window.state.currentDayIndex] || [];
             if(spots.length === 0) { c.innerHTML = '<div class="text-center text-gray-400 py-8">æœ¬æ—¥æš‚æ— å®‰æ’<br><span class="text-xs">å»"å‘ç°"æ·»åŠ æ™¯ç‚¹</span></div>'; return; }
             c.innerHTML = spots.map((id, idx) => {
                 const s = window.state.spots.find(x => x.id === id); if(!s) return '';
                 const img = s.img && s.img.startsWith('http') ? `<img src="${s.img}" class="w-16 h-16 rounded-lg object-cover flex-shrink-0 bg-gray-100">` : `<div class="w-16 h-16 rounded-lg bg-blue-50 text-blue-300 flex items-center justify-center flex-shrink-0"><i class="ph ph-map-pin text-xl"></i></div>`;
                 const line = idx < spots.length - 1 ? `<div class="absolute left-[31px] top-12 bottom-[-16px] w-0.5 bg-gray-100 z-0"></div>` : '';
                 return `<div class="relative flex items-center gap-4 mb-4 z-10">${line}${img}<div class="flex-grow bg-white p-3 rounded-xl border border-gray-100 card-shadow flex justify-between items-center"><div><h4 class="font-bold text-gray-800 text-sm">${s.name}</h4><p class="text-xs text-gray-400">${s.type}</p></div><button onclick="rmSpot(${idx})" class="text-gray-300 hover:text-red-500 p-2"><i class="ph ph-trash"></i></button></div></div>`;
             }).join('');
        }
        window.rmSpot = (idx) => { window.state.itinerary[window.state.currentDayIndex].splice(idx, 1); window.renderDayList(); debounceSave(); }
        window.renderAllSpots = () => { /* logic */ }

        window.addCustomBudgetItem = () => {
            const name = document.getElementById('custom-item-name').value;
            const price = parseFloat(document.getElementById('custom-item-price').value);
            const people = parseInt(document.getElementById('custom-item-people').value)||1;
            const days = parseInt(document.getElementById('custom-item-days').value)||1;
            const payer = document.getElementById('custom-item-payer').value||'';
            if(name && price) {
                window.state.customBudget.push({ name, price, people, days, payer });
                document.getElementById('custom-item-name').value = ''; document.getElementById('custom-item-price').value = '';
                window.updateDashboard(); debounceSave();
            }
        }
        window.removeBudgetItem = (idx) => { window.state.customBudget.splice(idx, 1); window.updateDashboard(); debounceSave(); }
        
        window.renderBudget = () => {
             const p = parseInt(document.getElementById('budget-people').value)||1;
             const d = window.state.itinerary.length;
             document.getElementById('budget-days').value = d;
             const stay = (parseFloat(document.getElementById('price-stay').value)||0) * Math.ceil(p/2) * Math.max(0, d-1);
             const trans = (parseFloat(document.getElementById('price-trans').value)||0) * d;
             const food = (parseFloat(document.getElementById('price-food').value)||0) * p * d;
             const ticket = (parseFloat(document.getElementById('price-ticket').value)||0) * p;
             let customTotal = 0; let html = '';
             window.state.customBudget.forEach((item, idx) => {
                 const t = item.price * item.people * item.days; customTotal += t;
                 html += `<div class="flex justify-between items-center p-3 bg-gray-50 rounded-xl"><div class="flex flex-col"><span class="font-bold text-gray-700">${item.name}</span><span class="text-[10px] text-gray-400">${item.payer ? 'ä»˜æ¬¾:'+item.payer+' ' : ''}Â¥${item.price}x${item.people}äººx${item.days}å¤©</span></div><div class="flex items-center gap-3"><span class="font-bold text-gray-800">Â¥${t}</span><button onclick="removeBudgetItem(${idx})" class="text-gray-300 hover:text-red-500"><i class="ph ph-trash"></i></button></div></div>`;
             });
             document.getElementById('budget-summary-list').innerHTML = html;
             
             // VISUAL FIX: Improve list styling for base items
             const baseItemClass = "flex justify-between items-center p-3 bg-gray-50 rounded-xl mb-2";
             const baseLabelClass = "text-sm text-gray-600";
             const baseValueClass = "font-mono font-bold text-gray-800";

             let baseHtml = `<div class="${baseItemClass}"><span class="${baseLabelClass}">ğŸ¨ ä½å®¿ (${document.getElementById('price-stay').value} x ${Math.max(0, d - 1)}æ™š)</span><span class="${baseValueClass}">Â¥${stay.toLocaleString()}</span></div>`;
             baseHtml += `<div class="${baseItemClass}"><span class="${baseLabelClass}">ğŸš— äº¤é€š (${document.getElementById('price-trans').value} x ${d}å¤©)</span><span class="${baseValueClass}">Â¥${trans.toLocaleString()}</span></div>`;
             baseHtml += `<div class="${baseItemClass}"><span class="${baseLabelClass}">ğŸ¥˜ é¤è´¹ (${document.getElementById('price-food').value} x ${p}äºº x ${d}å¤©)</span><span class="${baseValueClass}">Â¥${food.toLocaleString()}</span></div>`;
             baseHtml += `<div class="${baseItemClass}"><span class="${baseLabelClass}">ğŸ« é—¨ç¥¨ (${document.getElementById('price-ticket').value} x ${p}äºº)</span><span class="${baseValueClass}">Â¥${ticket.toLocaleString()}</span></div>`;
             
             document.getElementById('budget-summary-list').innerHTML = baseHtml + html;

             const total = stay + trans + food + ticket + customTotal;
             document.getElementById('disp-total').innerText = total.toLocaleString();
             document.getElementById('disp-avg').innerText = Math.round(total/p).toLocaleString();
             document.getElementById('people-count-display').innerText = p;
             if(budgetChart) { budgetChart.data.datasets[0].data = [stay, trans, food+ticket, customTotal]; budgetChart.update(); }
        }
        
        window.renderGear = () => {
            const c = document.getElementById('gear-container'); c.innerHTML = '';
            const allGear = { ...defaultGear };
            if(window.state.customGear.length) allGear["è‡ªå®šä¹‰"] = window.state.customGear;
            let total = 0; let checked = 0;
            for(const [cat, items] of Object.entries(allGear)) {
                let html = `<h4 class="font-bold text-sm text-gray-400 mb-2 mt-4">${cat}</h4><div class="bg-white rounded-2xl border border-gray-100 p-2 space-y-1">`;
                items.forEach(i => {
                    const isChecked = localStorage.getItem(`gear_${i}`) === 'true';
                    total++; if(isChecked) checked++;
                    html += `<label class="flex items-center p-2 rounded-lg hover:bg-gray-50 transition cursor-pointer"><input type="checkbox" class="gear-check rounded text-blue-600 focus:ring-blue-500 w-4 h-4 mr-3" data-item="${i}" ${isChecked?'checked':''} onchange="updateGearStats(this)"> <span class="${isChecked?'text-gray-400 line-through':'' } text-sm">${i}</span></label>`;
                });
                html += `</div>`; c.innerHTML += html;
            }
            document.getElementById('pack-total-count').innerText = total; document.getElementById('pack-checked-count').innerText = checked;
            const pct = total ? Math.round(checked/total*100) : 0;
            document.getElementById('pack-percent-text').innerText = pct + '%'; 
            if(packChart) { packChart.data.datasets[0].data = [checked, total-checked]; packChart.update(); }
        }
        
        window.updateGearStats = (cb) => { if(cb) localStorage.setItem(`gear_${cb.dataset.item}`, cb.checked); window.renderGear(); debounceSave(); }
        window.addCustomGear = () => { const n = prompt("è¾“å…¥ç‰©å“åç§°:"); if(n) { window.state.customGear.push(n); window.renderGear(); debounceSave(); } }
        window.updateDashboard = () => { window.renderBudget(); document.getElementById('dash-days').innerText = window.state.itinerary.length; }

        // --- XMind Export ---
        window.exportToXmindMarkdown = () => {
            const s = window.state;
            let md = `# æ—…è¡Œè§„åˆ’ï¼šæ–°ç–†\n\n`;
            md += `## ğŸ“… è¡Œç¨‹å®‰æ’\n`;
            if (s.itinerary.length === 0) md += `- æš‚æ— è¡Œç¨‹å®‰æ’\n`;
            else s.itinerary.forEach((daySpots, i) => {
                md += `### ç¬¬ ${i + 1} å¤©\n`;
                if (daySpots.length === 0) md += `- (ç©º)\n`;
                else daySpots.forEach(id => { const spot = s.spots.find(x => x.id === id); if (spot) md += `- ${spot.name} (${spot.type}) ${spot.desc ? ': ' + spot.desc : ''}\n`; });
            });
            md += `\n## ğŸ’° é¢„ç®—è§„åˆ’ (æ€»è®¡: Â¥${document.getElementById('disp-total').innerText})\n`;
            md += `- ä½å®¿: Â¥${document.getElementById('disp-stay').innerText}\n- äº¤é€š: Â¥${document.getElementById('disp-trans').innerText}\n- é¤è´¹: Â¥${document.getElementById('disp-food').innerText}\n- é—¨ç¥¨: Â¥${document.getElementById('disp-ticket').innerText}\n`;
            if (s.customBudget.length > 0) { md += `### è‡ªå®šä¹‰æ”¯å‡º\n`; s.customBudget.forEach(i => { const t = i.price * i.people * i.days; md += `- ${i.name}: Â¥${t.toLocaleString()} (ä»˜æ¬¾: ${i.payer})\n`; }); }
            md += `\n## ğŸ’ è£…å¤‡æ¸…å•\n`;
            const allInputs = document.querySelectorAll('.gear-check');
            let checkedMap = {};
            allInputs.forEach(input => { checkedMap[input.dataset.item] = input.checked; });
            for(const [cat, items] of Object.entries(defaultGear)){ md += `### ${cat}\n`; items.forEach(i => { const c = checkedMap[i] !== undefined ? checkedMap[i] : (localStorage.getItem(`gear_${i}`) === 'true'); md += `- [${c ? 'x' : ' '}] ${i}\n`; }); }
            const blob = new Blob([md], { type: 'text/markdown' });
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'æ–°ç–†æ—…è¡Œè®¡åˆ’.md'; a.click();
        }

        window.switchTab = (id) => {
            document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.mobile-nav-btn').forEach(b=> {
                b.classList.remove('text-blue-600'); b.classList.add('text-gray-400');
                if(b.dataset.tab === id) { b.classList.add('text-blue-600'); b.classList.remove('text-gray-400'); }
            });
            if(id === 'routes') window.renderDayList();
            if(id === 'pack') window.renderGear();
            if(id === 'budget') window.renderBudget();
            window.scrollTo(0,0);
        }

        // --- Init ---
        async function initAuthAndDb() {
            try {
                app = initializeApp(configToUse); auth = getAuth(app); db = getFirestore(app); storage = getStorage(app);Â 
                await setPersistence(auth, browserLocalPersistence);
                if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken);
                onAuthStateChanged(auth, (user) => {
                    updateAuthStateUI(user);
                    if (user) setupDataListener(user.uid);
                    else if (!window.state.initialized) { window.state.initialized = true; window.state.dataLoaded = true; window.renderApp(); }
                });
            } catch (error) { console.error(error); updateSyncStatus('error'); }
        }
        
        function setupDataListener(userId) {
            const docRef = doc(db, 'artifacts', appId, 'users', userId, 'data', 'state');
            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    // FIX: Always prioritize cloud data for spots, never fallback to default if cloud data exists
                    if (data.spots && data.spots.length > 0) {
                        window.state.spots = data.spots;
                    } else {
                        // Only use defaults on very first load ever
                        window.state.spots = [...window.defaultSpots];
                    }

                    try { const loadedItinerary = JSON.parse(data.itinerary); window.state.itinerary = loadedItinerary.length > 0 ? loadedItinerary : [[]]; } catch { window.state.itinerary = [[]]; }
                    window.state.customBudget = data.customBudget || []; window.state.customGear = data.customGear || [];
                } else { saveUserData(); }
                if (!window.state.initialized) window.state.initialized = true;
                window.state.dataLoaded = true; window.renderApp(); updateSyncStatus('synced');
            }, () => { updateSyncStatus('error'); window.state.dataLoaded = true; window.renderApp(); });
        }
        
        // --- Auth UI Helpers ---
        function updateAuthStateUI(user) {
            const statusEl = document.getElementById('auth-status'); const infoDiv = document.getElementById('auth-info'); const formDiv = document.getElementById('auth-form'); const logoutBtn = document.getElementById('logout-button-header');
            if (user) {
                currentUserId = user.uid; statusEl.textContent = user.email.split('@')[0]; document.getElementById('user-email-display').textContent = user.email.split('@')[0];
                infoDiv.classList.remove('hidden'); formDiv.classList.add('hidden'); logoutBtn.classList.remove('hidden');
            } else {
                currentUserId = null; statusEl.textContent = 'ç™»å½•'; infoDiv.classList.add('hidden'); formDiv.classList.remove('hidden'); logoutBtn.classList.add('hidden');
            }
        }
        
        // --- Save Logic ---
        async function saveUserData() {
            if (!currentUserId || !db) return;
            updateSyncStatus('saving');
            try {
                // FIX: Save ALL spots (default + custom) to persist edits
                // IMPORTANT: removed filters, now saving EVERYTHING
                const cleanSpots = window.state.spots.map(s => ({ 
                    id: s.id, name: s.name, type: s.type, desc: s.desc||'', lng: s.lng||87.617, lat: s.lat||43.792, tags: s.tags||[], img: s.img||null 
                }));
                const cleanCustomBudget = window.state.customBudget.map(i => ({ name: i.name||'', people: i.people||1, days: i.days||1, payer: i.payer||'æœªæŒ‡å®š', price: i.price||0 }));
                
                await setDoc(doc(db, 'artifacts', appId, 'users', currentUserId, 'data', 'state'), {
                    spots: cleanSpots, // Save ALL spots
                    itinerary: JSON.stringify(window.state.itinerary), 
                    customBudget: cleanCustomBudget, 
                    customGear: window.state.customGear || [], 
                    lastSave: new Date().toISOString()
                }, { merge: true });
                updateSyncStatus('synced');
            } catch (e) { console.error(e); updateSyncStatus('error'); }
        }

        async function uploadImageAndGetUrl(b64, uid) {
            if(!storage || !b64 || !uid) return null;
            const refPtr = ref(storage, `images/${uid}/${Date.now()}.jpeg`);
            try { await uploadString(refPtr, b64, 'data_url'); return await getDownloadURL(refPtr); } catch(e) { console.error(e); return null; }
        }

        window.onload = () => {
             budgetChart=new Chart(document.getElementById('budgetDoughnutChart'),{type:'doughnut',data:{labels:['ä½å®¿','äº¤é€š','é£Ÿç¥¨','å…¶ä»–'],datasets:[{data:[1,1,1,1],backgroundColor:['#3B82F6','#6366F1','#F59E0B','#10B981'],borderWidth:0, hoverOffset: 4}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right',labels:{boxWidth:12, font:{size:10}}}}}});
             packChart=new Chart(document.getElementById('packChart'),{type:'doughnut',data:{datasets:[{data:[0,1],backgroundColor:['#2563EB','#F1F5F9'],borderWidth:0,cutout:'80%'}]},options:{responsive:true,maintainAspectRatio:false,plugins:{tooltip:{enabled:false}}}});
        }
    </script>
</body>
</html>

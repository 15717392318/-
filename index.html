<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ–°ç–†æ—…è¡Œè§„åˆ’ | Proç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap');
        
        body { font-family: 'Noto Sans SC', sans-serif; background-color: #F8FAFC; color: #334155; padding-bottom: 80px; /* ä¸ºåº•éƒ¨å¯¼èˆªç•™ç™½ */ }
        
        /* äº¤äº’åŠ¨æ•ˆ */
        .tab-content { display: none; animation: fadeIn 0.3s ease-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .hover-card { transition: all 0.3s; }
        .hover-card:hover { transform: translateY(-2px); box-shadow: 0 10px 20px -10px rgba(0,0,0,0.1); }

        /* åœ°å›¾ç”»å¸ƒå®¹å™¨ */
        #map-wrapper {
            background-color: #e5e7eb;
            background-image: linear-gradient(rgba(255,255,255,0.5) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.5) 1px, transparent 1px);
            background-size: 40px 40px;
            cursor: grab; overflow: hidden; position: relative;
            touch-action: none; /* ç¦æ­¢æµè§ˆå™¨é»˜è®¤è§¦æ‘¸è¡Œä¸º(å¦‚æ»šåŠ¨)ä»¥ä¾¿åœ°å›¾æ‹–æ‹½ */
        }
        #map-wrapper:active { cursor: grabbing; }

        .day-card.active { border-left-color: #3B82F6; background-color: #EFF6FF; }
        
        /* æ»šåŠ¨æ¡ */
        .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }

        /* ç§»åŠ¨ç«¯åº•éƒ¨å¯¼èˆªæ¿€æ´»æ€ */
        .mobile-nav-btn.active { color: #2563EB; }
        .mobile-nav-btn.active i { font-weight: bold; }
        
        /* é¢„ç®—åˆ—è¡¨é¡¹è¿›å…¥åŠ¨ç”» */
        @keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
        .budget-item-enter { animation: slideIn 0.3s ease-out forwards; }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <!-- é¡¶éƒ¨æ ‡é¢˜æ  (Mobile & Desktop) -->
    <header class="bg-white/90 backdrop-blur-md sticky top-0 z-40 border-b border-gray-200 shadow-sm">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <div class="bg-blue-600 text-white p-1.5 rounded-lg shadow-md shadow-blue-500/30">
                    <i class="ph ph-airplane-tilt text-xl"></i>
                </div>
                <div>
                    <h1 class="font-bold text-gray-800 text-base leading-tight">æ–°ç–†è§„åˆ’å¸ˆ <span class="text-[10px] text-blue-600 bg-blue-50 px-1.5 py-0.5 rounded-full border border-blue-100 align-middle">V3.4</span></h1>
                </div>
            </div>
            
            <!-- Desktop Nav (Hidden on Mobile) -->
            <nav class="hidden md:flex bg-gray-100/50 p-1 rounded-xl border border-gray-100">
                <button onclick="switchTab('explore')" class="nav-btn px-4 py-2 rounded-lg text-sm font-medium transition-all text-gray-600 hover:bg-white hover:shadow-sm" data-tab="explore">ğŸ”ï¸ ç™¾ç§‘</button>
                <button onclick="switchTab('routes')" class="nav-btn px-4 py-2 rounded-lg text-sm font-medium transition-all text-gray-600 hover:bg-white hover:shadow-sm" data-tab="routes">ğŸ—ºï¸ åœ°å›¾</button>
                <button onclick="switchTab('budget')" class="nav-btn px-4 py-2 rounded-lg text-sm font-medium transition-all text-gray-600 hover:bg-white hover:shadow-sm" data-tab="budget">ğŸ’° é¢„ç®—</button>
                <button onclick="switchTab('data')" class="nav-btn px-4 py-2 rounded-lg text-sm font-medium transition-all text-gray-600 hover:bg-white hover:shadow-sm" data-tab="data">ğŸ“Š çœ‹æ¿</button>
                <button onclick="switchTab('pack')" class="nav-btn px-4 py-2 rounded-lg text-sm font-medium transition-all text-gray-600 hover:bg-white hover:shadow-sm" data-tab="pack">ğŸ’ æ¸…å•</button>
            </nav>
        </div>
    </header>

    <main class="flex-grow container mx-auto px-4 py-4">

        <!-- 1. æ™¯ç‚¹ç™¾ç§‘ -->
        <section id="explore" class="tab-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">æ™¯ç‚¹å‘ç°</h2>
                <button onclick="openAttractionModal(true)" class="bg-blue-600 active:bg-blue-700 text-white px-3 py-2 rounded-xl shadow-lg shadow-blue-500/30 flex items-center gap-1 text-xs transition-transform active:scale-95">
                    <i class="ph ph-plus-bold"></i> è‡ªå®šä¹‰
                </button>
            </div>
            
            <!-- æœç´¢æ  (Mobile Optimized) -->
            <div class="bg-white p-3 rounded-2xl shadow-sm border border-gray-100 mb-4 flex flex-col gap-3 sticky top-16 z-30">
                <div class="relative w-full">
                    <i class="ph ph-magnifying-glass absolute left-3 top-3 text-gray-400"></i>
                    <input type="text" id="explore-search" placeholder="æœæ™¯ç‚¹..." class="w-full bg-gray-50 border border-gray-200 rounded-xl pl-9 pr-3 py-2.5 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div class="flex overflow-x-auto gap-2 pb-1 custom-scrollbar">
                    <select id="explore-filter" class="bg-gray-50 border border-gray-200 rounded-xl px-3 py-2 text-xs outline-none flex-shrink-0">
                        <option value="all">å…¨éƒ¨ç±»å‹</option>
                        <option value="è‡ªç„¶">ğŸ”ï¸ è‡ªç„¶</option>
                        <option value="äººæ–‡">ğŸ•Œ äººæ–‡</option>
                        <option value="æ»‘é›ª">ğŸ¿ æ»‘é›ª</option>
                        <option value="custom">âœ¨ è‡ªå®šä¹‰</option>
                    </select>
                </div>
            </div>

            <div id="explore-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 pb-20"></div>
        </section>

        <!-- 2. äº¤äº’åœ°å›¾ (Mobile Optimized Layout) -->
        <section id="routes" class="tab-content">
            <!-- æ‰‹æœºç«¯æ”¹ä¸ºä¸Šä¸‹å¸ƒå±€ï¼šä¸Šéƒ¨åˆ†åˆ—è¡¨ï¼Œä¸­é—´åœ°å›¾ï¼Œä¸‹éƒ¨åˆ†æ·»åŠ  -->
            <div class="flex flex-col lg:grid lg:grid-cols-12 gap-4 h-auto lg:h-[calc(100vh-100px)]">
                
                <!-- 1. å¤©æ•°é€‰æ‹© (Mobile: Horizontal Scroll, Desktop: Vertical) -->
                <div class="lg:col-span-3 flex flex-col gap-3 bg-white p-3 rounded-2xl shadow-sm border border-gray-100 order-2 lg:order-1">
                    <div class="flex justify-between items-center">
                        <h3 class="font-bold text-gray-800 text-sm">ğŸ“… è¡Œç¨‹</h3>
                        <button onclick="addDay()" class="text-xs bg-blue-50 text-blue-600 px-2 py-1 rounded border border-blue-100">+ å¤©æ•°</button>
                    </div>
                    <!-- æ‰‹æœºç«¯æ¨ªå‘æ»šåŠ¨ -->
                    <div id="day-list" class="flex lg:flex-col gap-2 overflow-x-auto lg:overflow-y-auto custom-scrollbar pb-2 lg:pb-0 h-auto lg:h-1/2"></div>
                    
                    <div class="mt-2 border-t pt-2 lg:h-1/2 lg:flex-col lg:flex hidden lg:flex">
                         <h3 class="font-bold text-gray-800 mb-2 text-xs">ğŸ“ å½“æ—¥æ˜ç»†</h3>
                         <div id="day-spots-list-desktop" class="flex-grow overflow-y-auto space-y-2 pr-1 custom-scrollbar text-xs"></div>
                    </div>
                </div>

                <!-- 2. åœ°å›¾ (Mobile: Fixed Height, Desktop: Auto) -->
                <div class="lg:col-span-6 bg-white rounded-2xl shadow-sm border border-gray-100 relative overflow-hidden flex flex-col group order-1 lg:order-2">
                    <div class="absolute top-3 left-3 z-10">
                         <div class="bg-white/90 backdrop-blur px-2 py-1 rounded shadow-sm text-[10px] font-medium border border-gray-200 text-gray-600">
                            ç¬¬ <span id="current-day-num">1</span> å¤©
                        </div>
                    </div>
                    <div class="absolute bottom-3 right-3 z-10 flex gap-2">
                        <button onclick="resetMapView()" class="bg-white p-2 rounded shadow text-gray-600 text-xs"><i class="ph ph-arrows-out-cardinal"></i></button>
                        <div class="flex bg-white rounded shadow overflow-hidden">
                            <button onclick="zoomMap(0.2)" class="p-2 border-r text-gray-600"><i class="ph ph-plus"></i></button>
                            <button onclick="zoomMap(-0.2)" class="p-2 text-gray-600"><i class="ph ph-minus"></i></button>
                        </div>
                    </div>
                    <!-- æ‰‹æœºç«¯ç»™ä¸ªå›ºå®šé«˜åº¦ -->
                    <div class="relative w-full h-[350px] lg:h-full" id="map-wrapper">
                        <canvas id="route-canvas" class="block"></canvas>
                        <div id="map-tooltip" class="absolute hidden bg-gray-900/90 text-white text-xs px-2 py-1 rounded pointer-events-none z-20 whitespace-nowrap"></div>
                    </div>
                    <div class="p-2 bg-gray-50 text-[10px] text-gray-400 text-center">ğŸ‘† å•æŒ‡æ‹–æ‹½ â€¢ åŒæŒ‡/æ»šè½®ç¼©æ”¾</div>
                </div>

                <!-- 3. å½“å‰å¤©æ™¯ç‚¹ & æ·»åŠ  (Mobile: Below Map) -->
                <div class="lg:col-span-3 bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex flex-col h-full order-3">
                    <!-- Mobile only: Show spot list here -->
                    <div class="lg:hidden mb-4">
                        <h3 class="font-bold text-gray-800 mb-2 text-sm">ğŸ“ å½“æ—¥æ™¯ç‚¹ (<span id="day-spot-count">0</span>)</h3>
                        <div id="day-spots-list-mobile" class="space-y-2 max-h-40 overflow-y-auto custom-scrollbar text-xs"></div>
                    </div>

                    <h3 class="font-bold text-gray-800 mb-3 text-sm">â• æ·»åŠ æ™¯ç‚¹</h3>
                    <input type="text" id="spot-search" placeholder="æœç´¢..." class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm mb-3 outline-none">
                    <div id="all-spots-list" class="flex-grow overflow-y-auto space-y-2 pr-1 custom-scrollbar max-h-60 lg:max-h-none"></div>
                </div>
            </div>
        </section>

        <!-- 3. æ™ºèƒ½é¢„ç®— -->
        <section id="budget" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-4 pb-20">
                <!-- è‡ªå®šä¹‰æ·»åŠ  -->
                <div class="lg:col-span-5 space-y-4">
                    <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                        <div class="flex items-center gap-2 mb-3 text-blue-600 text-sm font-bold"><i class="ph ph-plus-circle text-lg"></i> æ·»åŠ æ”¯å‡º</div>
                        <div class="flex gap-2">
                            <input type="text" id="custom-item-name" placeholder="é¡¹ç›® (å¦‚:æ»‘é›ª)" class="flex-grow bg-gray-50 border-0 rounded-lg px-3 py-2 text-sm ring-1 ring-gray-200 focus:ring-blue-500 outline-none">
                            <input type="number" id="custom-item-price" placeholder="Â¥" class="w-20 bg-gray-50 border-0 rounded-lg px-3 py-2 text-sm ring-1 ring-gray-200 focus:ring-blue-500 outline-none">
                            <button onclick="addCustomBudgetItem()" class="bg-blue-600 text-white px-3 rounded-lg"><i class="ph ph-check-bold"></i></button>
                        </div>
                    </div>
                    
                    <!-- åŸºç¡€å‚æ•° -->
                    <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                        <h3 class="font-bold text-gray-800 mb-3 text-sm">åŸºç¡€è®¾å®š</h3>
                        <div class="grid grid-cols-2 gap-3 text-sm">
                            <div><label class="text-xs text-gray-400">äººæ•°</label><input type="number" id="budget-people" value="2" class="w-full mt-1 border rounded p-1.5"></div>
                            <div><label class="text-xs text-gray-400">å¤©æ•°</label><input type="number" id="budget-days" value="1" disabled class="w-full mt-1 bg-gray-50 border rounded p-1.5 text-gray-400"></div>
                            <div><label class="text-xs text-gray-400">ä½å®¿/é—´</label><input type="number" id="price-stay" value="400" class="w-full mt-1 border rounded p-1.5"></div>
                            <div><label class="text-xs text-gray-400">è½¦è´¹/å¤©</label><input type="number" id="price-trans" value="500" class="w-full mt-1 border rounded p-1.5"></div>
                            <div><label class="text-xs text-gray-400">é¤/äºº</label><input type="number" id="price-food" value="150" class="w-full mt-1 border rounded p-1.5"></div>
                            <div><label class="text-xs text-gray-400">é—¨ç¥¨/äºº</label><input type="number" id="price-ticket" value="800" class="w-full mt-1 border rounded p-1.5"></div>
                        </div>
                    </div>
                </div>

                <!-- ç»“æœé¢æ¿ -->
                <div class="lg:col-span-7">
                    <div class="bg-gradient-to-br from-blue-600 to-indigo-700 p-5 rounded-3xl shadow-xl text-white relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-40 h-40 bg-white/10 rounded-full blur-3xl -mr-10 -mt-10 pointer-events-none"></div>
                        
                        <div class="mb-4">
                            <h2 class="text-lg font-bold mb-4 flex items-center gap-2 opacity-90"><i class="ph ph-receipt"></i> é¢„ç®—æ¸…å•</h2>
                            <div id="budget-summary-list" class="space-y-2 text-sm text-blue-50 max-h-[300px] overflow-y-auto custom-scrollbar pr-1">
                                <!-- JS Injected -->
                            </div>
                        </div>

                        <div class="pt-4 border-t border-white/10 flex justify-between items-end">
                            <div>
                                <div class="text-blue-200 text-xs">é¢„ä¼°æ€»è®¡</div>
                                <div class="text-3xl font-bold mt-1">Â¥<span id="disp-total">0</span></div>
                            </div>
                            <div class="text-right text-blue-200 text-xs">äººå‡: Â¥<span id="disp-avg">0</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 4. å…¨æ™¯çœ‹æ¿ -->
        <section id="data" class="tab-content">
             <div class="grid grid-cols-2 gap-3 mb-4">
                <div class="bg-white p-3 rounded-2xl shadow-sm border border-gray-100 text-center"><div class="text-[10px] text-gray-400">æ€»é¢„ç®—</div><div class="text-lg font-bold text-blue-600">Â¥<span id="dash-total">0</span></div></div>
                <div class="bg-white p-3 rounded-2xl shadow-sm border border-gray-100 text-center"><div class="text-[10px] text-gray-400">è¡Œç¨‹</div><div class="text-lg font-bold text-gray-700"><span id="dash-days">0</span> å¤©</div></div>
                <div class="bg-white p-3 rounded-2xl shadow-sm border border-gray-100 text-center"><div class="text-[10px] text-gray-400">å‡†å¤‡</div><div class="text-lg font-bold text-green-600"><span id="dash-pack">0</span>%</div></div>
                <div class="bg-white p-3 rounded-2xl shadow-sm border border-gray-100 text-center"><div class="text-[10px] text-gray-400">æ»‘é›ªç‚¹</div><div class="text-lg font-bold text-purple-600"><span id="dash-ski-spots">0</span></div></div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 pb-20">
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                    <h3 class="text-sm font-bold text-gray-700 mb-2">èµ„é‡‘å æ¯”</h3>
                    <div class="h-48"><canvas id="budgetDoughnutChart"></canvas></div>
                </div>
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                    <h3 class="text-sm font-bold text-gray-700 mb-2">ç©æ³•åˆ†å¸ƒ</h3>
                    <div class="h-48"><canvas id="spotPolarChart"></canvas></div>
                </div>
            </div>
        </section>

        <!-- 5. è£…å¤‡æ¸…å• -->
        <section id="pack" class="tab-content">
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 mb-4">
                <div class="flex items-center gap-4 mb-4">
                    <div class="w-16 h-16 relative flex-shrink-0">
                        <canvas id="packChart"></canvas>
                        <div class="absolute inset-0 flex items-center justify-center text-xs font-bold text-blue-600" id="pack-percent-text">0%</div>
                    </div>
                    <div class="flex-grow">
                        <h2 class="font-bold text-gray-800">å‡†å¤‡è¿›åº¦</h2>
                        <p class="text-xs text-gray-400 mt-1">å·²é€‰ <span id="pack-checked-count">0</span> / <span id="pack-total-count">0</span></p>
                    </div>
                    <button onclick="exportGearList()" class="bg-blue-50 text-blue-600 p-2 rounded-lg text-xl"><i class="ph ph-export"></i></button>
                </div>
                <button onclick="addCustomGear()" class="w-full py-2 border border-dashed border-gray-300 rounded-xl text-xs text-gray-500 mb-4">+ æ·»åŠ è‡ªå®šä¹‰ç‰©å“</button>
                <div id="gear-container" class="space-y-4 pb-20"></div>
            </div>
        </section>
    </main>

    <!-- Mobile Bottom Navigation (Visible < 768px) -->
    <nav class="md:hidden fixed bottom-0 left-0 w-full bg-white border-t border-gray-200 z-50 flex justify-around items-center pb-safe pt-2 px-1 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
        <button onclick="switchTab('explore')" class="mobile-nav-btn flex flex-col items-center p-2 text-gray-400 active" data-tab="explore">
            <i class="ph ph-mountains text-2xl mb-0.5"></i><span class="text-[10px]">ç™¾ç§‘</span>
        </button>
        <button onclick="switchTab('routes')" class="mobile-nav-btn flex flex-col items-center p-2 text-gray-400" data-tab="routes">
            <i class="ph ph-map-trifold text-2xl mb-0.5"></i><span class="text-[10px]">åœ°å›¾</span>
        </button>
        <!-- Center Action Button -->
        <button onclick="openAttractionModal(true)" class="flex flex-col items-center justify-center w-12 h-12 bg-blue-600 rounded-full text-white shadow-lg -mt-6 border-4 border-gray-50">
            <i class="ph ph-plus text-2xl"></i>
        </button>
        <button onclick="switchTab('budget')" class="mobile-nav-btn flex flex-col items-center p-2 text-gray-400" data-tab="budget">
            <i class="ph ph-calculator text-2xl mb-0.5"></i><span class="text-[10px]">é¢„ç®—</span>
        </button>
        <button onclick="switchTab('data')" class="mobile-nav-btn flex flex-col items-center p-2 text-gray-400" data-tab="data">
            <i class="ph ph-chart-pie-slice text-2xl mb-0.5"></i><span class="text-[10px]">ç»Ÿè®¡</span>
        </button>
    </nav>

    <!-- Modal (Universal) -->
    <div id="attraction-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-sm p-5 shadow-2xl animate-[fadeIn_0.2s_ease-out]">
            <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-gray-800">è‡ªå®šä¹‰åœ°ç‚¹</h3><button onclick="closeModal()" class="text-gray-400"><i class="ph ph-x text-xl"></i></button></div>
            <div class="space-y-3">
                <input type="text" id="modal-name" placeholder="åç§° (å¦‚: éšè—æ‰“å¡ç‚¹)" class="w-full bg-gray-50 border-0 rounded-xl p-3 text-sm ring-1 ring-gray-200 focus:ring-blue-500 outline-none">
                <div class="flex gap-2">
                    <select id="modal-type" class="bg-gray-50 border-0 rounded-xl p-3 text-sm ring-1 ring-gray-200 outline-none flex-grow">
                        <option value="custom">âœ¨ ç§è—</option><option value="è‡ªç„¶">ğŸ”ï¸ è‡ªç„¶</option><option value="äººæ–‡">ğŸ•Œ äººæ–‡</option><option value="æ»‘é›ª">ğŸ¿ æ»‘é›ª</option>
                    </select>
                    <button onclick="pickLocationFromModal()" class="bg-blue-50 text-blue-600 px-3 rounded-xl text-sm font-medium border border-blue-100 whitespace-nowrap">ğŸ“ é€‰ä½ç½®</button>
                </div>
                <textarea id="modal-desc" placeholder="å¤‡æ³¨..." class="w-full bg-gray-50 border-0 rounded-xl p-3 text-sm ring-1 ring-gray-200 h-20 outline-none resize-none"></textarea>
                <div class="text-xs text-gray-400 text-center" id="modal-coords-display">åæ ‡: æœªè®¾ç½®</div>
            </div>
            <button onclick="saveCustomSpot()" class="w-full mt-5 bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-blue-500/30">ä¿ å­˜</button>
        </div>
    </div>

    <script>
        // --- æ ¸å¿ƒé€»è¾‘ ---
        const defaultSpots = [
            { id: 1, name: "ä¹Œé²æœ¨é½", type: "äººæ–‡", desc: "é¦–åºœ", x: 500, y: 300, tags: ["ä¸­è½¬"] },
            { id: 2, name: "ç¦¾æœ¨æ‘", type: "è‡ªç„¶", desc: "æ™¨é›¾", x: 450, y: 100, tags: ["æ‘„å½±"] },
            { id: 3, name: "å–€çº³æ–¯", type: "è‡ªç„¶", desc: "æ¹–æ€ª", x: 400, y: 80, tags: ["å¾’æ­¥"] },
            { id: 4, name: "èµ›é‡Œæœ¨æ¹–", type: "è‡ªç„¶", desc: "è“å†°", x: 200, y: 350, tags: ["è‡ªé©¾"] },
            { id: 5, name: "å–€ä»€", type: "äººæ–‡", desc: "å¤åŸ", x: 100, y: 800, tags: ["ç¾é£Ÿ"] },
            { id: 6, name: "å¯å¯æ‰˜æµ·", type: "æ»‘é›ª", desc: "æ»‘é›ª", x: 600, y: 150, tags: ["æé™"] }
        ];
        const defaultGear = { "è¯ä»¶": ["èº«ä»½è¯","é©¾ç…§"], "è¡£ç‰©": ["ç¾½ç»’æœ","ä¿æš–è¡£","é›ªåœ°é´"], "æ»‘é›ª": ["æ‰‹å¥—","æŠ¤ç›®é•œ"], "è¯å“": ["æ„Ÿå†’è¯","è‚ èƒƒè¯"] };
        
        let state = {
            spots: [...defaultSpots], itinerary: [[]], currentDayIndex: 0, customBudget: [], customGear: [],
            isPickingMode: false, mapScale: 1, mapOffset: {x:0,y:0}, isDragging: false, startDrag: {x:0,y:0}, tempSpotData: null
        };

        document.addEventListener('DOMContentLoaded', () => {
            renderExploreGrid(); renderDayList(); renderAllSpots(); renderBudget(); renderGear(); initCharts();
            setTimeout(() => { initMapEvents(); renderMap(); }, 100);
            
            // Event Listeners
            document.getElementById('explore-search').addEventListener('input', renderExploreGrid);
            document.getElementById('explore-filter').addEventListener('change', renderExploreGrid);
            document.getElementById('spot-search').addEventListener('input', renderAllSpots);
            ['budget-people','price-stay','price-trans','price-food','price-ticket'].forEach(id=>document.getElementById(id).addEventListener('input',renderBudget));
            
            // Mobile Nav Logic
            document.querySelectorAll('.mobile-nav-btn').forEach(btn => {
                btn.addEventListener('click', () => switchTab(btn.dataset.tab));
            });
        });

        // --- 1. Map Engine (Touch Support Added) ---
        function initMapEvents() {
            const w = document.getElementById('map-wrapper');
            
            // Mouse
            w.addEventListener('wheel', e => { e.preventDefault(); zoomMap(e.deltaY>0?0.9:1.1); });
            w.addEventListener('mousedown', e => { state.isDragging=true; state.startDrag={x:e.clientX,y:e.clientY}; w.style.cursor='grabbing'; if(state.isPickingMode) handleMapClick(e.clientX, e.clientY, w); });
            window.addEventListener('mousemove', e => { if(state.isDragging) handleDrag(e.clientX, e.clientY); });
            window.addEventListener('mouseup', () => { state.isDragging=false; w.style.cursor=state.isPickingMode?'crosshair':'grab'; });

            // Touch (New!)
            w.addEventListener('touchstart', e => { 
                if(e.touches.length === 1) {
                    state.isDragging=true; 
                    state.startDrag={x:e.touches[0].clientX, y:e.touches[0].clientY};
                }
            }, {passive: false});
            
            w.addEventListener('touchmove', e => {
                if(state.isDragging && e.touches.length === 1) {
                    e.preventDefault(); // Prevent scroll
                    handleDrag(e.touches[0].clientX, e.touches[0].clientY);
                }
            }, {passive: false});

            w.addEventListener('touchend', () => { state.isDragging=false; });
        }

        function handleDrag(cx, cy) {
            const dx = cx - state.startDrag.x;
            const dy = cy - state.startDrag.y;
            state.mapOffset.x += dx; state.mapOffset.y += dy;
            state.startDrag = {x:cx, y:cy};
            renderMap();
        }

        function zoomMap(delta) { const ns=state.mapScale+delta; if(ns>0.2 && ns<5) { state.mapScale=ns; renderMap(); } }
        function resetMapView() { state.mapScale=1; state.mapOffset={x:0,y:0}; renderMap(); }

        function renderMap() {
            const cvs=document.getElementById('route-canvas'), ctx=cvs.getContext('2d'), w=document.getElementById('map-wrapper');
            cvs.width=w.offsetWidth; cvs.height=w.offsetHeight; ctx.clearRect(0,0,cvs.width,cvs.height);
            ctx.save(); ctx.translate(cvs.width/2+state.mapOffset.x, cvs.height/2+state.mapOffset.y); ctx.scale(state.mapScale,state.mapScale); ctx.translate(-cvs.width/2,-cvs.height/2);
            
            const vs=1000, stX=(cvs.width-vs)/2, stY=(cvs.height-vs)/2; // Virtual canvas 1000x1000 centered

            // Lines
            state.itinerary.forEach((dS,di)=>{
                if(dS.length<2)return; ctx.beginPath(); ctx.strokeStyle=di===state.currentDayIndex?'#2563EB':'#CBD5E1'; ctx.lineWidth=di===state.currentDayIndex?3/state.mapScale:2/state.mapScale;
                ctx.setLineDash(di===state.currentDayIndex?[]:[5,5]);
                dS.forEach((id,idx)=>{const s=state.spots.find(sp=>sp.id===id); if(s) idx===0?ctx.moveTo(stX+s.x,stY+s.y):ctx.lineTo(stX+s.x,stY+s.y);}); ctx.stroke();
            });

            // Points
            state.spots.forEach(s=>{
                const cx=stX+s.x, cy=stY+s.y, act=state.itinerary[state.currentDayIndex].includes(s.id);
                ctx.beginPath(); ctx.arc(cx,cy,(act?8:5)/Math.sqrt(state.mapScale),0,Math.PI*2); ctx.fillStyle=act?'#2563EB':'#94A3B8'; ctx.fill();
                if(act || state.mapScale > 1.5) { ctx.fillStyle='#334155'; ctx.font=`${12/state.mapScale}px sans-serif`; ctx.fillText(s.name,cx+10,cy); }
            });
            ctx.restore();
        }

        // --- 2. Budget Logic (ID fix included) ---
        function addCustomBudgetItem() {
            const n=document.getElementById('custom-item-name').value, p=parseFloat(document.getElementById('custom-item-price').value);
            if(n&&p){state.customBudget.push({name:n,price:p}); document.getElementById('custom-item-name').value=''; document.getElementById('custom-item-price').value=''; renderBudget();}
        }
        function removeBudgetItem(i){state.customBudget.splice(i,1); renderBudget();}
        
        function renderBudget() {
            const p=parseInt(document.getElementById('budget-people').value)||1, d=parseInt(document.getElementById('budget-days').value)||1;
            const stay=parseFloat(document.getElementById('price-stay').value)||0, trans=parseFloat(document.getElementById('price-trans').value)||0;
            const food=parseFloat(document.getElementById('price-food').value)||0, ticket=parseFloat(document.getElementById('price-ticket').value)||0;
            
            const tStay=(stay*Math.ceil(p/2))*(d-1), tTrans=trans*d, tMisc=(food*p*d)+(ticket*p);
            let listHtml=`<div class="flex justify-between items-center p-2 bg-white/10 rounded-lg border border-white/10"><span>ğŸ¨ ä½å®¿</span><span class="font-mono font-bold">Â¥<span id="disp-stay">${tStay}</span></span></div>`;
            listHtml+=`<div class="flex justify-between items-center p-2 bg-white/10 rounded-lg border border-white/10"><span>ğŸš— äº¤é€š</span><span class="font-mono font-bold">Â¥<span id="disp-trans">${tTrans}</span></span></div>`;
            listHtml+=`<div class="flex justify-between items-center p-2 bg-white/10 rounded-lg border border-white/10"><span>ğŸ¥˜ é£Ÿ/ç¥¨</span><span class="font-mono font-bold">Â¥<span id="disp-misc">${tMisc}</span></span></div>`;
            
            let tCustom=0;
            state.customBudget.forEach((i,x)=>{
                tCustom+=i.price;
                listHtml+=`<div class="flex justify-between items-center p-2 bg-orange-500/20 rounded-lg border border-orange-500/30 text-orange-100 budget-item-enter relative group"><span>${i.name}</span><div class="flex items-center gap-2"><span class="font-mono font-bold">Â¥${i.price}</span><button onclick="removeBudgetItem(${x})" class="text-white/70"><i class="ph ph-trash"></i></button></div></div>`;
            });
            // Hack for Dashboard to read custom total easily
            listHtml+=`<span id="disp-custom" style="display:none">${tCustom}</span>`;

            document.getElementById('budget-summary-list').innerHTML=listHtml;
            const total=tStay+tTrans+tMisc+tCustom;
            document.getElementById('disp-total').innerText=total.toLocaleString();
            document.getElementById('disp-avg').innerText=Math.round(total/p).toLocaleString();
        }

        // --- 3. Dashboard Updates ---
        function updateDashboard() {
            renderBudget();
            const t=document.getElementById('disp-total').innerText, d=state.itinerary.length;
            const totGear=document.querySelectorAll('.gear-check').length, chkGear=document.querySelectorAll('.gear-check:checked').length;
            
            document.getElementById('dash-total').innerText=t;
            document.getElementById('dash-days').innerText=d;
            document.getElementById('dash-pack').innerText=totGear?Math.round(chkGear/totGear*100):0;
            document.getElementById('dash-ski-spots').innerText=state.itinerary.flat().map(id=>state.spots.find(s=>s.id===id)).filter(s=>s&&s.type==='æ»‘é›ª').length;
            
            updateCharts();
        }

        // --- 4. Charts ---
        let budgetChart, polarChart, packChart;
        function initCharts() {
            budgetChart=new Chart(document.getElementById('budgetDoughnutChart'),{type:'doughnut',data:{labels:['ä½','è¡Œ','é£Ÿ','è‡ª'],datasets:[{data:[1,1,1,1],backgroundColor:['#3B82F6','#10B981','#8B5CF6','#F97316'],borderWidth:0}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right',labels:{boxWidth:10}}}}});
            polarChart=new Chart(document.getElementById('spotPolarChart'),{type:'polarArea',data:{labels:['è‡ªç„¶','äººæ–‡','æ»‘é›ª','è‡ªå®š'],datasets:[{data:[1,1,1,0],backgroundColor:['#38BDF8aa','#A78BFAaa','#F97316aa','#FBBF24aa'],borderWidth:0}]},options:{responsive:true,maintainAspectRatio:false,scales:{r:{ticks:{display:false}}},plugins:{legend:{position:'right',labels:{boxWidth:10}}}}});
            packChart=new Chart(document.getElementById('packChart'),{type:'doughnut',data:{datasets:[{data:[0,1],backgroundColor:['#2563EB','#E5E7EB'],borderWidth:0,cutout:'85%'}]},options:{responsive:true,maintainAspectRatio:false,plugins:{tooltip:{enabled:false}}}});
        }
        function updateCharts() {
            // Budget
            const s=parseInt(document.getElementById('disp-stay').innerText), tr=parseInt(document.getElementById('disp-trans').innerText);
            const m=parseInt(document.getElementById('disp-misc').innerText), c=parseInt(document.getElementById('disp-custom').innerText);
            budgetChart.data.datasets[0].data=[s,tr,m,c]; budgetChart.update();
            // Polar
            const ids=state.itinerary.flat(), sp=ids.map(id=>state.spots.find(s=>s.id===id)).filter(s=>s);
            polarChart.data.datasets[0].data=[sp.filter(s=>s.type==='è‡ªç„¶').length,sp.filter(s=>s.type==='äººæ–‡').length,sp.filter(s=>s.type==='æ»‘é›ª').length,sp.filter(s=>s.type==='custom').length]; polarChart.update();
        }

        // --- 5. General Logic ---
        function renderExploreGrid() {
            const g=document.getElementById('explore-grid'), t=document.getElementById('explore-search').value.toLowerCase(), f=document.getElementById('explore-filter').value;
            g.innerHTML='';
            state.spots.forEach(s=>{
                if((s.name.includes(t)||s.tags.join('').includes(t))&&(f==='all'||(f==='custom'?s.id>1000:s.type===f))){
                    const div=document.createElement('div'); div.className="bg-white rounded-xl shadow-sm p-3 border border-gray-100 flex flex-col justify-between";
                    div.innerHTML=`<div><div class="flex justify-between"><h3 class="font-bold text-gray-800">${s.name}</h3><span class="text-[10px] bg-gray-100 px-1.5 py-0.5 rounded text-gray-500">${s.type}</span></div><p class="text-xs text-gray-400 mt-1">${s.desc||''}</p></div><button onclick="addToRoute(${s.id})" class="mt-3 w-full bg-blue-50 text-blue-600 text-xs py-2 rounded font-medium">åŠ å…¥è¡Œç¨‹</button>`;
                    g.appendChild(div);
                }
            });
        }
        function addToRoute(id){ state.itinerary[state.currentDayIndex].push(id); renderDayList(); switchTab('routes'); }
        
        function renderDayList() {
            const l=document.getElementById('day-list'); l.innerHTML=''; 
            document.getElementById('budget-days').value=state.itinerary.length;
            renderBudget(); // update days in budget
            state.itinerary.forEach((s,i)=>{
                const div=document.createElement('div'); 
                div.className=`flex-shrink-0 lg:flex-shrink w-20 lg:w-full p-2 lg:p-3 rounded-xl border border-gray-100 cursor-pointer text-center lg:text-left transition-all ${i===state.currentDayIndex?'bg-blue-50 border-blue-200 text-blue-700':'hover:bg-gray-50 text-gray-500'}`;
                div.innerHTML=`<div class="font-bold text-xs">D${i+1}</div><div class="text-[10px] opacity-70">${s.length}ç‚¹</div>`;
                div.onclick=()=>{state.currentDayIndex=i;renderDayList();};
                l.appendChild(div);
            });
            document.getElementById('current-day-num').innerText=state.currentDayIndex+1;
            document.getElementById('day-spot-count').innerText=state.itinerary[state.currentDayIndex].length;
            renderDaySpots(); renderMap();
        }
        function addDay(){ state.itinerary.push([]); state.currentDayIndex=state.itinerary.length-1; renderDayList(); }
        
        function renderDaySpots() {
            const desktopL=document.getElementById('day-spots-list-desktop');
            const mobileL=document.getElementById('day-spots-list-mobile');
            const html = state.itinerary[state.currentDayIndex].map((id,i)=>{
                const s=state.spots.find(sp=>sp.id===id); if(!s)return'';
                return `<div class="flex justify-between items-center p-2 bg-gray-50 rounded"><span class="truncate">${i+1}. ${s.name}</span><button onclick="rmSpot(${i})" class="text-red-400 px-2">Ã—</button></div>`;
            }).join('');
            desktopL.innerHTML=html; mobileL.innerHTML=html;
        }
        function rmSpot(i){state.itinerary[state.currentDayIndex].splice(i,1); renderDayList();}
        
        function renderAllSpots(){
            const l=document.getElementById('all-spots-list'), t=document.getElementById('spot-search').value; l.innerHTML='';
            state.spots.filter(s=>s.name.includes(t)).forEach(s=>{
                const b=document.createElement('button'); b.className="w-full text-left p-2 hover:bg-gray-50 text-xs text-gray-600 flex justify-between";
                b.innerHTML=`<span>${s.name}</span><span>+</span>`; b.onclick=()=>{state.itinerary[state.currentDayIndex].push(s.id);renderDayList();};
                l.appendChild(b);
            });
        }

        // --- Gear ---
        function renderGear() {
            const c=document.getElementById('gear-container'); c.innerHTML='';
            let cats={...defaultGear}; if(state.customGear.length) cats["è‡ªå®šä¹‰"]=state.customGear;
            for(const [k,v] of Object.entries(cats)){
                c.innerHTML+=`<div><h4 class="font-bold text-gray-700 text-sm mb-2">${k}</h4><div class="grid grid-cols-2 gap-2">${v.map(i=>`<label class="flex items-center space-x-2 text-xs text-gray-500"><input type="checkbox" class="gear-check rounded text-blue-600" onchange="updateGearStats()"><span>${i}</span></label>`).join('')}</div></div>`;
            }
            updateGearStats();
        }
        function updateGearStats(){
            const t=document.querySelectorAll('.gear-check').length, c=document.querySelectorAll('.gear-check:checked').length;
            document.getElementById('pack-checked-count').innerText=c; document.getElementById('pack-total-count').innerText=t;
            document.getElementById('pack-percent-text').innerText=(t?Math.round(c/t*100):0)+'%';
            if(packChart){packChart.data.datasets[0].data=[c,t-c]; packChart.update();}
        }
        function addCustomGear(){const n=prompt("åç§°"); if(n){state.customGear.push(n); renderGear();}}
        function exportGearList(){
            let txt="æˆ‘çš„æ¸…å•\n"; document.querySelectorAll('.gear-check').forEach(cb=>{if(cb.checked)txt+=`- [x] ${cb.nextElementSibling.innerText}\n`});
            const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([txt],{type:'text/plain'})); a.download='list.txt'; a.click();
        }

        // --- Utility ---
        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.mobile-nav-btn').forEach(b=>b.classList.toggle('active', b.dataset.tab===id));
            document.querySelectorAll('.nav-btn').forEach(b=>b.classList.toggle('bg-gray-100', b.dataset.tab!==id));
            
            if(id==='routes') setTimeout(renderMap,100);
            if(id==='data') updateDashboard();
            window.scrollTo(0,0);
        }
        
        // Modals
        function openAttractionModal(r){document.getElementById('attraction-modal').classList.remove('hidden'); if(r){document.getElementById('modal-name').value=''; state.tempSpotData=null; document.getElementById('modal-coords-display').innerText='æœªè®¾ç½®';}}
        function closeModal(){document.getElementById('attraction-modal').classList.add('hidden'); state.isPickingMode=false;}
        function pickLocationFromModal(){state.tempSpotData={name:document.getElementById('modal-name').value}; state.isPickingMode=true; closeModal(); switchTab('routes'); alert("è¯·ç‚¹å‡»åœ°å›¾");}
        function handleMapClick(cx, cy, w){
            const rect=w.getBoundingClientRect();
            // Calc virtual coords
            const vs=1000, stX=(w.offsetWidth-vs)/2, stY=(w.offsetHeight-vs)/2;
            const mx=cx-rect.left, my=cy-rect.top;
            const vx=(mx-w.offsetWidth/2-state.mapOffset.x)/state.mapScale+w.offsetWidth/2-stX;
            const vy=(my-w.offsetHeight/2-state.mapOffset.y)/state.mapScale+w.offsetHeight/2-stY;
            
            if(!state.tempSpotData)state.tempSpotData={}; state.tempSpotData.x=vx; state.tempSpotData.y=vy;
            state.isPickingMode=false; openAttractionModal(false);
        }
        function saveCustomSpot(){
            const n=document.getElementById('modal-name').value; if(!n)return;
            state.spots.push({id:Date.now(), name:n, type:document.getElementById('modal-type').value, desc:document.getElementById('modal-desc').value, x:state.tempSpotData?.x||500, y:state.tempSpotData?.y||500, tags:[]});
            renderExploreGrid(); renderAllSpots(); renderMap(); closeModal();
        }
    </script>
</body>
</html>
